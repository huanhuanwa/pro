import { __decorate, __metadata } from "tslib";
import { Observable, BehaviorSubject, from } from 'rxjs';
import { distinctUntilChanged, map, shareReplay } from 'rxjs/operators';
import { META_KEY } from './types';
import { helpers } from 'ngx-tethys/util';
import { getSingletonRootStore } from './root-store';
import { isDevMode, Injectable } from '@angular/core';
import { ActionState } from './action-state';
import { Action } from './action';
export class Store {
    constructor(initialState) {
        this.reduxToolEnabled = isDevMode();
        this._defaultStoreInstanceId = this._getClassName();
        this.state$ = new BehaviorSubject(initialState);
        this.initialStateCache = Object.assign({}, initialState);
        if (this.reduxToolEnabled) {
            const rootStore = getSingletonRootStore();
            ActionState.changeAction(`Add-${this._defaultStoreInstanceId}`);
            rootStore.registerStore(this);
        }
    }
    get snapshot() {
        return this.state$.getValue();
    }
    dispatch(type, payload) {
        ActionState.changeAction(`${this._defaultStoreInstanceId}-${type}`);
        const result = this._dispatch({
            type: type,
            payload: payload
        });
        result.subscribe();
        return result;
    }
    _dispatch(action) {
        const meta = this[META_KEY];
        if (!meta) {
            throw new Error(`${META_KEY} is not found, current store has not action`);
        }
        const actionMeta = meta.actions[action.type];
        if (!actionMeta) {
            throw new Error(`${action.type} is not found`);
        }
        // let result: any = this[actionMeta.fn](this.snapshot, action.payload);
        let result = actionMeta.originalFn.call(this, this.snapshot, action.payload);
        if (result instanceof Promise) {
            result = from(result);
        }
        if (result instanceof Observable) {
            result = result.pipe(map(r => r));
        }
        else {
            result = new Observable((observer) => {
                observer.next({});
            });
        }
        return result.pipe(shareReplay());
    }
    select(selector) {
        return this.state$.pipe(map(selector), distinctUntilChanged());
    }
    next(state) {
        this.state$.next(state);
    }
    error(error) {
        this.state$.error(error);
    }
    complete() {
        this.state$.complete();
    }
    subscribe(next, error, complete) {
        return this.state$.subscribe(next, error, complete);
    }
    /**
     * set store new state
     *
     * @example
     * this.setState(newState);
     * this.setState({ users: produce(this.snapshot.users).add(user) });
     * this.setState((state) => {
     *    return {
     *        users: produce(state.users).add(user)
     *    }
     * });
     * @param fn
     */
    setState(fn) {
        if (helpers.isFunction(fn)) {
            this.next(Object.assign(Object.assign({}, this.snapshot), fn(this.snapshot)));
        }
        else {
            this.next(Object.assign(Object.assign({}, this.snapshot), fn));
        }
    }
    getState() {
        return this.snapshot;
    }
    clearState() {
        this.setState(this.initialStateCache);
    }
    ngOnDestroy() {
        if (this.reduxToolEnabled) {
            const rootStore = getSingletonRootStore();
            rootStore.unregisterStore(this);
        }
    }
    /**
     * You can override this method if you want to give your container instance a custom id.
     * The returned id must be unique in the application.
     */
    getStoreInstanceId() {
        return this._defaultStoreInstanceId;
    }
    _getClassName() {
        const name = this.constructor.name || /function (.+)\(/.exec(this.constructor + '')[1];
        if (this.reduxToolEnabled) {
            const rootStore = getSingletonRootStore();
            if (!rootStore.existStoreInstanceId(name)) {
                return name;
            }
            let j = 0;
            for (let i = 1; i < 20; i++) {
                if (!rootStore.existStoreInstanceId(`${name}-${i}`)) {
                    j = i;
                    break;
                }
            }
            return `${name}-${j}`;
        }
        return name;
    }
}
Store.decorators = [
    { type: Injectable }
];
Store.ctorParameters = () => [
    { type: undefined }
];
__decorate([
    Action(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", []),
    __metadata("design:returntype", void 0)
], Store.prototype, "clearState", null);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RvcmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvc3RvcmUvc3RvcmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQVksZUFBZSxFQUFFLElBQUksRUFBcUMsTUFBTSxNQUFNLENBQUM7QUFDdEcsT0FBTyxFQUFFLG9CQUFvQixFQUFFLEdBQUcsRUFBRSxXQUFXLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN4RSxPQUFPLEVBQUUsUUFBUSxFQUFpQixNQUFNLFNBQVMsQ0FBQztBQUNsRCxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDMUMsT0FBTyxFQUFFLHFCQUFxQixFQUFhLE1BQU0sY0FBYyxDQUFDO0FBQ2hFLE9BQU8sRUFBYSxTQUFTLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ2pFLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUM3QyxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBUWxDLE1BQU0sT0FBTyxLQUFLO0lBU2QsWUFBWSxZQUFpQjtRQUp0QixxQkFBZ0IsR0FBRyxTQUFTLEVBQUUsQ0FBQztRQUtsQyxJQUFJLENBQUMsdUJBQXVCLEdBQUcsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBQ3BELElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxlQUFlLENBQUksWUFBWSxDQUFDLENBQUM7UUFDbkQsSUFBSSxDQUFDLGlCQUFpQixxQkFBUSxZQUFZLENBQUUsQ0FBQztRQUM3QyxJQUFJLElBQUksQ0FBQyxnQkFBZ0IsRUFBRTtZQUN2QixNQUFNLFNBQVMsR0FBYyxxQkFBcUIsRUFBRSxDQUFDO1lBQ3JELFdBQVcsQ0FBQyxZQUFZLENBQUMsT0FBTyxJQUFJLENBQUMsdUJBQXVCLEVBQUUsQ0FBQyxDQUFDO1lBQ2hFLFNBQVMsQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLENBQUM7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QUFDLENBQUM7b0JBQ04sTUFBTTtpQkFDVDthQUNKO1lBQ0QsT0FBTyxHQUFHLElBQUksSUFBSSxDQUFDLEVBQUUsQ0FBQztTQUN6QjtRQUNELE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7OztZQXRKSixVQUFVOzs7OztBQWtIUDtJQURDLE1BQU0sRUFBRTs7Ozt1Q0FHUiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE9ic2VydmFibGUsIE9ic2VydmVyLCBCZWhhdmlvclN1YmplY3QsIGZyb20sIG9mLCBQYXJ0aWFsT2JzZXJ2ZXIsIFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZGlzdGluY3RVbnRpbENoYW5nZWQsIG1hcCwgc2hhcmVSZXBsYXkgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBNRVRBX0tFWSwgU3RvcmVNZXRhSW5mbyB9IGZyb20gJy4vdHlwZXMnO1xuaW1wb3J0IHsgaGVscGVycyB9IGZyb20gJ25neC10ZXRoeXMvdXRpbCc7XG5pbXBvcnQgeyBnZXRTaW5nbGV0b25Sb290U3RvcmUsIFJvb3RTdG9yZSB9IGZyb20gJy4vcm9vdC1zdG9yZSc7XG5pbXBvcnQgeyBPbkRlc3Ryb3ksIGlzRGV2TW9kZSwgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQWN0aW9uU3RhdGUgfSBmcm9tICcuL2FjdGlvbi1zdGF0ZSc7XG5pbXBvcnQgeyBBY3Rpb24gfSBmcm9tICcuL2FjdGlvbic7XG5cbmludGVyZmFjZSBBY3Rpb24ge1xuICAgIHR5cGU6IHN0cmluZztcbiAgICBwYXlsb2FkPzogYW55O1xufVxuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgU3RvcmU8VCA9IHVua25vd24+IGltcGxlbWVudHMgT2JzZXJ2ZXI8VD4sIE9uRGVzdHJveSB7XG4gICAgaW5pdGlhbFN0YXRlQ2FjaGU6IGFueTtcblxuICAgIHB1YmxpYyBzdGF0ZSQ6IEJlaGF2aW9yU3ViamVjdDxUPjtcblxuICAgIHB1YmxpYyByZWR1eFRvb2xFbmFibGVkID0gaXNEZXZNb2RlKCk7XG5cbiAgICBwcml2YXRlIF9kZWZhdWx0U3RvcmVJbnN0YW5jZUlkOiBzdHJpbmc7XG5cbiAgICBjb25zdHJ1Y3Rvcihpbml0aWFsU3RhdGU6IGFueSkge1xuICAgICAgICB0aGlzLl9kZWZhdWx0U3RvcmVJbnN0YW5jZUlkID0gdGhpcy5fZ2V0Q2xhc3NOYW1lKCk7XG4gICAgICAgIHRoaXMuc3RhdGUkID0gbmV3IEJlaGF2aW9yU3ViamVjdDxUPihpbml0aWFsU3RhdGUpO1xuICAgICAgICB0aGlzLmluaXRpYWxTdGF0ZUNhY2hlID0geyAuLi5pbml0aWFsU3RhdGUgfTtcbiAgICAgICAgaWYgKHRoaXMucmVkdXhUb29sRW5hYmxlZCkge1xuICAgICAgICAgICAgY29uc3Qgcm9vdFN0b3JlOiBSb290U3RvcmUgPSBnZXRTaW5nbGV0b25Sb290U3RvcmUoKTtcbiAgICAgICAgICAgIEFjdGlvblN0YXRlLmNoYW5nZUFjdGlvbihgQWRkLSR7dGhpcy5fZGVmYXVsdFN0b3JlSW5zdGFuY2VJZH1gKTtcbiAgICAgICAgICAgIHJvb3RTdG9yZS5yZWdpc3RlclN0b3JlKHRoaXMpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgZ2V0IHNuYXBzaG90KCkge1xuICAgICAgICByZXR1cm4gdGhpcy5zdGF0ZSQuZ2V0VmFsdWUoKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZGlzcGF0Y2godHlwZTogc3RyaW5nLCBwYXlsb2FkPzogYW55KTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgQWN0aW9uU3RhdGUuY2hhbmdlQWN0aW9uKGAke3RoaXMuX2RlZmF1bHRTdG9yZUluc3RhbmNlSWR9LSR7dHlwZX1gKTtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gdGhpcy5fZGlzcGF0Y2goe1xuICAgICAgICAgICAgdHlwZTogdHlwZSxcbiAgICAgICAgICAgIHBheWxvYWQ6IHBheWxvYWRcbiAgICAgICAgfSk7XG4gICAgICAgIHJlc3VsdC5zdWJzY3JpYmUoKTtcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9kaXNwYXRjaChhY3Rpb246IGFueSk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgICAgIGNvbnN0IG1ldGEgPSB0aGlzW01FVEFfS0VZXSBhcyBTdG9yZU1ldGFJbmZvO1xuICAgICAgICBpZiAoIW1ldGEpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgJHtNRVRBX0tFWX0gaXMgbm90IGZvdW5kLCBjdXJyZW50IHN0b3JlIGhhcyBub3QgYWN0aW9uYCk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgYWN0aW9uTWV0YSA9IG1ldGEuYWN0aW9uc1thY3Rpb24udHlwZV07XG4gICAgICAgIGlmICghYWN0aW9uTWV0YSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGAke2FjdGlvbi50eXBlfSBpcyBub3QgZm91bmRgKTtcbiAgICAgICAgfVxuICAgICAgICAvLyBsZXQgcmVzdWx0OiBhbnkgPSB0aGlzW2FjdGlvbk1ldGEuZm5dKHRoaXMuc25hcHNob3QsIGFjdGlvbi5wYXlsb2FkKTtcbiAgICAgICAgbGV0IHJlc3VsdDogYW55ID0gYWN0aW9uTWV0YS5vcmlnaW5hbEZuLmNhbGwodGhpcywgdGhpcy5zbmFwc2hvdCwgYWN0aW9uLnBheWxvYWQpO1xuXG4gICAgICAgIGlmIChyZXN1bHQgaW5zdGFuY2VvZiBQcm9taXNlKSB7XG4gICAgICAgICAgICByZXN1bHQgPSBmcm9tKHJlc3VsdCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAocmVzdWx0IGluc3RhbmNlb2YgT2JzZXJ2YWJsZSkge1xuICAgICAgICAgICAgcmVzdWx0ID0gcmVzdWx0LnBpcGUobWFwKHIgPT4gcikpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVzdWx0ID0gbmV3IE9ic2VydmFibGUoKG9ic2VydmVyOiBPYnNlcnZlcjxhbnk+KSA9PiB7XG4gICAgICAgICAgICAgICAgb2JzZXJ2ZXIubmV4dCh7fSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzdWx0LnBpcGUoc2hhcmVSZXBsYXkoKSk7XG4gICAgfVxuXG4gICAgc2VsZWN0PFRSZXN1bHQ+KHNlbGVjdG9yOiAoc3RhdGU6IFQpID0+IFRSZXN1bHQpOiBPYnNlcnZhYmxlPFRSZXN1bHQ+IHwgT2JzZXJ2YWJsZTxUUmVzdWx0PjtcbiAgICBzZWxlY3Qoc2VsZWN0b3I6IHN0cmluZyB8IGFueSk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgICAgIHJldHVybiB0aGlzLnN0YXRlJC5waXBlKG1hcChzZWxlY3RvciksIGRpc3RpbmN0VW50aWxDaGFuZ2VkKCkpO1xuICAgIH1cblxuICAgIG5leHQoc3RhdGU6IFQpIHtcbiAgICAgICAgdGhpcy5zdGF0ZSQubmV4dChzdGF0ZSk7XG4gICAgfVxuXG4gICAgZXJyb3IoZXJyb3I6IGFueSkge1xuICAgICAgICB0aGlzLnN0YXRlJC5lcnJvcihlcnJvcik7XG4gICAgfVxuXG4gICAgY29tcGxldGUoKSB7XG4gICAgICAgIHRoaXMuc3RhdGUkLmNvbXBsZXRlKCk7XG4gICAgfVxuXG4gICAgc3Vic2NyaWJlKG5leHQ/OiAodmFsdWU6IFQpID0+IHZvaWQsIGVycm9yPzogKGVycm9yOiBhbnkpID0+IHZvaWQsIGNvbXBsZXRlPzogKCkgPT4gdm9pZCk6IFN1YnNjcmlwdGlvbiB7XG4gICAgICAgIHJldHVybiB0aGlzLnN0YXRlJC5zdWJzY3JpYmUobmV4dCwgZXJyb3IsIGNvbXBsZXRlKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBzZXQgc3RvcmUgbmV3IHN0YXRlXG4gICAgICpcbiAgICAgKiBAZXhhbXBsZVxuICAgICAqIHRoaXMuc2V0U3RhdGUobmV3U3RhdGUpO1xuICAgICAqIHRoaXMuc2V0U3RhdGUoeyB1c2VyczogcHJvZHVjZSh0aGlzLnNuYXBzaG90LnVzZXJzKS5hZGQodXNlcikgfSk7XG4gICAgICogdGhpcy5zZXRTdGF0ZSgoc3RhdGUpID0+IHtcbiAgICAgKiAgICByZXR1cm4ge1xuICAgICAqICAgICAgICB1c2VyczogcHJvZHVjZShzdGF0ZS51c2VycykuYWRkKHVzZXIpXG4gICAgICogICAgfVxuICAgICAqIH0pO1xuICAgICAqIEBwYXJhbSBmblxuICAgICAqL1xuICAgIHNldFN0YXRlKGZuOiBQYXJ0aWFsPFQ+IHwgKChuZXdTdGF0ZTogVCkgPT4gUGFydGlhbDxUPikpOiB2b2lkIHtcbiAgICAgICAgaWYgKGhlbHBlcnMuaXNGdW5jdGlvbihmbikpIHtcbiAgICAgICAgICAgIHRoaXMubmV4dCh7XG4gICAgICAgICAgICAgICAgLi4udGhpcy5zbmFwc2hvdCxcbiAgICAgICAgICAgICAgICAuLi4oZm4gYXMgYW55KSh0aGlzLnNuYXBzaG90KVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLm5leHQoe1xuICAgICAgICAgICAgICAgIC4uLnRoaXMuc25hcHNob3QsXG4gICAgICAgICAgICAgICAgLi4uKGZuIGFzIFQpXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGdldFN0YXRlKCk6IFQge1xuICAgICAgICByZXR1cm4gdGhpcy5zbmFwc2hvdDtcbiAgICB9XG5cbiAgICBAQWN0aW9uKClcbiAgICBjbGVhclN0YXRlKCkge1xuICAgICAgICB0aGlzLnNldFN0YXRlKHRoaXMuaW5pdGlhbFN0YXRlQ2FjaGUpO1xuICAgIH1cblxuICAgIG5nT25EZXN0cm95KCkge1xuICAgICAgICBpZiAodGhpcy5yZWR1eFRvb2xFbmFibGVkKSB7XG4gICAgICAgICAgICBjb25zdCByb290U3RvcmU6IFJvb3RTdG9yZSA9IGdldFNpbmdsZXRvblJvb3RTdG9yZSgpO1xuICAgICAgICAgICAgcm9vdFN0b3JlLnVucmVnaXN0ZXJTdG9yZSh0aGlzKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFlvdSBjYW4gb3ZlcnJpZGUgdGhpcyBtZXRob2QgaWYgeW91IHdhbnQgdG8gZ2l2ZSB5b3VyIGNvbnRhaW5lciBpbnN0YW5jZSBhIGN1c3RvbSBpZC5cbiAgICAgKiBUaGUgcmV0dXJuZWQgaWQgbXVzdCBiZSB1bmlxdWUgaW4gdGhlIGFwcGxpY2F0aW9uLlxuICAgICAqL1xuICAgIGdldFN0b3JlSW5zdGFuY2VJZCgpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy5fZGVmYXVsdFN0b3JlSW5zdGFuY2VJZDtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9nZXRDbGFzc05hbWUoKTogc3RyaW5nIHtcbiAgICAgICAgY29uc3QgbmFtZSA9IHRoaXMuY29uc3RydWN0b3IubmFtZSB8fCAvZnVuY3Rpb24gKC4rKVxcKC8uZXhlYyh0aGlzLmNvbnN0cnVjdG9yICsgJycpWzFdO1xuICAgICAgICBpZiAodGhpcy5yZWR1eFRvb2xFbmFibGVkKSB7XG4gICAgICAgICAgICBjb25zdCByb290U3RvcmU6IFJvb3RTdG9yZSA9IGdldFNpbmdsZXRvblJvb3RTdG9yZSgpO1xuICAgICAgICAgICAgaWYgKCFyb290U3RvcmUuZXhpc3RTdG9yZUluc3RhbmNlSWQobmFtZSkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gbmFtZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGxldCBqID0gMDtcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAxOyBpIDwgMjA7IGkrKykge1xuICAgICAgICAgICAgICAgIGlmICghcm9vdFN0b3JlLmV4aXN0U3RvcmVJbnN0YW5jZUlkKGAke25hbWV9LSR7aX1gKSkge1xuICAgICAgICAgICAgICAgICAgICBqID0gaTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGAke25hbWV9LSR7an1gO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBuYW1lO1xuICAgIH1cbn1cbiJdfQ==