import { Store } from './store';
import { helpers, produce } from 'ngx-tethys/util';
import { mergeReferences, buildReferencesKeyBy } from 'ngx-tethys/util';
import { map } from 'rxjs/operators';
export class EntityStore extends Store {
    constructor(initialState = {
        entities: []
    }, options = { idKey: '_id' }) {
        super(initialState);
        this.entities$ = this.select(state => {
            return state.entities;
        });
        this.entitiesWithRefs$ = this.entities$.pipe(map(entities => {
            if (!entities) {
                return entities;
            }
            return entities.map(entity => {
                const newEntity = Object.assign({}, entity);
                if (this['onCombineRefs']) {
                    if (!newEntity['refs']) {
                        newEntity['refs'] = {};
                    }
                    this['onCombineRefs'](newEntity, this.internalReferencesIdMap, this.snapshot.references);
                }
                else {
                    throw new Error(`onCombineRefs is not empty`);
                }
                return newEntity;
            });
        }));
        this.trackBy = (_index, entity) => {
            return entity[this.options.idKey];
        };
        this.options = Object.assign({ idKey: '_id' }, options);
        if (!this.options.idKey) {
            throw new Error(`idKey is required in EntityStore`);
        }
        this.buildReferencesIdMap();
    }
    get entities() {
        return this.snapshot.entities;
    }
    resetPagination(pagination, count) {
        pagination.count = count;
        // 向上取整 21 / 20 = 1.05 = 2 pageCount is 2
        const pageCount = Math.ceil(pagination.count / pagination.pageSize);
        pagination.pageCount = pageCount;
        this.snapshot.pagination = Object.assign({}, pagination);
    }
    increasePagination(amount) {
        const pagination = this.snapshot.pagination;
        this.resetPagination(pagination, pagination.count + amount);
    }
    decreasePagination(amount) {
        const pagination = this.snapshot.pagination;
        if (pagination) {
            this.resetPagination(pagination, pagination.count - amount);
        }
    }
    buildReferencesIdMap() {
        if (this.snapshot.references) {
            this.internalReferencesIdMap = buildReferencesKeyBy(this.snapshot.references, this.options.referencesIdKeys);
        }
    }
    /**
     *
     * Replace current collection with provided collection
     *
     * @example
     * this.store.initialize([Entity, Entity], pagination: PaginationInfo);
     *
     */
    initialize(entities, pagination) {
        const state = this.snapshot;
        state.entities = entities || [];
        state.pagination = pagination;
        this.next(state);
    }
    /**
     *
     * Replace current collection with provided collection with references
     *
     * @example
     * this.store.initializeWithReferences([Entity, Entity], references: TReferences, pagination: PaginationInfo);
     *
     */
    initializeWithReferences(entities, references, pagination) {
        const state = this.snapshot;
        state.entities = entities || [];
        state.pagination = pagination;
        state.references = references;
        this.buildReferencesIdMap();
        this.next(state);
    }
    /**
     * Add entity or entities for internal
     * @param entity
     * @param references
     * @param addOptions
     */
    addInternal(entity, references, addOptions) {
        const addEntities = helpers.coerceArray(entity);
        if (addEntities.length === 0) {
            return;
        }
        const state = this.snapshot;
        state.entities = produce(state.entities).add(addEntities, addOptions);
        if (state.references) {
            mergeReferences(state.references, references, this.options.referencesIdKeys);
            this.buildReferencesIdMap();
        }
        if (state.pagination) {
            this.increasePagination(addEntities.length);
            if (addOptions && !addOptions.prepend && addOptions.autoGotoLastPage) {
                state.pagination.pageIndex = state.pagination.pageCount;
            }
        }
        this.next(state);
    }
    /**
     * Add an entity or entities to the store.
     *
     * @example
     * this.store.add(Entity);
     * this.store.add([Entity, Entity]);
     * this.store.add(Entity, { prepend: true });
     */
    add(entity, addOptions) {
        this.addInternal(entity, undefined, addOptions);
    }
    /**
     * Add an entity or entities to the store with references.
     *
     * @example
     * this.store.add(Entity);
     * this.store.add([Entity, Entity]);
     * this.store.add(Entity, { prepend: true });
     */
    addWithReferences(entity, references, addOptions) {
        this.addInternal(entity, references, addOptions);
    }
    /**
     *
     * Update an entity or entities in the store.
     *
     * @example
     * this.store.update(3, {
     *   name: 'New Name'
     * }, references);
     *
     *  this.store.update(3, entity => {
     *    return {
     *      ...entity,
     *      name: 'New Name'
     *    }
     *  }, references);
     *
     * this.store.update([1,2,3], {
     *   name: 'New Name'
     * }, references);
     */
    updateInternal(idsOrFn, 
    // | Partial<TState>
    // | ((state: Readonly<TState>) => Partial<TState>)
    // | ((entity: Readonly<TEntity>) => boolean),
    newStateOrFn, references) {
        const ids = helpers.coerceArray(idsOrFn);
        const state = this.snapshot;
        for (let i = 0; i < state.entities.length; i++) {
            const oldEntity = state.entities[i];
            if (ids.indexOf(oldEntity[this.options.idKey]) > -1) {
                const newState = helpers.isFunction(newStateOrFn) ? newStateOrFn(oldEntity) : newStateOrFn;
                state.entities[i] = Object.assign(Object.assign({}, oldEntity), newState);
            }
        }
        state.entities = [...state.entities];
        if (state.references) {
            mergeReferences(state.references, references, this.options.referencesIdKeys);
            this.buildReferencesIdMap();
        }
        this.next(state);
    }
    /**
     *
     * Update an entity or entities in the store with references.
     *
     * @example
     * this.store.update(3, {
     *   name: 'New Name'
     * }, references);
     *
     *  this.store.update(3, entity => {
     *    return {
     *      ...entity,
     *      name: 'New Name'
     *    }
     *  }, references);
     *
     * this.store.update([1,2,3], {
     *   name: 'New Name'
     * }, references);
     */
    update(idsOrFn, newStateOrFn) {
        this.updateInternal(idsOrFn, newStateOrFn, undefined);
    }
    /**
     *
     * Update an entity or entities in the store with references.
     *
     * @example
     * this.store.updateWithReferences(3, {
     *   name: 'New Name'
     * }, references);
     *
     *  this.store.updateWithReferences(3, entity => {
     *    return {
     *      ...entity,
     *      name: 'New Name'
     *    }
     *  }, references);
     *
     * this.store.updateWithReferences([1,2,3], {
     *   name: 'New Name'
     * }, references);
     */
    updateWithReferences(idsOrFn, newStateOrFn, references) {
        this.updateInternal(idsOrFn, newStateOrFn, references);
    }
    remove(idsOrFn) {
        const state = this.snapshot;
        const originalLength = state.entities.length;
        state.entities = produce(state.entities, this.options).remove(idsOrFn);
        this.decreasePagination(originalLength - state.entities.length);
        this.next(state);
    }
    clearPagination() {
        const state = this.snapshot;
        state.pagination = null;
        this.next(state);
    }
    clear() {
        const state = this.snapshot;
        state.entities = [];
        state.pagination = null;
        state.references = null;
        this.next(state);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW50aXR5LXN0b3JlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL3N0b3JlL2VudGl0eS1zdG9yZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBRWhDLE9BQU8sRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDbkQsT0FBTyxFQUFFLGVBQWUsRUFBRSxvQkFBb0IsRUFBa0MsTUFBTSxpQkFBaUIsQ0FBQztBQUN4RyxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFvQnJDLE1BQU0sT0FBTyxXQUE4RixTQUFRLEtBQWE7SUE0RDVILFlBQ0ksZUFBa0Q7UUFDOUMsUUFBUSxFQUFFLEVBQWU7S0FDNUIsRUFDRCxVQUFvRCxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUU7UUFFcEUsS0FBSyxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBekR4QixjQUFTLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsRUFBRTtZQUM1QixPQUFPLEtBQUssQ0FBQyxRQUFRLENBQUM7UUFDMUIsQ0FBQyxDQUFDLENBQUM7UUFFSCxzQkFBaUIsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FDbkMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxFQUFFO1lBQ1gsSUFBSSxDQUFDLFFBQVEsRUFBRTtnQkFDWCxPQUFPLFFBQVEsQ0FBQzthQUNuQjtZQUNELE9BQU8sUUFBUSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsRUFBRTtnQkFDekIsTUFBTSxTQUFTLHFCQUFRLE1BQU0sQ0FBRSxDQUFDO2dCQUVoQyxJQUFJLElBQUksQ0FBQyxlQUFlLENBQUMsRUFBRTtvQkFDdkIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsRUFBRTt3QkFDcEIsU0FBUyxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsQ0FBQztxQkFD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O1FBQzVCLEtBQUssQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDO1FBQ3hCLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDckIsQ0FBQztJQUVELEtBQUs7UUFDRCxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDO1FBQzVCLEtBQUssQ0FBQyxRQUFRLEdBQUcsRUFBRSxDQUFDO1FBQ3BCLEtBQUssQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDO1FBQ3hCLEtBQUssQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDO1FBQ3hCLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDckIsQ0FBQztDQUNKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU3RvcmUgfSBmcm9tICcuL3N0b3JlJztcbmltcG9ydCB7IElkLCBQYWdpbmF0aW9uSW5mbyB9IGZyb20gJ25neC10ZXRoeXMvdHlwZXMnO1xuaW1wb3J0IHsgaGVscGVycywgcHJvZHVjZSB9IGZyb20gJ25neC10ZXRoeXMvdXRpbCc7XG5pbXBvcnQgeyBtZXJnZVJlZmVyZW5jZXMsIGJ1aWxkUmVmZXJlbmNlc0tleUJ5LCBSZWZlcmVuY2VBcnJheUV4dHJhY3RBbGxvd0tleXMgfSBmcm9tICduZ3gtdGV0aHlzL3V0aWwnO1xuaW1wb3J0IHsgbWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgUmVmZXJlbmNlc0lkRGljdGlvbmFyeSwgT25Db21iaW5lUmVmc0ZuIH0gZnJvbSAnLi9yZWZlcmVuY2VzJztcblxuZXhwb3J0IGludGVyZmFjZSBFbnRpdHlTdG9yZU9wdGlvbnM8VEVudGl0eSA9IHVua25vd24sIFRSZWZlcmVuY2VzID0gdW5rbm93bj4ge1xuICAgIGlkS2V5Pzogc3RyaW5nO1xuICAgIHJlZmVyZW5jZXNJZEtleXM/OiBSZWZlcmVuY2VBcnJheUV4dHJhY3RBbGxvd0tleXM8VFJlZmVyZW5jZXM+O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEVudGl0eUFkZE9wdGlvbnMge1xuICAgIHByZXBlbmQ/OiBib29sZWFuO1xuICAgIC8vIOWmguaenOaYr+acgOWQjui/veWKoO+8jOiHquWKqOi3s+i9rOWIsOacgOWQjuS4gOmhtVxuICAgIGF1dG9Hb3RvTGFzdFBhZ2U/OiBib29sZWFuO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEVudGl0eVN0YXRlPFRFbnRpdHksIFRSZWZlcmVuY2VzID0gdW5rbm93bj4ge1xuICAgIHBhZ2luYXRpb24/OiBQYWdpbmF0aW9uSW5mbztcbiAgICBlbnRpdGllczogVEVudGl0eVtdO1xuICAgIHJlZmVyZW5jZXM/OiBUUmVmZXJlbmNlcztcbn1cblxuZXhwb3J0IGNsYXNzIEVudGl0eVN0b3JlPFRTdGF0ZSBleHRlbmRzIEVudGl0eVN0YXRlPFRFbnRpdHksIFRSZWZlcmVuY2VzPiwgVEVudGl0eSwgVFJlZmVyZW5jZXMgPSB1bmtub3duPiBleHRlbmRzIFN0b3JlPFRTdGF0ZT4ge1xuICAgIHByb3RlY3RlZCBvcHRpb25zOiBFbnRpdHlTdG9yZU9wdGlvbnM8VEVudGl0eSwgVFJlZmVyZW5jZXM+O1xuXG4gICAgcHJpdmF0ZSBpbnRlcm5hbFJlZmVyZW5jZXNJZE1hcDogUmVmZXJlbmNlc0lkRGljdGlvbmFyeTxUUmVmZXJlbmNlcz47XG5cbiAgICBnZXQgZW50aXRpZXMoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnNuYXBzaG90LmVudGl0aWVzO1xuICAgIH1cblxuICAgIGVudGl0aWVzJCA9IHRoaXMuc2VsZWN0KHN0YXRlID0+IHtcbiAgICAgICAgcmV0dXJuIHN0YXRlLmVudGl0aWVzO1xuICAgIH0pO1xuXG4gICAgZW50aXRpZXNXaXRoUmVmcyQgPSB0aGlzLmVudGl0aWVzJC5waXBlKFxuICAgICAgICBtYXAoZW50aXRpZXMgPT4ge1xuICAgICAgICAgICAgaWYgKCFlbnRpdGllcykge1xuICAgICAgICAgICAgICAgIHJldHVybiBlbnRpdGllcztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBlbnRpdGllcy5tYXAoZW50aXR5ID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBuZXdFbnRpdHkgPSB7IC4uLmVudGl0eSB9O1xuXG4gICAgICAgICAgICAgICAgaWYgKHRoaXNbJ29uQ29tYmluZVJlZnMnXSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIW5ld0VudGl0eVsncmVmcyddKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBuZXdFbnRpdHlbJ3JlZnMnXSA9IHt9O1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHRoaXNbJ29uQ29tYmluZVJlZnMnXShuZXdFbnRpdHksIHRoaXMuaW50ZXJuYWxSZWZlcmVuY2VzSWRNYXAsIHRoaXMuc25hcHNob3QucmVmZXJlbmNlcyk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBvbkNvbWJpbmVSZWZzIGlzIG5vdCBlbXB0eWApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gbmV3RW50aXR5O1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pXG4gICAgKTtcblxuICAgIHByaXZhdGUgcmVzZXRQYWdpbmF0aW9uKHBhZ2luYXRpb246IFBhZ2luYXRpb25JbmZvLCBjb3VudDogbnVtYmVyKSB7XG4gICAgICAgIHBhZ2luYXRpb24uY291bnQgPSBjb3VudDtcbiAgICAgICAgLy8g5ZCR5LiK5Y+W5pW0IDIxIC8gMjAgPSAxLjA1ID0gMiBwYWdlQ291bnQgaXMgMlxuICAgICAgICBjb25zdCBwYWdlQ291bnQgPSBNYXRoLmNlaWwocGFnaW5hdGlvbi5jb3VudCAvIHBhZ2luYXRpb24ucGFnZVNpemUpO1xuICAgICAgICBwYWdpbmF0aW9uLnBhZ2VDb3VudCA9IHBhZ2VDb3VudDtcbiAgICAgICAgdGhpcy5zbmFwc2hvdC5wYWdpbmF0aW9uID0geyAuLi5wYWdpbmF0aW9uIH07XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBpbmNyZWFzZVBhZ2luYXRpb24oYW1vdW50OiBudW1iZXIpIHtcbiAgICAgICAgY29uc3QgcGFnaW5hdGlvbiA9IHRoaXMuc25hcHNob3QucGFnaW5hdGlvbjtcbiAgICAgICAgdGhpcy5yZXNldFBhZ2luYXRpb24ocGFnaW5hdGlvbiwgcGFnaW5hdGlvbi5jb3VudCArIGFtb3VudCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBkZWNyZWFzZVBhZ2luYXRpb24oYW1vdW50OiBudW1iZXIpIHtcbiAgICAgICAgY29uc3QgcGFnaW5hdGlvbiA9IHRoaXMuc25hcHNob3QucGFnaW5hdGlvbjtcbiAgICAgICAgaWYgKHBhZ2luYXRpb24pIHtcbiAgICAgICAgICAgIHRoaXMucmVzZXRQYWdpbmF0aW9uKHBhZ2luYXRpb24sIHBhZ2luYXRpb24uY291bnQgLSBhbW91bnQpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBidWlsZFJlZmVyZW5jZXNJZE1hcCgpIHtcbiAgICAgICAgaWYgKHRoaXMuc25hcHNob3QucmVmZXJlbmNlcykge1xuICAgICAgICAgICAgdGhpcy5pbnRlcm5hbFJlZmVyZW5jZXNJZE1hcCA9IGJ1aWxkUmVmZXJlbmNlc0tleUJ5KHRoaXMuc25hcHNob3QucmVmZXJlbmNlcywgdGhpcy5vcHRpb25zLnJlZmVyZW5jZXNJZEtleXMpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIGluaXRpYWxTdGF0ZTogRW50aXR5U3RhdGU8VEVudGl0eSwgVFJlZmVyZW5jZXM+ID0ge1xuICAgICAgICAgICAgZW50aXRpZXM6IFtdIGFzIFRFbnRpdHlbXVxuICAgICAgICB9LFxuICAgICAgICBvcHRpb25zOiBFbnRpdHlTdG9yZU9wdGlvbnM8VEVudGl0eSwgVFJlZmVyZW5jZXM+ID0geyBpZEtleTogJ19pZCcgfVxuICAgICkge1xuICAgICAgICBzdXBlcihpbml0aWFsU3RhdGUpO1xuICAgICAgICB0aGlzLm9wdGlvbnMgPSB7IGlkS2V5OiAnX2lkJywgLi4ub3B0aW9ucyB9O1xuICAgICAgICBpZiAoIXRoaXMub3B0aW9ucy5pZEtleSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBpZEtleSBpcyByZXF1aXJlZCBpbiBFbnRpdHlTdG9yZWApO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuYnVpbGRSZWZlcmVuY2VzSWRNYXAoKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqIFJlcGxhY2UgY3VycmVudCBjb2xsZWN0aW9uIHdpdGggcHJvdmlkZWQgY29sbGVjdGlvblxuICAgICAqXG4gICAgICogQGV4YW1wbGVcbiAgICAgKiB0aGlzLnN0b3JlLmluaXRpYWxpemUoW0VudGl0eSwgRW50aXR5XSwgcGFnaW5hdGlvbjogUGFnaW5hdGlvbkluZm8pO1xuICAgICAqXG4gICAgICovXG4gICAgaW5pdGlhbGl6ZShlbnRpdGllczogVEVudGl0eVtdLCBwYWdpbmF0aW9uPzogUGFnaW5hdGlvbkluZm8pIHtcbiAgICAgICAgY29uc3Qgc3RhdGUgPSB0aGlzLnNuYXBzaG90O1xuICAgICAgICBzdGF0ZS5lbnRpdGllcyA9IGVudGl0aWVzIHx8IFtdO1xuICAgICAgICBzdGF0ZS5wYWdpbmF0aW9uID0gcGFnaW5hdGlvbjtcbiAgICAgICAgdGhpcy5uZXh0KHN0YXRlKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqIFJlcGxhY2UgY3VycmVudCBjb2xsZWN0aW9uIHdpdGggcHJvdmlkZWQgY29sbGVjdGlvbiB3aXRoIHJlZmVyZW5jZXNcbiAgICAgKlxuICAgICAqIEBleGFtcGxlXG4gICAgICogdGhpcy5zdG9yZS5pbml0aWFsaXplV2l0aFJlZmVyZW5jZXMoW0VudGl0eSwgRW50aXR5XSwgcmVmZXJlbmNlczogVFJlZmVyZW5jZXMsIHBhZ2luYXRpb246IFBhZ2luYXRpb25JbmZvKTtcbiAgICAgKlxuICAgICAqL1xuICAgIGluaXRpYWxpemVXaXRoUmVmZXJlbmNlcyhlbnRpdGllczogVEVudGl0eVtdLCByZWZlcmVuY2VzOiBUUmVmZXJlbmNlcywgcGFnaW5hdGlvbj86IFBhZ2luYXRpb25JbmZvKSB7XG4gICAgICAgIGNvbnN0IHN0YXRlID0gdGhpcy5zbmFwc2hvdDtcbiAgICAgICAgc3RhdGUuZW50aXRpZXMgPSBlbnRpdGllcyB8fCBbXTtcbiAgICAgICAgc3RhdGUucGFnaW5hdGlvbiA9IHBhZ2luYXRpb247XG4gICAgICAgIHN0YXRlLnJlZmVyZW5jZXMgPSByZWZlcmVuY2VzO1xuICAgICAgICB0aGlzLmJ1aWxkUmVmZXJlbmNlc0lkTWFwKCk7XG4gICAgICAgIHRoaXMubmV4dChzdGF0ZSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQWRkIGVudGl0eSBvciBlbnRpdGllcyBmb3IgaW50ZXJuYWxcbiAgICAgKiBAcGFyYW0gZW50aXR5XG4gICAgICogQHBhcmFtIHJlZmVyZW5jZXNcbiAgICAgKiBAcGFyYW0gYWRkT3B0aW9uc1xuICAgICAqL1xuICAgIHByaXZhdGUgYWRkSW50ZXJuYWwoZW50aXR5OiBURW50aXR5IHwgVEVudGl0eVtdLCByZWZlcmVuY2VzPzogUGFydGlhbDxUUmVmZXJlbmNlcz4sIGFkZE9wdGlvbnM/OiBFbnRpdHlBZGRPcHRpb25zKSB7XG4gICAgICAgIGNvbnN0IGFkZEVudGl0aWVzID0gaGVscGVycy5jb2VyY2VBcnJheShlbnRpdHkpO1xuICAgICAgICBpZiAoYWRkRW50aXRpZXMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBzdGF0ZSA9IHRoaXMuc25hcHNob3Q7XG4gICAgICAgIHN0YXRlLmVudGl0aWVzID0gcHJvZHVjZShzdGF0ZS5lbnRpdGllcykuYWRkKGFkZEVudGl0aWVzLCBhZGRPcHRpb25zKTtcbiAgICAgICAgaWYgKHN0YXRlLnJlZmVyZW5jZXMpIHtcbiAgICAgICAgICAgIG1lcmdlUmVmZXJlbmNlcyhzdGF0ZS5yZWZlcmVuY2VzLCByZWZlcmVuY2VzLCB0aGlzLm9wdGlvbnMucmVmZXJlbmNlc0lkS2V5cyk7XG4gICAgICAgICAgICB0aGlzLmJ1aWxkUmVmZXJlbmNlc0lkTWFwKCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHN0YXRlLnBhZ2luYXRpb24pIHtcbiAgICAgICAgICAgIHRoaXMuaW5jcmVhc2VQYWdpbmF0aW9uKGFkZEVudGl0aWVzLmxlbmd0aCk7XG4gICAgICAgICAgICBpZiAoYWRkT3B0aW9ucyAmJiAhYWRkT3B0aW9ucy5wcmVwZW5kICYmIGFkZE9wdGlvbnMuYXV0b0dvdG9MYXN0UGFnZSkge1xuICAgICAgICAgICAgICAgIHN0YXRlLnBhZ2luYXRpb24ucGFnZUluZGV4ID0gc3RhdGUucGFnaW5hdGlvbi5wYWdlQ291bnQ7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5uZXh0KHN0YXRlKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGQgYW4gZW50aXR5IG9yIGVudGl0aWVzIHRvIHRoZSBzdG9yZS5cbiAgICAgKlxuICAgICAqIEBleGFtcGxlXG4gICAgICogdGhpcy5zdG9yZS5hZGQoRW50aXR5KTtcbiAgICAgKiB0aGlzLnN0b3JlLmFkZChbRW50aXR5LCBFbnRpdHldKTtcbiAgICAgKiB0aGlzLnN0b3JlLmFkZChFbnRpdHksIHsgcHJlcGVuZDogdHJ1ZSB9KTtcbiAgICAgKi9cbiAgICBhZGQoZW50aXR5OiBURW50aXR5IHwgVEVudGl0eVtdLCBhZGRPcHRpb25zPzogRW50aXR5QWRkT3B0aW9ucykge1xuICAgICAgICB0aGlzLmFkZEludGVybmFsKGVudGl0eSwgdW5kZWZpbmVkLCBhZGRPcHRpb25zKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGQgYW4gZW50aXR5IG9yIGVudGl0aWVzIHRvIHRoZSBzdG9yZSB3aXRoIHJlZmVyZW5jZXMuXG4gICAgICpcbiAgICAgKiBAZXhhbXBsZVxuICAgICAqIHRoaXMuc3RvcmUuYWRkKEVudGl0eSk7XG4gICAgICogdGhpcy5zdG9yZS5hZGQoW0VudGl0eSwgRW50aXR5XSk7XG4gICAgICogdGhpcy5zdG9yZS5hZGQoRW50aXR5LCB7IHByZXBlbmQ6IHRydWUgfSk7XG4gICAgICovXG4gICAgYWRkV2l0aFJlZmVyZW5jZXMoZW50aXR5OiBURW50aXR5IHwgVEVudGl0eVtdLCByZWZlcmVuY2VzOiBQYXJ0aWFsPFRSZWZlcmVuY2VzPiwgYWRkT3B0aW9ucz86IEVudGl0eUFkZE9wdGlvbnMpIHtcbiAgICAgICAgdGhpcy5hZGRJbnRlcm5hbChlbnRpdHksIHJlZmVyZW5jZXMsIGFkZE9wdGlvbnMpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqXG4gICAgICogVXBkYXRlIGFuIGVudGl0eSBvciBlbnRpdGllcyBpbiB0aGUgc3RvcmUuXG4gICAgICpcbiAgICAgKiBAZXhhbXBsZVxuICAgICAqIHRoaXMuc3RvcmUudXBkYXRlKDMsIHtcbiAgICAgKiAgIG5hbWU6ICdOZXcgTmFtZSdcbiAgICAgKiB9LCByZWZlcmVuY2VzKTtcbiAgICAgKlxuICAgICAqICB0aGlzLnN0b3JlLnVwZGF0ZSgzLCBlbnRpdHkgPT4ge1xuICAgICAqICAgIHJldHVybiB7XG4gICAgICogICAgICAuLi5lbnRpdHksXG4gICAgICogICAgICBuYW1lOiAnTmV3IE5hbWUnXG4gICAgICogICAgfVxuICAgICAqICB9LCByZWZlcmVuY2VzKTtcbiAgICAgKlxuICAgICAqIHRoaXMuc3RvcmUudXBkYXRlKFsxLDIsM10sIHtcbiAgICAgKiAgIG5hbWU6ICdOZXcgTmFtZSdcbiAgICAgKiB9LCByZWZlcmVuY2VzKTtcbiAgICAgKi9cbiAgICBwcml2YXRlIHVwZGF0ZUludGVybmFsKFxuICAgICAgICBpZHNPckZuOiBJZCB8IElkW10gfCBudWxsLFxuICAgICAgICAvLyB8IFBhcnRpYWw8VFN0YXRlPlxuICAgICAgICAvLyB8ICgoc3RhdGU6IFJlYWRvbmx5PFRTdGF0ZT4pID0+IFBhcnRpYWw8VFN0YXRlPilcbiAgICAgICAgLy8gfCAoKGVudGl0eTogUmVhZG9ubHk8VEVudGl0eT4pID0+IGJvb2xlYW4pLFxuICAgICAgICBuZXdTdGF0ZU9yRm46ICgoZW50aXR5OiBSZWFkb25seTxURW50aXR5PikgPT4gUGFydGlhbDxURW50aXR5PikgfCBQYXJ0aWFsPFRFbnRpdHk+LFxuICAgICAgICByZWZlcmVuY2VzPzogVFJlZmVyZW5jZXNcbiAgICApOiB2b2lkIHtcbiAgICAgICAgY29uc3QgaWRzID0gaGVscGVycy5jb2VyY2VBcnJheShpZHNPckZuKTtcblxuICAgICAgICBjb25zdCBzdGF0ZSA9IHRoaXMuc25hcHNob3Q7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc3RhdGUuZW50aXRpZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIGNvbnN0IG9sZEVudGl0eSA9IHN0YXRlLmVudGl0aWVzW2ldO1xuICAgICAgICAgICAgaWYgKGlkcy5pbmRleE9mKG9sZEVudGl0eVt0aGlzLm9wdGlvbnMuaWRLZXldKSA+IC0xKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgbmV3U3RhdGUgPSBoZWxwZXJzLmlzRnVuY3Rpb24obmV3U3RhdGVPckZuKSA/IChuZXdTdGF0ZU9yRm4gYXMgYW55KShvbGRFbnRpdHkpIDogbmV3U3RhdGVPckZuO1xuICAgICAgICAgICAgICAgIHN0YXRlLmVudGl0aWVzW2ldID0geyAuLi4ob2xkRW50aXR5IGFzIGFueSksIC4uLm5ld1N0YXRlIH07XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgc3RhdGUuZW50aXRpZXMgPSBbLi4uc3RhdGUuZW50aXRpZXNdO1xuICAgICAgICBpZiAoc3RhdGUucmVmZXJlbmNlcykge1xuICAgICAgICAgICAgbWVyZ2VSZWZlcmVuY2VzKHN0YXRlLnJlZmVyZW5jZXMsIHJlZmVyZW5jZXMsIHRoaXMub3B0aW9ucy5yZWZlcmVuY2VzSWRLZXlzKTtcbiAgICAgICAgICAgIHRoaXMuYnVpbGRSZWZlcmVuY2VzSWRNYXAoKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLm5leHQoc3RhdGUpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqXG4gICAgICogVXBkYXRlIGFuIGVudGl0eSBvciBlbnRpdGllcyBpbiB0aGUgc3RvcmUgd2l0aCByZWZlcmVuY2VzLlxuICAgICAqXG4gICAgICogQGV4YW1wbGVcbiAgICAgKiB0aGlzLnN0b3JlLnVwZGF0ZSgzLCB7XG4gICAgICogICBuYW1lOiAnTmV3IE5hbWUnXG4gICAgICogfSwgcmVmZXJlbmNlcyk7XG4gICAgICpcbiAgICAgKiAgdGhpcy5zdG9yZS51cGRhdGUoMywgZW50aXR5ID0+IHtcbiAgICAgKiAgICByZXR1cm4ge1xuICAgICAqICAgICAgLi4uZW50aXR5LFxuICAgICAqICAgICAgbmFtZTogJ05ldyBOYW1lJ1xuICAgICAqICAgIH1cbiAgICAgKiAgfSwgcmVmZXJlbmNlcyk7XG4gICAgICpcbiAgICAgKiB0aGlzLnN0b3JlLnVwZGF0ZShbMSwyLDNdLCB7XG4gICAgICogICBuYW1lOiAnTmV3IE5hbWUnXG4gICAgICogfSwgcmVmZXJlbmNlcyk7XG4gICAgICovXG4gICAgdXBkYXRlKGlkc09yRm46IElkIHwgSWRbXSB8IG51bGwsIG5ld1N0YXRlT3JGbjogKChlbnRpdHk6IFJlYWRvbmx5PFRFbnRpdHk+KSA9PiBQYXJ0aWFsPFRFbnRpdHk+KSB8IFBhcnRpYWw8VEVudGl0eT4pOiB2b2lkIHtcbiAgICAgICAgdGhpcy51cGRhdGVJbnRlcm5hbChpZHNPckZuLCBuZXdTdGF0ZU9yRm4sIHVuZGVmaW5lZCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICpcbiAgICAgKiBVcGRhdGUgYW4gZW50aXR5IG9yIGVudGl0aWVzIGluIHRoZSBzdG9yZSB3aXRoIHJlZmVyZW5jZXMuXG4gICAgICpcbiAgICAgKiBAZXhhbXBsZVxuICAgICAqIHRoaXMuc3RvcmUudXBkYXRlV2l0aFJlZmVyZW5jZXMoMywge1xuICAgICAqICAgbmFtZTogJ05ldyBOYW1lJ1xuICAgICAqIH0sIHJlZmVyZW5jZXMpO1xuICAgICAqXG4gICAgICogIHRoaXMuc3RvcmUudXBkYXRlV2l0aFJlZmVyZW5jZXMoMywgZW50aXR5ID0+IHtcbiAgICAgKiAgICByZXR1cm4ge1xuICAgICAqICAgICAgLi4uZW50aXR5LFxuICAgICAqICAgICAgbmFtZTogJ05ldyBOYW1lJ1xuICAgICAqICAgIH1cbiAgICAgKiAgfSwgcmVmZXJlbmNlcyk7XG4gICAgICpcbiAgICAgKiB0aGlzLnN0b3JlLnVwZGF0ZVdpdGhSZWZlcmVuY2VzKFsxLDIsM10sIHtcbiAgICAgKiAgIG5hbWU6ICdOZXcgTmFtZSdcbiAgICAgKiB9LCByZWZlcmVuY2VzKTtcbiAgICAgKi9cbiAgICB1cGRhdGVXaXRoUmVmZXJlbmNlcyhcbiAgICAgICAgaWRzT3JGbjogSWQgfCBJZFtdIHwgbnVsbCxcbiAgICAgICAgbmV3U3RhdGVPckZuOiAoKGVudGl0eTogUmVhZG9ubHk8VEVudGl0eT4pID0+IFBhcnRpYWw8VEVudGl0eT4pIHwgUGFydGlhbDxURW50aXR5PixcbiAgICAgICAgcmVmZXJlbmNlczogVFJlZmVyZW5jZXNcbiAgICApOiB2b2lkIHtcbiAgICAgICAgdGhpcy51cGRhdGVJbnRlcm5hbChpZHNPckZuLCBuZXdTdGF0ZU9yRm4sIHJlZmVyZW5jZXMpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqXG4gICAgICogUmVtb3ZlIG9uZSBvciBtb3JlIGVudGl0aWVzIGZyb20gdGhlIHN0b3JlOlxuICAgICAqXG4gICAgICogQGV4YW1wbGVcbiAgICAgKiB0aGlzLnN0b3JlLnJlbW92ZSg1KTtcbiAgICAgKiB0aGlzLnN0b3JlLnJlbW92ZShbMSwyLDNdKTtcbiAgICAgKiB0aGlzLnN0b3JlLnJlbW92ZShlbnRpdHkgPT4gZW50aXR5LmlkID09PSAxKTtcbiAgICAgKi9cbiAgICByZW1vdmUoaWQ6IElkIHwgSWRbXSk6IHZvaWQ7XG4gICAgcmVtb3ZlKHByZWRpY2F0ZTogKGVudGl0eTogUmVhZG9ubHk8VEVudGl0eT4pID0+IGJvb2xlYW4pOiB2b2lkO1xuICAgIHJlbW92ZShpZHNPckZuPzogSWQgfCBJZFtdIHwgKChlbnRpdHk6IFJlYWRvbmx5PFRFbnRpdHk+KSA9PiBib29sZWFuKSk6IHZvaWQge1xuICAgICAgICBjb25zdCBzdGF0ZSA9IHRoaXMuc25hcHNob3Q7XG4gICAgICAgIGNvbnN0IG9yaWdpbmFsTGVuZ3RoID0gc3RhdGUuZW50aXRpZXMubGVuZ3RoO1xuICAgICAgICBzdGF0ZS5lbnRpdGllcyA9IHByb2R1Y2Uoc3RhdGUuZW50aXRpZXMsIHRoaXMub3B0aW9ucykucmVtb3ZlKGlkc09yRm4pO1xuICAgICAgICB0aGlzLmRlY3JlYXNlUGFnaW5hdGlvbihvcmlnaW5hbExlbmd0aCAtIHN0YXRlLmVudGl0aWVzLmxlbmd0aCk7XG4gICAgICAgIHRoaXMubmV4dChzdGF0ZSk7XG4gICAgfVxuXG4gICAgdHJhY2tCeSA9IChfaW5kZXg6IG51bWJlciwgZW50aXR5OiBURW50aXR5KSA9PiB7XG4gICAgICAgIHJldHVybiBlbnRpdHlbdGhpcy5vcHRpb25zLmlkS2V5XTtcbiAgICB9O1xuXG4gICAgY2xlYXJQYWdpbmF0aW9uKCkge1xuICAgICAgICBjb25zdCBzdGF0ZSA9IHRoaXMuc25hcHNob3Q7XG4gICAgICAgIHN0YXRlLnBhZ2luYXRpb24gPSBudWxsO1xuICAgICAgICB0aGlzLm5leHQoc3RhdGUpO1xuICAgIH1cblxuICAgIGNsZWFyKCkge1xuICAgICAgICBjb25zdCBzdGF0ZSA9IHRoaXMuc25hcHNob3Q7XG4gICAgICAgIHN0YXRlLmVudGl0aWVzID0gW107XG4gICAgICAgIHN0YXRlLnBhZ2luYXRpb24gPSBudWxsO1xuICAgICAgICBzdGF0ZS5yZWZlcmVuY2VzID0gbnVsbDtcbiAgICAgICAgdGhpcy5uZXh0KHN0YXRlKTtcbiAgICB9XG59XG4iXX0=