import { __decorate, __metadata } from "tslib";
import { Observable, BehaviorSubject, from } from 'rxjs';
import { distinctUntilChanged, map, shareReplay } from 'rxjs/operators';
import { META_KEY } from './types';
import { helpers } from 'ngx-tethys/util';
import { getSingletonRootStore } from './root-store';
import { isDevMode, Injectable } from '@angular/core';
import { ActionState } from './action-state';
import { Action } from './action';
import * as ɵngcc0 from '@angular/core';
export class Store {
    constructor(initialState) {
        this.reduxToolEnabled = isDevMode();
        this._defaultStoreInstanceId = this._getClassName();
        this.state$ = new BehaviorSubject(initialState);
        this.initialStateCache = Object.assign({}, initialState);
        if (this.reduxToolEnabled) {
            const rootStore = getSingletonRootStore();
            ActionState.changeAction(`Add-${this._defaultStoreInstanceId}`);
            rootStore.registerStore(this);
        }
    }
    get snapshot() {
        return this.state$.getValue();
    }
    dispatch(type, payload) {
        ActionState.changeAction(`${this._defaultStoreInstanceId}-${type}`);
        const result = this._dispatch({
            type: type,
            payload: payload
        });
        result.subscribe();
        return result;
    }
    _dispatch(action) {
        const meta = this[META_KEY];
        if (!meta) {
            throw new Error(`${META_KEY} is not found, current store has not action`);
        }
        const actionMeta = meta.actions[action.type];
        if (!actionMeta) {
            throw new Error(`${action.type} is not found`);
        }
        // let result: any = this[actionMeta.fn](this.snapshot, action.payload);
        let result = actionMeta.originalFn.call(this, this.snapshot, action.payload);
        if (result instanceof Promise) {
            result = from(result);
        }
        if (result instanceof Observable) {
            result = result.pipe(map(r => r));
        }
        else {
            result = new Observable((observer) => {
                observer.next({});
            });
        }
        return result.pipe(shareReplay());
    }
    select(selector) {
        return this.state$.pipe(map(selector), distinctUntilChanged());
    }
    next(state) {
        this.state$.next(state);
    }
    error(error) {
        this.state$.error(error);
    }
    complete() {
        this.state$.complete();
    }
    subscribe(next, error, complete) {
        return this.state$.subscribe(next, error, complete);
    }
    /**
     * set store new state
     *
     * @example
     * this.setState(newState);
     * this.setState({ users: produce(this.snapshot.users).add(user) });
     * this.setState((state) => {
     *    return {
     *        users: produce(state.users).add(user)
     *    }
     * });
     * @param fn
     */
    setState(fn) {
        if (helpers.isFunction(fn)) {
            this.next(Object.assign(Object.assign({}, this.snapshot), fn(this.snapshot)));
        }
        else {
            this.next(Object.assign(Object.assign({}, this.snapshot), fn));
        }
    }
    getState() {
        return this.snapshot;
    }
    clearState() {
        this.setState(this.initialStateCache);
    }
    ngOnDestroy() {
        if (this.reduxToolEnabled) {
            const rootStore = getSingletonRootStore();
            rootStore.unregisterStore(this);
        }
    }
    /**
     * You can override this method if you want to give your container instance a custom id.
     * The returned id must be unique in the application.
     */
    getStoreInstanceId() {
        return this._defaultStoreInstanceId;
    }
    _getClassName() {
        const name = this.constructor.name || /function (.+)\(/.exec(this.constructor + '')[1];
        if (this.reduxToolEnabled) {
            const rootStore = getSingletonRootStore();
            if (!rootStore.existStoreInstanceId(name)) {
                return name;
            }
            let j = 0;
            for (let i = 1; i < 20; i++) {
                if (!rootStore.existStoreInstanceId(`${name}-${i}`)) {
                    j = i;
                    break;
                }
            }
            return `${name}-${j}`;
        }
        return name;
    }
}
Store.ɵfac = function Store_Factory(t) { return new (t || Store)(ɵngcc0.ɵɵinject(undefined)); };
Store.ɵprov = ɵngcc0.ɵɵdefineInjectable({ token: Store, factory: Store.ɵfac });
Store.ctorParameters = () => [
    { type: undefined }
];
__decorate([
    Action(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", []),
    __metadata("design:returntype", void 0)
], Store.prototype, "clearState", null);
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(Store, [{
        type: Injectable
    }], function () { return [{ type: undefined }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RvcmUuanMiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zdG9yZS9zdG9yZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBWSxlQUFlLEVBQUUsSUFBSSxFQUFxQyxNQUFNLE1BQU0sQ0FBQztBQUN0RyxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsR0FBRyxFQUFFLFdBQVcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3hFLE9BQU8sRUFBRSxRQUFRLEVBQWlCLE1BQU0sU0FBUyxDQUFDO0FBQ2xELE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMxQyxPQUFPLEVBQUUscUJBQXFCLEVBQWEsTUFBTSxjQUFjLENBQUM7QUFDaEUsT0FBTyxFQUFhLFNBQVMsRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDakUsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzdDLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxVQUFVLENBQUM7O0FBUWxDLE1BQU0sT0FBTyxLQUFLO0FBQUcsSUFTakIsWUFBWSxZQUFpQjtBQUNqQyxRQUxXLHFCQUFnQixHQUFHLFNBQVMsRUFBRSxDQUFDO0FBQzFDLFFBSVEsSUFBSSxDQUFDLHVCQUF1QixHQUFHLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztBQUM1RCxRQUFRLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxlQUFlLENBQUksWUFBWSxDQUFDLENBQUM7QUFDM0QsUUFBUSxJQUFJLENBQUMsaUJBQWlCLHFCQUFRLFlBQVksQ0FBRSxDQUFDO0FBQ3JELFFBQVEsSUFBSSxJQUFJLENBQUMsZ0JBQWdCLEVBQUU7QUFDbkMsWUFBWSxNQUFNLFNBQVMsR0FBYyxxQkFBcUIsRUFBRSxDQUFDO0FBQ2pFLFlBQVksV0FBVyxDQUFDLFlBQVksQ0FBQyxPQUFPLElBQUksQ0FBQyx1QkFBdUIsRUFBRSxDQUFDLENBQUM7QUFDNUUsWUFBWSxTQUFT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QUM1QyxJQUFJLENBQUM7QUFDTCxJQUNZLGFBQWE7QUFBSyxRQUN0QixNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksSUFBSSxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUMvRixRQUFRLElBQUksSUFBSSxDQUFDLGdCQUFnQixFQUFFO0FBQ25DLFlBQVksTUFBTSxTQUFTLEdBQWMscUJBQXFCLEVBQUUsQ0FBQztBQUNqRSxZQUFZLElBQUksQ0FBQyxTQUFTLENBQUMsb0JBQW9CLENBQUMsSUFBSSxDQUFDLEVBQUU7QUFDdkQsZ0JBQWdCLE9BQU8sSUFBSSxDQUFDO0FBQzVCLGFBQWE7QUFDYixZQUFZLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUN0QixZQUFZLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxFQUFFLEVBQUU7QUFDekMsZ0JBQWdCLElBQUksQ0FBQyxTQUFTLENBQUMsb0JBQW9CLENBQUMsR0FBRyxJQUFJLElBQUksQ0FBQyxFQUFFLENBQUMsRUFBRTtBQUNyRSxvQkFBb0IsQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUMxQixvQkFBb0IsTUFBTTtBQUMxQixpQkFBaUI7QUFDakIsYUFBYTtBQUNiLFlBQVksT0FBTyxHQUFHLElBQUksSUFBSSxDQUFDLEVBQUUsQ0FBQztBQUNsQyxTQUFTO0FBQ1QsUUFBUSxPQUFPLElBQUksQ0FBQztBQUNwQixJQUFJLENBQUM7QUFDTDtpQ0F2SkMsVUFBVTsrRUFDVDtBQUFDO0FBQStCO0FBQXdCO0FBaUh0RDtBQUFhLElBRFosTUFBTSxFQUFFO0FBQ1o7QUFDc0I7QUFHYjtBQUN3Qix1Q0FIN0I7OzttRUFDTDtBQUNBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgT2JzZXJ2YWJsZSwgT2JzZXJ2ZXIsIEJlaGF2aW9yU3ViamVjdCwgZnJvbSwgb2YsIFBhcnRpYWxPYnNlcnZlciwgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBkaXN0aW5jdFVudGlsQ2hhbmdlZCwgbWFwLCBzaGFyZVJlcGxheSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IE1FVEFfS0VZLCBTdG9yZU1ldGFJbmZvIH0gZnJvbSAnLi90eXBlcyc7XG5pbXBvcnQgeyBoZWxwZXJzIH0gZnJvbSAnbmd4LXRldGh5cy91dGlsJztcbmltcG9ydCB7IGdldFNpbmdsZXRvblJvb3RTdG9yZSwgUm9vdFN0b3JlIH0gZnJvbSAnLi9yb290LXN0b3JlJztcbmltcG9ydCB7IE9uRGVzdHJveSwgaXNEZXZNb2RlLCBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBBY3Rpb25TdGF0ZSB9IGZyb20gJy4vYWN0aW9uLXN0YXRlJztcbmltcG9ydCB7IEFjdGlvbiB9IGZyb20gJy4vYWN0aW9uJztcblxuaW50ZXJmYWNlIEFjdGlvbiB7XG4gICAgdHlwZTogc3RyaW5nO1xuICAgIHBheWxvYWQ/OiBhbnk7XG59XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBTdG9yZTxUID0gdW5rbm93bj4gaW1wbGVtZW50cyBPYnNlcnZlcjxUPiwgT25EZXN0cm95IHtcbiAgICBpbml0aWFsU3RhdGVDYWNoZTogYW55O1xuXG4gICAgcHVibGljIHN0YXRlJDogQmVoYXZpb3JTdWJqZWN0PFQ+O1xuXG4gICAgcHVibGljIHJlZHV4VG9vbEVuYWJsZWQgPSBpc0Rldk1vZGUoKTtcblxuICAgIHByaXZhdGUgX2RlZmF1bHRTdG9yZUluc3RhbmNlSWQ6IHN0cmluZztcblxuICAgIGNvbnN0cnVjdG9yKGluaXRpYWxTdGF0ZTogYW55KSB7XG4gICAgICAgIHRoaXMuX2RlZmF1bHRTdG9yZUluc3RhbmNlSWQgPSB0aGlzLl9nZXRDbGFzc05hbWUoKTtcbiAgICAgICAgdGhpcy5zdGF0ZSQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PFQ+KGluaXRpYWxTdGF0ZSk7XG4gICAgICAgIHRoaXMuaW5pdGlhbFN0YXRlQ2FjaGUgPSB7IC4uLmluaXRpYWxTdGF0ZSB9O1xuICAgICAgICBpZiAodGhpcy5yZWR1eFRvb2xFbmFibGVkKSB7XG4gICAgICAgICAgICBjb25zdCByb290U3RvcmU6IFJvb3RTdG9yZSA9IGdldFNpbmdsZXRvblJvb3RTdG9yZSgpO1xuICAgICAgICAgICAgQWN0aW9uU3RhdGUuY2hhbmdlQWN0aW9uKGBBZGQtJHt0aGlzLl9kZWZhdWx0U3RvcmVJbnN0YW5jZUlkfWApO1xuICAgICAgICAgICAgcm9vdFN0b3JlLnJlZ2lzdGVyU3RvcmUodGhpcyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBnZXQgc25hcHNob3QoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnN0YXRlJC5nZXRWYWx1ZSgpO1xuICAgIH1cblxuICAgIHB1YmxpYyBkaXNwYXRjaCh0eXBlOiBzdHJpbmcsIHBheWxvYWQ/OiBhbnkpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgICAgICBBY3Rpb25TdGF0ZS5jaGFuZ2VBY3Rpb24oYCR7dGhpcy5fZGVmYXVsdFN0b3JlSW5zdGFuY2VJZH0tJHt0eXBlfWApO1xuICAgICAgICBjb25zdCByZXN1bHQgPSB0aGlzLl9kaXNwYXRjaCh7XG4gICAgICAgICAgICB0eXBlOiB0eXBlLFxuICAgICAgICAgICAgcGF5bG9hZDogcGF5bG9hZFxuICAgICAgICB9KTtcbiAgICAgICAgcmVzdWx0LnN1YnNjcmliZSgpO1xuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cblxuICAgIHByaXZhdGUgX2Rpc3BhdGNoKGFjdGlvbjogYW55KTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgY29uc3QgbWV0YSA9IHRoaXNbTUVUQV9LRVldIGFzIFN0b3JlTWV0YUluZm87XG4gICAgICAgIGlmICghbWV0YSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGAke01FVEFfS0VZfSBpcyBub3QgZm91bmQsIGN1cnJlbnQgc3RvcmUgaGFzIG5vdCBhY3Rpb25gKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBhY3Rpb25NZXRhID0gbWV0YS5hY3Rpb25zW2FjdGlvbi50eXBlXTtcbiAgICAgICAgaWYgKCFhY3Rpb25NZXRhKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYCR7YWN0aW9uLnR5cGV9IGlzIG5vdCBmb3VuZGApO1xuICAgICAgICB9XG4gICAgICAgIC8vIGxldCByZXN1bHQ6IGFueSA9IHRoaXNbYWN0aW9uTWV0YS5mbl0odGhpcy5zbmFwc2hvdCwgYWN0aW9uLnBheWxvYWQpO1xuICAgICAgICBsZXQgcmVzdWx0OiBhbnkgPSBhY3Rpb25NZXRhLm9yaWdpbmFsRm4uY2FsbCh0aGlzLCB0aGlzLnNuYXBzaG90LCBhY3Rpb24ucGF5bG9hZCk7XG5cbiAgICAgICAgaWYgKHJlc3VsdCBpbnN0YW5jZW9mIFByb21pc2UpIHtcbiAgICAgICAgICAgIHJlc3VsdCA9IGZyb20ocmVzdWx0KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChyZXN1bHQgaW5zdGFuY2VvZiBPYnNlcnZhYmxlKSB7XG4gICAgICAgICAgICByZXN1bHQgPSByZXN1bHQucGlwZShtYXAociA9PiByKSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXN1bHQgPSBuZXcgT2JzZXJ2YWJsZSgob2JzZXJ2ZXI6IE9ic2VydmVyPGFueT4pID0+IHtcbiAgICAgICAgICAgICAgICBvYnNlcnZlci5uZXh0KHt9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXN1bHQucGlwZShzaGFyZVJlcGxheSgpKTtcbiAgICB9XG5cbiAgICBzZWxlY3Q8VFJlc3VsdD4oc2VsZWN0b3I6IChzdGF0ZTogVCkgPT4gVFJlc3VsdCk6IE9ic2VydmFibGU8VFJlc3VsdD4gfCBPYnNlcnZhYmxlPFRSZXN1bHQ+O1xuICAgIHNlbGVjdChzZWxlY3Rvcjogc3RyaW5nIHwgYW55KTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc3RhdGUkLnBpcGUobWFwKHNlbGVjdG9yKSwgZGlzdGluY3RVbnRpbENoYW5nZWQoKSk7XG4gICAgfVxuXG4gICAgbmV4dChzdGF0ZTogVCkge1xuICAgICAgICB0aGlzLnN0YXRlJC5uZXh0KHN0YXRlKTtcbiAgICB9XG5cbiAgICBlcnJvcihlcnJvcjogYW55KSB7XG4gICAgICAgIHRoaXMuc3RhdGUkLmVycm9yKGVycm9yKTtcbiAgICB9XG5cbiAgICBjb21wbGV0ZSgpIHtcbiAgICAgICAgdGhpcy5zdGF0ZSQuY29tcGxldGUoKTtcbiAgICB9XG5cbiAgICBzdWJzY3JpYmUobmV4dD86ICh2YWx1ZTogVCkgPT4gdm9pZCwgZXJyb3I/OiAoZXJyb3I6IGFueSkgPT4gdm9pZCwgY29tcGxldGU/OiAoKSA9PiB2b2lkKTogU3Vic2NyaXB0aW9uIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc3RhdGUkLnN1YnNjcmliZShuZXh0LCBlcnJvciwgY29tcGxldGUpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIHNldCBzdG9yZSBuZXcgc3RhdGVcbiAgICAgKlxuICAgICAqIEBleGFtcGxlXG4gICAgICogdGhpcy5zZXRTdGF0ZShuZXdTdGF0ZSk7XG4gICAgICogdGhpcy5zZXRTdGF0ZSh7IHVzZXJzOiBwcm9kdWNlKHRoaXMuc25hcHNob3QudXNlcnMpLmFkZCh1c2VyKSB9KTtcbiAgICAgKiB0aGlzLnNldFN0YXRlKChzdGF0ZSkgPT4ge1xuICAgICAqICAgIHJldHVybiB7XG4gICAgICogICAgICAgIHVzZXJzOiBwcm9kdWNlKHN0YXRlLnVzZXJzKS5hZGQodXNlcilcbiAgICAgKiAgICB9XG4gICAgICogfSk7XG4gICAgICogQHBhcmFtIGZuXG4gICAgICovXG4gICAgc2V0U3RhdGUoZm46IFBhcnRpYWw8VD4gfCAoKG5ld1N0YXRlOiBUKSA9PiBQYXJ0aWFsPFQ+KSk6IHZvaWQge1xuICAgICAgICBpZiAoaGVscGVycy5pc0Z1bmN0aW9uKGZuKSkge1xuICAgICAgICAgICAgdGhpcy5uZXh0KHtcbiAgICAgICAgICAgICAgICAuLi50aGlzLnNuYXBzaG90LFxuICAgICAgICAgICAgICAgIC4uLihmbiBhcyBhbnkpKHRoaXMuc25hcHNob3QpXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMubmV4dCh7XG4gICAgICAgICAgICAgICAgLi4udGhpcy5zbmFwc2hvdCxcbiAgICAgICAgICAgICAgICAuLi4oZm4gYXMgVClcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgZ2V0U3RhdGUoKTogVCB7XG4gICAgICAgIHJldHVybiB0aGlzLnNuYXBzaG90O1xuICAgIH1cblxuICAgIEBBY3Rpb24oKVxuICAgIGNsZWFyU3RhdGUoKSB7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUodGhpcy5pbml0aWFsU3RhdGVDYWNoZSk7XG4gICAgfVxuXG4gICAgbmdPbkRlc3Ryb3koKSB7XG4gICAgICAgIGlmICh0aGlzLnJlZHV4VG9vbEVuYWJsZWQpIHtcbiAgICAgICAgICAgIGNvbnN0IHJvb3RTdG9yZTogUm9vdFN0b3JlID0gZ2V0U2luZ2xldG9uUm9vdFN0b3JlKCk7XG4gICAgICAgICAgICByb290U3RvcmUudW5yZWdpc3RlclN0b3JlKHRoaXMpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogWW91IGNhbiBvdmVycmlkZSB0aGlzIG1ldGhvZCBpZiB5b3Ugd2FudCB0byBnaXZlIHlvdXIgY29udGFpbmVyIGluc3RhbmNlIGEgY3VzdG9tIGlkLlxuICAgICAqIFRoZSByZXR1cm5lZCBpZCBtdXN0IGJlIHVuaXF1ZSBpbiB0aGUgYXBwbGljYXRpb24uXG4gICAgICovXG4gICAgZ2V0U3RvcmVJbnN0YW5jZUlkKCk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiB0aGlzLl9kZWZhdWx0U3RvcmVJbnN0YW5jZUlkO1xuICAgIH1cblxuICAgIHByaXZhdGUgX2dldENsYXNzTmFtZSgpOiBzdHJpbmcge1xuICAgICAgICBjb25zdCBuYW1lID0gdGhpcy5jb25zdHJ1Y3Rvci5uYW1lIHx8IC9mdW5jdGlvbiAoLispXFwoLy5leGVjKHRoaXMuY29uc3RydWN0b3IgKyAnJylbMV07XG4gICAgICAgIGlmICh0aGlzLnJlZHV4VG9vbEVuYWJsZWQpIHtcbiAgICAgICAgICAgIGNvbnN0IHJvb3RTdG9yZTogUm9vdFN0b3JlID0gZ2V0U2luZ2xldG9uUm9vdFN0b3JlKCk7XG4gICAgICAgICAgICBpZiAoIXJvb3RTdG9yZS5leGlzdFN0b3JlSW5zdGFuY2VJZChuYW1lKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBuYW1lO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbGV0IGogPSAwO1xuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPCAyMDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFyb290U3RvcmUuZXhpc3RTdG9yZUluc3RhbmNlSWQoYCR7bmFtZX0tJHtpfWApKSB7XG4gICAgICAgICAgICAgICAgICAgIGogPSBpO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gYCR7bmFtZX0tJHtqfWA7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG5hbWU7XG4gICAgfVxufVxuIl19