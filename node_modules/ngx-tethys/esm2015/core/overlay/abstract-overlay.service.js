import { concatArray } from 'ngx-tethys/util';
import { Subject } from 'rxjs';
import { OverlayConfig } from '@angular/cdk/overlay';
import { ComponentPortal, TemplatePortal } from '@angular/cdk/portal';
import { TemplateRef } from '@angular/core';
export class ThyAbstractOverlayService {
    constructor(options, // component name, e.g: dialog | popover | slide
    overlay, injector, defaultConfig, scrollStrategy) {
        this.options = options;
        this.overlay = overlay;
        this.injector = injector;
        this.defaultConfig = defaultConfig;
        this.scrollStrategy = scrollStrategy;
        this.openedOverlays = [];
        this._afterAllClosed = new Subject();
        this._afterOpened = new Subject();
    }
    /** Attach component or template ref to overlay container */
    attachUpperOverlayContent(componentOrTemplateRef, containerInstance, overlayRef, config) {
        // Create a reference to the dialog we're creating in order to give the user a handle
        // to modify and close it.
        const upperOverlayRef = this.createUpperOverlayRef(overlayRef, containerInstance, config);
        // When the backdrop is clicked, we want to close it.
        if (config.hasBackdrop) {
            overlayRef.backdropClick().subscribe(() => {
                if (upperOverlayRef.backdropClosable) {
                    upperOverlayRef.close();
                }
            });
        }
        if (componentOrTemplateRef instanceof TemplateRef) {
            containerInstance.attachTemplatePortal(new TemplatePortal(componentOrTemplateRef, null, {
                $implicit: config.initialState,
                [`${this.options.name}Ref`]: upperOverlayRef
            }));
        }
        else {
            const injector = this.createInjector(config, upperOverlayRef, containerInstance);
            const contentRef = containerInstance.attachComponentPortal(new ComponentPortal(componentOrTemplateRef, undefined, injector));
            if (config.initialState) {
                Object.assign(contentRef.instance, config.initialState);
            }
            upperOverlayRef.componentInstance = contentRef.instance;
        }
        return upperOverlayRef;
    }
    removeOpenedOverlay(upperOverlayRef) {
        const index = this.openedOverlays.indexOf(upperOverlayRef);
        if (index > -1) {
            this.openedOverlays.splice(index, 1);
            if (!this.openedOverlays.length) {
                this._afterAllClosed.next();
            }
        }
    }
    getUpperOverlayById(id) {
        return this.openedOverlays.find(overlay => overlay.id === id);
    }
    buildBaseOverlayConfig(config, defaultPanelClass) {
        const overlayConfig = new OverlayConfig({
            positionStrategy: this.overlay.position().global(),
            hasBackdrop: config.hasBackdrop,
            direction: config.direction,
            width: config.width,
            height: config.height,
            minWidth: config.minWidth,
            minHeight: config.minHeight,
            maxWidth: config.maxWidth,
            maxHeight: config.maxHeight,
            disposeOnNavigation: config.closeOnNavigation
        });
        if (config.backdropClass) {
            overlayConfig.backdropClass = config.backdropClass;
        }
        overlayConfig.panelClass = concatArray(config.panelClass, defaultPanelClass);
        return overlayConfig;
    }
    openUpperOverlay(componentOrTemplateRef, config) {
        config = Object.assign(Object.assign({}, this.defaultConfig), config);
        if (config.id && this.getUpperOverlayById(config.id)) {
            throw Error(`${this.options.name} with id ${config.id} exists already. The ${this.options.name} id must be unique.`);
        }
        const overlayConfig = this.buildOverlayConfig(config);
        const overlayRef = this.overlay.create(overlayConfig);
        const overlayContainer = this.attachUpperOverlayContainer(overlayRef, config);
        const upperOverlayRef = this.attachUpperOverlayContent(componentOrTemplateRef, overlayContainer, overlayRef, config);
        this.openedOverlays.push(upperOverlayRef);
        upperOverlayRef.afterClosed().subscribe(() => {
            this.removeOpenedOverlay(upperOverlayRef);
        });
        this._afterOpened.next(upperOverlayRef);
        return upperOverlayRef;
    }
    afterAllClosed() {
        return this._afterAllClosed;
    }
    afterOpened() {
        return this._afterOpened;
    }
    close(result) {
        if (this.openedOverlays.length > 0) {
            const lastOverlayRef = this.openedOverlays[this.openedOverlays.length - 1];
            if (lastOverlayRef) {
                lastOverlayRef.close(result);
            }
        }
    }
    closeAll() {
        let i = this.openedOverlays.length;
        while (i--) {
            // 不需要操作 openedOverlays, 因为 close 会触发 afterClosed 的订阅
            // 触发订阅后会自动从 openedOverlays 中移除
            this.openedOverlays[i].close();
        }
    }
    dispose() {
        this.closeAll();
        this._afterAllClosed.complete();
        this._afterOpened.complete();
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWJzdHJhY3Qtb3ZlcmxheS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2NvcmUvb3ZlcmxheS9hYnN0cmFjdC1vdmVybGF5LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFnQixXQUFXLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUM1RCxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRS9CLE9BQU8sRUFBMEIsYUFBYSxFQUE4QixNQUFNLHNCQUFzQixDQUFDO0FBQ3pHLE9BQU8sRUFBRSxlQUFlLEVBQUUsY0FBYyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDdEUsT0FBTyxFQUFZLFdBQVcsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQVF0RCxNQUFNLE9BQWdCLHlCQUF5QjtJQU8zQyxZQUNjLE9BQStCLEVBQUUsZ0RBQWdEO0lBQ2pGLE9BQWdCLEVBQ2hCLFFBQWtCLEVBQ2xCLGFBQXNCLEVBQ3pCLGNBQTZDO1FBSjFDLFlBQU8sR0FBUCxPQUFPLENBQXdCO1FBQy9CLFlBQU8sR0FBUCxPQUFPLENBQVM7UUFDaEIsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUNsQixrQkFBYSxHQUFiLGFBQWEsQ0FBUztRQUN6QixtQkFBYyxHQUFkLGNBQWMsQ0FBK0I7UUFYaEQsbUJBQWMsR0FBaUQsRUFBRSxDQUFDO1FBRXpELG9CQUFlLEdBQUcsSUFBSSxPQUFPLEVBQVEsQ0FBQztRQUV0QyxpQkFBWSxHQUFHLElBQUksT0FBTyxFQUEwQyxDQUFDO0lBUW5GLENBQUM7SUEyQkosNERBQTREO0lBQ2xELHlCQUF5QixDQUMvQixzQkFBcUQsRUFDckQsaUJBQTZCLEVBQzdCLFVBQXNCLEVBQ3RCLE1BQWU7UUFFZixxRkFBcUY7UUFDckYsMEJBQTBCO1FBQzFCLE1BQU0sZUFBZSxHQUFHLElBQUksQ0FBQyxxQkFBcUIsQ0FBSSxVQUFVLEVBQUUsaUJBQWlCLEVBQUUsTUFB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ZUFBZSxDQUFDO0lBQ2hDLENBQUM7SUFFRCxXQUFXO1FBQ1AsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDO0lBQzdCLENBQUM7SUFFRCxLQUFLLENBQUksTUFBVTtRQUNmLElBQUksSUFBSSxDQUFDLGNBQWMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQ2hDLE1BQU0sY0FBYyxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDM0UsSUFBSSxjQUFjLEVBQUU7Z0JBQ2hCLGNBQWMsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7YUFDaEM7U0FDSjtJQUNMLENBQUM7SUFFRCxRQUFRO1FBQ0osSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUM7UUFDbkMsT0FBTyxDQUFDLEVBQUUsRUFBRTtZQUNSLHFEQUFxRDtZQUNyRCwrQkFBK0I7WUFDL0IsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQztTQUNsQztJQUNMLENBQUM7SUFFRCxPQUFPO1FBQ0gsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ2hCLElBQUksQ0FBQyxlQUFlLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDaEMsSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLEVBQUUsQ0FBQztJQUNqQyxDQUFDO0NBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBGdW5jdGlvblByb3AsIGNvbmNhdEFycmF5IH0gZnJvbSAnbmd4LXRldGh5cy91dGlsJztcbmltcG9ydCB7IFN1YmplY3QgfSBmcm9tICdyeGpzJztcblxuaW1wb3J0IHsgQ29tcG9uZW50VHlwZSwgT3ZlcmxheSwgT3ZlcmxheUNvbmZpZywgT3ZlcmxheVJlZiwgU2Nyb2xsU3RyYXRlZ3kgfSBmcm9tICdAYW5ndWxhci9jZGsvb3ZlcmxheSc7XG5pbXBvcnQgeyBDb21wb25lbnRQb3J0YWwsIFRlbXBsYXRlUG9ydGFsIH0gZnJvbSAnQGFuZ3VsYXIvY2RrL3BvcnRhbCc7XG5pbXBvcnQgeyBJbmplY3RvciwgVGVtcGxhdGVSZWYgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHsgVGh5QWJzdHJhY3RPdmVybGF5Q29udGFpbmVyIH0gZnJvbSAnLi9hYnN0cmFjdC1vdmVybGF5LWNvbnRhaW5lcic7XG5pbXBvcnQgeyBUaHlBYnN0cmFjdE92ZXJsYXlSZWYgfSBmcm9tICcuL2Fic3RyYWN0LW92ZXJsYXktcmVmJztcbmltcG9ydCB7IFRoeUFic3RyYWN0T3ZlcmxheUNvbmZpZywgVGh5VXBwZXJPdmVybGF5T3B0aW9ucyB9IGZyb20gJy4vYWJzdHJhY3Qtb3ZlcmxheS5jb25maWcnO1xuXG5leHBvcnQgdHlwZSBDb21wb25lbnRUeXBlT3JUZW1wbGF0ZVJlZjxUPiA9IENvbXBvbmVudFR5cGU8VD4gfCBUZW1wbGF0ZVJlZjxUPjtcblxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIFRoeUFic3RyYWN0T3ZlcmxheVNlcnZpY2U8VENvbmZpZyBleHRlbmRzIFRoeUFic3RyYWN0T3ZlcmxheUNvbmZpZywgVENvbnRhaW5lciBleHRlbmRzIFRoeUFic3RyYWN0T3ZlcmxheUNvbnRhaW5lcj4ge1xuICAgIHByaXZhdGUgb3BlbmVkT3ZlcmxheXM6IFRoeUFic3RyYWN0T3ZlcmxheVJlZjx1bmtub3duLCBUQ29udGFpbmVyPltdID0gW107XG5cbiAgICBwcml2YXRlIHJlYWRvbmx5IF9hZnRlckFsbENsb3NlZCA9IG5ldyBTdWJqZWN0PHZvaWQ+KCk7XG5cbiAgICBwcml2YXRlIHJlYWRvbmx5IF9hZnRlck9wZW5lZCA9IG5ldyBTdWJqZWN0PFRoeUFic3RyYWN0T3ZlcmxheVJlZjxhbnksIFRDb250YWluZXI+PigpO1xuXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIHByb3RlY3RlZCBvcHRpb25zOiBUaHlVcHBlck92ZXJsYXlPcHRpb25zLCAvLyBjb21wb25lbnQgbmFtZSwgZS5nOiBkaWFsb2cgfCBwb3BvdmVyIHwgc2xpZGVcbiAgICAgICAgcHJvdGVjdGVkIG92ZXJsYXk6IE92ZXJsYXksXG4gICAgICAgIHByb3RlY3RlZCBpbmplY3RvcjogSW5qZWN0b3IsXG4gICAgICAgIHByb3RlY3RlZCBkZWZhdWx0Q29uZmlnOiBUQ29uZmlnLFxuICAgICAgICBwdWJsaWMgc2Nyb2xsU3RyYXRlZ3k/OiBGdW5jdGlvblByb3A8U2Nyb2xsU3RyYXRlZ3k+XG4gICAgKSB7fVxuXG4gICAgLyoqIEJ1aWxkIGNkayBvdmVybGF5IGNvbmZpZyBieSBjb25maWcgKi9cbiAgICBwcm90ZWN0ZWQgYWJzdHJhY3QgYnVpbGRPdmVybGF5Q29uZmlnKGNvbmZpZzogVENvbmZpZyk6IE92ZXJsYXlDb25maWc7XG5cbiAgICAvKiogQXR0YWNoIG92ZXJsYXkgY29udGFpbmVyIHRvIG92ZXJsYXkqL1xuICAgIHByb3RlY3RlZCBhYnN0cmFjdCBhdHRhY2hVcHBlck92ZXJsYXlDb250YWluZXIob3ZlcmxheTogT3ZlcmxheVJlZiwgY29uZmlnOiBUQ29uZmlnKTogVENvbnRhaW5lcjtcblxuICAgIC8qKiBDcmVhdGUgdXBwZXIgb3ZlcmxheSByZWYgYnkgY2RrIG92ZXJsYXksIGNvbnRhaW5lciBhbmQgY29uZmlnICAqL1xuICAgIHByb3RlY3RlZCBhYnN0cmFjdCBjcmVhdGVVcHBlck92ZXJsYXlSZWY8VD4oXG4gICAgICAgIG92ZXJsYXlSZWY6IE92ZXJsYXlSZWYsXG4gICAgICAgIGNvbnRhaW5lckluc3RhbmNlOiBUQ29udGFpbmVyLFxuICAgICAgICBjb25maWc6IFRDb25maWdcbiAgICApOiBUaHlBYnN0cmFjdE92ZXJsYXlSZWY8VCwgVENvbnRhaW5lcj47XG5cbiAgICAvKiogQ3JlYXRlIGluamVjdG9yIGZvciBjb21wb25lbnQgY29udGVudCAqL1xuICAgIHByb3RlY3RlZCBhYnN0cmFjdCBjcmVhdGVJbmplY3RvcjxUPihcbiAgICAgICAgY29uZmlnOiBUQ29uZmlnLFxuICAgICAgICBvdmVybGF5UmVmOiBUaHlBYnN0cmFjdE92ZXJsYXlSZWY8VCwgVENvbnRhaW5lcj4sXG4gICAgICAgIGNvbnRhaW5lckluc3RhbmNlOiBUQ29udGFpbmVyXG4gICAgKTogSW5qZWN0b3I7XG5cbiAgICBhYnN0cmFjdCBvcGVuPFQsIFREYXRhID0gdW5kZWZpbmVkLCBUUmVzdWx0ID0gdW5kZWZpbmVkPihcbiAgICAgICAgY29tcG9uZW50T3JUZW1wbGF0ZVJlZjogQ29tcG9uZW50VHlwZU9yVGVtcGxhdGVSZWY8VD4sXG4gICAgICAgIGNvbmZpZz86IFRoeUFic3RyYWN0T3ZlcmxheUNvbmZpZzxURGF0YT5cbiAgICApOiBUaHlBYnN0cmFjdE92ZXJsYXlSZWY8VCwgVENvbnRhaW5lciwgVFJlc3VsdD47XG5cbiAgICAvKiogQXR0YWNoIGNvbXBvbmVudCBvciB0ZW1wbGF0ZSByZWYgdG8gb3ZlcmxheSBjb250YWluZXIgKi9cbiAgICBwcm90ZWN0ZWQgYXR0YWNoVXBwZXJPdmVybGF5Q29udGVudDxULCBUUmVzdWx0PihcbiAgICAgICAgY29tcG9uZW50T3JUZW1wbGF0ZVJlZjogQ29tcG9uZW50VHlwZU9yVGVtcGxhdGVSZWY8VD4sXG4gICAgICAgIGNvbnRhaW5lckluc3RhbmNlOiBUQ29udGFpbmVyLFxuICAgICAgICBvdmVybGF5UmVmOiBPdmVybGF5UmVmLFxuICAgICAgICBjb25maWc6IFRDb25maWdcbiAgICApOiBUaHlBYnN0cmFjdE92ZXJsYXlSZWY8VCwgVENvbnRhaW5lciwgVFJlc3VsdD4ge1xuICAgICAgICAvLyBDcmVhdGUgYSByZWZlcmVuY2UgdG8gdGhlIGRpYWxvZyB3ZSdyZSBjcmVhdGluZyBpbiBvcmRlciB0byBnaXZlIHRoZSB1c2VyIGEgaGFuZGxlXG4gICAgICAgIC8vIHRvIG1vZGlmeSBhbmQgY2xvc2UgaXQuXG4gICAgICAgIGNvbnN0IHVwcGVyT3ZlcmxheVJlZiA9IHRoaXMuY3JlYXRlVXBwZXJPdmVybGF5UmVmPFQ+KG92ZXJsYXlSZWYsIGNvbnRhaW5lckluc3RhbmNlLCBjb25maWcpO1xuXG4gICAgICAgIC8vIFdoZW4gdGhlIGJhY2tkcm9wIGlzIGNsaWNrZWQsIHdlIHdhbnQgdG8gY2xvc2UgaXQuXG4gICAgICAgIGlmIChjb25maWcuaGFzQmFja2Ryb3ApIHtcbiAgICAgICAgICAgIG92ZXJsYXlSZWYuYmFja2Ryb3BDbGljaygpLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHVwcGVyT3ZlcmxheVJlZi5iYWNrZHJvcENsb3NhYmxlKSB7XG4gICAgICAgICAgICAgICAgICAgIHVwcGVyT3ZlcmxheVJlZi5jbG9zZSgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGNvbXBvbmVudE9yVGVtcGxhdGVSZWYgaW5zdGFuY2VvZiBUZW1wbGF0ZVJlZikge1xuICAgICAgICAgICAgY29udGFpbmVySW5zdGFuY2UuYXR0YWNoVGVtcGxhdGVQb3J0YWwoXG4gICAgICAgICAgICAgICAgbmV3IFRlbXBsYXRlUG9ydGFsPFQ+KGNvbXBvbmVudE9yVGVtcGxhdGVSZWYsIG51bGwsIDxhbnk+e1xuICAgICAgICAgICAgICAgICAgICAkaW1wbGljaXQ6IGNvbmZpZy5pbml0aWFsU3RhdGUsXG4gICAgICAgICAgICAgICAgICAgIFtgJHt0aGlzLm9wdGlvbnMubmFtZX1SZWZgXTogdXBwZXJPdmVybGF5UmVmXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zdCBpbmplY3RvciA9IHRoaXMuY3JlYXRlSW5qZWN0b3I8VD4oY29uZmlnLCB1cHBlck92ZXJsYXlSZWYsIGNvbnRhaW5lckluc3RhbmNlKTtcbiAgICAgICAgICAgIGNvbnN0IGNvbnRlbnRSZWYgPSBjb250YWluZXJJbnN0YW5jZS5hdHRhY2hDb21wb25lbnRQb3J0YWw8VD4obmV3IENvbXBvbmVudFBvcnRhbChjb21wb25lbnRPclRlbXBsYXRlUmVmLCB1bmRlZmluZWQsIGluamVjdG9yKSk7XG4gICAgICAgICAgICBpZiAoY29uZmlnLmluaXRpYWxTdGF0ZSkge1xuICAgICAgICAgICAgICAgIE9iamVjdC5hc3NpZ24oY29udGVudFJlZi5pbnN0YW5jZSwgY29uZmlnLmluaXRpYWxTdGF0ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB1cHBlck92ZXJsYXlSZWYuY29tcG9uZW50SW5zdGFuY2UgPSBjb250ZW50UmVmLmluc3RhbmNlO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHVwcGVyT3ZlcmxheVJlZjtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgcmVtb3ZlT3BlbmVkT3ZlcmxheSh1cHBlck92ZXJsYXlSZWY6IFRoeUFic3RyYWN0T3ZlcmxheVJlZjxhbnksIFRDb250YWluZXI+KSB7XG4gICAgICAgIGNvbnN0IGluZGV4ID0gdGhpcy5vcGVuZWRPdmVybGF5cy5pbmRleE9mKHVwcGVyT3ZlcmxheVJlZik7XG5cbiAgICAgICAgaWYgKGluZGV4ID4gLTEpIHtcbiAgICAgICAgICAgIHRoaXMub3BlbmVkT3ZlcmxheXMuc3BsaWNlKGluZGV4LCAxKTtcblxuICAgICAgICAgICAgaWYgKCF0aGlzLm9wZW5lZE92ZXJsYXlzLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIHRoaXMuX2FmdGVyQWxsQ2xvc2VkLm5leHQoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByb3RlY3RlZCBnZXRVcHBlck92ZXJsYXlCeUlkKGlkOiBzdHJpbmcpOiBUaHlBYnN0cmFjdE92ZXJsYXlSZWY8YW55LCBUQ29udGFpbmVyPiB8IHVuZGVmaW5lZCB7XG4gICAgICAgIHJldHVybiB0aGlzLm9wZW5lZE92ZXJsYXlzLmZpbmQob3ZlcmxheSA9PiBvdmVybGF5LmlkID09PSBpZCk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGJ1aWxkQmFzZU92ZXJsYXlDb25maWcoY29uZmlnOiBUQ29uZmlnLCBkZWZhdWx0UGFuZWxDbGFzcz86IHN0cmluZyB8IHN0cmluZ1tdKTogT3ZlcmxheUNvbmZpZyB7XG4gICAgICAgIGNvbnN0IG92ZXJsYXlDb25maWcgPSBuZXcgT3ZlcmxheUNvbmZpZyh7XG4gICAgICAgICAgICBwb3NpdGlvblN0cmF0ZWd5OiB0aGlzLm92ZXJsYXkucG9zaXRpb24oKS5nbG9iYWwoKSxcbiAgICAgICAgICAgIGhhc0JhY2tkcm9wOiBjb25maWcuaGFzQmFja2Ryb3AsXG4gICAgICAgICAgICBkaXJlY3Rpb246IGNvbmZpZy5kaXJlY3Rpb24sXG4gICAgICAgICAgICB3aWR0aDogY29uZmlnLndpZHRoLFxuICAgICAgICAgICAgaGVpZ2h0OiBjb25maWcuaGVpZ2h0LFxuICAgICAgICAgICAgbWluV2lkdGg6IGNvbmZpZy5taW5XaWR0aCxcbiAgICAgICAgICAgIG1pbkhlaWdodDogY29uZmlnLm1pbkhlaWdodCxcbiAgICAgICAgICAgIG1heFdpZHRoOiBjb25maWcubWF4V2lkdGgsXG4gICAgICAgICAgICBtYXhIZWlnaHQ6IGNvbmZpZy5tYXhIZWlnaHQsXG4gICAgICAgICAgICBkaXNwb3NlT25OYXZpZ2F0aW9uOiBjb25maWcuY2xvc2VPbk5hdmlnYXRpb25cbiAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKGNvbmZpZy5iYWNrZHJvcENsYXNzKSB7XG4gICAgICAgICAgICBvdmVybGF5Q29uZmlnLmJhY2tkcm9wQ2xhc3MgPSBjb25maWcuYmFja2Ryb3BDbGFzcztcbiAgICAgICAgfVxuXG4gICAgICAgIG92ZXJsYXlDb25maWcucGFuZWxDbGFzcyA9IGNvbmNhdEFycmF5KGNvbmZpZy5wYW5lbENsYXNzLCBkZWZhdWx0UGFuZWxDbGFzcyk7XG5cbiAgICAgICAgcmV0dXJuIG92ZXJsYXlDb25maWc7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIG9wZW5VcHBlck92ZXJsYXk8VCwgVFJlc3VsdCA9IGFueT4oXG4gICAgICAgIGNvbXBvbmVudE9yVGVtcGxhdGVSZWY6IENvbXBvbmVudFR5cGVPclRlbXBsYXRlUmVmPFQ+LFxuICAgICAgICBjb25maWc/OiBUQ29uZmlnXG4gICAgKTogVGh5QWJzdHJhY3RPdmVybGF5UmVmPFQsIFRDb250YWluZXIsIFRSZXN1bHQ+IHtcbiAgICAgICAgY29uZmlnID0geyAuLi50aGlzLmRlZmF1bHRDb25maWcsIC4uLmNvbmZpZyB9O1xuICAgICAgICBpZiAoY29uZmlnLmlkICYmIHRoaXMuZ2V0VXBwZXJPdmVybGF5QnlJZChjb25maWcuaWQpKSB7XG4gICAgICAgICAgICB0aHJvdyBFcnJvcihgJHt0aGlzLm9wdGlvbnMubmFtZX0gd2l0aCBpZCAke2NvbmZpZy5pZH0gZXhpc3RzIGFscmVhZHkuIFRoZSAke3RoaXMub3B0aW9ucy5uYW1lfSBpZCBtdXN0IGJlIHVuaXF1ZS5gKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBvdmVybGF5Q29uZmlnOiBPdmVybGF5Q29uZmlnID0gdGhpcy5idWlsZE92ZXJsYXlDb25maWcoY29uZmlnKTtcbiAgICAgICAgY29uc3Qgb3ZlcmxheVJlZiA9IHRoaXMub3ZlcmxheS5jcmVhdGUob3ZlcmxheUNvbmZpZyk7XG5cbiAgICAgICAgY29uc3Qgb3ZlcmxheUNvbnRhaW5lciA9IHRoaXMuYXR0YWNoVXBwZXJPdmVybGF5Q29udGFpbmVyKG92ZXJsYXlSZWYsIGNvbmZpZyk7XG4gICAgICAgIGNvbnN0IHVwcGVyT3ZlcmxheVJlZiA9IHRoaXMuYXR0YWNoVXBwZXJPdmVybGF5Q29udGVudDxULCBUUmVzdWx0Pihjb21wb25lbnRPclRlbXBsYXRlUmVmLCBvdmVybGF5Q29udGFpbmVyLCBvdmVybGF5UmVmLCBjb25maWcpO1xuXG4gICAgICAgIHRoaXMub3BlbmVkT3ZlcmxheXMucHVzaCh1cHBlck92ZXJsYXlSZWYpO1xuICAgICAgICB1cHBlck92ZXJsYXlSZWYuYWZ0ZXJDbG9zZWQoKS5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5yZW1vdmVPcGVuZWRPdmVybGF5KHVwcGVyT3ZlcmxheVJlZik7XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLl9hZnRlck9wZW5lZC5uZXh0KHVwcGVyT3ZlcmxheVJlZik7XG5cbiAgICAgICAgcmV0dXJuIHVwcGVyT3ZlcmxheVJlZjtcbiAgICB9XG5cbiAgICBhZnRlckFsbENsb3NlZCgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2FmdGVyQWxsQ2xvc2VkO1xuICAgIH1cblxuICAgIGFmdGVyT3BlbmVkKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fYWZ0ZXJPcGVuZWQ7XG4gICAgfVxuXG4gICAgY2xvc2U8VD4ocmVzdWx0PzogVCkge1xuICAgICAgICBpZiAodGhpcy5vcGVuZWRPdmVybGF5cy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBjb25zdCBsYXN0T3ZlcmxheVJlZiA9IHRoaXMub3BlbmVkT3ZlcmxheXNbdGhpcy5vcGVuZWRPdmVybGF5cy5sZW5ndGggLSAxXTtcbiAgICAgICAgICAgIGlmIChsYXN0T3ZlcmxheVJlZikge1xuICAgICAgICAgICAgICAgIGxhc3RPdmVybGF5UmVmLmNsb3NlKHJlc3VsdCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBjbG9zZUFsbCgpIHtcbiAgICAgICAgbGV0IGkgPSB0aGlzLm9wZW5lZE92ZXJsYXlzLmxlbmd0aDtcbiAgICAgICAgd2hpbGUgKGktLSkge1xuICAgICAgICAgICAgLy8g5LiN6ZyA6KaB5pON5L2cIG9wZW5lZE92ZXJsYXlzLCDlm6DkuLogY2xvc2Ug5Lya6Kem5Y+RIGFmdGVyQ2xvc2VkIOeahOiuoumYhVxuICAgICAgICAgICAgLy8g6Kem5Y+R6K6i6ZiF5ZCO5Lya6Ieq5Yqo5LuOIG9wZW5lZE92ZXJsYXlzIOS4reenu+mZpFxuICAgICAgICAgICAgdGhpcy5vcGVuZWRPdmVybGF5c1tpXS5jbG9zZSgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgZGlzcG9zZSgpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5jbG9zZUFsbCgpO1xuICAgICAgICB0aGlzLl9hZnRlckFsbENsb3NlZC5jb21wbGV0ZSgpO1xuICAgICAgICB0aGlzLl9hZnRlck9wZW5lZC5jb21wbGV0ZSgpO1xuICAgIH1cbn1cbiJdfQ==