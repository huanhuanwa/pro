import { Subject, fromEvent } from 'rxjs';
import { takeUntil, take } from 'rxjs/operators';
export class ThyOverlayDirectiveBase {
    constructor(elementRef, platform, focusMonitor, ngZone) {
        this.initialized = false;
        /** Trigger Overlay */
        this._trigger = 'click';
        this.manualListeners = new Map();
        this.ngUnsubscribe$ = new Subject();
        this.showDelay = 0;
        this.hideDelay = 0;
        this.touchendHideDelay = 0;
        this.disabled = false;
        this.elementRef = elementRef;
        this.platform = platform;
        this.focusMonitor = focusMonitor;
        this.ngZone = ngZone;
    }
    get trigger() {
        return this._trigger;
    }
    set trigger(value) {
        this._trigger = value;
        // Trigger reinitialize when trigger changed which can't contain first
        if (this.initialized) {
            this.clearEventListeners();
            this.initialize();
        }
    }
    clearEventListeners() {
        this.manualListeners.forEach((listener, event) => {
            this.elementRef.nativeElement.removeEventListener(event, listener);
        });
        this.manualListeners.clear();
        this.focusMonitor.stopMonitoring(this.elementRef);
    }
    clearTimer() {
        if (this.showTimeoutId) {
            clearTimeout(this.showTimeoutId);
        }
        if (this.hideTimeoutId) {
            clearTimeout(this.hideTimeoutId);
        }
    }
    initialize() {
        this.initialized = true;
        const element = this.elementRef.nativeElement;
        if (!this.platform.IOS && !this.platform.ANDROID) {
            if (this.trigger === 'hover') {
                this.manualListeners
                    .set('mouseenter', () => {
                    this.show();
                })
                    .set('mouseleave', (event) => {
                    // element which mouse moved to
                    const overlayElement = this.overlayRef && this.overlayRef.overlayElement;
                    const toElement = event['toElement'] || event.relatedTarget;
                    // if element which moved to is in overlayElement, don't hide tooltip
                    if (overlayElement && overlayElement.contains && overlayElement.contains(toElement) && this.tooltipPin) {
                        fromEvent(overlayElement, 'mouseleave')
                            .pipe(take(1))
                            .subscribe(() => {
                            this.hide();
                        });
                    }
                    else {
                        this.hide();
                    }
                    // if showDelay is too long and mouseleave immediately, overlayRef is not exist, we should clearTimeout
                    if (!this.overlayRef) {
                        this.clearTimer();
                    }
                });
            }
            else if (this.trigger === 'focus') {
                this.focusMonitor
                    .monitor(this.elementRef)
                    .pipe(takeUntil(this.ngUnsubscribe$))
                    .subscribe(origin => {
                    // Note that the focus monitor runs outside the Angular zone.
                    if (!origin) {
                        this.ngZone.run(() => this.hide(0));
                    }
                    else {
                        this.ngZone.run(() => this.show());
                    }
                });
                // this.manualListeners.set('focus', () => this.show());
                // this.manualListeners.set('blur', () => this.hide());
            }
            else if (this.trigger === 'click') {
                this.manualListeners.set('click', () => this.show());
            }
            else {
                throw new Error(`${this.trigger} is not support, only support hover | focus | click`);
            }
        }
        else {
            const touchendListener = () => {
                // this.hide(this.touchendHideDelay);
                setTimeout(() => {
                    this.hide();
                }, this.touchendHideDelay);
            };
            // Reserve extensions for mobile in the future
            this.manualListeners
                .set('touchend', touchendListener)
                .set('touchcancel', touchendListener)
                .set('touchstart', () => {
                this.show();
            });
        }
        this.manualListeners.forEach((listener, event) => element.addEventListener(event, listener));
    }
    dispose() {
        this.ngUnsubscribe$.next();
        this.ngUnsubscribe$.complete();
        if (this.overlayRef) {
            this.overlayRef.dispose();
        }
        this.clearEventListeners();
        this.clearTimer();
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3ZlcmxheS5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvY29yZS9vdmVybGF5L292ZXJsYXkuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUVBLE9BQU8sRUFBRSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRzFDLE9BQU8sRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFJakQsTUFBTSxPQUFnQix1QkFBdUI7SUFxRHpDLFlBQVksVUFBc0IsRUFBRSxRQUFrQixFQUFFLFlBQTBCLEVBQUUsTUFBYztRQW5EMUYsZ0JBQVcsR0FBRyxLQUFLLENBQUM7UUFDNUIsc0JBQXNCO1FBQ1osYUFBUSxHQUFzQixPQUFPLENBQUM7UUFjdEMsb0JBQWUsR0FBRyxJQUFJLEdBQUcsRUFBOEMsQ0FBQztRQUN4RSxtQkFBYyxHQUFHLElBQUksT0FBTyxFQUFFLENBQUM7UUFJL0IsY0FBUyxHQUFJLENBQUMsQ0FBQztRQUNmLGNBQVMsR0FBSSxDQUFDLENBQUM7UUFDZixzQkFBaUIsR0FBSSxDQUFDLENBQUM7UUFDdkIsYUFBUSxHQUFHLEtBQUssQ0FBQztRQTRCdkIsSUFBSSxDQUFDLFVBQVUsR0FBRyxVQUFVLENBQUM7UUFDN0IsSUFBSSxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUM7UUFDekIsSUFBSSxDQUFDLFlBQVksR0FBRyxZQUFZLENBQUM7UUFDakMsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7SUFDekIsQ0FBQztJQXJERCxJQUFXLE9BQU87UUFDZCxPQUFPLElBQUksQ0FBQyxRQUFRLENBQUM7SUFDekIsQ0FBQztJQUNELElBQVcsT0FBTyxDQUFDLEtBQXdCO1FBQ3ZDLElBQUksQ0FBQyxRQUFRLEdBQUcsS0FBSyxDQUFDO1FBQ3RCLHNFQUFzRTtRQUN0RSxJQUFJLElBQUksQ0FBQyxXQUFXLEVBQUU7WUFDbEIsSUFBSSxD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QUFJLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRSxDQUFDO1FBQzNCLElBQUksQ0FBQyxjQUFjLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDL0IsSUFBSSxJQUFJLENBQUMsVUFBVSxFQUFFO1lBQ2pCLElBQUksQ0FBQyxVQUFVLENBQUMsT0FBTyxFQUFFLENBQUM7U0FDN0I7UUFDRCxJQUFJLENBQUMsbUJBQW1CLEVBQUUsQ0FBQztRQUMzQixJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7SUFDdEIsQ0FBQztDQUNKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgT25EZXN0cm95LCBFbGVtZW50UmVmLCBOZ1pvbmUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE92ZXJsYXlSZWYgfSBmcm9tICdAYW5ndWxhci9jZGsvb3ZlcmxheSc7XG5pbXBvcnQgeyBTdWJqZWN0LCBmcm9tRXZlbnQgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IFBsYXRmb3JtIH0gZnJvbSAnQGFuZ3VsYXIvY2RrL3BsYXRmb3JtJztcbmltcG9ydCB7IEZvY3VzTW9uaXRvciB9IGZyb20gJ0Bhbmd1bGFyL2Nkay9hMTF5JztcbmltcG9ydCB7IHRha2VVbnRpbCwgdGFrZSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuZXhwb3J0IHR5cGUgVGh5T3ZlcmxheVRyaWdnZXIgPSAnaG92ZXInIHwgJ2ZvY3VzJyB8ICdjbGljayc7XG5cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBUaHlPdmVybGF5RGlyZWN0aXZlQmFzZSB7XG4gICAgcHJvdGVjdGVkIGVsZW1lbnRSZWY6IEVsZW1lbnRSZWY7XG4gICAgcHJpdmF0ZSBpbml0aWFsaXplZCA9IGZhbHNlO1xuICAgIC8qKiBUcmlnZ2VyIE92ZXJsYXkgKi9cbiAgICBwcm90ZWN0ZWQgX3RyaWdnZXI6IFRoeU92ZXJsYXlUcmlnZ2VyID0gJ2NsaWNrJztcbiAgICBwdWJsaWMgZ2V0IHRyaWdnZXIoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl90cmlnZ2VyO1xuICAgIH1cbiAgICBwdWJsaWMgc2V0IHRyaWdnZXIodmFsdWU6IFRoeU92ZXJsYXlUcmlnZ2VyKSB7XG4gICAgICAgIHRoaXMuX3RyaWdnZXIgPSB2YWx1ZTtcbiAgICAgICAgLy8gVHJpZ2dlciByZWluaXRpYWxpemUgd2hlbiB0cmlnZ2VyIGNoYW5nZWQgd2hpY2ggY2FuJ3QgY29udGFpbiBmaXJzdFxuICAgICAgICBpZiAodGhpcy5pbml0aWFsaXplZCkge1xuICAgICAgICAgICAgdGhpcy5jbGVhckV2ZW50TGlzdGVuZXJzKCk7XG4gICAgICAgICAgICB0aGlzLmluaXRpYWxpemUoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByb3RlY3RlZCBvdmVybGF5UmVmOiBPdmVybGF5UmVmO1xuICAgIHByb3RlY3RlZCBtYW51YWxMaXN0ZW5lcnMgPSBuZXcgTWFwPHN0cmluZywgRXZlbnRMaXN0ZW5lck9yRXZlbnRMaXN0ZW5lck9iamVjdD4oKTtcbiAgICBwcm90ZWN0ZWQgbmdVbnN1YnNjcmliZSQgPSBuZXcgU3ViamVjdCgpO1xuICAgIHByb3RlY3RlZCBmb2N1c01vbml0b3I6IEZvY3VzTW9uaXRvcjtcbiAgICBwcm90ZWN0ZWQgcGxhdGZvcm06IFBsYXRmb3JtO1xuICAgIHByb3RlY3RlZCBuZ1pvbmU6IE5nWm9uZTtcbiAgICBwcm90ZWN0ZWQgc2hvd0RlbGF5PyA9IDA7XG4gICAgcHJvdGVjdGVkIGhpZGVEZWxheT8gPSAwO1xuICAgIHByb3RlY3RlZCB0b3VjaGVuZEhpZGVEZWxheT8gPSAwO1xuICAgIHByb3RlY3RlZCBkaXNhYmxlZCA9IGZhbHNlO1xuICAgIHByb3RlY3RlZCBzaG93VGltZW91dElkOiBudW1iZXIgfCBudWxsIHwgYW55O1xuICAgIHByb3RlY3RlZCBoaWRlVGltZW91dElkOiBudW1iZXIgfCBudWxsIHwgYW55O1xuXG4gICAgcHJvdGVjdGVkIHRvb2x0aXBQaW46IGJvb2xlYW47XG4gICAgLyoqIGNyZWF0ZSBvdmVybGF5LCB5b3UgY2FuIHVzZSBwb3BvdmVyIHNlcnZpY2Ugb3Igb3ZlcmxheSovXG4gICAgYWJzdHJhY3QgY3JlYXRlT3ZlcmxheSgpOiBPdmVybGF5UmVmO1xuICAgIGFic3RyYWN0IHNob3coZGVsYXk/OiBudW1iZXIpOiB2b2lkO1xuICAgIGFic3RyYWN0IGhpZGUoZGVsYXk/OiBudW1iZXIpOiB2b2lkO1xuXG4gICAgcHJpdmF0ZSBjbGVhckV2ZW50TGlzdGVuZXJzKCkge1xuICAgICAgICB0aGlzLm1hbnVhbExpc3RlbmVycy5mb3JFYWNoKChsaXN0ZW5lciwgZXZlbnQpID0+IHtcbiAgICAgICAgICAgIHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoZXZlbnQsIGxpc3RlbmVyKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMubWFudWFsTGlzdGVuZXJzLmNsZWFyKCk7XG4gICAgICAgIHRoaXMuZm9jdXNNb25pdG9yLnN0b3BNb25pdG9yaW5nKHRoaXMuZWxlbWVudFJlZik7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjbGVhclRpbWVyKCkge1xuICAgICAgICBpZiAodGhpcy5zaG93VGltZW91dElkKSB7XG4gICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5zaG93VGltZW91dElkKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5oaWRlVGltZW91dElkKSB7XG4gICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5oaWRlVGltZW91dElkKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0cnVjdG9yKGVsZW1lbnRSZWY6IEVsZW1lbnRSZWYsIHBsYXRmb3JtOiBQbGF0Zm9ybSwgZm9jdXNNb25pdG9yOiBGb2N1c01vbml0b3IsIG5nWm9uZTogTmdab25lKSB7XG4gICAgICAgIHRoaXMuZWxlbWVudFJlZiA9IGVsZW1lbnRSZWY7XG4gICAgICAgIHRoaXMucGxhdGZvcm0gPSBwbGF0Zm9ybTtcbiAgICAgICAgdGhpcy5mb2N1c01vbml0b3IgPSBmb2N1c01vbml0b3I7XG4gICAgICAgIHRoaXMubmdab25lID0gbmdab25lO1xuICAgIH1cblxuICAgIGluaXRpYWxpemUoKSB7XG4gICAgICAgIHRoaXMuaW5pdGlhbGl6ZWQgPSB0cnVlO1xuICAgICAgICBjb25zdCBlbGVtZW50OiBIVE1MRWxlbWVudCA9IHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50O1xuICAgICAgICBpZiAoIXRoaXMucGxhdGZvcm0uSU9TICYmICF0aGlzLnBsYXRmb3JtLkFORFJPSUQpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLnRyaWdnZXIgPT09ICdob3ZlcicpIHtcbiAgICAgICAgICAgICAgICB0aGlzLm1hbnVhbExpc3RlbmVyc1xuICAgICAgICAgICAgICAgICAgICAuc2V0KCdtb3VzZWVudGVyJywgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93KCk7XG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgIC5zZXQoJ21vdXNlbGVhdmUnLCAoZXZlbnQ6IE1vdXNlRXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGVsZW1lbnQgd2hpY2ggbW91c2UgbW92ZWQgdG9cbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG92ZXJsYXlFbGVtZW50OiBIVE1MRWxlbWVudCA9IHRoaXMub3ZlcmxheVJlZiAmJiB0aGlzLm92ZXJsYXlSZWYub3ZlcmxheUVsZW1lbnQ7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0b0VsZW1lbnQgPSBldmVudFsndG9FbGVtZW50J10gfHwgZXZlbnQucmVsYXRlZFRhcmdldDtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmIGVsZW1lbnQgd2hpY2ggbW92ZWQgdG8gaXMgaW4gb3ZlcmxheUVsZW1lbnQsIGRvbid0IGhpZGUgdG9vbHRpcFxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG92ZXJsYXlFbGVtZW50ICYmIG92ZXJsYXlFbGVtZW50LmNvbnRhaW5zICYmIG92ZXJsYXlFbGVtZW50LmNvbnRhaW5zKHRvRWxlbWVudCBhcyBFbGVtZW50KSAmJiB0aGlzLnRvb2x0aXBQaW4pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcm9tRXZlbnQob3ZlcmxheUVsZW1lbnQsICdtb3VzZWxlYXZlJylcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnBpcGUodGFrZSgxKSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmhpZGUoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaGlkZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBpZiBzaG93RGVsYXkgaXMgdG9vIGxvbmcgYW5kIG1vdXNlbGVhdmUgaW1tZWRpYXRlbHksIG92ZXJsYXlSZWYgaXMgbm90IGV4aXN0LCB3ZSBzaG91bGQgY2xlYXJUaW1lb3V0XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMub3ZlcmxheVJlZikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2xlYXJUaW1lcigpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy50cmlnZ2VyID09PSAnZm9jdXMnKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5mb2N1c01vbml0b3JcbiAgICAgICAgICAgICAgICAgICAgLm1vbml0b3IodGhpcy5lbGVtZW50UmVmKVxuICAgICAgICAgICAgICAgICAgICAucGlwZSh0YWtlVW50aWwodGhpcy5uZ1Vuc3Vic2NyaWJlJCkpXG4gICAgICAgICAgICAgICAgICAgIC5zdWJzY3JpYmUob3JpZ2luID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE5vdGUgdGhhdCB0aGUgZm9jdXMgbW9uaXRvciBydW5zIG91dHNpZGUgdGhlIEFuZ3VsYXIgem9uZS5cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghb3JpZ2luKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5uZ1pvbmUucnVuKCgpID0+IHRoaXMuaGlkZSgwKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubmdab25lLnJ1bigoKSA9PiB0aGlzLnNob3coKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIC8vIHRoaXMubWFudWFsTGlzdGVuZXJzLnNldCgnZm9jdXMnLCAoKSA9PiB0aGlzLnNob3coKSk7XG4gICAgICAgICAgICAgICAgLy8gdGhpcy5tYW51YWxMaXN0ZW5lcnMuc2V0KCdibHVyJywgKCkgPT4gdGhpcy5oaWRlKCkpO1xuICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLnRyaWdnZXIgPT09ICdjbGljaycpIHtcbiAgICAgICAgICAgICAgICB0aGlzLm1hbnVhbExpc3RlbmVycy5zZXQoJ2NsaWNrJywgKCkgPT4gdGhpcy5zaG93KCkpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYCR7dGhpcy50cmlnZ2VyfSBpcyBub3Qgc3VwcG9ydCwgb25seSBzdXBwb3J0IGhvdmVyIHwgZm9jdXMgfCBjbGlja2ApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc3QgdG91Y2hlbmRMaXN0ZW5lciA9ICgpID0+IHtcbiAgICAgICAgICAgICAgICAvLyB0aGlzLmhpZGUodGhpcy50b3VjaGVuZEhpZGVEZWxheSk7XG4gICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaGlkZSgpO1xuICAgICAgICAgICAgICAgIH0sIHRoaXMudG91Y2hlbmRIaWRlRGVsYXkpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIC8vIFJlc2VydmUgZXh0ZW5zaW9ucyBmb3IgbW9iaWxlIGluIHRoZSBmdXR1cmVcbiAgICAgICAgICAgIHRoaXMubWFudWFsTGlzdGVuZXJzXG4gICAgICAgICAgICAgICAgLnNldCgndG91Y2hlbmQnLCB0b3VjaGVuZExpc3RlbmVyKVxuICAgICAgICAgICAgICAgIC5zZXQoJ3RvdWNoY2FuY2VsJywgdG91Y2hlbmRMaXN0ZW5lcilcbiAgICAgICAgICAgICAgICAuc2V0KCd0b3VjaHN0YXJ0JywgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3coKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMubWFudWFsTGlzdGVuZXJzLmZvckVhY2goKGxpc3RlbmVyLCBldmVudCkgPT4gZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKGV2ZW50LCBsaXN0ZW5lcikpO1xuICAgIH1cblxuICAgIGRpc3Bvc2UoKTogdm9pZCB7XG4gICAgICAgIHRoaXMubmdVbnN1YnNjcmliZSQubmV4dCgpO1xuICAgICAgICB0aGlzLm5nVW5zdWJzY3JpYmUkLmNvbXBsZXRlKCk7XG4gICAgICAgIGlmICh0aGlzLm92ZXJsYXlSZWYpIHtcbiAgICAgICAgICAgIHRoaXMub3ZlcmxheVJlZi5kaXNwb3NlKCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5jbGVhckV2ZW50TGlzdGVuZXJzKCk7XG4gICAgICAgIHRoaXMuY2xlYXJUaW1lcigpO1xuICAgIH1cbn1cbiJdfQ==