import { ThyAbstractOverlayService } from 'ngx-tethys/core';
import { coerceArray } from 'ngx-tethys/util';
import { of } from 'rxjs';
import { Directionality } from '@angular/cdk/bidi';
import { coerceElement } from '@angular/cdk/coercion';
import { Overlay } from '@angular/cdk/overlay';
import { ComponentPortal } from '@angular/cdk/portal';
import { Inject, Injectable, Injector, Optional } from '@angular/core';
import { ThySlideContainerComponent } from './slide-container.component';
import { ThyInternalSlideRef, ThySlideRef } from './slide-ref.service';
import { slideDefaultConfigValue, slideUpperOverlayOptions, THY_SLIDE_DEFAULT_CONFIG, ThySlideConfig } from './slide.config';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@angular/cdk/overlay';
import * as ɵngcc2 from './slide.config';
export class ThySlideService extends ThyAbstractOverlayService {
    constructor(overlay, injector, defaultConfig) {
        const slideDefaultConfig = Object.assign({}, slideDefaultConfigValue, defaultConfig);
        super(slideUpperOverlayOptions, overlay, injector, slideDefaultConfig);
    }
    originElementAddActiveClass(config) {
        if (config.origin) {
            coerceElement(config.origin).classList.add(...coerceArray(config.originActiveClass));
        }
    }
    originElementRemoveActiveClass(config) {
        if (config.origin) {
            coerceElement(config.origin).classList.remove(...coerceArray(config.originActiveClass));
        }
    }
    buildOverlayConfig(config) {
        const defaultClasses = ['thy-slide-overlay-pane', `thy-slide-${config.from}`];
        const overlayConfig = Object.assign(Object.assign({}, this.buildBaseOverlayConfig(config, defaultClasses)), { width: config.width });
        return overlayConfig;
    }
    attachUpperOverlayContainer(overlay, config) {
        const userInjector = config && config.viewContainerRef && config.viewContainerRef.injector;
        const injector = Injector.create({
            parent: userInjector || this.injector,
            providers: [{ provide: ThySlideConfig, useValue: config }]
        });
        const containerPortal = new ComponentPortal(ThySlideContainerComponent, config.viewContainerRef, injector);
        const containerRef = overlay.attach(containerPortal);
        return containerRef.instance;
    }
    createUpperOverlayRef(overlayRef, containerInstance, config) {
        return new ThyInternalSlideRef(overlayRef, containerInstance, config);
    }
    createInjector(config, overlayRef, containerInstance) {
        const userInjector = config && config.viewContainerRef && config.viewContainerRef.injector;
        const injectionTokens = [
            { provide: ThySlideContainerComponent, useValue: containerInstance },
            { provide: ThySlideRef, useValue: overlayRef }
        ];
        if (config.direction && (!userInjector || !userInjector.get(Directionality, null))) {
            injectionTokens.push({
                provide: Directionality,
                useValue: {
                    value: config.direction,
                    change: of()
                }
            });
        }
        return Injector.create({ parent: userInjector || this.injector, providers: injectionTokens });
    }
    overlayIsOpened(config) {
        const openedOverlay = this.getUpperOverlayById(config.id);
        this.close(openedOverlay);
        return openedOverlay;
    }
    open(componentOrTemplateRef, config) {
        if (this.overlayIsOpened(config)) {
            return;
        }
        const slideRef = this.openUpperOverlay(componentOrTemplateRef, config);
        this.originElementAddActiveClass(slideRef.containerInstance.config);
        slideRef.afterClosed().subscribe(() => {
            this.originElementRemoveActiveClass(slideRef.containerInstance.config);
        });
        return slideRef;
    }
    ngOnDestroy() {
        this.dispose();
    }
}
ThySlideService.ɵfac = function ThySlideService_Factory(t) { return new (t || ThySlideService)(ɵngcc0.ɵɵinject(ɵngcc1.Overlay), ɵngcc0.ɵɵinject(ɵngcc0.Injector), ɵngcc0.ɵɵinject(THY_SLIDE_DEFAULT_CONFIG, 8)); };
ThySlideService.ɵprov = ɵngcc0.ɵɵdefineInjectable({ token: ThySlideService, factory: ThySlideService.ɵfac });
ThySlideService.ctorParameters = () => [
    { type: Overlay },
    { type: Injector },
    { type: ThySlideConfig, decorators: [{ type: Optional }, { type: Inject, args: [THY_SLIDE_DEFAULT_CONFIG,] }] }
];
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(ThySlideService, [{
        type: Injectable
    }], function () { return [{ type: ɵngcc1.Overlay }, { type: ɵngcc0.Injector }, { type: ɵngcc2.ThySlideConfig, decorators: [{
                type: Optional
            }, {
                type: Inject,
                args: [THY_SLIDE_DEFAULT_CONFIG]
            }] }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2xpZGUuc2VydmljZS5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL3NsaWRlL3NsaWRlLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFxRCx5QkFBeUIsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQy9HLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUM5QyxPQUFPLEVBQUUsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRTFCLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNuRCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDdEQsT0FBTyxFQUFFLE9BQU8sRUFBNkIsTUFBTSxzQkFBc0IsQ0FBQztBQUMxRSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDdEQsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFhLFFBQVEsRUFBa0IsTUFBTSxlQUFlLENBQUM7QUFFbEcsT0FBTyxFQUFFLDBCQUEwQixFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFDekUsT0FBTyxFQUFFLG1CQUFtQixFQUFFLFdBQVcsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3ZFLE9BQU8sRUFBRSx1QkFBdUIsRUFBRSx3QkFBd0IsRUFBRSx3QkFBd0IsRUFBRSxjQUFjLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQzs7OztBQUc3SCxNQUFNLE9BQU8sZUFBZ0IsU0FBUSx5QkFBcUU7QUFBRyxJQXdFekcsWUFDSSxPQUFnQixFQUNoQixRQUFrQixFQUdsQixhQUE2QjtBQUNsQyxRQUNLLE1BQU0sa0JBQWtCLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsdUJBQXVCLEVBQUUsYUFBYSxDQUFDLENBQUM7QUFDN0YsUUFBUSxLQUFLLENBQUMsd0JBQXdCLEVBQUUsT0FBTyxFQUFFLFFBQVEsRUFBRSxrQkFBa0IsQ0FBQyxD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QyxDQUFDO0FBQ25ELElBQUksQ0FBQztBQUNMLElBQ0ksV0FBVztBQUNmLFFBQVEsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO0FBQ3ZCLElBQUksQ0FBQztBQUNMOzJDQXRHQyxVQUFVOzZHQUNUO0FBQUM7QUFBeUMsWUFUbkMsT0FBTztBQUFJLFlBRVMsUUFBUTtBQUFJLFlBSTZDLGNBQWMsdUJBOEUzRixRQUFRLFlBQ1IsTUFBTSxTQUFDLHdCQUF3QjtBQUNsQzs7Ozs7Ozs7a0NBQUU7QUFBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudFR5cGVPclRlbXBsYXRlUmVmLCBUaHlBYnN0cmFjdE92ZXJsYXlSZWYsIFRoeUFic3RyYWN0T3ZlcmxheVNlcnZpY2UgfSBmcm9tICduZ3gtdGV0aHlzL2NvcmUnO1xuaW1wb3J0IHsgY29lcmNlQXJyYXkgfSBmcm9tICduZ3gtdGV0aHlzL3V0aWwnO1xuaW1wb3J0IHsgb2YgfSBmcm9tICdyeGpzJztcblxuaW1wb3J0IHsgRGlyZWN0aW9uYWxpdHkgfSBmcm9tICdAYW5ndWxhci9jZGsvYmlkaSc7XG5pbXBvcnQgeyBjb2VyY2VFbGVtZW50IH0gZnJvbSAnQGFuZ3VsYXIvY2RrL2NvZXJjaW9uJztcbmltcG9ydCB7IE92ZXJsYXksIE92ZXJsYXlDb25maWcsIE92ZXJsYXlSZWYgfSBmcm9tICdAYW5ndWxhci9jZGsvb3ZlcmxheSc7XG5pbXBvcnQgeyBDb21wb25lbnRQb3J0YWwgfSBmcm9tICdAYW5ndWxhci9jZGsvcG9ydGFsJztcbmltcG9ydCB7IEluamVjdCwgSW5qZWN0YWJsZSwgSW5qZWN0b3IsIE9uRGVzdHJveSwgT3B0aW9uYWwsIFN0YXRpY1Byb3ZpZGVyIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbmltcG9ydCB7IFRoeVNsaWRlQ29udGFpbmVyQ29tcG9uZW50IH0gZnJvbSAnLi9zbGlkZS1jb250YWluZXIuY29tcG9uZW50JztcbmltcG9ydCB7IFRoeUludGVybmFsU2xpZGVSZWYsIFRoeVNsaWRlUmVmIH0gZnJvbSAnLi9zbGlkZS1yZWYuc2VydmljZSc7XG5pbXBvcnQgeyBzbGlkZURlZmF1bHRDb25maWdWYWx1ZSwgc2xpZGVVcHBlck92ZXJsYXlPcHRpb25zLCBUSFlfU0xJREVfREVGQVVMVF9DT05GSUcsIFRoeVNsaWRlQ29uZmlnIH0gZnJvbSAnLi9zbGlkZS5jb25maWcnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgVGh5U2xpZGVTZXJ2aWNlIGV4dGVuZHMgVGh5QWJzdHJhY3RPdmVybGF5U2VydmljZTxUaHlTbGlkZUNvbmZpZywgVGh5U2xpZGVDb250YWluZXJDb21wb25lbnQ+IGltcGxlbWVudHMgT25EZXN0cm95IHtcbiAgICBwcml2YXRlIG9yaWdpbkVsZW1lbnRBZGRBY3RpdmVDbGFzcyhjb25maWc6IFRoeVNsaWRlQ29uZmlnKSB7XG4gICAgICAgIGlmIChjb25maWcub3JpZ2luKSB7XG4gICAgICAgICAgICBjb2VyY2VFbGVtZW50PEhUTUxFbGVtZW50Pihjb25maWcub3JpZ2luKS5jbGFzc0xpc3QuYWRkKC4uLmNvZXJjZUFycmF5KGNvbmZpZy5vcmlnaW5BY3RpdmVDbGFzcykpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvcmlnaW5FbGVtZW50UmVtb3ZlQWN0aXZlQ2xhc3MoY29uZmlnOiBUaHlTbGlkZUNvbmZpZykge1xuICAgICAgICBpZiAoY29uZmlnLm9yaWdpbikge1xuICAgICAgICAgICAgY29lcmNlRWxlbWVudDxIVE1MRWxlbWVudD4oY29uZmlnLm9yaWdpbikuY2xhc3NMaXN0LnJlbW92ZSguLi5jb2VyY2VBcnJheShjb25maWcub3JpZ2luQWN0aXZlQ2xhc3MpKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByb3RlY3RlZCBidWlsZE92ZXJsYXlDb25maWcoY29uZmlnOiBUaHlTbGlkZUNvbmZpZyk6IE92ZXJsYXlDb25maWcge1xuICAgICAgICBjb25zdCBkZWZhdWx0Q2xhc3Nlczogc3RyaW5nW10gPSBbJ3RoeS1zbGlkZS1vdmVybGF5LXBhbmUnLCBgdGh5LXNsaWRlLSR7Y29uZmlnLmZyb219YF07XG4gICAgICAgIGNvbnN0IG92ZXJsYXlDb25maWcgPSB7XG4gICAgICAgICAgICAuLi50aGlzLmJ1aWxkQmFzZU92ZXJsYXlDb25maWcoY29uZmlnLCBkZWZhdWx0Q2xhc3NlcyksXG4gICAgICAgICAgICB3aWR0aDogY29uZmlnLndpZHRoXG4gICAgICAgIH07XG4gICAgICAgIHJldHVybiBvdmVybGF5Q29uZmlnO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBhdHRhY2hVcHBlck92ZXJsYXlDb250YWluZXIob3ZlcmxheTogT3ZlcmxheVJlZiwgY29uZmlnOiBUaHlTbGlkZUNvbmZpZyk6IFRoeVNsaWRlQ29udGFpbmVyQ29tcG9uZW50IHtcbiAgICAgICAgY29uc3QgdXNlckluamVjdG9yID0gY29uZmlnICYmIGNvbmZpZy52aWV3Q29udGFpbmVyUmVmICYmIGNvbmZpZy52aWV3Q29udGFpbmVyUmVmLmluamVjdG9yO1xuICAgICAgICBjb25zdCBpbmplY3RvciA9IEluamVjdG9yLmNyZWF0ZSh7XG4gICAgICAgICAgICBwYXJlbnQ6IHVzZXJJbmplY3RvciB8fCB0aGlzLmluamVjdG9yLFxuICAgICAgICAgICAgcHJvdmlkZXJzOiBbeyBwcm92aWRlOiBUaHlTbGlkZUNvbmZpZywgdXNlVmFsdWU6IGNvbmZpZyB9XVxuICAgICAgICB9KTtcbiAgICAgICAgY29uc3QgY29udGFpbmVyUG9ydGFsID0gbmV3IENvbXBvbmVudFBvcnRhbChUaHlTbGlkZUNvbnRhaW5lckNvbXBvbmVudCwgY29uZmlnLnZpZXdDb250YWluZXJSZWYsIGluamVjdG9yKTtcbiAgICAgICAgY29uc3QgY29udGFpbmVyUmVmID0gb3ZlcmxheS5hdHRhY2g8VGh5U2xpZGVDb250YWluZXJDb21wb25lbnQ+KGNvbnRhaW5lclBvcnRhbCk7XG4gICAgICAgIHJldHVybiBjb250YWluZXJSZWYuaW5zdGFuY2U7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGNyZWF0ZVVwcGVyT3ZlcmxheVJlZjxUPihcbiAgICAgICAgb3ZlcmxheVJlZjogT3ZlcmxheVJlZixcbiAgICAgICAgY29udGFpbmVySW5zdGFuY2U6IFRoeVNsaWRlQ29udGFpbmVyQ29tcG9uZW50LFxuICAgICAgICBjb25maWc6IFRoeVNsaWRlQ29uZmlnXG4gICAgKTogVGh5QWJzdHJhY3RPdmVybGF5UmVmPFQsIFRoeVNsaWRlQ29udGFpbmVyQ29tcG9uZW50LCBhbnk+IHtcbiAgICAgICAgcmV0dXJuIG5ldyBUaHlJbnRlcm5hbFNsaWRlUmVmKG92ZXJsYXlSZWYsIGNvbnRhaW5lckluc3RhbmNlLCBjb25maWcpO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBjcmVhdGVJbmplY3RvcjxUPihcbiAgICAgICAgY29uZmlnOiBUaHlTbGlkZUNvbmZpZyxcbiAgICAgICAgb3ZlcmxheVJlZjogVGh5QWJzdHJhY3RPdmVybGF5UmVmPFQsIFRoeVNsaWRlQ29udGFpbmVyQ29tcG9uZW50LCBhbnk+LFxuICAgICAgICBjb250YWluZXJJbnN0YW5jZTogVGh5U2xpZGVDb250YWluZXJDb21wb25lbnRcbiAgICApOiBJbmplY3RvciB7XG4gICAgICAgIGNvbnN0IHVzZXJJbmplY3RvciA9IGNvbmZpZyAmJiBjb25maWcudmlld0NvbnRhaW5lclJlZiAmJiBjb25maWcudmlld0NvbnRhaW5lclJlZi5pbmplY3RvcjtcblxuICAgICAgICBjb25zdCBpbmplY3Rpb25Ub2tlbnM6IFN0YXRpY1Byb3ZpZGVyW10gPSBbXG4gICAgICAgICAgICB7IHByb3ZpZGU6IFRoeVNsaWRlQ29udGFpbmVyQ29tcG9uZW50LCB1c2VWYWx1ZTogY29udGFpbmVySW5zdGFuY2UgfSxcbiAgICAgICAgICAgIHsgcHJvdmlkZTogVGh5U2xpZGVSZWYsIHVzZVZhbHVlOiBvdmVybGF5UmVmIH1cbiAgICAgICAgXTtcblxuICAgICAgICBpZiAoY29uZmlnLmRpcmVjdGlvbiAmJiAoIXVzZXJJbmplY3RvciB8fCAhdXNlckluamVjdG9yLmdldDxEaXJlY3Rpb25hbGl0eSB8IG51bGw+KERpcmVjdGlvbmFsaXR5LCBudWxsKSkpIHtcbiAgICAgICAgICAgIGluamVjdGlvblRva2Vucy5wdXNoKHtcbiAgICAgICAgICAgICAgICBwcm92aWRlOiBEaXJlY3Rpb25hbGl0eSxcbiAgICAgICAgICAgICAgICB1c2VWYWx1ZToge1xuICAgICAgICAgICAgICAgICAgICB2YWx1ZTogY29uZmlnLmRpcmVjdGlvbixcbiAgICAgICAgICAgICAgICAgICAgY2hhbmdlOiBvZigpXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gSW5qZWN0b3IuY3JlYXRlKHsgcGFyZW50OiB1c2VySW5qZWN0b3IgfHwgdGhpcy5pbmplY3RvciwgcHJvdmlkZXJzOiBpbmplY3Rpb25Ub2tlbnMgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvdmVybGF5SXNPcGVuZWQoY29uZmlnOiBUaHlTbGlkZUNvbmZpZykge1xuICAgICAgICBjb25zdCBvcGVuZWRPdmVybGF5ID0gdGhpcy5nZXRVcHBlck92ZXJsYXlCeUlkKGNvbmZpZy5pZCk7XG4gICAgICAgIHRoaXMuY2xvc2Uob3BlbmVkT3ZlcmxheSk7XG4gICAgICAgIHJldHVybiBvcGVuZWRPdmVybGF5O1xuICAgIH1cblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBvdmVybGF5OiBPdmVybGF5LFxuICAgICAgICBpbmplY3RvcjogSW5qZWN0b3IsXG4gICAgICAgIEBPcHRpb25hbCgpXG4gICAgICAgIEBJbmplY3QoVEhZX1NMSURFX0RFRkFVTFRfQ09ORklHKVxuICAgICAgICBkZWZhdWx0Q29uZmlnOiBUaHlTbGlkZUNvbmZpZ1xuICAgICkge1xuICAgICAgICBjb25zdCBzbGlkZURlZmF1bHRDb25maWcgPSBPYmplY3QuYXNzaWduKHt9LCBzbGlkZURlZmF1bHRDb25maWdWYWx1ZSwgZGVmYXVsdENvbmZpZyk7XG4gICAgICAgIHN1cGVyKHNsaWRlVXBwZXJPdmVybGF5T3B0aW9ucywgb3ZlcmxheSwgaW5qZWN0b3IsIHNsaWRlRGVmYXVsdENvbmZpZyk7XG4gICAgfVxuXG4gICAgb3BlbjxULCBURGF0YSA9IHVuZGVmaW5lZCwgVFJlc3VsdCA9IHVuZGVmaW5lZD4oXG4gICAgICAgIGNvbXBvbmVudE9yVGVtcGxhdGVSZWY6IENvbXBvbmVudFR5cGVPclRlbXBsYXRlUmVmPFQ+LFxuICAgICAgICBjb25maWc6IFRoeVNsaWRlQ29uZmlnXG4gICAgKTogVGh5U2xpZGVSZWY8VCwgVFJlc3VsdD4ge1xuICAgICAgICBpZiAodGhpcy5vdmVybGF5SXNPcGVuZWQoY29uZmlnKSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHNsaWRlUmVmID0gdGhpcy5vcGVuVXBwZXJPdmVybGF5KGNvbXBvbmVudE9yVGVtcGxhdGVSZWYsIGNvbmZpZyk7XG4gICAgICAgIHRoaXMub3JpZ2luRWxlbWVudEFkZEFjdGl2ZUNsYXNzKHNsaWRlUmVmLmNvbnRhaW5lckluc3RhbmNlLmNvbmZpZyk7XG4gICAgICAgIHNsaWRlUmVmLmFmdGVyQ2xvc2VkKCkuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgICAgICAgIHRoaXMub3JpZ2luRWxlbWVudFJlbW92ZUFjdGl2ZUNsYXNzKHNsaWRlUmVmLmNvbnRhaW5lckluc3RhbmNlLmNvbmZpZyk7XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gc2xpZGVSZWYgYXMgVGh5U2xpZGVSZWY8VCwgVFJlc3VsdD47XG4gICAgfVxuXG4gICAgbmdPbkRlc3Ryb3koKSB7XG4gICAgICAgIHRoaXMuZGlzcG9zZSgpO1xuICAgIH1cbn1cbiJdfQ==