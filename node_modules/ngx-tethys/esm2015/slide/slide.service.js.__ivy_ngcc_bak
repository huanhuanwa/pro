import { ThyAbstractOverlayService } from 'ngx-tethys/core';
import { coerceArray } from 'ngx-tethys/util';
import { of } from 'rxjs';
import { Directionality } from '@angular/cdk/bidi';
import { coerceElement } from '@angular/cdk/coercion';
import { Overlay } from '@angular/cdk/overlay';
import { ComponentPortal } from '@angular/cdk/portal';
import { Inject, Injectable, Injector, Optional } from '@angular/core';
import { ThySlideContainerComponent } from './slide-container.component';
import { ThyInternalSlideRef, ThySlideRef } from './slide-ref.service';
import { slideDefaultConfigValue, slideUpperOverlayOptions, THY_SLIDE_DEFAULT_CONFIG, ThySlideConfig } from './slide.config';
export class ThySlideService extends ThyAbstractOverlayService {
    constructor(overlay, injector, defaultConfig) {
        const slideDefaultConfig = Object.assign({}, slideDefaultConfigValue, defaultConfig);
        super(slideUpperOverlayOptions, overlay, injector, slideDefaultConfig);
    }
    originElementAddActiveClass(config) {
        if (config.origin) {
            coerceElement(config.origin).classList.add(...coerceArray(config.originActiveClass));
        }
    }
    originElementRemoveActiveClass(config) {
        if (config.origin) {
            coerceElement(config.origin).classList.remove(...coerceArray(config.originActiveClass));
        }
    }
    buildOverlayConfig(config) {
        const defaultClasses = ['thy-slide-overlay-pane', `thy-slide-${config.from}`];
        const overlayConfig = Object.assign(Object.assign({}, this.buildBaseOverlayConfig(config, defaultClasses)), { width: config.width });
        return overlayConfig;
    }
    attachUpperOverlayContainer(overlay, config) {
        const userInjector = config && config.viewContainerRef && config.viewContainerRef.injector;
        const injector = Injector.create({
            parent: userInjector || this.injector,
            providers: [{ provide: ThySlideConfig, useValue: config }]
        });
        const containerPortal = new ComponentPortal(ThySlideContainerComponent, config.viewContainerRef, injector);
        const containerRef = overlay.attach(containerPortal);
        return containerRef.instance;
    }
    createUpperOverlayRef(overlayRef, containerInstance, config) {
        return new ThyInternalSlideRef(overlayRef, containerInstance, config);
    }
    createInjector(config, overlayRef, containerInstance) {
        const userInjector = config && config.viewContainerRef && config.viewContainerRef.injector;
        const injectionTokens = [
            { provide: ThySlideContainerComponent, useValue: containerInstance },
            { provide: ThySlideRef, useValue: overlayRef }
        ];
        if (config.direction && (!userInjector || !userInjector.get(Directionality, null))) {
            injectionTokens.push({
                provide: Directionality,
                useValue: {
                    value: config.direction,
                    change: of()
                }
            });
        }
        return Injector.create({ parent: userInjector || this.injector, providers: injectionTokens });
    }
    overlayIsOpened(config) {
        const openedOverlay = this.getUpperOverlayById(config.id);
        this.close(openedOverlay);
        return openedOverlay;
    }
    open(componentOrTemplateRef, config) {
        if (this.overlayIsOpened(config)) {
            return;
        }
        const slideRef = this.openUpperOverlay(componentOrTemplateRef, config);
        this.originElementAddActiveClass(slideRef.containerInstance.config);
        slideRef.afterClosed().subscribe(() => {
            this.originElementRemoveActiveClass(slideRef.containerInstance.config);
        });
        return slideRef;
    }
    ngOnDestroy() {
        this.dispose();
    }
}
ThySlideService.decorators = [
    { type: Injectable }
];
ThySlideService.ctorParameters = () => [
    { type: Overlay },
    { type: Injector },
    { type: ThySlideConfig, decorators: [{ type: Optional }, { type: Inject, args: [THY_SLIDE_DEFAULT_CONFIG,] }] }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2xpZGUuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zbGlkZS9zbGlkZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBcUQseUJBQXlCLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMvRyxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDOUMsT0FBTyxFQUFFLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUUxQixPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDbkQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQ3RELE9BQU8sRUFBRSxPQUFPLEVBQTZCLE1BQU0sc0JBQXNCLENBQUM7QUFDMUUsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3RELE9BQU8sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBYSxRQUFRLEVBQWtCLE1BQU0sZUFBZSxDQUFDO0FBRWxHLE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBQ3pFLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxXQUFXLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN2RSxPQUFPLEVBQUUsdUJBQXVCLEVBQUUsd0JBQXdCLEVBQUUsd0JBQXdCLEVBQUUsY0FBYyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFHN0gsTUFBTSxPQUFPLGVBQWdCLFNBQVEseUJBQXFFO0lBd0V0RyxZQUNJLE9BQWdCLEVBQ2hCLFFBQWtCLEVBR2xCLGFBQTZCO1FBRTdCLE1BQU0sa0JBQWtCLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsdUJBQXVCLEVBQUUsYUFBYSxDQUFDLENBQUM7UUFDckYsS0FBSyxDQUFDLHdCQUF3QixFQUFFLE9BQU8sRUFBRSxRQUFRLEVBQUUsa0JBQWtCLENBQUMsQ0FB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QVMsRUFBRSxlQUFlLEVBQUUsQ0FBQyxDQUFDO0lBQ2xHLENBQUM7SUFFTyxlQUFlLENBQUMsTUFBc0I7UUFDMUMsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLG1CQUFtQixDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUMxRCxJQUFJLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQzFCLE9BQU8sYUFBYSxDQUFDO0lBQ3pCLENBQUM7SUFhRCxJQUFJLENBQ0Esc0JBQXFELEVBQ3JELE1BQXNCO1FBRXRCLElBQUksSUFBSSxDQUFDLGVBQWUsQ0FBQyxNQUFNLENBQUMsRUFBRTtZQUM5QixPQUFPO1NBQ1Y7UUFDRCxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsc0JBQXNCLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDdkUsSUFBSSxDQUFDLDJCQUEyQixDQUFDLFFBQVEsQ0FBQyxpQkFBaUIsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUNwRSxRQUFRLENBQUMsV0FBVyxFQUFFLENBQUMsU0FBUyxDQUFDLEdBQUcsRUFBRTtZQUNsQyxJQUFJLENBQUMsOEJBQThCLENBQUMsUUFBUSxDQUFDLGlCQUFpQixDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQzNFLENBQUMsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxRQUFtQyxDQUFDO0lBQy9DLENBQUM7SUFFRCxXQUFXO1FBQ1AsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO0lBQ25CLENBQUM7OztZQXJHSixVQUFVOzs7WUFSRixPQUFPO1lBRWEsUUFBUTtZQUlpRCxjQUFjLHVCQThFM0YsUUFBUSxZQUNSLE1BQU0sU0FBQyx3QkFBd0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnRUeXBlT3JUZW1wbGF0ZVJlZiwgVGh5QWJzdHJhY3RPdmVybGF5UmVmLCBUaHlBYnN0cmFjdE92ZXJsYXlTZXJ2aWNlIH0gZnJvbSAnbmd4LXRldGh5cy9jb3JlJztcbmltcG9ydCB7IGNvZXJjZUFycmF5IH0gZnJvbSAnbmd4LXRldGh5cy91dGlsJztcbmltcG9ydCB7IG9mIH0gZnJvbSAncnhqcyc7XG5cbmltcG9ydCB7IERpcmVjdGlvbmFsaXR5IH0gZnJvbSAnQGFuZ3VsYXIvY2RrL2JpZGknO1xuaW1wb3J0IHsgY29lcmNlRWxlbWVudCB9IGZyb20gJ0Bhbmd1bGFyL2Nkay9jb2VyY2lvbic7XG5pbXBvcnQgeyBPdmVybGF5LCBPdmVybGF5Q29uZmlnLCBPdmVybGF5UmVmIH0gZnJvbSAnQGFuZ3VsYXIvY2RrL292ZXJsYXknO1xuaW1wb3J0IHsgQ29tcG9uZW50UG9ydGFsIH0gZnJvbSAnQGFuZ3VsYXIvY2RrL3BvcnRhbCc7XG5pbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUsIEluamVjdG9yLCBPbkRlc3Ryb3ksIE9wdGlvbmFsLCBTdGF0aWNQcm92aWRlciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuXG5pbXBvcnQgeyBUaHlTbGlkZUNvbnRhaW5lckNvbXBvbmVudCB9IGZyb20gJy4vc2xpZGUtY29udGFpbmVyLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBUaHlJbnRlcm5hbFNsaWRlUmVmLCBUaHlTbGlkZVJlZiB9IGZyb20gJy4vc2xpZGUtcmVmLnNlcnZpY2UnO1xuaW1wb3J0IHsgc2xpZGVEZWZhdWx0Q29uZmlnVmFsdWUsIHNsaWRlVXBwZXJPdmVybGF5T3B0aW9ucywgVEhZX1NMSURFX0RFRkFVTFRfQ09ORklHLCBUaHlTbGlkZUNvbmZpZyB9IGZyb20gJy4vc2xpZGUuY29uZmlnJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFRoeVNsaWRlU2VydmljZSBleHRlbmRzIFRoeUFic3RyYWN0T3ZlcmxheVNlcnZpY2U8VGh5U2xpZGVDb25maWcsIFRoeVNsaWRlQ29udGFpbmVyQ29tcG9uZW50PiBpbXBsZW1lbnRzIE9uRGVzdHJveSB7XG4gICAgcHJpdmF0ZSBvcmlnaW5FbGVtZW50QWRkQWN0aXZlQ2xhc3MoY29uZmlnOiBUaHlTbGlkZUNvbmZpZykge1xuICAgICAgICBpZiAoY29uZmlnLm9yaWdpbikge1xuICAgICAgICAgICAgY29lcmNlRWxlbWVudDxIVE1MRWxlbWVudD4oY29uZmlnLm9yaWdpbikuY2xhc3NMaXN0LmFkZCguLi5jb2VyY2VBcnJheShjb25maWcub3JpZ2luQWN0aXZlQ2xhc3MpKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgb3JpZ2luRWxlbWVudFJlbW92ZUFjdGl2ZUNsYXNzKGNvbmZpZzogVGh5U2xpZGVDb25maWcpIHtcbiAgICAgICAgaWYgKGNvbmZpZy5vcmlnaW4pIHtcbiAgICAgICAgICAgIGNvZXJjZUVsZW1lbnQ8SFRNTEVsZW1lbnQ+KGNvbmZpZy5vcmlnaW4pLmNsYXNzTGlzdC5yZW1vdmUoLi4uY29lcmNlQXJyYXkoY29uZmlnLm9yaWdpbkFjdGl2ZUNsYXNzKSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgYnVpbGRPdmVybGF5Q29uZmlnKGNvbmZpZzogVGh5U2xpZGVDb25maWcpOiBPdmVybGF5Q29uZmlnIHtcbiAgICAgICAgY29uc3QgZGVmYXVsdENsYXNzZXM6IHN0cmluZ1tdID0gWyd0aHktc2xpZGUtb3ZlcmxheS1wYW5lJywgYHRoeS1zbGlkZS0ke2NvbmZpZy5mcm9tfWBdO1xuICAgICAgICBjb25zdCBvdmVybGF5Q29uZmlnID0ge1xuICAgICAgICAgICAgLi4udGhpcy5idWlsZEJhc2VPdmVybGF5Q29uZmlnKGNvbmZpZywgZGVmYXVsdENsYXNzZXMpLFxuICAgICAgICAgICAgd2lkdGg6IGNvbmZpZy53aWR0aFxuICAgICAgICB9O1xuICAgICAgICByZXR1cm4gb3ZlcmxheUNvbmZpZztcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgYXR0YWNoVXBwZXJPdmVybGF5Q29udGFpbmVyKG92ZXJsYXk6IE92ZXJsYXlSZWYsIGNvbmZpZzogVGh5U2xpZGVDb25maWcpOiBUaHlTbGlkZUNvbnRhaW5lckNvbXBvbmVudCB7XG4gICAgICAgIGNvbnN0IHVzZXJJbmplY3RvciA9IGNvbmZpZyAmJiBjb25maWcudmlld0NvbnRhaW5lclJlZiAmJiBjb25maWcudmlld0NvbnRhaW5lclJlZi5pbmplY3RvcjtcbiAgICAgICAgY29uc3QgaW5qZWN0b3IgPSBJbmplY3Rvci5jcmVhdGUoe1xuICAgICAgICAgICAgcGFyZW50OiB1c2VySW5qZWN0b3IgfHwgdGhpcy5pbmplY3RvcixcbiAgICAgICAgICAgIHByb3ZpZGVyczogW3sgcHJvdmlkZTogVGh5U2xpZGVDb25maWcsIHVzZVZhbHVlOiBjb25maWcgfV1cbiAgICAgICAgfSk7XG4gICAgICAgIGNvbnN0IGNvbnRhaW5lclBvcnRhbCA9IG5ldyBDb21wb25lbnRQb3J0YWwoVGh5U2xpZGVDb250YWluZXJDb21wb25lbnQsIGNvbmZpZy52aWV3Q29udGFpbmVyUmVmLCBpbmplY3Rvcik7XG4gICAgICAgIGNvbnN0IGNvbnRhaW5lclJlZiA9IG92ZXJsYXkuYXR0YWNoPFRoeVNsaWRlQ29udGFpbmVyQ29tcG9uZW50Pihjb250YWluZXJQb3J0YWwpO1xuICAgICAgICByZXR1cm4gY29udGFpbmVyUmVmLmluc3RhbmNlO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBjcmVhdGVVcHBlck92ZXJsYXlSZWY8VD4oXG4gICAgICAgIG92ZXJsYXlSZWY6IE92ZXJsYXlSZWYsXG4gICAgICAgIGNvbnRhaW5lckluc3RhbmNlOiBUaHlTbGlkZUNvbnRhaW5lckNvbXBvbmVudCxcbiAgICAgICAgY29uZmlnOiBUaHlTbGlkZUNvbmZpZ1xuICAgICk6IFRoeUFic3RyYWN0T3ZlcmxheVJlZjxULCBUaHlTbGlkZUNvbnRhaW5lckNvbXBvbmVudCwgYW55PiB7XG4gICAgICAgIHJldHVybiBuZXcgVGh5SW50ZXJuYWxTbGlkZVJlZihvdmVybGF5UmVmLCBjb250YWluZXJJbnN0YW5jZSwgY29uZmlnKTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgY3JlYXRlSW5qZWN0b3I8VD4oXG4gICAgICAgIGNvbmZpZzogVGh5U2xpZGVDb25maWcsXG4gICAgICAgIG92ZXJsYXlSZWY6IFRoeUFic3RyYWN0T3ZlcmxheVJlZjxULCBUaHlTbGlkZUNvbnRhaW5lckNvbXBvbmVudCwgYW55PixcbiAgICAgICAgY29udGFpbmVySW5zdGFuY2U6IFRoeVNsaWRlQ29udGFpbmVyQ29tcG9uZW50XG4gICAgKTogSW5qZWN0b3Ige1xuICAgICAgICBjb25zdCB1c2VySW5qZWN0b3IgPSBjb25maWcgJiYgY29uZmlnLnZpZXdDb250YWluZXJSZWYgJiYgY29uZmlnLnZpZXdDb250YWluZXJSZWYuaW5qZWN0b3I7XG5cbiAgICAgICAgY29uc3QgaW5qZWN0aW9uVG9rZW5zOiBTdGF0aWNQcm92aWRlcltdID0gW1xuICAgICAgICAgICAgeyBwcm92aWRlOiBUaHlTbGlkZUNvbnRhaW5lckNvbXBvbmVudCwgdXNlVmFsdWU6IGNvbnRhaW5lckluc3RhbmNlIH0sXG4gICAgICAgICAgICB7IHByb3ZpZGU6IFRoeVNsaWRlUmVmLCB1c2VWYWx1ZTogb3ZlcmxheVJlZiB9XG4gICAgICAgIF07XG5cbiAgICAgICAgaWYgKGNvbmZpZy5kaXJlY3Rpb24gJiYgKCF1c2VySW5qZWN0b3IgfHwgIXVzZXJJbmplY3Rvci5nZXQ8RGlyZWN0aW9uYWxpdHkgfCBudWxsPihEaXJlY3Rpb25hbGl0eSwgbnVsbCkpKSB7XG4gICAgICAgICAgICBpbmplY3Rpb25Ub2tlbnMucHVzaCh7XG4gICAgICAgICAgICAgICAgcHJvdmlkZTogRGlyZWN0aW9uYWxpdHksXG4gICAgICAgICAgICAgICAgdXNlVmFsdWU6IHtcbiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGNvbmZpZy5kaXJlY3Rpb24sXG4gICAgICAgICAgICAgICAgICAgIGNoYW5nZTogb2YoKVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIEluamVjdG9yLmNyZWF0ZSh7IHBhcmVudDogdXNlckluamVjdG9yIHx8IHRoaXMuaW5qZWN0b3IsIHByb3ZpZGVyczogaW5qZWN0aW9uVG9rZW5zIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgb3ZlcmxheUlzT3BlbmVkKGNvbmZpZzogVGh5U2xpZGVDb25maWcpIHtcbiAgICAgICAgY29uc3Qgb3BlbmVkT3ZlcmxheSA9IHRoaXMuZ2V0VXBwZXJPdmVybGF5QnlJZChjb25maWcuaWQpO1xuICAgICAgICB0aGlzLmNsb3NlKG9wZW5lZE92ZXJsYXkpO1xuICAgICAgICByZXR1cm4gb3BlbmVkT3ZlcmxheTtcbiAgICB9XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgb3ZlcmxheTogT3ZlcmxheSxcbiAgICAgICAgaW5qZWN0b3I6IEluamVjdG9yLFxuICAgICAgICBAT3B0aW9uYWwoKVxuICAgICAgICBASW5qZWN0KFRIWV9TTElERV9ERUZBVUxUX0NPTkZJRylcbiAgICAgICAgZGVmYXVsdENvbmZpZzogVGh5U2xpZGVDb25maWdcbiAgICApIHtcbiAgICAgICAgY29uc3Qgc2xpZGVEZWZhdWx0Q29uZmlnID0gT2JqZWN0LmFzc2lnbih7fSwgc2xpZGVEZWZhdWx0Q29uZmlnVmFsdWUsIGRlZmF1bHRDb25maWcpO1xuICAgICAgICBzdXBlcihzbGlkZVVwcGVyT3ZlcmxheU9wdGlvbnMsIG92ZXJsYXksIGluamVjdG9yLCBzbGlkZURlZmF1bHRDb25maWcpO1xuICAgIH1cblxuICAgIG9wZW48VCwgVERhdGEgPSB1bmRlZmluZWQsIFRSZXN1bHQgPSB1bmRlZmluZWQ+KFxuICAgICAgICBjb21wb25lbnRPclRlbXBsYXRlUmVmOiBDb21wb25lbnRUeXBlT3JUZW1wbGF0ZVJlZjxUPixcbiAgICAgICAgY29uZmlnOiBUaHlTbGlkZUNvbmZpZ1xuICAgICk6IFRoeVNsaWRlUmVmPFQsIFRSZXN1bHQ+IHtcbiAgICAgICAgaWYgKHRoaXMub3ZlcmxheUlzT3BlbmVkKGNvbmZpZykpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBzbGlkZVJlZiA9IHRoaXMub3BlblVwcGVyT3ZlcmxheShjb21wb25lbnRPclRlbXBsYXRlUmVmLCBjb25maWcpO1xuICAgICAgICB0aGlzLm9yaWdpbkVsZW1lbnRBZGRBY3RpdmVDbGFzcyhzbGlkZVJlZi5jb250YWluZXJJbnN0YW5jZS5jb25maWcpO1xuICAgICAgICBzbGlkZVJlZi5hZnRlckNsb3NlZCgpLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLm9yaWdpbkVsZW1lbnRSZW1vdmVBY3RpdmVDbGFzcyhzbGlkZVJlZi5jb250YWluZXJJbnN0YW5jZS5jb25maWcpO1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHNsaWRlUmVmIGFzIFRoeVNsaWRlUmVmPFQsIFRSZXN1bHQ+O1xuICAgIH1cblxuICAgIG5nT25EZXN0cm95KCkge1xuICAgICAgICB0aGlzLmRpc3Bvc2UoKTtcbiAgICB9XG59XG4iXX0=