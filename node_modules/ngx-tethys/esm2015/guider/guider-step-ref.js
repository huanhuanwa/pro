import { fromEvent } from 'rxjs';
import { helpers } from 'ngx-tethys/util';
const pointContainerSize = 28;
export class ThyGuiderStepRef {
    constructor(step, stepIndex, rendererFactory, popover, guiderManager, overlay, document) {
        this.step = step;
        this.stepIndex = stepIndex;
        this.rendererFactory = rendererFactory;
        this.popover = popover;
        this.guiderManager = guiderManager;
        this.overlay = overlay;
        this.document = document;
        this.renderer = this.rendererFactory.createRenderer(null, null);
    }
    show(guiderRef) {
        this.guiderRef = guiderRef;
        this.createPoint(this.step, guiderRef);
    }
    dispose() {
        this.removeLastPointContainer();
        this.removeTip();
    }
    getTargetElement(step) {
        let targetElement;
        if (step.target) {
            targetElement = this.document.querySelector(step.target);
        }
        else {
            targetElement = this.guiderManager.getActiveTarget(step.key);
        }
        return targetElement;
    }
    createPoint(step, guiderRef) {
        var _a;
        // target 为空并且 guiderManager 中的 targetMap 也没有此step 的 key，或者 target 直接为 坐标数组
        // 则执行无 target 的显示
        if (!this.isTipHasTarget(step)) {
            this.createTip(this.step);
            return;
        }
        const targetElement = this.getTargetElement(step);
        if (helpers.isNull(targetElement)) {
            throw new Error(`there is no target called ${step.target}`);
        }
        this.targetElementObserver = fromEvent(targetElement, 'click').subscribe(() => {
            guiderRef.targetClicked().next(step);
        });
        const positionValue = (_a = targetElement === null || targetElement === void 0 ? void 0 : targetElement.style) === null || _a === void 0 ? void 0 : _a.position;
        if (!positionValue || positionValue === 'static') {
            this.renderer.setStyle(targetElement, 'position', 'relative');
        }
        this.setStyleForPointContainer(step, targetElement);
    }
    setStyleForPointContainer(step, targetElement) {
        const pointPosition = this.getPointPosition(step, targetElement);
        const pointContainer = this.setPointPosition(pointPosition);
        this.renderPoint(targetElement, pointContainer);
    }
    getPointPosition(step, targetElement) {
        const targetElementClientRect = targetElement.getBoundingClientRect();
        const { width: targetElementWidth, height: targetElementHeight } = targetElementClientRect;
        const pointOffset = step.pointOffset;
        // 只通过 pointOffset 控制 point 的位置，默认在 target 的右下角，
        // offset 的基点也为默认位置
        return [targetElementWidth + pointOffset[0], targetElementHeight + pointOffset[1]];
    }
    setPointPosition(pointPosition) {
        const currentPointContainer = this.renderer.createElement('div');
        this.renderer.addClass(currentPointContainer, 'thy-guider-highlight-container');
        if (this.guiderRef.config.pointClass) {
            this.addPointClass(currentPointContainer, this.guiderRef.config.pointClass);
        }
        this.renderer.setStyle(currentPointContainer, 'position', 'absolute');
        this.renderer.setStyle(currentPointContainer, 'left', pointPosition[0] + 'px');
        this.renderer.setStyle(currentPointContainer, 'top', pointPosition[1] + 'px');
        this.renderer.setStyle(currentPointContainer, 'transform', 'translate(-100%,-100%)');
        return currentPointContainer;
    }
    addPointClass(el, pointClass) {
        if (helpers.isString(pointClass)) {
            this.renderer.addClass(el, pointClass);
        }
        if (helpers.isArray(pointClass)) {
            pointClass.forEach(classItem => {
                this.renderer.addClass(el, classItem);
            });
        }
    }
    renderPoint(targetElement, pointContainer) {
        this.renderer.appendChild(targetElement, pointContainer);
        this.lastPointerContainer = pointContainer;
        this.lastTargetElement = targetElement;
        this.createTip(this.step);
    }
    removeLastPointContainer() {
        if (this.lastPointerContainer) {
            this.renderer.removeChild(this.document.body, this.lastPointerContainer);
            this.lastPointerContainer = undefined;
        }
    }
    createTip(step) {
        if (this.isTipHasTarget(step)) {
            this.tipWithTarget(step);
        }
        else {
            this.tipWithoutTarget(step);
        }
    }
    tipWithoutTarget(step) {
        const position = this.getTipPosition(step);
        this.lastPopoverRef = this.popover.open(this.guiderRef.config.hintComponent, {
            origin: null,
            originPosition: {
                x: position[0],
                y: position[1]
            },
            originActiveClass: '',
            panelClass: this.guiderRef.config.hintClass || '',
            backdropClosable: false,
            hasBackdrop: false,
            manualClosure: true,
            initialState: {
                guiderRef: this.guiderRef,
                stepRef: this
            },
            scrollStrategy: this.overlay.scrollStrategies.block()
        });
    }
    getTipPosition(step) {
        if (Array.isArray(step.target)) {
            return step.target;
        }
        return this.guiderRef.config.defaultPosition;
    }
    createTipContainer() {
        const tipContainer = this.renderer.createElement('div');
        this.renderer.addClass(tipContainer, 'thy-guider-content-container');
        this.renderer.setStyle(tipContainer, 'position', 'absolute');
        this.renderer.setStyle(tipContainer, 'top', '0px');
        this.renderer.setStyle(tipContainer, 'right', '0px');
        this.renderer.setStyle(tipContainer, 'bottom', '0px');
        this.renderer.setStyle(tipContainer, 'left', '0px');
        return tipContainer;
    }
    tipWithTarget(step) {
        let targetElement;
        if (step.target) {
            targetElement = this.document.querySelector(step.target);
        }
        else {
            targetElement = this.guiderManager.getActiveTarget(step.key);
        }
        const hintContainer = this.createTipContainer();
        this.renderer.appendChild(targetElement, hintContainer);
        this.lastTipContainer = hintContainer;
        const popoverConfig = {
            origin: hintContainer,
            placement: step.hintPlacement,
            panelClass: this.guiderRef.config.hintClass || '',
            backdropClosable: false,
            hasBackdrop: false,
            manualClosure: true,
            initialState: {
                guiderRef: this.guiderRef,
                stepRef: this
            },
            scrollStrategy: this.overlay.scrollStrategies.block()
        };
        const pointPosition = this.getPointPosition(step, targetElement);
        const hintOffset = this.getTipOffset(step, pointPosition, targetElement);
        if (hintOffset) {
            popoverConfig.offset = hintOffset;
        }
        this.lastPopoverRef = this.popover.open(this.guiderRef.config.hintComponent, popoverConfig);
    }
    getTipOffset(step, pointPosition, targetElement) {
        const hintPlacement = step.hintPlacement;
        const targetElementClientRect = targetElement.getBoundingClientRect();
        const { width: targetElementWidth, height: targetElementHeight } = targetElementClientRect;
        let hintOffset = step.hintOffset || 0;
        const pointXAxisOffset = pointPosition[0];
        const pointYAxisOffset = pointPosition[1];
        if (hintPlacement.startsWith('top')) {
            if (pointYAxisOffset < pointContainerSize) {
                hintOffset = hintOffset + Math.abs(pointYAxisOffset) + pointContainerSize;
            }
        }
        else if (hintPlacement.startsWith('bottom')) {
            if (pointYAxisOffset > targetElementHeight) {
                hintOffset = hintOffset + (pointYAxisOffset - targetElementHeight) + 10; // 10 为空隙量
            }
        }
        else if (hintPlacement.startsWith('left')) {
            if (pointXAxisOffset < 0) {
                hintOffset = hintOffset + Math.abs(pointXAxisOffset) + pointContainerSize;
            }
        }
        else if (hintPlacement.startsWith('right')) {
            if (pointXAxisOffset > targetElementWidth) {
                hintOffset = hintOffset + (pointXAxisOffset - targetElementWidth) + 10; // 10 为空隙量
            }
        }
        return hintOffset;
    }
    removeTip() {
        if (this.lastPopoverRef) {
            this.lastPopoverRef.close();
            this.lastPopoverRef = undefined;
        }
        if (this.lastTipContainer) {
            this.renderer.removeChild(this.document.body, this.lastTipContainer);
            this.lastTipContainer = undefined;
        }
        if (this.lastTargetElement && this.targetElementObserver) {
            this.targetElementObserver.unsubscribe();
            this.lastTargetElement = undefined;
            this.targetElementObserver = undefined;
        }
    }
    isTipHasTarget(step) {
        if (step.target) {
            return !Array.isArray(step.target);
        }
        else {
            return !!this.guiderManager.getActiveTarget(step.key);
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ3VpZGVyLXN0ZXAtcmVmLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2d1aWRlci9ndWlkZXItc3RlcC1yZWYudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBRUEsT0FBTyxFQUFFLFNBQVMsRUFBZ0IsTUFBTSxNQUFNLENBQUM7QUFLL0MsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBRzFDLE1BQU0sa0JBQWtCLEdBQUcsRUFBRSxDQUFDO0FBQzlCLE1BQU0sT0FBTyxnQkFBZ0I7SUFlekIsWUFDVyxJQUFtQixFQUNuQixTQUFpQixFQUNQLGVBQWlDLEVBQzFDLE9BQW1CLEVBQ25CLGFBQStCLEVBQy9CLE9BQWdCLEVBQ2hCLFFBQWE7UUFOZCxTQUFJLEdBQUosSUFBSSxDQUFlO1FBQ25CLGNBQVMsR0FBVCxTQUFTLENBQVE7UUFDUCxvQkFBZSxHQUFmLGVBQWUsQ0FBa0I7UUFDMUMsWUFBTyxHQUFQLE9BQU8sQ0FBWTtRQUNuQixrQkFBYSxHQUFiLGFBQWEsQ0FBa0I7UUFDL0IsWUFBTyxHQUFQLE9BQU8sQ0FBUztRQUNoQixhQUFRLEdBQVIsUUFBUSxDQUFLO1FBRXJCLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxjQUFjLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ3BFLENBQUM7SUFFTSxJQUFJLENBQUMsU0FBdUI7UUFDL0IsSUFBSSxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUM7UUFDM0IsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLFNBQVMsQ0FBQyxDQUFDO0lBQzNDLENBQUM7SUFFTSxPQUFPO1FBQ1YsSUFBSSxDQUFDLHdCQUF3QixFQUFFLENBQUM7UUFDaEMsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO0lBQ3JCLENBQUM7SUFFTyxnQkFBZ0IsQ0FBQyxJQUFtQjtRQUN4QyxJQUFJLGFBQTBCLENBQUM7UUFDL0Is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SUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQ3pEO0lBQ0wsQ0FBQztDQUNKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUmVuZGVyZXIyIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBUaHlHdWlkZXJSZWYgfSBmcm9tICcuL2d1aWRlci1yZWYnO1xuaW1wb3J0IHsgZnJvbUV2ZW50LCBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IFJlbmRlcmVyRmFjdG9yeTIgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFRoeUd1aWRlck1hbmFnZXIgfSBmcm9tICcuL2d1aWRlci1tYW5hZ2VyJztcbmltcG9ydCB7IFRoeUd1aWRlclN0ZXAgfSBmcm9tICcuL2d1aWRlci5jbGFzcyc7XG5pbXBvcnQgeyBUaHlQb3BvdmVyLCBUaHlQb3BvdmVyQ29uZmlnLCBUaHlQb3BvdmVyUmVmIH0gZnJvbSAnbmd4LXRldGh5cy9wb3BvdmVyJztcbmltcG9ydCB7IGhlbHBlcnMgfSBmcm9tICduZ3gtdGV0aHlzL3V0aWwnO1xuaW1wb3J0IHsgT3ZlcmxheSB9IGZyb20gJ0Bhbmd1bGFyL2Nkay9vdmVybGF5JztcblxuY29uc3QgcG9pbnRDb250YWluZXJTaXplID0gMjg7XG5leHBvcnQgY2xhc3MgVGh5R3VpZGVyU3RlcFJlZiB7XG4gICAgcHJpdmF0ZSByZW5kZXJlcjogUmVuZGVyZXIyO1xuXG4gICAgcHJpdmF0ZSBsYXN0UG9pbnRlckNvbnRhaW5lcjogYW55O1xuXG4gICAgcHJpdmF0ZSBsYXN0VGFyZ2V0RWxlbWVudDogRWxlbWVudDtcblxuICAgIHByaXZhdGUgdGFyZ2V0RWxlbWVudE9ic2VydmVyOiBTdWJzY3JpcHRpb247XG5cbiAgICBwcml2YXRlIGxhc3RUaXBDb250YWluZXI6IGFueTtcblxuICAgIHByaXZhdGUgZ3VpZGVyUmVmOiBUaHlHdWlkZXJSZWY7XG5cbiAgICBwcml2YXRlIGxhc3RQb3BvdmVyUmVmOiBUaHlQb3BvdmVyUmVmPGFueT47XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHVibGljIHN0ZXA6IFRoeUd1aWRlclN0ZXAsXG4gICAgICAgIHB1YmxpYyBzdGVwSW5kZXg6IG51bWJlcixcbiAgICAgICAgcHJpdmF0ZSByZWFkb25seSByZW5kZXJlckZhY3Rvcnk6IFJlbmRlcmVyRmFjdG9yeTIsXG4gICAgICAgIHByaXZhdGUgcG9wb3ZlcjogVGh5UG9wb3ZlcixcbiAgICAgICAgcHJpdmF0ZSBndWlkZXJNYW5hZ2VyOiBUaHlHdWlkZXJNYW5hZ2VyLFxuICAgICAgICBwcml2YXRlIG92ZXJsYXk6IE92ZXJsYXksXG4gICAgICAgIHByaXZhdGUgZG9jdW1lbnQ6IGFueVxuICAgICkge1xuICAgICAgICB0aGlzLnJlbmRlcmVyID0gdGhpcy5yZW5kZXJlckZhY3RvcnkuY3JlYXRlUmVuZGVyZXIobnVsbCwgbnVsbCk7XG4gICAgfVxuXG4gICAgcHVibGljIHNob3coZ3VpZGVyUmVmOiBUaHlHdWlkZXJSZWYpIHtcbiAgICAgICAgdGhpcy5ndWlkZXJSZWYgPSBndWlkZXJSZWY7XG4gICAgICAgIHRoaXMuY3JlYXRlUG9pbnQodGhpcy5zdGVwLCBndWlkZXJSZWYpO1xuICAgIH1cblxuICAgIHB1YmxpYyBkaXNwb3NlKCkge1xuICAgICAgICB0aGlzLnJlbW92ZUxhc3RQb2ludENvbnRhaW5lcigpO1xuICAgICAgICB0aGlzLnJlbW92ZVRpcCgpO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0VGFyZ2V0RWxlbWVudChzdGVwOiBUaHlHdWlkZXJTdGVwKSB7XG4gICAgICAgIGxldCB0YXJnZXRFbGVtZW50OiBIVE1MRWxlbWVudDtcbiAgICAgICAgaWYgKHN0ZXAudGFyZ2V0KSB7XG4gICAgICAgICAgICB0YXJnZXRFbGVtZW50ID0gdGhpcy5kb2N1bWVudC5xdWVyeVNlbGVjdG9yKHN0ZXAudGFyZ2V0KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRhcmdldEVsZW1lbnQgPSB0aGlzLmd1aWRlck1hbmFnZXIuZ2V0QWN0aXZlVGFyZ2V0KHN0ZXAua2V5KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGFyZ2V0RWxlbWVudDtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNyZWF0ZVBvaW50KHN0ZXA6IFRoeUd1aWRlclN0ZXAsIGd1aWRlclJlZjogVGh5R3VpZGVyUmVmKSB7XG4gICAgICAgIC8vIHRhcmdldCDkuLrnqbrlubbkuJQgZ3VpZGVyTWFuYWdlciDkuK3nmoQgdGFyZ2V0TWFwIOS5n+ayoeacieatpHN0ZXAg55qEIGtlee+8jOaIluiAhSB0YXJnZXQg55u05o6l5Li6IOWdkOagh+aVsOe7hFxuICAgICAgICAvLyDliJnmiafooYzml6AgdGFyZ2V0IOeahOaYvuekulxuICAgICAgICBpZiAoIXRoaXMuaXNUaXBIYXNUYXJnZXQoc3RlcCkpIHtcbiAgICAgICAgICAgIHRoaXMuY3JlYXRlVGlwKHRoaXMuc3RlcCk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCB0YXJnZXRFbGVtZW50ID0gdGhpcy5nZXRUYXJnZXRFbGVtZW50KHN0ZXApO1xuXG4gICAgICAgIGlmIChoZWxwZXJzLmlzTnVsbCh0YXJnZXRFbGVtZW50KSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGB0aGVyZSBpcyBubyB0YXJnZXQgY2FsbGVkICR7c3RlcC50YXJnZXR9YCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy50YXJnZXRFbGVtZW50T2JzZXJ2ZXIgPSBmcm9tRXZlbnQodGFyZ2V0RWxlbWVudCwgJ2NsaWNrJykuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgICAgICAgIGd1aWRlclJlZi50YXJnZXRDbGlja2VkKCkubmV4dChzdGVwKTtcbiAgICAgICAgfSk7XG4gICAgICAgIGNvbnN0IHBvc2l0aW9uVmFsdWUgPSB0YXJnZXRFbGVtZW50Py5zdHlsZT8ucG9zaXRpb247XG4gICAgICAgIGlmICghcG9zaXRpb25WYWx1ZSB8fCBwb3NpdGlvblZhbHVlID09PSAnc3RhdGljJykge1xuICAgICAgICAgICAgdGhpcy5yZW5kZXJlci5zZXRTdHlsZSh0YXJnZXRFbGVtZW50LCAncG9zaXRpb24nLCAncmVsYXRpdmUnKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnNldFN0eWxlRm9yUG9pbnRDb250YWluZXIoc3RlcCwgdGFyZ2V0RWxlbWVudCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzZXRTdHlsZUZvclBvaW50Q29udGFpbmVyKHN0ZXA6IFRoeUd1aWRlclN0ZXAsIHRhcmdldEVsZW1lbnQ6IEVsZW1lbnQpIHtcbiAgICAgICAgY29uc3QgcG9pbnRQb3NpdGlvbiA9IHRoaXMuZ2V0UG9pbnRQb3NpdGlvbihzdGVwLCB0YXJnZXRFbGVtZW50KTtcblxuICAgICAgICBjb25zdCBwb2ludENvbnRhaW5lciA9IHRoaXMuc2V0UG9pbnRQb3NpdGlvbihwb2ludFBvc2l0aW9uKTtcbiAgICAgICAgdGhpcy5yZW5kZXJQb2ludCh0YXJnZXRFbGVtZW50LCBwb2ludENvbnRhaW5lcik7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRQb2ludFBvc2l0aW9uKHN0ZXA6IFRoeUd1aWRlclN0ZXAsIHRhcmdldEVsZW1lbnQ6IEVsZW1lbnQpOiBbbnVtYmVyLCBudW1iZXJdIHtcbiAgICAgICAgY29uc3QgdGFyZ2V0RWxlbWVudENsaWVudFJlY3QgPSB0YXJnZXRFbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xuICAgICAgICBjb25zdCB7IHdpZHRoOiB0YXJnZXRFbGVtZW50V2lkdGgsIGhlaWdodDogdGFyZ2V0RWxlbWVudEhlaWdodCB9ID0gdGFyZ2V0RWxlbWVudENsaWVudFJlY3Q7XG5cbiAgICAgICAgY29uc3QgcG9pbnRPZmZzZXQgPSBzdGVwLnBvaW50T2Zmc2V0O1xuICAgICAgICAvLyDlj6rpgJrov4cgcG9pbnRPZmZzZXQg5o6n5Yi2IHBvaW50IOeahOS9jee9ru+8jOm7mOiupOWcqCB0YXJnZXQg55qE5Y+z5LiL6KeS77yMXG4gICAgICAgIC8vIG9mZnNldCDnmoTln7rngrnkuZ/kuLrpu5jorqTkvY3nva5cbiAgICAgICAgcmV0dXJuIFt0YXJnZXRFbGVtZW50V2lkdGggKyBwb2ludE9mZnNldFswXSwgdGFyZ2V0RWxlbWVudEhlaWdodCArIHBvaW50T2Zmc2V0WzFdXTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHNldFBvaW50UG9zaXRpb24ocG9pbnRQb3NpdGlvbjogW251bWJlciwgbnVtYmVyXSkge1xuICAgICAgICBjb25zdCBjdXJyZW50UG9pbnRDb250YWluZXIgPSB0aGlzLnJlbmRlcmVyLmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuXG4gICAgICAgIHRoaXMucmVuZGVyZXIuYWRkQ2xhc3MoY3VycmVudFBvaW50Q29udGFpbmVyLCAndGh5LWd1aWRlci1oaWdobGlnaHQtY29udGFpbmVyJyk7XG4gICAgICAgIGlmICh0aGlzLmd1aWRlclJlZi5jb25maWcucG9pbnRDbGFzcykge1xuICAgICAgICAgICAgdGhpcy5hZGRQb2ludENsYXNzKGN1cnJlbnRQb2ludENvbnRhaW5lciwgdGhpcy5ndWlkZXJSZWYuY29uZmlnLnBvaW50Q2xhc3MpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMucmVuZGVyZXIuc2V0U3R5bGUoY3VycmVudFBvaW50Q29udGFpbmVyLCAncG9zaXRpb24nLCAnYWJzb2x1dGUnKTtcbiAgICAgICAgdGhpcy5yZW5kZXJlci5zZXRTdHlsZShjdXJyZW50UG9pbnRDb250YWluZXIsICdsZWZ0JywgcG9pbnRQb3NpdGlvblswXSArICdweCcpO1xuICAgICAgICB0aGlzLnJlbmRlcmVyLnNldFN0eWxlKGN1cnJlbnRQb2ludENvbnRhaW5lciwgJ3RvcCcsIHBvaW50UG9zaXRpb25bMV0gKyAncHgnKTtcbiAgICAgICAgdGhpcy5yZW5kZXJlci5zZXRTdHlsZShjdXJyZW50UG9pbnRDb250YWluZXIsICd0cmFuc2Zvcm0nLCAndHJhbnNsYXRlKC0xMDAlLC0xMDAlKScpO1xuXG4gICAgICAgIHJldHVybiBjdXJyZW50UG9pbnRDb250YWluZXI7XG4gICAgfVxuICAgIHByaXZhdGUgYWRkUG9pbnRDbGFzcyhlbDogYW55LCBwb2ludENsYXNzOiBzdHJpbmcgfCBzdHJpbmdbXSkge1xuICAgICAgICBpZiAoaGVscGVycy5pc1N0cmluZyhwb2ludENsYXNzKSkge1xuICAgICAgICAgICAgdGhpcy5yZW5kZXJlci5hZGRDbGFzcyhlbCwgcG9pbnRDbGFzcyk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGhlbHBlcnMuaXNBcnJheShwb2ludENsYXNzKSkge1xuICAgICAgICAgICAgcG9pbnRDbGFzcy5mb3JFYWNoKGNsYXNzSXRlbSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5yZW5kZXJlci5hZGRDbGFzcyhlbCwgY2xhc3NJdGVtKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSByZW5kZXJQb2ludCh0YXJnZXRFbGVtZW50OiBFbGVtZW50LCBwb2ludENvbnRhaW5lcjogYW55KSB7XG4gICAgICAgIHRoaXMucmVuZGVyZXIuYXBwZW5kQ2hpbGQodGFyZ2V0RWxlbWVudCwgcG9pbnRDb250YWluZXIpO1xuICAgICAgICB0aGlzLmxhc3RQb2ludGVyQ29udGFpbmVyID0gcG9pbnRDb250YWluZXI7XG4gICAgICAgIHRoaXMubGFzdFRhcmdldEVsZW1lbnQgPSB0YXJnZXRFbGVtZW50O1xuICAgICAgICB0aGlzLmNyZWF0ZVRpcCh0aGlzLnN0ZXApO1xuICAgIH1cblxuICAgIHByaXZhdGUgcmVtb3ZlTGFzdFBvaW50Q29udGFpbmVyKCkge1xuICAgICAgICBpZiAodGhpcy5sYXN0UG9pbnRlckNvbnRhaW5lcikge1xuICAgICAgICAgICAgdGhpcy5yZW5kZXJlci5yZW1vdmVDaGlsZCh0aGlzLmRvY3VtZW50LmJvZHksIHRoaXMubGFzdFBvaW50ZXJDb250YWluZXIpO1xuICAgICAgICAgICAgdGhpcy5sYXN0UG9pbnRlckNvbnRhaW5lciA9IHVuZGVmaW5lZDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgY3JlYXRlVGlwKHN0ZXA6IFRoeUd1aWRlclN0ZXApIHtcbiAgICAgICAgaWYgKHRoaXMuaXNUaXBIYXNUYXJnZXQoc3RlcCkpIHtcbiAgICAgICAgICAgIHRoaXMudGlwV2l0aFRhcmdldChzdGVwKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMudGlwV2l0aG91dFRhcmdldChzdGVwKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgdGlwV2l0aG91dFRhcmdldChzdGVwOiBUaHlHdWlkZXJTdGVwKSB7XG4gICAgICAgIGNvbnN0IHBvc2l0aW9uID0gdGhpcy5nZXRUaXBQb3NpdGlvbihzdGVwKTtcbiAgICAgICAgdGhpcy5sYXN0UG9wb3ZlclJlZiA9IHRoaXMucG9wb3Zlci5vcGVuKHRoaXMuZ3VpZGVyUmVmLmNvbmZpZy5oaW50Q29tcG9uZW50LCB7XG4gICAgICAgICAgICBvcmlnaW46IG51bGwsXG4gICAgICAgICAgICBvcmlnaW5Qb3NpdGlvbjoge1xuICAgICAgICAgICAgICAgIHg6IHBvc2l0aW9uWzBdLFxuICAgICAgICAgICAgICAgIHk6IHBvc2l0aW9uWzFdXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgb3JpZ2luQWN0aXZlQ2xhc3M6ICcnLFxuICAgICAgICAgICAgcGFuZWxDbGFzczogdGhpcy5ndWlkZXJSZWYuY29uZmlnLmhpbnRDbGFzcyB8fCAnJyxcbiAgICAgICAgICAgIGJhY2tkcm9wQ2xvc2FibGU6IGZhbHNlLFxuICAgICAgICAgICAgaGFzQmFja2Ryb3A6IGZhbHNlLFxuICAgICAgICAgICAgbWFudWFsQ2xvc3VyZTogdHJ1ZSxcbiAgICAgICAgICAgIGluaXRpYWxTdGF0ZToge1xuICAgICAgICAgICAgICAgIGd1aWRlclJlZjogdGhpcy5ndWlkZXJSZWYsXG4gICAgICAgICAgICAgICAgc3RlcFJlZjogdGhpc1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHNjcm9sbFN0cmF0ZWd5OiB0aGlzLm92ZXJsYXkuc2Nyb2xsU3RyYXRlZ2llcy5ibG9jaygpXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0VGlwUG9zaXRpb24oc3RlcDogVGh5R3VpZGVyU3RlcCk6IFtudW1iZXIsIG51bWJlcl0ge1xuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShzdGVwLnRhcmdldCkpIHtcbiAgICAgICAgICAgIHJldHVybiBzdGVwLnRhcmdldDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5ndWlkZXJSZWYuY29uZmlnLmRlZmF1bHRQb3NpdGlvbjtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNyZWF0ZVRpcENvbnRhaW5lcigpIHtcbiAgICAgICAgY29uc3QgdGlwQ29udGFpbmVyID0gdGhpcy5yZW5kZXJlci5jcmVhdGVFbGVtZW50KCdkaXYnKTtcbiAgICAgICAgdGhpcy5yZW5kZXJlci5hZGRDbGFzcyh0aXBDb250YWluZXIsICd0aHktZ3VpZGVyLWNvbnRlbnQtY29udGFpbmVyJyk7XG4gICAgICAgIHRoaXMucmVuZGVyZXIuc2V0U3R5bGUodGlwQ29udGFpbmVyLCAncG9zaXRpb24nLCAnYWJzb2x1dGUnKTtcbiAgICAgICAgdGhpcy5yZW5kZXJlci5zZXRTdHlsZSh0aXBDb250YWluZXIsICd0b3AnLCAnMHB4Jyk7XG4gICAgICAgIHRoaXMucmVuZGVyZXIuc2V0U3R5bGUodGlwQ29udGFpbmVyLCAncmlnaHQnLCAnMHB4Jyk7XG4gICAgICAgIHRoaXMucmVuZGVyZXIuc2V0U3R5bGUodGlwQ29udGFpbmVyLCAnYm90dG9tJywgJzBweCcpO1xuICAgICAgICB0aGlzLnJlbmRlcmVyLnNldFN0eWxlKHRpcENvbnRhaW5lciwgJ2xlZnQnLCAnMHB4Jyk7XG4gICAgICAgIHJldHVybiB0aXBDb250YWluZXI7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSB0aXBXaXRoVGFyZ2V0KHN0ZXA6IFRoeUd1aWRlclN0ZXApIHtcbiAgICAgICAgbGV0IHRhcmdldEVsZW1lbnQ6IEVsZW1lbnQ7XG5cbiAgICAgICAgaWYgKHN0ZXAudGFyZ2V0KSB7XG4gICAgICAgICAgICB0YXJnZXRFbGVtZW50ID0gdGhpcy5kb2N1bWVudC5xdWVyeVNlbGVjdG9yKHN0ZXAudGFyZ2V0KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRhcmdldEVsZW1lbnQgPSB0aGlzLmd1aWRlck1hbmFnZXIuZ2V0QWN0aXZlVGFyZ2V0KHN0ZXAua2V5KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGhpbnRDb250YWluZXIgPSB0aGlzLmNyZWF0ZVRpcENvbnRhaW5lcigpO1xuICAgICAgICB0aGlzLnJlbmRlcmVyLmFwcGVuZENoaWxkKHRhcmdldEVsZW1lbnQsIGhpbnRDb250YWluZXIpO1xuICAgICAgICB0aGlzLmxhc3RUaXBDb250YWluZXIgPSBoaW50Q29udGFpbmVyO1xuXG4gICAgICAgIGNvbnN0IHBvcG92ZXJDb25maWcgPSB7XG4gICAgICAgICAgICBvcmlnaW46IGhpbnRDb250YWluZXIsXG4gICAgICAgICAgICBwbGFjZW1lbnQ6IHN0ZXAuaGludFBsYWNlbWVudCxcbiAgICAgICAgICAgIHBhbmVsQ2xhc3M6IHRoaXMuZ3VpZGVyUmVmLmNvbmZpZy5oaW50Q2xhc3MgfHwgJycsXG4gICAgICAgICAgICBiYWNrZHJvcENsb3NhYmxlOiBmYWxzZSxcbiAgICAgICAgICAgIGhhc0JhY2tkcm9wOiBmYWxzZSxcbiAgICAgICAgICAgIG1hbnVhbENsb3N1cmU6IHRydWUsXG4gICAgICAgICAgICBpbml0aWFsU3RhdGU6IHtcbiAgICAgICAgICAgICAgICBndWlkZXJSZWY6IHRoaXMuZ3VpZGVyUmVmLFxuICAgICAgICAgICAgICAgIHN0ZXBSZWY6IHRoaXNcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBzY3JvbGxTdHJhdGVneTogdGhpcy5vdmVybGF5LnNjcm9sbFN0cmF0ZWdpZXMuYmxvY2soKVxuICAgICAgICB9IGFzIFRoeVBvcG92ZXJDb25maWc8YW55PjtcblxuICAgICAgICBjb25zdCBwb2ludFBvc2l0aW9uID0gdGhpcy5nZXRQb2ludFBvc2l0aW9uKHN0ZXAsIHRhcmdldEVsZW1lbnQpO1xuICAgICAgICBjb25zdCBoaW50T2Zmc2V0ID0gdGhpcy5nZXRUaXBPZmZzZXQoc3RlcCwgcG9pbnRQb3NpdGlvbiwgdGFyZ2V0RWxlbWVudCk7XG4gICAgICAgIGlmIChoaW50T2Zmc2V0KSB7XG4gICAgICAgICAgICBwb3BvdmVyQ29uZmlnLm9mZnNldCA9IGhpbnRPZmZzZXQ7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5sYXN0UG9wb3ZlclJlZiA9IHRoaXMucG9wb3Zlci5vcGVuKHRoaXMuZ3VpZGVyUmVmLmNvbmZpZy5oaW50Q29tcG9uZW50LCBwb3BvdmVyQ29uZmlnKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldFRpcE9mZnNldChzdGVwOiBUaHlHdWlkZXJTdGVwLCBwb2ludFBvc2l0aW9uOiBbbnVtYmVyLCBudW1iZXJdLCB0YXJnZXRFbGVtZW50OiBFbGVtZW50KTogbnVtYmVyIHtcbiAgICAgICAgY29uc3QgaGludFBsYWNlbWVudCA9IHN0ZXAuaGludFBsYWNlbWVudDtcbiAgICAgICAgY29uc3QgdGFyZ2V0RWxlbWVudENsaWVudFJlY3QgPSB0YXJnZXRFbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xuICAgICAgICBjb25zdCB7IHdpZHRoOiB0YXJnZXRFbGVtZW50V2lkdGgsIGhlaWdodDogdGFyZ2V0RWxlbWVudEhlaWdodCB9ID0gdGFyZ2V0RWxlbWVudENsaWVudFJlY3Q7XG4gICAgICAgIGxldCBoaW50T2Zmc2V0OiBudW1iZXIgPSBzdGVwLmhpbnRPZmZzZXQgfHwgMDtcbiAgICAgICAgY29uc3QgcG9pbnRYQXhpc09mZnNldCA9IHBvaW50UG9zaXRpb25bMF07XG4gICAgICAgIGNvbnN0IHBvaW50WUF4aXNPZmZzZXQgPSBwb2ludFBvc2l0aW9uWzFdO1xuXG4gICAgICAgIGlmIChoaW50UGxhY2VtZW50LnN0YXJ0c1dpdGgoJ3RvcCcpKSB7XG4gICAgICAgICAgICBpZiAocG9pbnRZQXhpc09mZnNldCA8IHBvaW50Q29udGFpbmVyU2l6ZSkge1xuICAgICAgICAgICAgICAgIGhpbnRPZmZzZXQgPSBoaW50T2Zmc2V0ICsgTWF0aC5hYnMocG9pbnRZQXhpc09mZnNldCkgKyBwb2ludENvbnRhaW5lclNpemU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSBpZiAoaGludFBsYWNlbWVudC5zdGFydHNXaXRoKCdib3R0b20nKSkge1xuICAgICAgICAgICAgaWYgKHBvaW50WUF4aXNPZmZzZXQgPiB0YXJnZXRFbGVtZW50SGVpZ2h0KSB7XG4gICAgICAgICAgICAgICAgaGludE9mZnNldCA9IGhpbnRPZmZzZXQgKyAocG9pbnRZQXhpc09mZnNldCAtIHRhcmdldEVsZW1lbnRIZWlnaHQpICsgMTA7IC8vIDEwIOS4uuepuumamemHj1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKGhpbnRQbGFjZW1lbnQuc3RhcnRzV2l0aCgnbGVmdCcpKSB7XG4gICAgICAgICAgICBpZiAocG9pbnRYQXhpc09mZnNldCA8IDApIHtcbiAgICAgICAgICAgICAgICBoaW50T2Zmc2V0ID0gaGludE9mZnNldCArIE1hdGguYWJzKHBvaW50WEF4aXNPZmZzZXQpICsgcG9pbnRDb250YWluZXJTaXplO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKGhpbnRQbGFjZW1lbnQuc3RhcnRzV2l0aCgncmlnaHQnKSkge1xuICAgICAgICAgICAgaWYgKHBvaW50WEF4aXNPZmZzZXQgPiB0YXJnZXRFbGVtZW50V2lkdGgpIHtcbiAgICAgICAgICAgICAgICBoaW50T2Zmc2V0ID0gaGludE9mZnNldCArIChwb2ludFhBeGlzT2Zmc2V0IC0gdGFyZ2V0RWxlbWVudFdpZHRoKSArIDEwOyAvLyAxMCDkuLrnqbrpmpnph49cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gaGludE9mZnNldDtcbiAgICB9XG5cbiAgICBwcml2YXRlIHJlbW92ZVRpcCgpIHtcbiAgICAgICAgaWYgKHRoaXMubGFzdFBvcG92ZXJSZWYpIHtcbiAgICAgICAgICAgIHRoaXMubGFzdFBvcG92ZXJSZWYuY2xvc2UoKTtcbiAgICAgICAgICAgIHRoaXMubGFzdFBvcG92ZXJSZWYgPSB1bmRlZmluZWQ7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMubGFzdFRpcENvbnRhaW5lcikge1xuICAgICAgICAgICAgdGhpcy5yZW5kZXJlci5yZW1vdmVDaGlsZCh0aGlzLmRvY3VtZW50LmJvZHksIHRoaXMubGFzdFRpcENvbnRhaW5lcik7XG4gICAgICAgICAgICB0aGlzLmxhc3RUaXBDb250YWluZXIgPSB1bmRlZmluZWQ7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMubGFzdFRhcmdldEVsZW1lbnQgJiYgdGhpcy50YXJnZXRFbGVtZW50T2JzZXJ2ZXIpIHtcbiAgICAgICAgICAgIHRoaXMudGFyZ2V0RWxlbWVudE9ic2VydmVyLnVuc3Vic2NyaWJlKCk7XG4gICAgICAgICAgICB0aGlzLmxhc3RUYXJnZXRFbGVtZW50ID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgdGhpcy50YXJnZXRFbGVtZW50T2JzZXJ2ZXIgPSB1bmRlZmluZWQ7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGlzVGlwSGFzVGFyZ2V0KHN0ZXA6IFRoeUd1aWRlclN0ZXApOiBib29sZWFuIHtcbiAgICAgICAgaWYgKHN0ZXAudGFyZ2V0KSB7XG4gICAgICAgICAgICByZXR1cm4gIUFycmF5LmlzQXJyYXkoc3RlcC50YXJnZXQpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuICEhdGhpcy5ndWlkZXJNYW5hZ2VyLmdldEFjdGl2ZVRhcmdldChzdGVwLmtleSk7XG4gICAgICAgIH1cbiAgICB9XG59XG4iXX0=