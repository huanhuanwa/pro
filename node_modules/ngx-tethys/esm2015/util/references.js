import { keyBy, indexKeyBy } from './helpers';
function getReferenceIdKey(referenceKey, idKeys) {
    if (idKeys && idKeys[referenceKey]) {
        return idKeys[referenceKey];
    }
    else {
        return '_id';
    }
}
/**
 * Append references to original references
 * @example
 * mergeReferences({departments: [{ _id: '1', name: 'name-1'}]}, {departments: [{ _id: '3', name: 'name-3'}]})
 * mergeReferences({users: [{ uid: '1', name: 'name-1'}]}, {users: [{ uid: '3', name: 'name-3'}]}, { users: "uid" })
 * @param originalReferences original references
 * @param references append references
 * @param idKeys references 's id key, default is '_id'
 *
 * @returns TReferences
 */
export function mergeReferences(originalReferences, references, idKeys) {
    for (const key in references) {
        if (references.hasOwnProperty(key)) {
            const reference = references[key];
            const referenceIdKey = getReferenceIdKey(key, idKeys);
            const originalReference = originalReferences[key];
            if (!originalReference) {
                throw new Error(`original reference must exist when append new reference: ${key}`);
            }
            if (originalReference instanceof Array) {
                // original reference id index map
                const originalReferenceIdIndexMap = indexKeyBy(originalReferences[key], referenceIdKey);
                // append reference is array
                if (reference instanceof Array) {
                    reference.forEach((item) => {
                        const itemId = item[referenceIdKey];
                        const index = originalReferenceIdIndexMap[itemId];
                        if (index >= 0) {
                            originalReference[index] = Object.assign(Object.assign({}, originalReference[index]), item);
                        }
                        else {
                            originalReferences[key] = [...originalReferences[key], item];
                        }
                    });
                }
                else {
                    // append reference is not array, support append signal object to array reference
                    const itemId = reference[referenceIdKey];
                    const index = originalReferenceIdIndexMap[itemId];
                    if (itemId >= 0) {
                        originalReference[index] = Object.assign(Object.assign({}, originalReference[index]), reference);
                    }
                    else {
                        originalReferences[key] = [...originalReferences[key], reference];
                    }
                }
            }
            else {
                originalReferences[key] = Object.assign(Object.assign({}, originalReferences[key]), reference);
            }
        }
    }
    return originalReferences;
}
/**
 * Build dictionary for references
 * @param references references
 * @param idKeys references 's id key, default is '_id'
 */
export function buildReferencesKeyBy(references, idKeys) {
    const result = {};
    for (const key in references) {
        if (references.hasOwnProperty(key)) {
            const referenceIdKey = getReferenceIdKey(key, idKeys);
            const reference = references[key];
            if (reference instanceof Array) {
                const originalReferenceIdMap = keyBy(reference, referenceIdKey);
                result[key] = originalReferenceIdMap;
            }
        }
    }
    return result;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVmZXJlbmNlcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy91dGlsL3JlZmVyZW5jZXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLEtBQUssRUFBRSxVQUFVLEVBQUUsTUFBTSxXQUFXLENBQUM7QUEyQzlDLFNBQVMsaUJBQWlCLENBQWMsWUFBb0IsRUFBRSxNQUFtRDtJQUM3RyxJQUFJLE1BQU0sSUFBSSxNQUFNLENBQUMsWUFBWSxDQUFDLEVBQUU7UUFDaEMsT0FBTyxNQUFNLENBQUMsWUFBWSxDQUFDLENBQUM7S0FDL0I7U0FBTTtRQUNILE9BQU8sS0FBSyxDQUFDO0tBQ2hCO0FBQ0wsQ0FBQztBQUVEOzs7Ozs7Ozs7O0dBVUc7QUFDSCxNQUFNLFVBQVUsZUFBZSxDQUMzQixrQkFBK0IsRUFDL0IsVUFBZ0MsRUFDaEMsTUFBb0Q7SUFFcEQsS0FBSyxNQUFNLEdBQUcsSUFBSSxVQUFVLEVBQUU7UUFDMUIsSUFBSSxVQUFVLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQ2hDLE1BQU0sU0FBUyxHQUFHLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNsQyxNQUFNLGNBQWMsR0FBRyxpQkFBaUIsQ0FBYyxHQUFHLEVBQUUsTUFBTSxDQUFDLENBQUM7WUFDbkUsTUFBTSxpQkFBaUIsR0FBRyxrQkFBa0IsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNsRCxJQUFJLENBQUMsaUJBQWlCLEVBQUU7Z0JBQ3BCLE1BQU0sSUFBSSxLQUFLLENBQUMsNERBQTRELEdBQUcsRUFBRSxDQUFDLENBQUM7YUFDdEY7WUFDRCxJQUFJLGlCQUFpQixZQUFZLEtBQUssRUFBRTtnQkFDcEMsa0NBQWtDO2dCQUNsQyxNQUFNLDJCQUEyQixHQUFHLFVBQVUsQ0FDMUMsa0JBQWtCLENBQUMsR0FBRyxDQUFRLEVBQzlCLGNBQWMsQ0FDakIsQ0FBQztnQkFDRiw0QkFBNEI7Z0JBQzVCLElBQUksU0FBUyxZQUFZLEtBQUssRUFBRTtvQkFDNUIsU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQXFELEVBQUUsRUFBRTt3QkFDeEUsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDO3dCQUNwQyxNQUFNLEtBQUssR0FBRywyQkFBMkIsQ0FBQyxNQUFNLENBQUMsQ0FBQzt3QkFDbEQsSUFBSSxLQUFLLElBQUksQ0FBQyxFQUFFOzRCQUNaLGlCQUFpQixDQUFDLEtBQUssQ0FBQyxtQ0FBUSxpQkFBaUIsQ0FBQyxLQUFLLENBQUMsR0FBSyxJQUFJLENBQUUsQ0FBQzt5QkFDdkU7NkJBQU07NEJBQ0Ysa0JBQTBCLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFJLGtCQUFrQixDQUFDLEdBQUcsQ0FBUyxFQUFFLElBQUksQ0FBQyxDQUFDO3lCQUNsRjtvQkFDTCxDQUFDLENBQUMsQ0FBQztpQkFDTjtxQkFBTTtvQkFDSCxpRkFBaUY7b0JBQ2pGLE1BQU0sTUFBTSxHQUFHLFNBQVMsQ0FBQyxjQUFjLENBQUMsQ0FBQztvQkFDekMsTUFBTSxLQUFLLEdBQUcsMkJBQTJCLENBQUMsTUFBTSxDQUFDLENBQUM7b0JBQ2xELElBQUksTUFBTSxJQUFJLENBQUMsRUFBRTt3QkFDYixpQkFBaUIsQ0FBQyxLQUFLLENBQUMsbUNBQVEsaUJBQWlCLENBQUMsS0FBSyxDQUFDLEdBQUssU0FBUyxDQUFFLENBQUM7cUJBQzVFO3lCQUFNO3dCQUNGLGtCQUEwQixDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsR0FBSSxrQkFBa0IsQ0FBQyxHQUFHLENBQVMsRUFBRSxTQUFTLENBQUMsQ0FBQztxQkFDdkY7aUJBQ0o7YUFDSjtpQkFBTTtnQkFDSCxrQkFBa0IsQ0FBQyxHQUFHLENBQUMsbUNBQVEsa0JBQWtCLENBQUMsR0FBRyxDQUFDLEdBQUssU0FBUyxDQUFFLENBQUM7YUFDMUU7U0FDSjtLQUNKO0lBRUQsT0FBTyxrQkFBa0IsQ0FBQztBQUM5QixDQUFDO0FBRUQ7Ozs7R0FJRztBQUNILE1BQU0sVUFBVSxvQkFBb0IsQ0FDaEMsVUFBZ0MsRUFDaEMsTUFBNkQ7SUFFN0QsTUFBTSxNQUFNLEdBQTRGLEVBQUUsQ0FBQztJQUMzRyxLQUFLLE1BQU0sR0FBRyxJQUFJLFVBQVUsRUFBRTtRQUMxQixJQUFJLFVBQVUsQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDaEMsTUFBTSxjQUFjLEdBQUcsaUJBQWlCLENBQWMsR0FBRyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1lBQ25FLE1BQU0sU0FBUyxHQUFHLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNsQyxJQUFJLFNBQVMsWUFBWSxLQUFLLEVBQUU7Z0JBQzVCLE1BQU0sc0JBQXNCLEdBQUcsS0FBSyxDQUFpQyxTQUFTLEVBQUUsY0FBYyxDQUFDLENBQUM7Z0JBQy9GLE1BQWMsQ0FBQyxHQUFHLENBQUMsR0FBRyxzQkFBc0IsQ0FBQzthQUNqRDtTQUNKO0tBQ0o7SUFDRCxPQUFPLE1BQU0sQ0FBQztBQUNsQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsga2V5QnksIGluZGV4S2V5QnkgfSBmcm9tICcuL2hlbHBlcnMnO1xuXG4vLyDmir3lj5bmlbDmja7kuK3nmoRJdGVt57G75Z6L77yM5LiN5piv5pWw57uE55u05o6l6L+U5Zue5a+56LGh55qE57G75Z6LXG5leHBvcnQgdHlwZSBBcnJheUluZmVyRXh0cmFjdDxUPiA9IFQgZXh0ZW5kcyBBcnJheTxpbmZlciBQPiA/IFAgOiBUO1xuZXhwb3J0IHR5cGUgQXJyYXlBbHdheXNFeHRyYWN0PFQ+ID0gVCBleHRlbmRzIEFycmF5PGluZmVyIFA+ID8gUCA6IG5ldmVyO1xuLy8g5oq95Y+WIFJlZmVyZW5jZXMg5LitIE9iamVjdCDnsbvlnossIOWmguaenOaYr+aVsOe7hOWPluaVsOe7hCBJdGVtIOexu+Wei1xuZXhwb3J0IHR5cGUgUmVmZXJlbmNlT2JqZWN0RXh0cmFjdDxUPiA9IHtcbiAgICBba2V5IGluIGtleW9mIFRdOiBBcnJheUluZmVyRXh0cmFjdDxUW2tleV0+IGV4dGVuZHMgb2JqZWN0ID8gQXJyYXlJbmZlckV4dHJhY3Q8VFtrZXldPiA6IG5ldmVyXG59O1xuLy8g5pS25Y+WIFJlZmVyZW5jZXMg5Lit5omA5pyJ55qE5bGe5oCnIE5hbWVz77yM5aaC5p6cQXJyYXlJbmZlckV4dHJhY3TkuI3mmK/lr7nosaHvvIzov5Tlm54gbmV2ZXJcbmV4cG9ydCB0eXBlIFJlZmVyZW5jZUV4dHJhY3ROYW1lczxUPiA9IHsgW2tleSBpbiBrZXlvZiBUXTogQXJyYXlJbmZlckV4dHJhY3Q8VFtrZXldPiBleHRlbmRzIG9iamVjdCA/IGtleSA6IG5ldmVyIH07XG5leHBvcnQgdHlwZSBSZWZlcmVuY2VBcnJheUV4dHJhY3ROYW1lczxUPiA9IHsgW2tleSBpbiBrZXlvZiBUXTogVFtrZXldIGV4dGVuZHMgQXJyYXk8b2JqZWN0PiA/IGtleSA6IG5ldmVyIH07XG4vLyDmjpLpmaQgUmVmZXJlbmNlRXh0cmFjdE5hbWVzIOaKveWPliBOYW1lcyDkuK3nmoQgbmV2ZXLvvIzlj6rkv53nlZnmmK/lr7nosaHnmoQgTmFtZXNcbmV4cG9ydCB0eXBlIFJlZmVyZW5jZUV4dHJhY3RBbGxvd05hbWVzPFQ+ID0ge1xuICAgIFtrZXkgaW4gUmVmZXJlbmNlRXh0cmFjdE5hbWVzPFQ+W2tleW9mIFRdXTogUmVmZXJlbmNlRXh0cmFjdE5hbWVzPFQ+W2tleV1cbn07XG5leHBvcnQgdHlwZSBSZWZlcmVuY2VBcnJheUV4dHJhY3RBbGxvd05hbWVzPFQ+ID0ge1xuICAgIFtrZXkgaW4gUmVmZXJlbmNlQXJyYXlFeHRyYWN0TmFtZXM8VD5ba2V5b2YgVF1dOiBSZWZlcmVuY2VFeHRyYWN0TmFtZXM8VD5ba2V5XVxufTtcblxuLyoqXG4gKiDmoLnmja4gUmVmZXJlbmNlRXh0cmFjdEFsbG93S2V5cyDmir3lj5blh7rnmoQgT2JqZWN0IEtleXMg57uE5ZCI5paw55qE5a+56LGhXG4gKiBAZXhhbXBsZSBSZWZlcmVuY2VFeHRyYWN0QWxsb3dLZXlzPHtcbiAgICB1c2VyczogeyB1aWQ6IHN0cmluZzsgbmFtZTogc3RyaW5nIH1bXTtcbiAgICBpbmZvOiB7IGlkOiBudW1iZXI7IG5hbWU6IHN0cmluZyB9O1xuICAgIGRlcGFydG1lbnRzOiB7IGRlcHQ6IG51bWJlciB9W107XG4gICAgaWRzOiBzdHJpbmdbXTtcbiAgICBpZDogc3RyaW5nO1xuICB9PiA9PiB7XG4gICAgICB1c2VyczogXCJ1aWRcIiB8IFwibmFtZVwiLFxuICAgICAgaW5mbzogXCJpZFwiIHwgXCJuYW1lXCIsXG4gICAgICBkZXBhcnRtZW50czogXCJkZXB0XCJcblxuICB9XG4gKi9cbmV4cG9ydCB0eXBlIFJlZmVyZW5jZUV4dHJhY3RBbGxvd0tleXM8VD4gPSB7XG4gICAgW2tleSBpbiBrZXlvZiBSZWZlcmVuY2VFeHRyYWN0QWxsb3dOYW1lczxUPl0/OiBrZXlvZiBSZWZlcmVuY2VPYmplY3RFeHRyYWN0PFQ+W2tleV1cbn07XG4vLyDlj6rlhYHorrggcmVmZXJlbmNlIOaYryBBcnJheSDnmoQgS2V5c1xuZXhwb3J0IHR5cGUgUmVmZXJlbmNlQXJyYXlFeHRyYWN0QWxsb3dLZXlzPFQ+ID0ge1xuICAgIFtrZXkgaW4ga2V5b2YgUmVmZXJlbmNlQXJyYXlFeHRyYWN0QWxsb3dOYW1lczxUPl0/OiBrZXlvZiBSZWZlcmVuY2VPYmplY3RFeHRyYWN0PFQ+W2tleV1cbn07XG5cbmZ1bmN0aW9uIGdldFJlZmVyZW5jZUlkS2V5PFRSZWZlcmVuY2VzPihyZWZlcmVuY2VLZXk6IHN0cmluZywgaWRLZXlzOiBSZWZlcmVuY2VBcnJheUV4dHJhY3RBbGxvd0tleXM8VFJlZmVyZW5jZXM+KSB7XG4gICAgaWYgKGlkS2V5cyAmJiBpZEtleXNbcmVmZXJlbmNlS2V5XSkge1xuICAgICAgICByZXR1cm4gaWRLZXlzW3JlZmVyZW5jZUtleV07XG4gICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuICdfaWQnO1xuICAgIH1cbn1cblxuLyoqXG4gKiBBcHBlbmQgcmVmZXJlbmNlcyB0byBvcmlnaW5hbCByZWZlcmVuY2VzXG4gKiBAZXhhbXBsZVxuICogbWVyZ2VSZWZlcmVuY2VzKHtkZXBhcnRtZW50czogW3sgX2lkOiAnMScsIG5hbWU6ICduYW1lLTEnfV19LCB7ZGVwYXJ0bWVudHM6IFt7IF9pZDogJzMnLCBuYW1lOiAnbmFtZS0zJ31dfSlcbiAqIG1lcmdlUmVmZXJlbmNlcyh7dXNlcnM6IFt7IHVpZDogJzEnLCBuYW1lOiAnbmFtZS0xJ31dfSwge3VzZXJzOiBbeyB1aWQ6ICczJywgbmFtZTogJ25hbWUtMyd9XX0sIHsgdXNlcnM6IFwidWlkXCIgfSlcbiAqIEBwYXJhbSBvcmlnaW5hbFJlZmVyZW5jZXMgb3JpZ2luYWwgcmVmZXJlbmNlc1xuICogQHBhcmFtIHJlZmVyZW5jZXMgYXBwZW5kIHJlZmVyZW5jZXNcbiAqIEBwYXJhbSBpZEtleXMgcmVmZXJlbmNlcyAncyBpZCBrZXksIGRlZmF1bHQgaXMgJ19pZCdcbiAqXG4gKiBAcmV0dXJucyBUUmVmZXJlbmNlc1xuICovXG5leHBvcnQgZnVuY3Rpb24gbWVyZ2VSZWZlcmVuY2VzPFRSZWZlcmVuY2VzPihcbiAgICBvcmlnaW5hbFJlZmVyZW5jZXM6IFRSZWZlcmVuY2VzLFxuICAgIHJlZmVyZW5jZXM6IFBhcnRpYWw8VFJlZmVyZW5jZXM+LFxuICAgIGlkS2V5cz86IFJlZmVyZW5jZUFycmF5RXh0cmFjdEFsbG93S2V5czxUUmVmZXJlbmNlcz5cbik6IFRSZWZlcmVuY2VzIHtcbiAgICBmb3IgKGNvbnN0IGtleSBpbiByZWZlcmVuY2VzKSB7XG4gICAgICAgIGlmIChyZWZlcmVuY2VzLmhhc093blByb3BlcnR5KGtleSkpIHtcbiAgICAgICAgICAgIGNvbnN0IHJlZmVyZW5jZSA9IHJlZmVyZW5jZXNba2V5XTtcbiAgICAgICAgICAgIGNvbnN0IHJlZmVyZW5jZUlkS2V5ID0gZ2V0UmVmZXJlbmNlSWRLZXk8VFJlZmVyZW5jZXM+KGtleSwgaWRLZXlzKTtcbiAgICAgICAgICAgIGNvbnN0IG9yaWdpbmFsUmVmZXJlbmNlID0gb3JpZ2luYWxSZWZlcmVuY2VzW2tleV07XG4gICAgICAgICAgICBpZiAoIW9yaWdpbmFsUmVmZXJlbmNlKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBvcmlnaW5hbCByZWZlcmVuY2UgbXVzdCBleGlzdCB3aGVuIGFwcGVuZCBuZXcgcmVmZXJlbmNlOiAke2tleX1gKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChvcmlnaW5hbFJlZmVyZW5jZSBpbnN0YW5jZW9mIEFycmF5KSB7XG4gICAgICAgICAgICAgICAgLy8gb3JpZ2luYWwgcmVmZXJlbmNlIGlkIGluZGV4IG1hcFxuICAgICAgICAgICAgICAgIGNvbnN0IG9yaWdpbmFsUmVmZXJlbmNlSWRJbmRleE1hcCA9IGluZGV4S2V5Qnk8UmVmZXJlbmNlRXh0cmFjdEFsbG93S2V5czxUUmVmZXJlbmNlcz4+KFxuICAgICAgICAgICAgICAgICAgICBvcmlnaW5hbFJlZmVyZW5jZXNba2V5XSBhcyBhbnksXG4gICAgICAgICAgICAgICAgICAgIHJlZmVyZW5jZUlkS2V5XG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAvLyBhcHBlbmQgcmVmZXJlbmNlIGlzIGFycmF5XG4gICAgICAgICAgICAgICAgaWYgKHJlZmVyZW5jZSBpbnN0YW5jZW9mIEFycmF5KSB7XG4gICAgICAgICAgICAgICAgICAgIHJlZmVyZW5jZS5mb3JFYWNoKChpdGVtOiBUUmVmZXJlbmNlc1tFeHRyYWN0PGtleW9mIFRSZWZlcmVuY2VzLCBzdHJpbmc+XSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaXRlbUlkID0gaXRlbVtyZWZlcmVuY2VJZEtleV07XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpbmRleCA9IG9yaWdpbmFsUmVmZXJlbmNlSWRJbmRleE1hcFtpdGVtSWRdO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluZGV4ID49IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcmlnaW5hbFJlZmVyZW5jZVtpbmRleF0gPSB7IC4uLm9yaWdpbmFsUmVmZXJlbmNlW2luZGV4XSwgLi4uaXRlbSB9O1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAob3JpZ2luYWxSZWZlcmVuY2VzIGFzIGFueSlba2V5XSA9IFsuLi4ob3JpZ2luYWxSZWZlcmVuY2VzW2tleV0gYXMgYW55KSwgaXRlbV07XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIGFwcGVuZCByZWZlcmVuY2UgaXMgbm90IGFycmF5LCBzdXBwb3J0IGFwcGVuZCBzaWduYWwgb2JqZWN0IHRvIGFycmF5IHJlZmVyZW5jZVxuICAgICAgICAgICAgICAgICAgICBjb25zdCBpdGVtSWQgPSByZWZlcmVuY2VbcmVmZXJlbmNlSWRLZXldO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBpbmRleCA9IG9yaWdpbmFsUmVmZXJlbmNlSWRJbmRleE1hcFtpdGVtSWRdO1xuICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbUlkID49IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG9yaWdpbmFsUmVmZXJlbmNlW2luZGV4XSA9IHsgLi4ub3JpZ2luYWxSZWZlcmVuY2VbaW5kZXhdLCAuLi5yZWZlcmVuY2UgfTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIChvcmlnaW5hbFJlZmVyZW5jZXMgYXMgYW55KVtrZXldID0gWy4uLihvcmlnaW5hbFJlZmVyZW5jZXNba2V5XSBhcyBhbnkpLCByZWZlcmVuY2VdO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBvcmlnaW5hbFJlZmVyZW5jZXNba2V5XSA9IHsgLi4ub3JpZ2luYWxSZWZlcmVuY2VzW2tleV0sIC4uLnJlZmVyZW5jZSB9O1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIG9yaWdpbmFsUmVmZXJlbmNlcztcbn1cblxuLyoqXG4gKiBCdWlsZCBkaWN0aW9uYXJ5IGZvciByZWZlcmVuY2VzXG4gKiBAcGFyYW0gcmVmZXJlbmNlcyByZWZlcmVuY2VzXG4gKiBAcGFyYW0gaWRLZXlzIHJlZmVyZW5jZXMgJ3MgaWQga2V5LCBkZWZhdWx0IGlzICdfaWQnXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBidWlsZFJlZmVyZW5jZXNLZXlCeTxUUmVmZXJlbmNlcz4oXG4gICAgcmVmZXJlbmNlczogUGFydGlhbDxUUmVmZXJlbmNlcz4sXG4gICAgaWRLZXlzPzogUGFydGlhbDxSZWZlcmVuY2VBcnJheUV4dHJhY3RBbGxvd0tleXM8VFJlZmVyZW5jZXM+PlxuKSB7XG4gICAgY29uc3QgcmVzdWx0OiB7IFtrZXkgaW4ga2V5b2YgVFJlZmVyZW5jZXNdPzogeyBba2V5OiBzdHJpbmddOiBBcnJheUluZmVyRXh0cmFjdDxUUmVmZXJlbmNlc1trZXldPiB9IH0gPSB7fTtcbiAgICBmb3IgKGNvbnN0IGtleSBpbiByZWZlcmVuY2VzKSB7XG4gICAgICAgIGlmIChyZWZlcmVuY2VzLmhhc093blByb3BlcnR5KGtleSkpIHtcbiAgICAgICAgICAgIGNvbnN0IHJlZmVyZW5jZUlkS2V5ID0gZ2V0UmVmZXJlbmNlSWRLZXk8VFJlZmVyZW5jZXM+KGtleSwgaWRLZXlzKTtcbiAgICAgICAgICAgIGNvbnN0IHJlZmVyZW5jZSA9IHJlZmVyZW5jZXNba2V5XTtcbiAgICAgICAgICAgIGlmIChyZWZlcmVuY2UgaW5zdGFuY2VvZiBBcnJheSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IG9yaWdpbmFsUmVmZXJlbmNlSWRNYXAgPSBrZXlCeTxBcnJheUluZmVyRXh0cmFjdDxUUmVmZXJlbmNlcz4+KHJlZmVyZW5jZSwgcmVmZXJlbmNlSWRLZXkpO1xuICAgICAgICAgICAgICAgIChyZXN1bHQgYXMgYW55KVtrZXldID0gb3JpZ2luYWxSZWZlcmVuY2VJZE1hcDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0O1xufVxuIl19