import { Inject, Injectable, Optional } from '@angular/core';
import { THY_VALIDATOR_CONFIG } from './form.class';
import { helpers } from 'ngx-tethys/util';
import * as ɵngcc0 from '@angular/core';
export const ERROR_VALUE_REPLACE_REGEX = /\{(.+?)\}/g;
const INVALID_CLASS = 'is-invalid';
const INVALID_FEEDBACK_CLASS = 'invalid-feedback';
const defaultValidatorConfig = {
    showElementError: true,
    removeElementError: true,
    validationMessages: {}
};
const globalValidationMessages = {
    required: '该选项不能为空',
    maxlength: '该选项输入值长度不能大于{maxlength}',
    minlength: '该选项输入值长度不能小于{minlength}',
    thyUniqueCheck: '输入值已经存在，请重新输入',
    email: '输入邮件的格式不正确',
    confirm: '两次输入不一致',
    pattern: '该选项输入格式不正确',
    number: '必须输入数字',
    url: '输入URL格式不正确',
    max: '该选项输入值不能大于{max}',
    min: '该选项输入值不能小于{min}'
};
export class ThyFormValidatorLoader {
    constructor(config) {
        this.config = Object.assign({}, defaultValidatorConfig, config);
    }
    getDefaultValidationMessage(key) {
        if (this.config.globalValidationMessages && this.config.globalValidationMessages[key]) {
            return this.config.globalValidationMessages[key];
        }
        else {
            return globalValidationMessages[key];
        }
    }
    get validationMessages() {
        return this.config.validationMessages;
    }
    getErrorMessage(name, key) {
        if (this.validationMessages[name] && this.validationMessages[name][key]) {
            return this.validationMessages[name][key];
        }
        else {
            return this.getDefaultValidationMessage(key);
        }
    }
    getErrorMessages(name, validationErrors) {
        const messages = [];
        for (const validationError in validationErrors) {
            if (validationErrors.hasOwnProperty(validationError)) {
                messages.push(this.getErrorMessage(name, validationError));
            }
        }
        return messages;
    }
    defaultShowError(element, errorMessages) {
        if (element && element.parentElement) {
            const documentFrag = document.createDocumentFragment();
            const divNode = document.createElement('DIV');
            const textNode = document.createTextNode(errorMessages[0]);
            divNode.appendChild(textNode);
            divNode.setAttribute('class', INVALID_FEEDBACK_CLASS);
            documentFrag.appendChild(divNode);
            element.parentElement.append(documentFrag);
        }
    }
    defaultRemoveError(element) {
        if (element && element.parentElement) {
            const invalidFeedback = element.parentElement.querySelector('.invalid-feedback');
            element.parentElement.removeChild(invalidFeedback);
        }
    }
    removeError(element) {
        element.classList.remove(INVALID_CLASS);
        if (helpers.isFunction(this.config.removeElementError)) {
            this.config.removeElementError(element);
        }
        else if (this.config.showElementError) {
            this.defaultRemoveError(element);
        }
        else {
            // do nothings
        }
    }
    showError(element, errorMessages) {
        element.classList.add(INVALID_CLASS);
        if (helpers.isFunction(this.config.showElementError)) {
            this.config.showElementError(element, errorMessages);
        }
        else if (this.config.showElementError) {
            this.defaultShowError(element, errorMessages);
        }
        else {
            // do nothings
        }
    }
    addValidationMessages(messages) {
        Object.assign(this.config.validationMessages, messages);
    }
    setGlobalValidationMessages(validationMessages) {
        this.config.globalValidationMessages = validationMessages;
    }
}
ThyFormValidatorLoader.ɵfac = function ThyFormValidatorLoader_Factory(t) { return new (t || ThyFormValidatorLoader)(ɵngcc0.ɵɵinject(THY_VALIDATOR_CONFIG, 8)); };
ThyFormValidatorLoader.ɵprov = ɵngcc0.ɵɵdefineInjectable({ token: ThyFormValidatorLoader, factory: ThyFormValidatorLoader.ɵfac });
ThyFormValidatorLoader.ctorParameters = () => [
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [THY_VALIDATOR_CONFIG,] }] }
];
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(ThyFormValidatorLoader, [{
        type: Injectable
    }], function () { return [{ type: undefined, decorators: [{
                type: Optional
            }, {
                type: Inject,
                args: [THY_VALIDATOR_CONFIG]
            }] }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybS12YWxpZGF0b3ItbG9hZGVyLmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvZm9ybS9mb3JtLXZhbGlkYXRvci1sb2FkZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFrQixNQUFNLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM3RSxPQUFPLEVBQTJELG9CQUFvQixFQUFFLE1BQU0sY0FBYyxDQUFDO0FBRzdHLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQzs7QUFFMUMsTUFBTSxDQUFDLE1BQU0seUJBQXlCLEdBQUcsWUFBWSxDQUFDO0FBRXRELE1BQU0sYUFBYSxHQUFHLFlBQVksQ0FBQztBQUNuQyxNQUFNLHNCQUFzQixHQUFHLGtCQUFrQixDQUFDO0FBRWxELE1BQU0sc0JBQXNCLEdBQWlDO0FBQzdELElBQUksZ0JBQWdCLEVBQUUsSUFBSTtBQUMxQixJQUFJLGtCQUFrQixFQUFFLElBQUk7QUFDNUIsSUFBSSxrQkFBa0IsRUFBRSxFQUFFO0FBQzFCLENBQUMsQ0FBQztBQUVGLE1BQU0sd0JBQXdCLEdBQUc7QUFDakMsSUFBSSxRQUFRLEVBQUUsU0FBUztBQUN2QixJQUFJLFNBQVMsRUFBRSx5QkFBeUI7QUFDeEMsSUFBSSxTQUFTLEVBQUUseUJBQXlCO0FBQ3hDLElBQUksY0FBYyxFQUFFLGVBQWU7QUFDbkMsSUFBSSxLQUFLLEVBQUUsWUFBWTtBQUN2QixJQUFJLE9BQU8sRUFBRSxTQUFTO0FBQ3RCLElBQUksT0FBTyxFQUFFLFlBQVk7QUFDekIsSUFBSSxNQUFNLEVBQUUsUUFBUTtBQUNwQixJQUFJLEdBQUcsRUFBRSxZQUFZO0FBQ3JCLElBQUksR0FBRyxFQUFFLGlCQUFpQjtBQUMxQixJQUFJLEdBQUcsRUFBRSxpQkFBaUI7QUFDMUIsQ0FBQyxDQUFDO0FBR0YsTUFBTSxPQUFPLHNCQUFzQjtBQUNuQyxJQVNJLFlBR0ksTUFBb0M7QUFDekMsUUFDSyxJQUFJ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QyxDQUFDO0FBQ2hFLElBQUksQ0FBQztBQUNMLElBQ0ksMkJBQTJCLENBQUMsa0JBQXNDO0FBQ3RFLFFBQVEsSUFBSSxDQUFDLE1BQU0sQ0FBQyx3QkFBd0IsR0FBRyxrQkFBa0IsQ0FBQztBQUNsRSxJQUFJLENBQUM7QUFDTDtrREF6RkMsVUFBVTtrSUFDVDtBQUFDO0FBQ1UsNENBVUosUUFBUSxZQUNSLE1BQU0sU0FBQyxvQkFBb0I7QUFDOUI7Ozs7Ozs7O2tDQUFFO0FBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3Rpb25Ub2tlbiwgSW5qZWN0LCBJbmplY3RhYmxlLCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgVGh5Rm9ybVZhbGlkYXRvckdsb2JhbENvbmZpZywgVGh5Rm9ybVZhbGlkYXRpb25NZXNzYWdlcywgVEhZX1ZBTElEQVRPUl9DT05GSUcgfSBmcm9tICcuL2Zvcm0uY2xhc3MnO1xuaW1wb3J0IHsgRGljdGlvbmFyeSB9IGZyb20gJ25neC10ZXRoeXMvdHlwZXMnO1xuaW1wb3J0IHsgVmFsaWRhdGlvbkVycm9ycyB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcbmltcG9ydCB7IGhlbHBlcnMgfSBmcm9tICduZ3gtdGV0aHlzL3V0aWwnO1xuXG5leHBvcnQgY29uc3QgRVJST1JfVkFMVUVfUkVQTEFDRV9SRUdFWCA9IC9cXHsoLis/KVxcfS9nO1xuXG5jb25zdCBJTlZBTElEX0NMQVNTID0gJ2lzLWludmFsaWQnO1xuY29uc3QgSU5WQUxJRF9GRUVEQkFDS19DTEFTUyA9ICdpbnZhbGlkLWZlZWRiYWNrJztcblxuY29uc3QgZGVmYXVsdFZhbGlkYXRvckNvbmZpZzogVGh5Rm9ybVZhbGlkYXRvckdsb2JhbENvbmZpZyA9IHtcbiAgICBzaG93RWxlbWVudEVycm9yOiB0cnVlLFxuICAgIHJlbW92ZUVsZW1lbnRFcnJvcjogdHJ1ZSxcbiAgICB2YWxpZGF0aW9uTWVzc2FnZXM6IHt9XG59O1xuXG5jb25zdCBnbG9iYWxWYWxpZGF0aW9uTWVzc2FnZXMgPSB7XG4gICAgcmVxdWlyZWQ6ICfor6XpgInpobnkuI3og73kuLrnqbonLFxuICAgIG1heGxlbmd0aDogJ+ivpemAiemhuei+k+WFpeWAvOmVv+W6puS4jeiDveWkp+S6jnttYXhsZW5ndGh9JyxcbiAgICBtaW5sZW5ndGg6ICfor6XpgInpobnovpPlhaXlgLzplb/luqbkuI3og73lsI/kuo57bWlubGVuZ3RofScsXG4gICAgdGh5VW5pcXVlQ2hlY2s6ICfovpPlhaXlgLzlt7Lnu4/lrZjlnKjvvIzor7fph43mlrDovpPlhaUnLFxuICAgIGVtYWlsOiAn6L6T5YWl6YKu5Lu255qE5qC85byP5LiN5q2j56GuJyxcbiAgICBjb25maXJtOiAn5Lik5qyh6L6T5YWl5LiN5LiA6Ie0JyxcbiAgICBwYXR0ZXJuOiAn6K+l6YCJ6aG56L6T5YWl5qC85byP5LiN5q2j56GuJyxcbiAgICBudW1iZXI6ICflv4XpobvovpPlhaXmlbDlrZcnLFxuICAgIHVybDogJ+i+k+WFpVVSTOagvOW8j+S4jeato+ehricsXG4gICAgbWF4OiAn6K+l6YCJ6aG56L6T5YWl5YC85LiN6IO95aSn5LqOe21heH0nLFxuICAgIG1pbjogJ+ivpemAiemhuei+k+WFpeWAvOS4jeiDveWwj+S6jnttaW59J1xufTtcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFRoeUZvcm1WYWxpZGF0b3JMb2FkZXIge1xuICAgIHByaXZhdGUgY29uZmlnOiBUaHlGb3JtVmFsaWRhdG9yR2xvYmFsQ29uZmlnO1xuXG4gICAgcHJpdmF0ZSBnZXREZWZhdWx0VmFsaWRhdGlvbk1lc3NhZ2Uoa2V5OiBzdHJpbmcpIHtcbiAgICAgICAgaWYgKHRoaXMuY29uZmlnLmdsb2JhbFZhbGlkYXRpb25NZXNzYWdlcyAmJiB0aGlzLmNvbmZpZy5nbG9iYWxWYWxpZGF0aW9uTWVzc2FnZXNba2V5XSkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuY29uZmlnLmdsb2JhbFZhbGlkYXRpb25NZXNzYWdlc1trZXldO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIGdsb2JhbFZhbGlkYXRpb25NZXNzYWdlc1trZXldO1xuICAgICAgICB9XG4gICAgfVxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBAT3B0aW9uYWwoKVxuICAgICAgICBASW5qZWN0KFRIWV9WQUxJREFUT1JfQ09ORklHKVxuICAgICAgICBjb25maWc6IFRoeUZvcm1WYWxpZGF0b3JHbG9iYWxDb25maWdcbiAgICApIHtcbiAgICAgICAgdGhpcy5jb25maWcgPSBPYmplY3QuYXNzaWduKHt9LCBkZWZhdWx0VmFsaWRhdG9yQ29uZmlnLCBjb25maWcpO1xuICAgIH1cblxuICAgIGdldCB2YWxpZGF0aW9uTWVzc2FnZXMoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmNvbmZpZy52YWxpZGF0aW9uTWVzc2FnZXM7XG4gICAgfVxuXG4gICAgZ2V0RXJyb3JNZXNzYWdlKG5hbWU6IHN0cmluZywga2V5OiBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgICBpZiAodGhpcy52YWxpZGF0aW9uTWVzc2FnZXNbbmFtZV0gJiYgdGhpcy52YWxpZGF0aW9uTWVzc2FnZXNbbmFtZV1ba2V5XSkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMudmFsaWRhdGlvbk1lc3NhZ2VzW25hbWVdW2tleV07XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5nZXREZWZhdWx0VmFsaWRhdGlvbk1lc3NhZ2Uoa2V5KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGdldEVycm9yTWVzc2FnZXMobmFtZTogc3RyaW5nLCB2YWxpZGF0aW9uRXJyb3JzOiBWYWxpZGF0aW9uRXJyb3JzKTogc3RyaW5nW10ge1xuICAgICAgICBjb25zdCBtZXNzYWdlcyA9IFtdO1xuICAgICAgICBmb3IgKGNvbnN0IHZhbGlkYXRpb25FcnJvciBpbiB2YWxpZGF0aW9uRXJyb3JzKSB7XG4gICAgICAgICAgICBpZiAodmFsaWRhdGlvbkVycm9ycy5oYXNPd25Qcm9wZXJ0eSh2YWxpZGF0aW9uRXJyb3IpKSB7XG4gICAgICAgICAgICAgICAgbWVzc2FnZXMucHVzaCh0aGlzLmdldEVycm9yTWVzc2FnZShuYW1lLCB2YWxpZGF0aW9uRXJyb3IpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbWVzc2FnZXM7XG4gICAgfVxuXG4gICAgZGVmYXVsdFNob3dFcnJvcihlbGVtZW50OiBIVE1MRWxlbWVudCwgZXJyb3JNZXNzYWdlczogc3RyaW5nW10pIHtcbiAgICAgICAgaWYgKGVsZW1lbnQgJiYgZWxlbWVudC5wYXJlbnRFbGVtZW50KSB7XG4gICAgICAgICAgICBjb25zdCBkb2N1bWVudEZyYWcgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7XG4gICAgICAgICAgICBjb25zdCBkaXZOb2RlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnRElWJyk7XG4gICAgICAgICAgICBjb25zdCB0ZXh0Tm9kZSA9IGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKGVycm9yTWVzc2FnZXNbMF0pO1xuICAgICAgICAgICAgZGl2Tm9kZS5hcHBlbmRDaGlsZCh0ZXh0Tm9kZSk7XG4gICAgICAgICAgICBkaXZOb2RlLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCBJTlZBTElEX0ZFRURCQUNLX0NMQVNTKTtcbiAgICAgICAgICAgIGRvY3VtZW50RnJhZy5hcHBlbmRDaGlsZChkaXZOb2RlKTtcbiAgICAgICAgICAgIGVsZW1lbnQucGFyZW50RWxlbWVudC5hcHBlbmQoZG9jdW1lbnRGcmFnKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGRlZmF1bHRSZW1vdmVFcnJvcihlbGVtZW50OiBIVE1MRWxlbWVudCkge1xuICAgICAgICBpZiAoZWxlbWVudCAmJiBlbGVtZW50LnBhcmVudEVsZW1lbnQpIHtcbiAgICAgICAgICAgIGNvbnN0IGludmFsaWRGZWVkYmFjayA9IGVsZW1lbnQucGFyZW50RWxlbWVudC5xdWVyeVNlbGVjdG9yKCcuaW52YWxpZC1mZWVkYmFjaycpO1xuICAgICAgICAgICAgZWxlbWVudC5wYXJlbnRFbGVtZW50LnJlbW92ZUNoaWxkKGludmFsaWRGZWVkYmFjayk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICByZW1vdmVFcnJvcihlbGVtZW50OiBIVE1MRWxlbWVudCkge1xuICAgICAgICBlbGVtZW50LmNsYXNzTGlzdC5yZW1vdmUoSU5WQUxJRF9DTEFTUyk7XG4gICAgICAgIGlmIChoZWxwZXJzLmlzRnVuY3Rpb24odGhpcy5jb25maWcucmVtb3ZlRWxlbWVudEVycm9yKSkge1xuICAgICAgICAgICAgdGhpcy5jb25maWcucmVtb3ZlRWxlbWVudEVycm9yKGVsZW1lbnQpO1xuICAgICAgICB9IGVsc2UgaWYgKHRoaXMuY29uZmlnLnNob3dFbGVtZW50RXJyb3IpIHtcbiAgICAgICAgICAgIHRoaXMuZGVmYXVsdFJlbW92ZUVycm9yKGVsZW1lbnQpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLy8gZG8gbm90aGluZ3NcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHNob3dFcnJvcihlbGVtZW50OiBIVE1MRWxlbWVudCwgZXJyb3JNZXNzYWdlczogc3RyaW5nW10pIHtcbiAgICAgICAgZWxlbWVudC5jbGFzc0xpc3QuYWRkKElOVkFMSURfQ0xBU1MpO1xuICAgICAgICBpZiAoaGVscGVycy5pc0Z1bmN0aW9uKHRoaXMuY29uZmlnLnNob3dFbGVtZW50RXJyb3IpKSB7XG4gICAgICAgICAgICB0aGlzLmNvbmZpZy5zaG93RWxlbWVudEVycm9yKGVsZW1lbnQsIGVycm9yTWVzc2FnZXMpO1xuICAgICAgICB9IGVsc2UgaWYgKHRoaXMuY29uZmlnLnNob3dFbGVtZW50RXJyb3IpIHtcbiAgICAgICAgICAgIHRoaXMuZGVmYXVsdFNob3dFcnJvcihlbGVtZW50LCBlcnJvck1lc3NhZ2VzKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIC8vIGRvIG5vdGhpbmdzXG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhZGRWYWxpZGF0aW9uTWVzc2FnZXMobWVzc2FnZXM6IFRoeUZvcm1WYWxpZGF0aW9uTWVzc2FnZXMpIHtcbiAgICAgICAgT2JqZWN0LmFzc2lnbih0aGlzLmNvbmZpZy52YWxpZGF0aW9uTWVzc2FnZXMsIG1lc3NhZ2VzKTtcbiAgICB9XG5cbiAgICBzZXRHbG9iYWxWYWxpZGF0aW9uTWVzc2FnZXModmFsaWRhdGlvbk1lc3NhZ2VzOiBEaWN0aW9uYXJ5PHN0cmluZz4pIHtcbiAgICAgICAgdGhpcy5jb25maWcuZ2xvYmFsVmFsaWRhdGlvbk1lc3NhZ2VzID0gdmFsaWRhdGlvbk1lc3NhZ2VzO1xuICAgIH1cbn1cbiJdfQ==