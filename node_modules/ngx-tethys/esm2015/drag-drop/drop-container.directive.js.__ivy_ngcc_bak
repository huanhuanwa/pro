import { Directive, Output, EventEmitter, ContentChildren, QueryList, NgZone, Input } from '@angular/core';
import { ThyDragDirective } from './drag.directive';
import { merge, defer } from 'rxjs';
import { mixinUnsubscribe, MixinBase } from 'ngx-tethys/core';
import { takeUntil, startWith, take, switchMap } from 'rxjs/operators';
import { THY_DROP_CONTAINER_DIRECTIVE } from './drop-container.class';
const _MixinBase = mixinUnsubscribe(MixinBase);
export class ThyDropContainerDirective extends _MixinBase {
    constructor(ngZone) {
        super();
        this.ngZone = ngZone;
        this.started = new EventEmitter();
        this.ended = new EventEmitter();
        this.overed = new EventEmitter();
        this.dropped = new EventEmitter();
    }
    set dragContainer(data) {
        this.data = data;
    }
    ngOnInit() { }
    ngAfterContentInit() {
        this.draggables.changes.pipe(startWith(null), takeUntil(this.ngUnsubscribe$)).subscribe(() => {
            this.draggableChanges();
        });
    }
    draggableChanges() {
        this.resetDraggableChanges(item => item.dragRef.started).subscribe(event => {
            this.started.emit(event);
        });
        this.resetDraggableChanges(item => item.dragRef.ended).subscribe(event => {
            this.ended.emit(event);
        });
        this.resetDraggableChanges(item => item.dragRef.overed).subscribe(event => {
            this.overed.emit(event);
        });
        this.resetDraggableChanges(item => item.dragRef.dropped).subscribe(event => {
            this.dropped.emit(event);
        });
    }
    resetDraggableChanges(fn) {
        return defer(() => {
            if (this.draggables) {
                return merge(...this.draggables.map(fn));
            }
            return this.ngZone.onStable.asObservable().pipe(take(1), switchMap(() => this.resetDraggableChanges.bind(this, fn)));
        }).pipe(takeUntil(merge(this.ngUnsubscribe$, this.draggables.changes)));
    }
}
ThyDropContainerDirective.decorators = [
    { type: Directive, args: [{
                selector: 'thy-drop-container,[thyDropContainer]',
                providers: [
                    {
                        provide: THY_DROP_CONTAINER_DIRECTIVE,
                        useExisting: ThyDropContainerDirective
                    }
                ]
            },] }
];
ThyDropContainerDirective.ctorParameters = () => [
    { type: NgZone }
];
ThyDropContainerDirective.propDecorators = {
    dragContainer: [{ type: Input, args: ['thyDropContainer',] }],
    data: [{ type: Input, args: ['thyDropContainerData',] }],
    disabled: [{ type: Input, args: ['thyDropContainerDisabled',] }],
    beforeStart: [{ type: Input, args: ['thyBeforeDragStart',] }],
    beforeOver: [{ type: Input, args: ['thyBeforeDragOver',] }],
    beforeDrop: [{ type: Input, args: ['thyBeforeDragDrop',] }],
    started: [{ type: Output, args: ['thyDragStarted',] }],
    ended: [{ type: Output, args: ['thyDragEnded',] }],
    overed: [{ type: Output, args: ['thyDragOvered',] }],
    dropped: [{ type: Output, args: ['thyDragDropped',] }],
    draggables: [{ type: ContentChildren, args: [ThyDragDirective, {
                    descendants: false
                },] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHJvcC1jb250YWluZXIuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2RyYWctZHJvcC9kcm9wLWNvbnRhaW5lci5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFVLFNBQVMsRUFBRSxNQUFNLEVBQUUsWUFBWSxFQUFFLGVBQWUsRUFBRSxTQUFTLEVBQW9CLE1BQU0sRUFBRSxLQUFLLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDckksT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDcEQsT0FBTyxFQUFFLEtBQUssRUFBYyxLQUFLLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDaEQsT0FBTyxFQUFFLGdCQUFnQixFQUFFLFNBQVMsRUFBK0IsTUFBTSxpQkFBaUIsQ0FBQztBQUMzRixPQUFPLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFdkUsT0FBTyxFQUFFLDRCQUE0QixFQUE4QixNQUFNLHdCQUF3QixDQUFDO0FBRWxHLE1BQU0sVUFBVSxHQUFtRCxnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsQ0FBQztBQVcvRixNQUFNLE9BQU8seUJBQW1DLFNBQVEsVUFBVTtJQTZCOUQsWUFBb0IsTUFBYztRQUM5QixLQUFLLEVBQUUsQ0FBQztRQURRLFdBQU0sR0FBTixNQUFNLENBQVE7UUFiUixZQUFPLEdBQUcsSUFBSSxZQUFZLEVBQXVDLENBQUM7UUFFcEUsVUFBSyxHQUFHLElBQUksWUFBWSxFQUFxQyxDQUFDO1FBRTdELFdBQU0sR0FBRyxJQUFJLFlBQVksRUFBc0MsQ0FBQztRQUUvRCxZQUFPLEdBQUcsSUFBSSxZQUFZLEVBQXNDLENBQUM7SUFTM0YsQ0FBQztJQTlCRCxJQUNJLGFBQWEsQ0FBQyxJQUFTO1FBQ3ZCLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO0lBQ3JCLENB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ZUFBZTtzQkFFdEIsTUFBTSxTQUFDLGdCQUFnQjt5QkFFdkIsZUFBZSxTQUFDLGdCQUFnQixFQUFFO29CQUMvQixXQUFXLEVBQUUsS0FBSztpQkFDckIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBPbkluaXQsIERpcmVjdGl2ZSwgT3V0cHV0LCBFdmVudEVtaXR0ZXIsIENvbnRlbnRDaGlsZHJlbiwgUXVlcnlMaXN0LCBBZnRlckNvbnRlbnRJbml0LCBOZ1pvbmUsIElucHV0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBUaHlEcmFnRGlyZWN0aXZlIH0gZnJvbSAnLi9kcmFnLmRpcmVjdGl2ZSc7XG5pbXBvcnQgeyBtZXJnZSwgT2JzZXJ2YWJsZSwgZGVmZXIgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IG1peGluVW5zdWJzY3JpYmUsIE1peGluQmFzZSwgQ29uc3RydWN0b3IsIFRoeVVuc3Vic2NyaWJlIH0gZnJvbSAnbmd4LXRldGh5cy9jb3JlJztcbmltcG9ydCB7IHRha2VVbnRpbCwgc3RhcnRXaXRoLCB0YWtlLCBzd2l0Y2hNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBUaHlEcmFnRHJvcEV2ZW50LCBUaHlEcmFnU3RhcnRFdmVudCwgVGh5RHJhZ0VuZEV2ZW50LCBUaHlEcmFnT3ZlckV2ZW50IH0gZnJvbSAnLi9kcmFnLWRyb3AuY2xhc3MnO1xuaW1wb3J0IHsgVEhZX0RST1BfQ09OVEFJTkVSX0RJUkVDVElWRSwgSVRoeURyb3BDb250YWluZXJEaXJlY3RpdmUgfSBmcm9tICcuL2Ryb3AtY29udGFpbmVyLmNsYXNzJztcblxuY29uc3QgX01peGluQmFzZTogQ29uc3RydWN0b3I8VGh5VW5zdWJzY3JpYmU+ICYgdHlwZW9mIE1peGluQmFzZSA9IG1peGluVW5zdWJzY3JpYmUoTWl4aW5CYXNlKTtcblxuQERpcmVjdGl2ZSh7XG4gICAgc2VsZWN0b3I6ICd0aHktZHJvcC1jb250YWluZXIsW3RoeURyb3BDb250YWluZXJdJyxcbiAgICBwcm92aWRlcnM6IFtcbiAgICAgICAge1xuICAgICAgICAgICAgcHJvdmlkZTogVEhZX0RST1BfQ09OVEFJTkVSX0RJUkVDVElWRSxcbiAgICAgICAgICAgIHVzZUV4aXN0aW5nOiBUaHlEcm9wQ29udGFpbmVyRGlyZWN0aXZlXG4gICAgICAgIH1cbiAgICBdXG59KVxuZXhwb3J0IGNsYXNzIFRoeURyb3BDb250YWluZXJEaXJlY3RpdmU8VCA9IGFueT4gZXh0ZW5kcyBfTWl4aW5CYXNlIGltcGxlbWVudHMgT25Jbml0LCBBZnRlckNvbnRlbnRJbml0LCBJVGh5RHJvcENvbnRhaW5lckRpcmVjdGl2ZSB7XG4gICAgQElucHV0KCd0aHlEcm9wQ29udGFpbmVyJylcbiAgICBzZXQgZHJhZ0NvbnRhaW5lcihkYXRhOiBUW10pIHtcbiAgICAgICAgdGhpcy5kYXRhID0gZGF0YTtcbiAgICB9XG5cbiAgICBASW5wdXQoJ3RoeURyb3BDb250YWluZXJEYXRhJykgZGF0YTogVFtdO1xuXG4gICAgQElucHV0KCd0aHlEcm9wQ29udGFpbmVyRGlzYWJsZWQnKSBkaXNhYmxlZDogYm9vbGVhbjtcblxuICAgIEBJbnB1dCgndGh5QmVmb3JlRHJhZ1N0YXJ0JykgYmVmb3JlU3RhcnQ6IChlOiBUaHlEcmFnU3RhcnRFdmVudDxUPikgPT4gYm9vbGVhbjtcblxuICAgIEBJbnB1dCgndGh5QmVmb3JlRHJhZ092ZXInKSBiZWZvcmVPdmVyOiAoZTogVGh5RHJhZ092ZXJFdmVudDxUPikgPT4gYm9vbGVhbjtcblxuICAgIEBJbnB1dCgndGh5QmVmb3JlRHJhZ0Ryb3AnKSBiZWZvcmVEcm9wOiAoZTogVGh5RHJhZ0Ryb3BFdmVudDxUPikgPT4gYm9vbGVhbjtcblxuICAgIEBPdXRwdXQoJ3RoeURyYWdTdGFydGVkJykgc3RhcnRlZCA9IG5ldyBFdmVudEVtaXR0ZXI8VGh5RHJhZ1N0YXJ0RXZlbnQ8VGh5RHJhZ0RpcmVjdGl2ZT4+KCk7XG5cbiAgICBAT3V0cHV0KCd0aHlEcmFnRW5kZWQnKSBlbmRlZCA9IG5ldyBFdmVudEVtaXR0ZXI8VGh5RHJhZ0VuZEV2ZW50PFRoeURyYWdEaXJlY3RpdmU+PigpO1xuXG4gICAgQE91dHB1dCgndGh5RHJhZ092ZXJlZCcpIG92ZXJlZCA9IG5ldyBFdmVudEVtaXR0ZXI8VGh5RHJhZ092ZXJFdmVudDxUaHlEcmFnRGlyZWN0aXZlPj4oKTtcblxuICAgIEBPdXRwdXQoJ3RoeURyYWdEcm9wcGVkJykgZHJvcHBlZCA9IG5ldyBFdmVudEVtaXR0ZXI8VGh5RHJhZ0Ryb3BFdmVudDxUaHlEcmFnRGlyZWN0aXZlPj4oKTtcblxuICAgIEBDb250ZW50Q2hpbGRyZW4oVGh5RHJhZ0RpcmVjdGl2ZSwge1xuICAgICAgICBkZXNjZW5kYW50czogZmFsc2VcbiAgICB9KVxuICAgIGRyYWdnYWJsZXM6IFF1ZXJ5TGlzdDxUaHlEcmFnRGlyZWN0aXZlPjtcblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgbmdab25lOiBOZ1pvbmUpIHtcbiAgICAgICAgc3VwZXIoKTtcbiAgICB9XG5cbiAgICBuZ09uSW5pdCgpIHt9XG5cbiAgICBuZ0FmdGVyQ29udGVudEluaXQoKSB7XG4gICAgICAgIHRoaXMuZHJhZ2dhYmxlcy5jaGFuZ2VzLnBpcGUoc3RhcnRXaXRoKG51bGwpLCB0YWtlVW50aWwodGhpcy5uZ1Vuc3Vic2NyaWJlJCkpLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmRyYWdnYWJsZUNoYW5nZXMoKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBkcmFnZ2FibGVDaGFuZ2VzKCkge1xuICAgICAgICB0aGlzLnJlc2V0RHJhZ2dhYmxlQ2hhbmdlcyhpdGVtID0+IGl0ZW0uZHJhZ1JlZi5zdGFydGVkKS5zdWJzY3JpYmUoZXZlbnQgPT4ge1xuICAgICAgICAgICAgdGhpcy5zdGFydGVkLmVtaXQoZXZlbnQpO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5yZXNldERyYWdnYWJsZUNoYW5nZXMoaXRlbSA9PiBpdGVtLmRyYWdSZWYuZW5kZWQpLnN1YnNjcmliZShldmVudCA9PiB7XG4gICAgICAgICAgICB0aGlzLmVuZGVkLmVtaXQoZXZlbnQpO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5yZXNldERyYWdnYWJsZUNoYW5nZXMoaXRlbSA9PiBpdGVtLmRyYWdSZWYub3ZlcmVkKS5zdWJzY3JpYmUoZXZlbnQgPT4ge1xuICAgICAgICAgICAgdGhpcy5vdmVyZWQuZW1pdChldmVudCk7XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLnJlc2V0RHJhZ2dhYmxlQ2hhbmdlcyhpdGVtID0+IGl0ZW0uZHJhZ1JlZi5kcm9wcGVkKS5zdWJzY3JpYmUoZXZlbnQgPT4ge1xuICAgICAgICAgICAgdGhpcy5kcm9wcGVkLmVtaXQoZXZlbnQpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHJlc2V0RHJhZ2dhYmxlQ2hhbmdlcyhmbjogKGl0ZW06IFRoeURyYWdEaXJlY3RpdmUpID0+IE9ic2VydmFibGU8YW55Pikge1xuICAgICAgICByZXR1cm4gZGVmZXIoKCkgPT4ge1xuICAgICAgICAgICAgaWYgKHRoaXMuZHJhZ2dhYmxlcykge1xuICAgICAgICAgICAgICAgIHJldHVybiBtZXJnZSguLi50aGlzLmRyYWdnYWJsZXMubWFwKGZuKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5uZ1pvbmUub25TdGFibGUuYXNPYnNlcnZhYmxlKCkucGlwZShcbiAgICAgICAgICAgICAgICB0YWtlKDEpLFxuICAgICAgICAgICAgICAgIHN3aXRjaE1hcCgoKSA9PiB0aGlzLnJlc2V0RHJhZ2dhYmxlQ2hhbmdlcy5iaW5kKHRoaXMsIGZuKSlcbiAgICAgICAgICAgICk7XG4gICAgICAgIH0pLnBpcGUodGFrZVVudGlsKG1lcmdlKHRoaXMubmdVbnN1YnNjcmliZSQsIHRoaXMuZHJhZ2dhYmxlcy5jaGFuZ2VzKSkpIGFzIE9ic2VydmFibGU8YW55PjtcbiAgICB9XG59XG4iXX0=