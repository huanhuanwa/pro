import { coerceElement } from '@angular/cdk/coercion';
import { Subject, fromEvent } from 'rxjs';
import { takeUntil } from 'rxjs/operators';
import { ThyDropPosition } from './drag-drop.class';
import { coerceArray } from 'ngx-tethys/util';
const dropPositionClass = {
    [ThyDropPosition.in]: 'thy-drop-position-in',
    [ThyDropPosition.before]: 'thy-drop-position-before',
    [ThyDropPosition.after]: 'thy-drop-position-after'
};
export class DragRef {
    constructor(element, drag, container, dragDropService, document, ngZone) {
        this.drag = drag;
        this.container = container;
        this.dragDropService = dragDropService;
        this.document = document;
        this.ngZone = ngZone;
        this.ngUnsubscribe$ = new Subject();
        this.started = new Subject();
        this.ended = new Subject();
        this.overed = new Subject();
        this.dropped = new Subject();
        this.entered = new Subject();
        this.leaved = new Subject();
        this._disabled = false;
        this.withRootElement(element);
    }
    get disabled() {
        return (this.container && this.container.disabled) || this._disabled;
    }
    set disabled(value) {
        this._disabled = value;
    }
    withRootElement(rootElement) {
        const element = coerceElement(rootElement);
        this.rootElement = element;
        this.registerDragDropEvents();
        return this;
    }
    withContentElement(contentElement) {
        this.contentElement = coerceElement(contentElement);
        return this;
    }
    withHandles(handleOrHandles) {
        this.handles = coerceArray(handleOrHandles);
        return this;
    }
    registerDragDropEvents() {
        const events = {
            dragstart: this.dragStart,
            dragover: this.dragOver,
            dragend: this.dragEnd,
            drop: this.dragDrop,
            dragleave: this.dragLeave,
            dragenter: (event) => {
                this.entered.next(event);
            },
            mouseover: (event) => {
                this.target = event.target;
            }
        };
        this.ngZone.runOutsideAngular(() => {
            for (const name in events) {
                if (events.hasOwnProperty(name)) {
                    fromEvent(this.rootElement, name)
                        .pipe(takeUntil(this.ngUnsubscribe$))
                        .subscribe(events[name].bind(this));
                }
            }
        });
    }
    dragStart(event) {
        event.stopPropagation();
        const dragStartEvent = {
            event: event,
            item: this.drag.data,
            containerItems: this.container.data,
            currentIndex: this.container.data.indexOf(this.drag.data)
        };
        if (this.disabled || !this.isTriggerHandle() || (this.container.beforeStart && !this.container.beforeStart(dragStartEvent))) {
            event.preventDefault();
            return false;
        }
        this.dragDropService.previousDrag = this.drag;
        this.ngZone.run(() => {
            this.started.next(dragStartEvent);
        });
    }
    isTriggerHandle() {
        if (this.handles && this.handles.length > 0) {
            const targetHandle = this.handles.find(handle => {
                return (!handle.disabled && (handle.element.nativeElement === this.target || handle.element.nativeElement.contains(this.target)));
            });
            return !!targetHandle;
        }
        else {
            return true;
        }
    }
    getPreviousEventData() {
        const previousItem = this.dragDropService.previousDrag.data;
        const previousContainerItems = this.dragDropService.previousDrag.container.data;
        return {
            previousItem: previousItem,
            previousContainerItems: this.dragDropService.previousDrag.container.data,
            previousIndex: previousContainerItems.indexOf(previousItem)
        };
    }
    isContinueDragOver(event, container) {
        if (event.item === event.previousItem && event.position === ThyDropPosition.in) {
            return false;
        }
        if (container && container.beforeOver) {
            return container.beforeOver(event);
        }
        return true;
    }
    dragOver(event) {
        event.stopPropagation();
        event.preventDefault();
        const dropPosition = this.calcDropPosition(event);
        const dragOverEvent = Object.assign({ event: event, item: this.drag.data, containerItems: this.drag.container.data, currentIndex: this.container.data.indexOf(this.drag.data), position: dropPosition }, this.getPreviousEventData());
        if (this.isContinueDragOver(dragOverEvent, this.container)) {
            this.dragOverHandler(dropPosition);
            this.overed.next(dragOverEvent);
        }
    }
    dragOverHandler(position) {
        const element = this.contentElement || this.rootElement;
        if (this.dragDropService.dropPosition !== position) {
            this.clearDragPositionClass();
        }
        element.classList.add(dropPositionClass[position]);
        this.dragDropService.dropPosition = position;
    }
    dragDrop(event) {
        event.stopPropagation();
        this.clearDragPositionClass();
        const dragDropEvent = Object.assign({ event: event, item: this.drag.data, containerItems: this.drag.container.data, currentIndex: this.container.data.indexOf(this.drag.data), position: this.calcDropPosition(event) }, this.getPreviousEventData());
        if (this.dragDropService.previousDrag === this.drag || (this.container.beforeDrop && !this.container.beforeDrop(dragDropEvent))) {
            event.preventDefault();
            return;
        }
        this.ngZone.run(() => {
            this.dropped.next(dragDropEvent);
        });
    }
    dragEnd(event) {
        this.ngZone.run(() => {
            this.ended.next({
                event: event,
                item: this.drag.data,
                containerItems: this.container.data
            });
        });
    }
    dragLeave(event) {
        event.stopPropagation();
        this.clearDragPositionClass();
        this.leaved.next(event);
    }
    clearDragPositionClass() {
        const element = this.contentElement || this.rootElement;
        for (const key in dropPositionClass) {
            if (dropPositionClass[key]) {
                element.classList.remove(dropPositionClass[key]);
            }
        }
    }
    calcDropPosition(event) {
        const sideRange = 0.25;
        const minGap = 2;
        const { clientY } = event;
        const { top, bottom, height } = event.srcElement
            ? event.srcElement.getBoundingClientRect()
            : event.target.getBoundingClientRect();
        const des = Math.max(height * sideRange, minGap);
        if (clientY <= top + des) {
            return ThyDropPosition.before;
        }
        else if (clientY >= bottom - des) {
            return ThyDropPosition.after;
        }
        return ThyDropPosition.in;
    }
    dispose() {
        this.ngUnsubscribe$.complete();
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHJhZy1yZWYuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvZHJhZy1kcm9wL2RyYWctcmVmLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUN0RCxPQUFPLEVBQUUsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMxQyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFHM0MsT0FBTyxFQUEwRSxlQUFlLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUc1SCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFFOUMsTUFBTSxpQkFBaUIsR0FBRztJQUN0QixDQUFDLGVBQWUsQ0FBQyxFQUFFLENBQUMsRUFBRSxzQkFBc0I7SUFDNUMsQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDLEVBQUUsMEJBQTBCO0lBQ3BELENBQUMsZUFBZSxDQUFDLEtBQUssQ0FBQyxFQUFFLHlCQUF5QjtDQUNyRCxDQUFDO0FBRUYsTUFBTSxPQUFPLE9BQU87SUFnQ2hCLFlBQ0ksT0FBOEMsRUFDdEMsSUFBc0IsRUFDdEIsU0FBd0MsRUFDeEMsZUFBc0MsRUFDdEMsUUFBYSxFQUNiLE1BQWM7UUFKZCxTQUFJLEdBQUosSUFBSSxDQUFrQjtRQUN0QixjQUFTLEdBQVQsU0FBUyxDQUErQjtRQUN4QyxvQkFBZSxHQUFmLGVBQWUsQ0FBdUI7UUFDdEMsYUFBUSxHQUFSLFFBQVEsQ0FBSztRQUNiLFdBQU0sR0FBTixNQUFNLENBQVE7UUE3QmxCLG1CQUFjLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQztRQUV2QyxZQUFPLEdBQUcsSUFBSSxPQUFPLEVBQXFCLENBQUM7UUFFM0MsVUFBSyxHQUFHLElBQUksT0FBTyxFQUFtQixDQUFDO1FBRXZDLFdBQU0sR0FBRyxJQUFJLE9BQU8sRUFBb0IsQ0FBQztRQUV6QyxZQUFPLEdBQUcs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QyxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUM7UUFDdkIsTUFBTSxNQUFNLEdBQUcsQ0FBQyxDQUFDO1FBQ2pCLE1BQU0sRUFBRSxPQUFPLEVBQUUsR0FBRyxLQUFLLENBQUM7UUFDMUIsTUFBTSxFQUFFLEdBQUcsRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLEdBQUcsS0FBSyxDQUFDLFVBQVU7WUFDNUMsQ0FBQyxDQUFFLEtBQUssQ0FBQyxVQUFzQixDQUFDLHFCQUFxQixFQUFFO1lBQ3ZELENBQUMsQ0FBRSxLQUFLLENBQUMsTUFBa0IsQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO1FBQ3hELE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxHQUFHLFNBQVMsRUFBRSxNQUFNLENBQUMsQ0FBQztRQUNqRCxJQUFJLE9BQU8sSUFBSSxHQUFHLEdBQUcsR0FBRyxFQUFFO1lBQ3RCLE9BQU8sZUFBZSxDQUFDLE1BQU0sQ0FBQztTQUNqQzthQUFNLElBQUksT0FBTyxJQUFJLE1BQU0sR0FBRyxHQUFHLEVBQUU7WUFDaEMsT0FBTyxlQUFlLENBQUMsS0FBSyxDQUFDO1NBQ2hDO1FBQ0QsT0FBTyxlQUFlLENBQUMsRUFBRSxDQUFDO0lBQzlCLENBQUM7SUFFRCxPQUFPO1FBQ0gsSUFBSSxDQUFDLGNBQWMsQ0FBQyxRQUFRLEVBQUUsQ0FBQztJQUNuQyxDQUFDO0NBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBOZ1pvbmUsIEVsZW1lbnRSZWYgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IGNvZXJjZUVsZW1lbnQgfSBmcm9tICdAYW5ndWxhci9jZGsvY29lcmNpb24nO1xuaW1wb3J0IHsgU3ViamVjdCwgZnJvbUV2ZW50IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyB0YWtlVW50aWwgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBUaHlEcmFnSGFuZGxlRGlyZWN0aXZlIH0gZnJvbSAnLi9kcmFnLWhhbmRsZS5kaXJlY3RpdmUnO1xuaW1wb3J0IHsgVGh5RHJhZ0Ryb3BTZXJ2aWNlIH0gZnJvbSAnLi9kcmFnLWRyb3Auc2VydmljZSc7XG5pbXBvcnQgeyBUaHlEcmFnU3RhcnRFdmVudCwgVGh5RHJhZ0VuZEV2ZW50LCBUaHlEcmFnT3ZlckV2ZW50LCBUaHlEcmFnRHJvcEV2ZW50LCBUaHlEcm9wUG9zaXRpb24gfSBmcm9tICcuL2RyYWctZHJvcC5jbGFzcyc7XG5pbXBvcnQgeyBUaHlEcmFnRGlyZWN0aXZlIH0gZnJvbSAnLi9kcmFnLmRpcmVjdGl2ZSc7XG5pbXBvcnQgeyBJVGh5RHJvcENvbnRhaW5lckRpcmVjdGl2ZSB9IGZyb20gJy4vZHJvcC1jb250YWluZXIuY2xhc3MnO1xuaW1wb3J0IHsgY29lcmNlQXJyYXkgfSBmcm9tICduZ3gtdGV0aHlzL3V0aWwnO1xuXG5jb25zdCBkcm9wUG9zaXRpb25DbGFzcyA9IHtcbiAgICBbVGh5RHJvcFBvc2l0aW9uLmluXTogJ3RoeS1kcm9wLXBvc2l0aW9uLWluJyxcbiAgICBbVGh5RHJvcFBvc2l0aW9uLmJlZm9yZV06ICd0aHktZHJvcC1wb3NpdGlvbi1iZWZvcmUnLFxuICAgIFtUaHlEcm9wUG9zaXRpb24uYWZ0ZXJdOiAndGh5LWRyb3AtcG9zaXRpb24tYWZ0ZXInXG59O1xuXG5leHBvcnQgY2xhc3MgRHJhZ1JlZjxUID0gYW55PiB7XG4gICAgcHJpdmF0ZSByb290RWxlbWVudDogSFRNTEVsZW1lbnQ7XG5cbiAgICBwcml2YXRlIGNvbnRlbnRFbGVtZW50OiBIVE1MRWxlbWVudDtcblxuICAgIHByaXZhdGUgdGFyZ2V0OiBIVE1MRWxlbWVudDtcblxuICAgIHByaXZhdGUgaGFuZGxlczogVGh5RHJhZ0hhbmRsZURpcmVjdGl2ZVtdO1xuXG4gICAgcHJpdmF0ZSBuZ1Vuc3Vic2NyaWJlJCA9IG5ldyBTdWJqZWN0KCk7XG5cbiAgICBzdGFydGVkID0gbmV3IFN1YmplY3Q8VGh5RHJhZ1N0YXJ0RXZlbnQ+KCk7XG5cbiAgICBlbmRlZCA9IG5ldyBTdWJqZWN0PFRoeURyYWdFbmRFdmVudD4oKTtcblxuICAgIG92ZXJlZCA9IG5ldyBTdWJqZWN0PFRoeURyYWdPdmVyRXZlbnQ+KCk7XG5cbiAgICBkcm9wcGVkID0gbmV3IFN1YmplY3Q8VGh5RHJhZ0Ryb3BFdmVudD4oKTtcblxuICAgIGVudGVyZWQgPSBuZXcgU3ViamVjdDxEcmFnRXZlbnQ+KCk7XG5cbiAgICBsZWF2ZWQgPSBuZXcgU3ViamVjdDxEcmFnRXZlbnQ+KCk7XG5cbiAgICBwcml2YXRlIF9kaXNhYmxlZCA9IGZhbHNlO1xuXG4gICAgZ2V0IGRpc2FibGVkKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gKHRoaXMuY29udGFpbmVyICYmIHRoaXMuY29udGFpbmVyLmRpc2FibGVkKSB8fCB0aGlzLl9kaXNhYmxlZDtcbiAgICB9XG4gICAgc2V0IGRpc2FibGVkKHZhbHVlOiBib29sZWFuKSB7XG4gICAgICAgIHRoaXMuX2Rpc2FibGVkID0gdmFsdWU7XG4gICAgfVxuXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIGVsZW1lbnQ6IEVsZW1lbnRSZWY8SFRNTEVsZW1lbnQ+IHwgSFRNTEVsZW1lbnQsXG4gICAgICAgIHByaXZhdGUgZHJhZzogVGh5RHJhZ0RpcmVjdGl2ZSxcbiAgICAgICAgcHJpdmF0ZSBjb250YWluZXI6IElUaHlEcm9wQ29udGFpbmVyRGlyZWN0aXZlPFQ+LFxuICAgICAgICBwcml2YXRlIGRyYWdEcm9wU2VydmljZTogVGh5RHJhZ0Ryb3BTZXJ2aWNlPFQ+LFxuICAgICAgICBwcml2YXRlIGRvY3VtZW50OiBhbnksXG4gICAgICAgIHByaXZhdGUgbmdab25lOiBOZ1pvbmVcbiAgICApIHtcbiAgICAgICAgdGhpcy53aXRoUm9vdEVsZW1lbnQoZWxlbWVudCk7XG4gICAgfVxuXG4gICAgd2l0aFJvb3RFbGVtZW50KHJvb3RFbGVtZW50OiBFbGVtZW50UmVmPEhUTUxFbGVtZW50PiB8IEhUTUxFbGVtZW50KTogdGhpcyB7XG4gICAgICAgIGNvbnN0IGVsZW1lbnQgPSBjb2VyY2VFbGVtZW50KHJvb3RFbGVtZW50KTtcbiAgICAgICAgdGhpcy5yb290RWxlbWVudCA9IGVsZW1lbnQ7XG4gICAgICAgIHRoaXMucmVnaXN0ZXJEcmFnRHJvcEV2ZW50cygpO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICB3aXRoQ29udGVudEVsZW1lbnQoY29udGVudEVsZW1lbnQ6IEVsZW1lbnRSZWY8SFRNTEVsZW1lbnQ+IHwgSFRNTEVsZW1lbnQpOiB0aGlzIHtcbiAgICAgICAgdGhpcy5jb250ZW50RWxlbWVudCA9IGNvZXJjZUVsZW1lbnQoY29udGVudEVsZW1lbnQpO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICB3aXRoSGFuZGxlcyhoYW5kbGVPckhhbmRsZXM6IFRoeURyYWdIYW5kbGVEaXJlY3RpdmUgfCBUaHlEcmFnSGFuZGxlRGlyZWN0aXZlW10pOiB0aGlzIHtcbiAgICAgICAgdGhpcy5oYW5kbGVzID0gY29lcmNlQXJyYXkoaGFuZGxlT3JIYW5kbGVzKTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSByZWdpc3RlckRyYWdEcm9wRXZlbnRzKCkge1xuICAgICAgICBjb25zdCBldmVudHMgPSB7XG4gICAgICAgICAgICBkcmFnc3RhcnQ6IHRoaXMuZHJhZ1N0YXJ0LFxuICAgICAgICAgICAgZHJhZ292ZXI6IHRoaXMuZHJhZ092ZXIsXG4gICAgICAgICAgICBkcmFnZW5kOiB0aGlzLmRyYWdFbmQsXG4gICAgICAgICAgICBkcm9wOiB0aGlzLmRyYWdEcm9wLFxuICAgICAgICAgICAgZHJhZ2xlYXZlOiB0aGlzLmRyYWdMZWF2ZSxcbiAgICAgICAgICAgIGRyYWdlbnRlcjogKGV2ZW50OiBEcmFnRXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmVudGVyZWQubmV4dChldmVudCk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgbW91c2VvdmVyOiAoZXZlbnQ6IE1vdXNlRXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldCA9IGV2ZW50LnRhcmdldCBhcyBIVE1MRWxlbWVudDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5uZ1pvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT4ge1xuICAgICAgICAgICAgZm9yIChjb25zdCBuYW1lIGluIGV2ZW50cykge1xuICAgICAgICAgICAgICAgIGlmIChldmVudHMuaGFzT3duUHJvcGVydHkobmFtZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgZnJvbUV2ZW50KHRoaXMucm9vdEVsZW1lbnQsIG5hbWUpXG4gICAgICAgICAgICAgICAgICAgICAgICAucGlwZSh0YWtlVW50aWwodGhpcy5uZ1Vuc3Vic2NyaWJlJCkpXG4gICAgICAgICAgICAgICAgICAgICAgICAuc3Vic2NyaWJlKGV2ZW50c1tuYW1lXS5iaW5kKHRoaXMpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgZHJhZ1N0YXJ0KGV2ZW50OiBEcmFnRXZlbnQpIHtcbiAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgIGNvbnN0IGRyYWdTdGFydEV2ZW50OiBUaHlEcmFnU3RhcnRFdmVudCA9IHtcbiAgICAgICAgICAgIGV2ZW50OiBldmVudCxcbiAgICAgICAgICAgIGl0ZW06IHRoaXMuZHJhZy5kYXRhLFxuICAgICAgICAgICAgY29udGFpbmVySXRlbXM6IHRoaXMuY29udGFpbmVyLmRhdGEsXG4gICAgICAgICAgICBjdXJyZW50SW5kZXg6IHRoaXMuY29udGFpbmVyLmRhdGEuaW5kZXhPZih0aGlzLmRyYWcuZGF0YSlcbiAgICAgICAgfTtcbiAgICAgICAgaWYgKHRoaXMuZGlzYWJsZWQgfHwgIXRoaXMuaXNUcmlnZ2VySGFuZGxlKCkgfHwgKHRoaXMuY29udGFpbmVyLmJlZm9yZVN0YXJ0ICYmICF0aGlzLmNvbnRhaW5lci5iZWZvcmVTdGFydChkcmFnU3RhcnRFdmVudCkpKSB7XG4gICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuZHJhZ0Ryb3BTZXJ2aWNlLnByZXZpb3VzRHJhZyA9IHRoaXMuZHJhZztcbiAgICAgICAgdGhpcy5uZ1pvbmUucnVuKCgpID0+IHtcbiAgICAgICAgICAgIHRoaXMuc3RhcnRlZC5uZXh0KGRyYWdTdGFydEV2ZW50KTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBpc1RyaWdnZXJIYW5kbGUoKSB7XG4gICAgICAgIGlmICh0aGlzLmhhbmRsZXMgJiYgdGhpcy5oYW5kbGVzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIGNvbnN0IHRhcmdldEhhbmRsZSA9IHRoaXMuaGFuZGxlcy5maW5kKGhhbmRsZSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgICAgICAgICAgIWhhbmRsZS5kaXNhYmxlZCAmJiAoaGFuZGxlLmVsZW1lbnQubmF0aXZlRWxlbWVudCA9PT0gdGhpcy50YXJnZXQgfHwgaGFuZGxlLmVsZW1lbnQubmF0aXZlRWxlbWVudC5jb250YWlucyh0aGlzLnRhcmdldCkpXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcmV0dXJuICEhdGFyZ2V0SGFuZGxlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGdldFByZXZpb3VzRXZlbnREYXRhKCkge1xuICAgICAgICBjb25zdCBwcmV2aW91c0l0ZW0gPSB0aGlzLmRyYWdEcm9wU2VydmljZS5wcmV2aW91c0RyYWcuZGF0YTtcbiAgICAgICAgY29uc3QgcHJldmlvdXNDb250YWluZXJJdGVtcyA9IHRoaXMuZHJhZ0Ryb3BTZXJ2aWNlLnByZXZpb3VzRHJhZy5jb250YWluZXIuZGF0YTtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHByZXZpb3VzSXRlbTogcHJldmlvdXNJdGVtLFxuICAgICAgICAgICAgcHJldmlvdXNDb250YWluZXJJdGVtczogdGhpcy5kcmFnRHJvcFNlcnZpY2UucHJldmlvdXNEcmFnLmNvbnRhaW5lci5kYXRhLFxuICAgICAgICAgICAgcHJldmlvdXNJbmRleDogcHJldmlvdXNDb250YWluZXJJdGVtcy5pbmRleE9mKHByZXZpb3VzSXRlbSlcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGlzQ29udGludWVEcmFnT3ZlcihldmVudDogVGh5RHJhZ092ZXJFdmVudCwgY29udGFpbmVyOiBJVGh5RHJvcENvbnRhaW5lckRpcmVjdGl2ZTxUPikge1xuICAgICAgICBpZiAoZXZlbnQuaXRlbSA9PT0gZXZlbnQucHJldmlvdXNJdGVtICYmIGV2ZW50LnBvc2l0aW9uID09PSBUaHlEcm9wUG9zaXRpb24uaW4pIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoY29udGFpbmVyICYmIGNvbnRhaW5lci5iZWZvcmVPdmVyKSB7XG4gICAgICAgICAgICByZXR1cm4gY29udGFpbmVyLmJlZm9yZU92ZXIoZXZlbnQpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIHByaXZhdGUgZHJhZ092ZXIoZXZlbnQ6IERyYWdFdmVudCkge1xuICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcblxuICAgICAgICBjb25zdCBkcm9wUG9zaXRpb24gPSB0aGlzLmNhbGNEcm9wUG9zaXRpb24oZXZlbnQpO1xuICAgICAgICBjb25zdCBkcmFnT3ZlckV2ZW50OiBUaHlEcmFnT3ZlckV2ZW50PFQ+ID0ge1xuICAgICAgICAgICAgZXZlbnQ6IGV2ZW50LFxuICAgICAgICAgICAgaXRlbTogdGhpcy5kcmFnLmRhdGEsXG4gICAgICAgICAgICBjb250YWluZXJJdGVtczogdGhpcy5kcmFnLmNvbnRhaW5lci5kYXRhLFxuICAgICAgICAgICAgY3VycmVudEluZGV4OiB0aGlzLmNvbnRhaW5lci5kYXRhLmluZGV4T2YodGhpcy5kcmFnLmRhdGEpLFxuICAgICAgICAgICAgcG9zaXRpb246IGRyb3BQb3NpdGlvbixcbiAgICAgICAgICAgIC4uLnRoaXMuZ2V0UHJldmlvdXNFdmVudERhdGEoKVxuICAgICAgICB9O1xuXG4gICAgICAgIGlmICh0aGlzLmlzQ29udGludWVEcmFnT3ZlcihkcmFnT3ZlckV2ZW50LCB0aGlzLmNvbnRhaW5lcikpIHtcbiAgICAgICAgICAgIHRoaXMuZHJhZ092ZXJIYW5kbGVyKGRyb3BQb3NpdGlvbik7XG4gICAgICAgICAgICB0aGlzLm92ZXJlZC5uZXh0KGRyYWdPdmVyRXZlbnQpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBkcmFnT3ZlckhhbmRsZXIocG9zaXRpb246IFRoeURyb3BQb3NpdGlvbikge1xuICAgICAgICBjb25zdCBlbGVtZW50ID0gdGhpcy5jb250ZW50RWxlbWVudCB8fCB0aGlzLnJvb3RFbGVtZW50O1xuICAgICAgICBpZiAodGhpcy5kcmFnRHJvcFNlcnZpY2UuZHJvcFBvc2l0aW9uICE9PSBwb3NpdGlvbikge1xuICAgICAgICAgICAgdGhpcy5jbGVhckRyYWdQb3NpdGlvbkNsYXNzKCk7XG4gICAgICAgIH1cbiAgICAgICAgZWxlbWVudC5jbGFzc0xpc3QuYWRkKGRyb3BQb3NpdGlvbkNsYXNzW3Bvc2l0aW9uXSk7XG4gICAgICAgIHRoaXMuZHJhZ0Ryb3BTZXJ2aWNlLmRyb3BQb3NpdGlvbiA9IHBvc2l0aW9uO1xuICAgIH1cblxuICAgIHByaXZhdGUgZHJhZ0Ryb3AoZXZlbnQ6IERyYWdFdmVudCkge1xuICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgdGhpcy5jbGVhckRyYWdQb3NpdGlvbkNsYXNzKCk7XG4gICAgICAgIGNvbnN0IGRyYWdEcm9wRXZlbnQ6IFRoeURyYWdEcm9wRXZlbnQ8VD4gPSB7XG4gICAgICAgICAgICBldmVudDogZXZlbnQsXG4gICAgICAgICAgICBpdGVtOiB0aGlzLmRyYWcuZGF0YSxcbiAgICAgICAgICAgIGNvbnRhaW5lckl0ZW1zOiB0aGlzLmRyYWcuY29udGFpbmVyLmRhdGEsXG4gICAgICAgICAgICBjdXJyZW50SW5kZXg6IHRoaXMuY29udGFpbmVyLmRhdGEuaW5kZXhPZih0aGlzLmRyYWcuZGF0YSksXG4gICAgICAgICAgICBwb3NpdGlvbjogdGhpcy5jYWxjRHJvcFBvc2l0aW9uKGV2ZW50KSxcbiAgICAgICAgICAgIC4uLnRoaXMuZ2V0UHJldmlvdXNFdmVudERhdGEoKVxuICAgICAgICB9O1xuICAgICAgICBpZiAodGhpcy5kcmFnRHJvcFNlcnZpY2UucHJldmlvdXNEcmFnID09PSB0aGlzLmRyYWcgfHwgKHRoaXMuY29udGFpbmVyLmJlZm9yZURyb3AgJiYgIXRoaXMuY29udGFpbmVyLmJlZm9yZURyb3AoZHJhZ0Ryb3BFdmVudCkpKSB7XG4gICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMubmdab25lLnJ1bigoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmRyb3BwZWQubmV4dChkcmFnRHJvcEV2ZW50KTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBkcmFnRW5kKGV2ZW50OiBEcmFnRXZlbnQpIHtcbiAgICAgICAgdGhpcy5uZ1pvbmUucnVuKCgpID0+IHtcbiAgICAgICAgICAgIHRoaXMuZW5kZWQubmV4dCh7XG4gICAgICAgICAgICAgICAgZXZlbnQ6IGV2ZW50LFxuICAgICAgICAgICAgICAgIGl0ZW06IHRoaXMuZHJhZy5kYXRhLFxuICAgICAgICAgICAgICAgIGNvbnRhaW5lckl0ZW1zOiB0aGlzLmNvbnRhaW5lci5kYXRhXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBkcmFnTGVhdmUoZXZlbnQ6IERyYWdFdmVudCkge1xuICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgdGhpcy5jbGVhckRyYWdQb3NpdGlvbkNsYXNzKCk7XG4gICAgICAgIHRoaXMubGVhdmVkLm5leHQoZXZlbnQpO1xuICAgIH1cblxuICAgIHByaXZhdGUgY2xlYXJEcmFnUG9zaXRpb25DbGFzcygpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgZWxlbWVudCA9IHRoaXMuY29udGVudEVsZW1lbnQgfHwgdGhpcy5yb290RWxlbWVudDtcbiAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gZHJvcFBvc2l0aW9uQ2xhc3MpIHtcbiAgICAgICAgICAgIGlmIChkcm9wUG9zaXRpb25DbGFzc1trZXldKSB7XG4gICAgICAgICAgICAgICAgZWxlbWVudC5jbGFzc0xpc3QucmVtb3ZlKGRyb3BQb3NpdGlvbkNsYXNzW2tleV0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjYWxjRHJvcFBvc2l0aW9uKGV2ZW50OiBEcmFnRXZlbnQpOiBUaHlEcm9wUG9zaXRpb24ge1xuICAgICAgICBjb25zdCBzaWRlUmFuZ2UgPSAwLjI1O1xuICAgICAgICBjb25zdCBtaW5HYXAgPSAyO1xuICAgICAgICBjb25zdCB7IGNsaWVudFkgfSA9IGV2ZW50O1xuICAgICAgICBjb25zdCB7IHRvcCwgYm90dG9tLCBoZWlnaHQgfSA9IGV2ZW50LnNyY0VsZW1lbnRcbiAgICAgICAgICAgID8gKGV2ZW50LnNyY0VsZW1lbnQgYXMgRWxlbWVudCkuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KClcbiAgICAgICAgICAgIDogKGV2ZW50LnRhcmdldCBhcyBFbGVtZW50KS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcbiAgICAgICAgY29uc3QgZGVzID0gTWF0aC5tYXgoaGVpZ2h0ICogc2lkZVJhbmdlLCBtaW5HYXApO1xuICAgICAgICBpZiAoY2xpZW50WSA8PSB0b3AgKyBkZXMpIHtcbiAgICAgICAgICAgIHJldHVybiBUaHlEcm9wUG9zaXRpb24uYmVmb3JlO1xuICAgICAgICB9IGVsc2UgaWYgKGNsaWVudFkgPj0gYm90dG9tIC0gZGVzKSB7XG4gICAgICAgICAgICByZXR1cm4gVGh5RHJvcFBvc2l0aW9uLmFmdGVyO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBUaHlEcm9wUG9zaXRpb24uaW47XG4gICAgfVxuXG4gICAgZGlzcG9zZSgpIHtcbiAgICAgICAgdGhpcy5uZ1Vuc3Vic2NyaWJlJC5jb21wbGV0ZSgpO1xuICAgIH1cbn1cbiJdfQ==