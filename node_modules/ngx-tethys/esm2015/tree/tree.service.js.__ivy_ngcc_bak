import { Injectable } from '@angular/core';
import { ThyTreeNodeCheckState } from './tree.class';
import { Subject } from 'rxjs';
import { coerceArray } from 'ngx-tethys/util';
function checkStateResolve(node) {
    const checkedNodes = node.children.filter(n => n.isChecked === ThyTreeNodeCheckState.checked);
    const unCheckedNodes = node.children.filter(n => n.isChecked === ThyTreeNodeCheckState.unchecked);
    if (checkedNodes.length === node.children.length) {
        return ThyTreeNodeCheckState.checked;
    }
    else if (unCheckedNodes.length === node.children.length) {
        return ThyTreeNodeCheckState.unchecked;
    }
    else {
        return ThyTreeNodeCheckState.indeterminate;
    }
}
export class ThyTreeService {
    constructor() {
        this.checkStateResolve = checkStateResolve;
        this.$statusChange = new Subject();
    }
    _getParallelTreeNodes(nodes, list = []) {
        (nodes || []).forEach(node => {
            list.push(node);
            this._getParallelTreeNodes(node.children || [], list);
        });
        return list;
    }
    setCheckStateResolve(resolve = checkStateResolve) {
        this.checkStateResolve = resolve;
    }
    resetSortedTreeNodes(treeNodes, parent) {
        treeNodes.forEach(node => {
            node.level = node.parentNode ? node.parentNode.level + 1 : 0;
            node.origin.children = node.children.map(n => n.origin);
            node.parentNode = parent;
            this.resetSortedTreeNodes(node.children, node);
        });
    }
    getTreeNode(key) {
        const allNodes = this._getParallelTreeNodes(this.treeNodes);
        return allNodes.find(n => n.key === key);
    }
    getExpandedNodes() {
        const allNodes = this._getParallelTreeNodes(this.treeNodes);
        return allNodes.filter(n => n.isExpanded);
    }
    getCheckedNodes() {
        const allNodes = this._getParallelTreeNodes(this.treeNodes);
        return allNodes.filter(n => n.isChecked === ThyTreeNodeCheckState.checked);
    }
    deleteTreeNode(node) {
        const children = node.parentNode ? node.parentNode.children : this.treeNodes;
        const index = children.findIndex(n => n.key === node.key);
        if (index > -1) {
            children.splice(index, 1);
        }
    }
    expandTreeNodes(keyOrKeys) {
        const keys = coerceArray(keyOrKeys);
        const needExpandNodes = this._getParallelTreeNodes(this.treeNodes).filter(node => {
            return keys.indexOf(node.key) > -1;
        });
        needExpandNodes.forEach(node => {
            node.setExpanded(true);
        });
    }
    statusChanged() {
        return this.$statusChange.asObservable();
    }
    // 设置节点选中状态
    setNodeChecked(node, checked, propagateUp = true, propagateDown = true) {
        node.isChecked = checked ? ThyTreeNodeCheckState.checked : ThyTreeNodeCheckState.unchecked;
        node.origin.checked = checked;
        if (propagateDown && node.children) {
            node.children.forEach(subNode => {
                this.setNodeChecked(subNode, checked, false, true);
            });
        }
        if (propagateUp) {
            this.syncNodeCheckState(node.parentNode);
        }
    }
    syncNodeCheckState(node) {
        if (node) {
            node.isChecked = this.checkStateResolve(node);
            this.syncNodeCheckState(node.parentNode);
        }
    }
    ngOnDestroy() {
        this.$statusChange.complete();
        this.$statusChange = null;
    }
}
ThyTreeService.decorators = [
    { type: Injectable }
];
ThyTreeService.ctorParameters = () => [];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJlZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL3RyZWUvdHJlZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQWEsTUFBTSxlQUFlLENBQUM7QUFDdEQsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQ3JELE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFL0IsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBRTlDLFNBQVMsaUJBQWlCLENBQUMsSUFBaUI7SUFDeEMsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsU0FBUyxLQUFLLHFCQUFxQixDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQzlGLE1BQU0sY0FBYyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLFNBQVMsS0FBSyxxQkFBcUIsQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUNsRyxJQUFJLFlBQVksQ0FBQyxNQUFNLEtBQUssSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEVBQUU7UUFDOUMsT0FBTyxxQkFBcUIsQ0FBQyxPQUFPLENBQUM7S0FDeEM7U0FBTSxJQUFJLGNBQWMsQ0FBQyxNQUFNLEtBQUssSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEVBQUU7UUFDdkQsT0FBTyxxQkFBcUIsQ0FBQyxTQUFTLENBQUM7S0FDMUM7U0FBTTtRQUNILE9BQU8scUJBQXFCLENBQUMsYUFBYSxDQUFDO0tBQzlDO0FBQ0wsQ0FBQztBQUdELE1BQU0sT0FBTyxjQUFjO0lBT3ZCO1FBSlEsc0JBQWlCLEdBQWlELGlCQUFpQixDQUFDO1FBRTVGLGtCQUFhLEdBQUcsSUFBSSxPQUFPLEVBQTBCLENB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QUFJLENBQUMsQ0FBQztZQUM5QyxJQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1NBQzVDO0lBQ0wsQ0FBQztJQUVELFdBQVc7UUFDUCxJQUFJLENBQUMsYUFBYSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQzlCLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDO0lBQzlCLENBQUM7OztZQTVGSixVQUFVIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgT25EZXN0cm95IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBUaHlUcmVlTm9kZUNoZWNrU3RhdGUgfSBmcm9tICcuL3RyZWUuY2xhc3MnO1xuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgVGh5VHJlZU5vZGUgfSBmcm9tICcuL3RyZWUtbm9kZS5jbGFzcyc7XG5pbXBvcnQgeyBjb2VyY2VBcnJheSB9IGZyb20gJ25neC10ZXRoeXMvdXRpbCc7XG5cbmZ1bmN0aW9uIGNoZWNrU3RhdGVSZXNvbHZlKG5vZGU6IFRoeVRyZWVOb2RlKSB7XG4gICAgY29uc3QgY2hlY2tlZE5vZGVzID0gbm9kZS5jaGlsZHJlbi5maWx0ZXIobiA9PiBuLmlzQ2hlY2tlZCA9PT0gVGh5VHJlZU5vZGVDaGVja1N0YXRlLmNoZWNrZWQpO1xuICAgIGNvbnN0IHVuQ2hlY2tlZE5vZGVzID0gbm9kZS5jaGlsZHJlbi5maWx0ZXIobiA9PiBuLmlzQ2hlY2tlZCA9PT0gVGh5VHJlZU5vZGVDaGVja1N0YXRlLnVuY2hlY2tlZCk7XG4gICAgaWYgKGNoZWNrZWROb2Rlcy5sZW5ndGggPT09IG5vZGUuY2hpbGRyZW4ubGVuZ3RoKSB7XG4gICAgICAgIHJldHVybiBUaHlUcmVlTm9kZUNoZWNrU3RhdGUuY2hlY2tlZDtcbiAgICB9IGVsc2UgaWYgKHVuQ2hlY2tlZE5vZGVzLmxlbmd0aCA9PT0gbm9kZS5jaGlsZHJlbi5sZW5ndGgpIHtcbiAgICAgICAgcmV0dXJuIFRoeVRyZWVOb2RlQ2hlY2tTdGF0ZS51bmNoZWNrZWQ7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIFRoeVRyZWVOb2RlQ2hlY2tTdGF0ZS5pbmRldGVybWluYXRlO1xuICAgIH1cbn1cblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFRoeVRyZWVTZXJ2aWNlIGltcGxlbWVudHMgT25EZXN0cm95IHtcbiAgICBwdWJsaWMgdHJlZU5vZGVzOiBUaHlUcmVlTm9kZVtdO1xuXG4gICAgcHJpdmF0ZSBjaGVja1N0YXRlUmVzb2x2ZTogKG5vZGU6IFRoeVRyZWVOb2RlKSA9PiBUaHlUcmVlTm9kZUNoZWNrU3RhdGUgPSBjaGVja1N0YXRlUmVzb2x2ZTtcblxuICAgICRzdGF0dXNDaGFuZ2UgPSBuZXcgU3ViamVjdDxUaHlUcmVlRm9ybWF0RW1pdEV2ZW50PigpO1xuXG4gICAgY29uc3RydWN0b3IoKSB7fVxuXG4gICAgcHJpdmF0ZSBfZ2V0UGFyYWxsZWxUcmVlTm9kZXMobm9kZXM6IFRoeVRyZWVOb2RlW10sIGxpc3Q6IFRoeVRyZWVOb2RlW10gPSBbXSkge1xuICAgICAgICAobm9kZXMgfHwgW10pLmZvckVhY2gobm9kZSA9PiB7XG4gICAgICAgICAgICBsaXN0LnB1c2gobm9kZSk7XG4gICAgICAgICAgICB0aGlzLl9nZXRQYXJhbGxlbFRyZWVOb2Rlcyhub2RlLmNoaWxkcmVuIHx8IFtdLCBsaXN0KTtcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBsaXN0O1xuICAgIH1cblxuICAgIHNldENoZWNrU3RhdGVSZXNvbHZlKHJlc29sdmU6IChub2RlOiBUaHlUcmVlTm9kZSkgPT4gVGh5VHJlZU5vZGVDaGVja1N0YXRlID0gY2hlY2tTdGF0ZVJlc29sdmUpIHtcbiAgICAgICAgdGhpcy5jaGVja1N0YXRlUmVzb2x2ZSA9IHJlc29sdmU7XG4gICAgfVxuXG4gICAgcHVibGljIHJlc2V0U29ydGVkVHJlZU5vZGVzKHRyZWVOb2RlczogVGh5VHJlZU5vZGVbXSwgcGFyZW50PzogVGh5VHJlZU5vZGUpIHtcbiAgICAgICAgdHJlZU5vZGVzLmZvckVhY2gobm9kZSA9PiB7XG4gICAgICAgICAgICBub2RlLmxldmVsID0gbm9kZS5wYXJlbnROb2RlID8gbm9kZS5wYXJlbnROb2RlLmxldmVsICsgMSA6IDA7XG4gICAgICAgICAgICBub2RlLm9yaWdpbi5jaGlsZHJlbiA9IG5vZGUuY2hpbGRyZW4ubWFwKG4gPT4gbi5vcmlnaW4pO1xuICAgICAgICAgICAgbm9kZS5wYXJlbnROb2RlID0gcGFyZW50O1xuICAgICAgICAgICAgdGhpcy5yZXNldFNvcnRlZFRyZWVOb2Rlcyhub2RlLmNoaWxkcmVuLCBub2RlKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIGdldFRyZWVOb2RlKGtleTogc3RyaW5nIHwgbnVtYmVyKSB7XG4gICAgICAgIGNvbnN0IGFsbE5vZGVzID0gdGhpcy5fZ2V0UGFyYWxsZWxUcmVlTm9kZXModGhpcy50cmVlTm9kZXMpO1xuICAgICAgICByZXR1cm4gYWxsTm9kZXMuZmluZChuID0+IG4ua2V5ID09PSBrZXkpO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXRFeHBhbmRlZE5vZGVzKCk6IFRoeVRyZWVOb2RlW10ge1xuICAgICAgICBjb25zdCBhbGxOb2RlcyA9IHRoaXMuX2dldFBhcmFsbGVsVHJlZU5vZGVzKHRoaXMudHJlZU5vZGVzKTtcbiAgICAgICAgcmV0dXJuIGFsbE5vZGVzLmZpbHRlcihuID0+IG4uaXNFeHBhbmRlZCk7XG4gICAgfVxuXG4gICAgcHVibGljIGdldENoZWNrZWROb2RlcygpOiBUaHlUcmVlTm9kZVtdIHtcbiAgICAgICAgY29uc3QgYWxsTm9kZXMgPSB0aGlzLl9nZXRQYXJhbGxlbFRyZWVOb2Rlcyh0aGlzLnRyZWVOb2Rlcyk7XG4gICAgICAgIHJldHVybiBhbGxOb2Rlcy5maWx0ZXIobiA9PiBuLmlzQ2hlY2tlZCA9PT0gVGh5VHJlZU5vZGVDaGVja1N0YXRlLmNoZWNrZWQpO1xuICAgIH1cblxuICAgIHB1YmxpYyBkZWxldGVUcmVlTm9kZShub2RlOiBUaHlUcmVlTm9kZSkge1xuICAgICAgICBjb25zdCBjaGlsZHJlbiA9IG5vZGUucGFyZW50Tm9kZSA/IG5vZGUucGFyZW50Tm9kZS5jaGlsZHJlbiA6IHRoaXMudHJlZU5vZGVzO1xuICAgICAgICBjb25zdCBpbmRleCA9IGNoaWxkcmVuLmZpbmRJbmRleChuID0+IG4ua2V5ID09PSBub2RlLmtleSk7XG4gICAgICAgIGlmIChpbmRleCA+IC0xKSB7XG4gICAgICAgICAgICBjaGlsZHJlbi5zcGxpY2UoaW5kZXgsIDEpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIGV4cGFuZFRyZWVOb2RlcyhrZXlPcktleXM6IHN0cmluZyB8IG51bWJlciB8IChzdHJpbmcgfCBudW1iZXIpW10pIHtcbiAgICAgICAgY29uc3Qga2V5cyA9IGNvZXJjZUFycmF5KGtleU9yS2V5cyk7XG4gICAgICAgIGNvbnN0IG5lZWRFeHBhbmROb2RlcyA9IHRoaXMuX2dldFBhcmFsbGVsVHJlZU5vZGVzKHRoaXMudHJlZU5vZGVzKS5maWx0ZXIobm9kZSA9PiB7XG4gICAgICAgICAgICByZXR1cm4ga2V5cy5pbmRleE9mKG5vZGUua2V5KSA+IC0xO1xuICAgICAgICB9KTtcbiAgICAgICAgbmVlZEV4cGFuZE5vZGVzLmZvckVhY2gobm9kZSA9PiB7XG4gICAgICAgICAgICBub2RlLnNldEV4cGFuZGVkKHRydWUpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdHVzQ2hhbmdlZCgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuJHN0YXR1c0NoYW5nZS5hc09ic2VydmFibGUoKTtcbiAgICB9XG5cbiAgICAvLyDorr7nva7oioLngrnpgInkuK3nirbmgIFcbiAgICBwdWJsaWMgc2V0Tm9kZUNoZWNrZWQobm9kZTogVGh5VHJlZU5vZGUsIGNoZWNrZWQ6IGJvb2xlYW4sIHByb3BhZ2F0ZVVwID0gdHJ1ZSwgcHJvcGFnYXRlRG93biA9IHRydWUpIHtcbiAgICAgICAgbm9kZS5pc0NoZWNrZWQgPSBjaGVja2VkID8gVGh5VHJlZU5vZGVDaGVja1N0YXRlLmNoZWNrZWQgOiBUaHlUcmVlTm9kZUNoZWNrU3RhdGUudW5jaGVja2VkO1xuICAgICAgICBub2RlLm9yaWdpbi5jaGVja2VkID0gY2hlY2tlZDtcbiAgICAgICAgaWYgKHByb3BhZ2F0ZURvd24gJiYgbm9kZS5jaGlsZHJlbikge1xuICAgICAgICAgICAgbm9kZS5jaGlsZHJlbi5mb3JFYWNoKHN1Yk5vZGUgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuc2V0Tm9kZUNoZWNrZWQoc3ViTm9kZSwgY2hlY2tlZCwgZmFsc2UsIHRydWUpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHByb3BhZ2F0ZVVwKSB7XG4gICAgICAgICAgICB0aGlzLnN5bmNOb2RlQ2hlY2tTdGF0ZShub2RlLnBhcmVudE5vZGUpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIHN5bmNOb2RlQ2hlY2tTdGF0ZShub2RlOiBUaHlUcmVlTm9kZSkge1xuICAgICAgICBpZiAobm9kZSkge1xuICAgICAgICAgICAgbm9kZS5pc0NoZWNrZWQgPSB0aGlzLmNoZWNrU3RhdGVSZXNvbHZlKG5vZGUpO1xuICAgICAgICAgICAgdGhpcy5zeW5jTm9kZUNoZWNrU3RhdGUobm9kZS5wYXJlbnROb2RlKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgICAgICB0aGlzLiRzdGF0dXNDaGFuZ2UuY29tcGxldGUoKTtcbiAgICAgICAgdGhpcy4kc3RhdHVzQ2hhbmdlID0gbnVsbDtcbiAgICB9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgVGh5VHJlZUZvcm1hdEVtaXRFdmVudCB7XG4gICAgZXZlbnROYW1lOiBzdHJpbmc7XG4gICAgbm9kZTogVGh5VHJlZU5vZGU7XG4gICAgZXZlbnQ/OiBNb3VzZUV2ZW50IHwgRHJhZ0V2ZW50O1xufVxuIl19