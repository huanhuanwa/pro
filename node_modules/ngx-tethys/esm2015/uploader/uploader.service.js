import { Injectable } from '@angular/core';
import { Observable, from } from 'rxjs';
import { coerceArray } from 'ngx-tethys/util';
import { map, tap, mergeMap } from 'rxjs/operators';
import { HttpClient, XhrFactory } from '@angular/common/http';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@angular/common/http';
export var ThyUploadStatus;
(function (ThyUploadStatus) {
    ThyUploadStatus["pending"] = "pending";
    ThyUploadStatus["started"] = "started";
    ThyUploadStatus["uploading"] = "uploading";
    ThyUploadStatus["done"] = "done";
})(ThyUploadStatus || (ThyUploadStatus = {}));
export class ThyUploaderService {
    constructor(http, xhrFactory) {
        this.http = http;
        this.xhrFactory = xhrFactory;
    }
    secondsToHuman(sec) {
        return new Date(sec * 1000).toISOString().substr(11, 8);
    }
    humanizeBytes(bytes) {
        if (bytes === 0) {
            return '0 Byte';
        }
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    normalizeUploadFiles(uploadFiles) {
        coerceArray(uploadFiles).forEach(uploadFile => {
            if (!uploadFile.progress) {
                uploadFile.progress = {
                    status: ThyUploadStatus.pending,
                    percentage: 0,
                    startTime: 0
                };
            }
        });
    }
    // private uploadByHttp(observer: Subscriber<ThyUploadResponse>, uploadFile: ThyUploadFile) {
    //     const time: number = new Date().getTime();
    //     let speed = 0;
    //     let estimatedTime: number | null = null;
    //     uploadFile.progress = {
    //         status: ThyUploadStatus.started,
    //         percentage: 0,
    //         startTime: time
    //     };
    //     const formData = new FormData();
    //     Object.keys(uploadFile.data || {}).forEach(key => formData.append(key, uploadFile.data[key]));
    //     formData.append(uploadFile.fileField || 'file', uploadFile.nativeFile, uploadFile.fileName);
    //     const headers = {
    //         'Content-Type': 'multipart/form-data'
    //     };
    //     Object.keys(uploadFile.headers || {}).forEach(key => (headers[key] = uploadFile.headers[key]));
    //     const subscription = this.http
    //         .post(uploadFile.url, formData, {
    //             headers: headers,
    //             reportProgress: true,
    //             observe: 'events',
    //             withCredentials: uploadFile.withCredentials ? true : false
    //         })
    //         .subscribe(
    //             (event: HttpEvent<any>) => {
    //                 console.log('Subscribe data', event);
    //                 switch (event.type) {
    //                     case HttpEventType.Sent:
    //                         observer.next({ status: ThyUploadStatus.started, uploadFile: uploadFile });
    //                         break;
    //                     case HttpEventType.UploadProgress:
    //                         let percentage = Math.round((event.loaded * 100) / event.total);
    //                         if (percentage === 100) {
    //                             percentage = 99;
    //                         }
    //                         const diff = new Date().getTime() - time;
    //                         speed = Math.round((event.loaded / diff) * 1000);
    //                         const progressStartTime = (uploadFile.progress && uploadFile.progress.startTime) || new Date().getTime();
    //                         estimatedTime = Math.ceil((event.total - event.loaded) / speed);
    //                         uploadFile.progress.status = ThyUploadStatus.uploading;
    //                         uploadFile.progress.percentage = percentage;
    //                         uploadFile.progress.speed = speed;
    //                         uploadFile.progress.speedHuman = `${this.humanizeBytes(speed)}/s`;
    //                         uploadFile.progress.startTime = progressStartTime;
    //                         uploadFile.progress.estimatedTime = estimatedTime;
    //                         uploadFile.progress.estimatedTimeHuman = this.secondsToHuman(estimatedTime);
    //                         observer.next({ status: ThyUploadStatus.uploading, uploadFile: uploadFile });
    //                         break;
    //                     case HttpEventType.Response:
    //                         uploadFile.response = event.body;
    //                         observer.next({ status: ThyUploadStatus.done, uploadFile: uploadFile });
    //                         break;
    //                     default:
    //                         throw new Error(`Unhandled event: ${event.type}`);
    //                 }
    //             },
    //             error => {
    //                 observer.error(error);
    //             }
    //         );
    //     return subscription;
    // }
    uploadByXhr(observer, uploadFile) {
        const xhr = this.xhrFactory.build();
        const time = new Date().getTime();
        let speed = 0;
        let estimatedTime = null;
        uploadFile.progress = {
            status: ThyUploadStatus.started,
            percentage: 0,
            startTime: time
        };
        xhr.upload.addEventListener('progress', (event) => {
            if (event.lengthComputable) {
                let percentage = Math.round((event.loaded * 100) / event.total);
                if (percentage === 100) {
                    percentage = 99;
                }
                const diff = new Date().getTime() - time;
                speed = Math.round((event.loaded / diff) * 1000);
                const progressStartTime = (uploadFile.progress && uploadFile.progress.startTime) || new Date().getTime();
                estimatedTime = Math.ceil((event.total - event.loaded) / speed);
                uploadFile.progress.status = ThyUploadStatus.uploading;
                uploadFile.progress.percentage = percentage;
                uploadFile.progress.speed = speed;
                uploadFile.progress.speedHuman = `${this.humanizeBytes(speed)}/s`;
                uploadFile.progress.startTime = progressStartTime;
                uploadFile.progress.estimatedTime = estimatedTime;
                uploadFile.progress.estimatedTimeHuman = this.secondsToHuman(estimatedTime);
                observer.next({ status: ThyUploadStatus.uploading, uploadFile: uploadFile });
            }
        }, false);
        xhr.upload.addEventListener('error', (e) => {
            observer.error(e);
            observer.complete();
        });
        xhr.onreadystatechange = () => {
            if (xhr.readyState === XMLHttpRequest.DONE) {
                const speedTime = (new Date().getTime() - uploadFile.progress.startTime) * 1000;
                const speedAverage = Math.round(uploadFile.nativeFile.size / speedTime);
                uploadFile.progress.status = ThyUploadStatus.done;
                uploadFile.progress.percentage = 100;
                uploadFile.progress.speed = speedAverage;
                uploadFile.progress.speedHuman = `${this.humanizeBytes(speed)}/s`;
                uploadFile.progress.estimatedTime = estimatedTime;
                uploadFile.progress.estimatedTimeHuman = this.secondsToHuman(estimatedTime || 0);
                uploadFile.responseStatus = xhr.status;
                try {
                    uploadFile.response = JSON.parse(xhr.response);
                }
                catch (e) {
                    uploadFile.response = xhr.response;
                }
                // file.responseHeaders = this.parseResponseHeaders(xhr.getAllResponseHeaders());
                observer.next({ status: ThyUploadStatus.done, uploadFile: uploadFile });
                observer.complete();
            }
        };
        xhr.open(uploadFile.method, uploadFile.url, true);
        xhr.withCredentials = uploadFile.withCredentials ? true : false;
        try {
            const formData = new FormData();
            Object.keys(uploadFile.data || {}).forEach(key => formData.append(key, uploadFile.data[key]));
            Object.keys(uploadFile.headers || {}).forEach(key => xhr.setRequestHeader(key, uploadFile.headers[key]));
            formData.append(uploadFile.fileField || 'file', uploadFile.nativeFile, uploadFile.fileName);
            observer.next({ status: ThyUploadStatus.started, uploadFile: uploadFile });
            xhr.send(formData);
        }
        catch (error) {
            observer.error(error);
            observer.complete();
        }
        return xhr;
    }
    ensureFileName(uploadFile) {
        uploadFile.fileName = uploadFile.fileName || uploadFile.nativeFile.name;
    }
    /**
     * 上传单个文件
     * @param uploadFile 上传文件对象
     */
    upload(uploadFile) {
        this.ensureFileName(uploadFile);
        return new Observable(observer => {
            const xhr = this.uploadByXhr(observer, uploadFile);
            return () => {
                xhr.abort();
            };
        });
    }
    /**
     * 并发上传多个文件
     * @param uploadFiles 上传文件列表
     * @param concurrent 并发上传数, 默认 5
     * @param options onStared, onDone 回调
     */
    uploadBulk(uploadFiles, concurrent = 5, options) {
        this.normalizeUploadFiles(uploadFiles);
        const result = from(uploadFiles).pipe(mergeMap(uploadFile => {
            return this.upload(uploadFile).pipe(tap(uploadResponse => {
                if (options && options.onStarted && uploadResponse.status === ThyUploadStatus.started) {
                    options.onStarted(uploadResponse.uploadFile);
                }
                if (options && options.onDone && uploadResponse.status === ThyUploadStatus.done) {
                    options.onDone(uploadResponse.uploadFile);
                }
            }));
        }, concurrent), map(response => {
            return response;
        }));
        return result;
    }
}
ThyUploaderService.ɵfac = function ThyUploaderService_Factory(t) { return new (t || ThyUploaderService)(ɵngcc0.ɵɵinject(ɵngcc1.HttpClient), ɵngcc0.ɵɵinject(ɵngcc1.XhrFactory)); };
ThyUploaderService.ɵprov = ɵngcc0.ɵɵdefineInjectable({ token: ThyUploaderService, factory: ThyUploaderService.ɵfac });
ThyUploaderService.ctorParameters = () => [
    { type: HttpClient },
    { type: XhrFactory }
];
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(ThyUploaderService, [{
        type: Injectable
    }], function () { return [{ type: ɵngcc1.HttpClient }, { type: ɵngcc1.XhrFactory }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXBsb2FkZXIuc2VydmljZS5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL3VwbG9hZGVyL3VwbG9hZGVyLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsVUFBVSxFQUF1QixJQUFJLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDN0QsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzlDLE9BQU8sRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLFFBQVEsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3BELE9BQU8sRUFBRSxVQUFVLEVBQTRCLFVBQVUsRUFBRSxNQUFNLHNCQUFzQixDQUFDOzs7QUFFeEYsTUFBTSxDQUFOLElBQVksZUFLWDtBQUxELFdBQVksZUFBZTtBQUMxQixJQUFHLHNDQUFtQixDQUFBO0FBQUMsSUFDcEIsc0NBQW1CLENBQUE7QUFBQyxJQUNwQiwwQ0FBdUIsQ0FBQTtBQUFDLElBQ3hCLGdDQUFhLENBQUE7QUFDakIsQ0FBQyxFQUxXLGVBQWUsS0FBZixlQUFlLFFBSzFCO0FBNENELE1BQU0sT0FBTyxrQkFBa0I7QUFDL0IsSUFBSSxZQUFvQixJQUFnQixFQUFVLFVBQXNCO0FBQUksUUFBcEQsU0FBSSxHQUFKLElBQUksQ0FBWTtBQUFDLFFBQVMsZUFBVSxHQUFWLFVBQVUsQ0FBWTtBQUFDLElBQUUsQ0FBQztBQUM1RSxJQUNZLGNBQWMsQ0FBQyxHQUFXO0FBQUksUUFDbEMsT0FBTyxJQUFJLElBQUksQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQztBQUNoRSxJQUFJLENBQUM7QUFDTCxJQUNZLGFBQWEsQ0FBQyxLQUFhO0FBQUksUUFDbkMsSUFBSSxLQUFLLEtBQUssQ0FBQyxFQUFFO0FBQ3pCLFlBQVksT0FB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VSxZQXBESixVQUFVO0FBQUksWUFBd0IsVUFBVTtBQUFHOzs7d0dBQUU7QUFBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE9ic2VydmFibGUsIFN1YmplY3QsIFN1YnNjcmliZXIsIGZyb20gfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGNvZXJjZUFycmF5IH0gZnJvbSAnbmd4LXRldGh5cy91dGlsJztcbmltcG9ydCB7IG1hcCwgdGFwLCBtZXJnZU1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEh0dHBDbGllbnQsIEh0dHBFdmVudCwgSHR0cEV2ZW50VHlwZSwgWGhyRmFjdG9yeSB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcblxuZXhwb3J0IGVudW0gVGh5VXBsb2FkU3RhdHVzIHtcbiAgICBwZW5kaW5nID0gJ3BlbmRpbmcnLFxuICAgIHN0YXJ0ZWQgPSAnc3RhcnRlZCcsXG4gICAgdXBsb2FkaW5nID0gJ3VwbG9hZGluZycsXG4gICAgZG9uZSA9ICdkb25lJ1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFRoeVVwbG9hZFJlc3BvbnNlIHtcbiAgICBzdGF0dXM6IFRoeVVwbG9hZFN0YXR1cztcbiAgICB1cGxvYWRGaWxlPzogVGh5VXBsb2FkRmlsZTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBUaHlVcGxvYWRGaWxlIHtcbiAgICBpZGVudGlmaWVyPzogc3RyaW5nO1xuICAgIG1ldGhvZDogc3RyaW5nO1xuICAgIHVybDogc3RyaW5nO1xuICAgIHdpdGhDcmVkZW50aWFscz86IGJvb2xlYW47XG4gICAgbmF0aXZlRmlsZTogRmlsZTtcbiAgICBmaWxlRmllbGQ/OiBzdHJpbmc7XG4gICAgZmlsZU5hbWU/OiBzdHJpbmc7XG4gICAgaGVhZGVycz86IHtcbiAgICAgICAgW2tleTogc3RyaW5nXTogc3RyaW5nO1xuICAgIH07XG4gICAgZGF0YT86IHtcbiAgICAgICAgW2tleTogc3RyaW5nXTogc3RyaW5nO1xuICAgIH07XG5cbiAgICByZXNwb25zZVN0YXR1cz86IGFueTtcbiAgICByZXNwb25zZT86IGFueTtcbiAgICByZXNwb25zZUhlYWRlcnM/OiBhbnk7XG5cbiAgICBwcm9ncmVzcz86IHtcbiAgICAgICAgc3RhdHVzOiBUaHlVcGxvYWRTdGF0dXM7XG4gICAgICAgIHBlcmNlbnRhZ2U6IG51bWJlcjtcbiAgICAgICAgc3BlZWQ/OiBudW1iZXI7XG4gICAgICAgIHNwZWVkSHVtYW4/OiBzdHJpbmc7XG4gICAgICAgIHN0YXJ0VGltZTogbnVtYmVyIHwgbnVsbDtcbiAgICAgICAgZW5kVGltZT86IG51bWJlciB8IG51bGw7XG4gICAgICAgIGVzdGltYXRlZFRpbWU/OiBudW1iZXIgfCBudWxsO1xuICAgICAgICBlc3RpbWF0ZWRUaW1lSHVtYW4/OiBzdHJpbmcgfCBudWxsO1xuICAgIH07XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgVGh5VXBsb2FkRmlsZXNPcHRpb25zIHtcbiAgICBvblN0YXJ0ZWQ/OiAoaXRlbTogVGh5VXBsb2FkRmlsZSkgPT4gdm9pZDtcbiAgICBvbkRvbmU/OiAoaXRlbTogVGh5VXBsb2FkRmlsZSkgPT4gdm9pZDtcbn1cblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFRoeVVwbG9hZGVyU2VydmljZSB7XG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBodHRwOiBIdHRwQ2xpZW50LCBwcml2YXRlIHhockZhY3Rvcnk6IFhockZhY3RvcnkpIHt9XG5cbiAgICBwcml2YXRlIHNlY29uZHNUb0h1bWFuKHNlYzogbnVtYmVyKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIG5ldyBEYXRlKHNlYyAqIDEwMDApLnRvSVNPU3RyaW5nKCkuc3Vic3RyKDExLCA4KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGh1bWFuaXplQnl0ZXMoYnl0ZXM6IG51bWJlcik6IHN0cmluZyB7XG4gICAgICAgIGlmIChieXRlcyA9PT0gMCkge1xuICAgICAgICAgICAgcmV0dXJuICcwIEJ5dGUnO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgayA9IDEwMjQ7XG4gICAgICAgIGNvbnN0IHNpemVzOiBzdHJpbmdbXSA9IFsnQnl0ZXMnLCAnS0InLCAnTUInLCAnR0InLCAnVEInLCAnUEInXTtcbiAgICAgICAgY29uc3QgaTogbnVtYmVyID0gTWF0aC5mbG9vcihNYXRoLmxvZyhieXRlcykgLyBNYXRoLmxvZyhrKSk7XG5cbiAgICAgICAgcmV0dXJuIHBhcnNlRmxvYXQoKGJ5dGVzIC8gTWF0aC5wb3coaywgaSkpLnRvRml4ZWQoMikpICsgJyAnICsgc2l6ZXNbaV07XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBub3JtYWxpemVVcGxvYWRGaWxlcyh1cGxvYWRGaWxlczogVGh5VXBsb2FkRmlsZSB8IFRoeVVwbG9hZEZpbGVbXSkge1xuICAgICAgICBjb2VyY2VBcnJheSh1cGxvYWRGaWxlcykuZm9yRWFjaCh1cGxvYWRGaWxlID0+IHtcbiAgICAgICAgICAgIGlmICghdXBsb2FkRmlsZS5wcm9ncmVzcykge1xuICAgICAgICAgICAgICAgIHVwbG9hZEZpbGUucHJvZ3Jlc3MgPSB7XG4gICAgICAgICAgICAgICAgICAgIHN0YXR1czogVGh5VXBsb2FkU3RhdHVzLnBlbmRpbmcsXG4gICAgICAgICAgICAgICAgICAgIHBlcmNlbnRhZ2U6IDAsXG4gICAgICAgICAgICAgICAgICAgIHN0YXJ0VGltZTogMFxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIHByaXZhdGUgdXBsb2FkQnlIdHRwKG9ic2VydmVyOiBTdWJzY3JpYmVyPFRoeVVwbG9hZFJlc3BvbnNlPiwgdXBsb2FkRmlsZTogVGh5VXBsb2FkRmlsZSkge1xuICAgIC8vICAgICBjb25zdCB0aW1lOiBudW1iZXIgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTtcbiAgICAvLyAgICAgbGV0IHNwZWVkID0gMDtcbiAgICAvLyAgICAgbGV0IGVzdGltYXRlZFRpbWU6IG51bWJlciB8IG51bGwgPSBudWxsO1xuXG4gICAgLy8gICAgIHVwbG9hZEZpbGUucHJvZ3Jlc3MgPSB7XG4gICAgLy8gICAgICAgICBzdGF0dXM6IFRoeVVwbG9hZFN0YXR1cy5zdGFydGVkLFxuICAgIC8vICAgICAgICAgcGVyY2VudGFnZTogMCxcbiAgICAvLyAgICAgICAgIHN0YXJ0VGltZTogdGltZVxuICAgIC8vICAgICB9O1xuXG4gICAgLy8gICAgIGNvbnN0IGZvcm1EYXRhID0gbmV3IEZvcm1EYXRhKCk7XG4gICAgLy8gICAgIE9iamVjdC5rZXlzKHVwbG9hZEZpbGUuZGF0YSB8fCB7fSkuZm9yRWFjaChrZXkgPT4gZm9ybURhdGEuYXBwZW5kKGtleSwgdXBsb2FkRmlsZS5kYXRhW2tleV0pKTtcbiAgICAvLyAgICAgZm9ybURhdGEuYXBwZW5kKHVwbG9hZEZpbGUuZmlsZUZpZWxkIHx8ICdmaWxlJywgdXBsb2FkRmlsZS5uYXRpdmVGaWxlLCB1cGxvYWRGaWxlLmZpbGVOYW1lKTtcbiAgICAvLyAgICAgY29uc3QgaGVhZGVycyA9IHtcbiAgICAvLyAgICAgICAgICdDb250ZW50LVR5cGUnOiAnbXVsdGlwYXJ0L2Zvcm0tZGF0YSdcbiAgICAvLyAgICAgfTtcbiAgICAvLyAgICAgT2JqZWN0LmtleXModXBsb2FkRmlsZS5oZWFkZXJzIHx8IHt9KS5mb3JFYWNoKGtleSA9PiAoaGVhZGVyc1trZXldID0gdXBsb2FkRmlsZS5oZWFkZXJzW2tleV0pKTtcblxuICAgIC8vICAgICBjb25zdCBzdWJzY3JpcHRpb24gPSB0aGlzLmh0dHBcbiAgICAvLyAgICAgICAgIC5wb3N0KHVwbG9hZEZpbGUudXJsLCBmb3JtRGF0YSwge1xuICAgIC8vICAgICAgICAgICAgIGhlYWRlcnM6IGhlYWRlcnMsXG4gICAgLy8gICAgICAgICAgICAgcmVwb3J0UHJvZ3Jlc3M6IHRydWUsXG4gICAgLy8gICAgICAgICAgICAgb2JzZXJ2ZTogJ2V2ZW50cycsXG4gICAgLy8gICAgICAgICAgICAgd2l0aENyZWRlbnRpYWxzOiB1cGxvYWRGaWxlLndpdGhDcmVkZW50aWFscyA/IHRydWUgOiBmYWxzZVxuICAgIC8vICAgICAgICAgfSlcbiAgICAvLyAgICAgICAgIC5zdWJzY3JpYmUoXG4gICAgLy8gICAgICAgICAgICAgKGV2ZW50OiBIdHRwRXZlbnQ8YW55PikgPT4ge1xuICAgIC8vICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnU3Vic2NyaWJlIGRhdGEnLCBldmVudCk7XG4gICAgLy8gICAgICAgICAgICAgICAgIHN3aXRjaCAoZXZlbnQudHlwZSkge1xuICAgIC8vICAgICAgICAgICAgICAgICAgICAgY2FzZSBIdHRwRXZlbnRUeXBlLlNlbnQ6XG4gICAgLy8gICAgICAgICAgICAgICAgICAgICAgICAgb2JzZXJ2ZXIubmV4dCh7IHN0YXR1czogVGh5VXBsb2FkU3RhdHVzLnN0YXJ0ZWQsIHVwbG9hZEZpbGU6IHVwbG9hZEZpbGUgfSk7XG4gICAgLy8gICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgLy8gICAgICAgICAgICAgICAgICAgICBjYXNlIEh0dHBFdmVudFR5cGUuVXBsb2FkUHJvZ3Jlc3M6XG4gICAgLy8gICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHBlcmNlbnRhZ2UgPSBNYXRoLnJvdW5kKChldmVudC5sb2FkZWQgKiAxMDApIC8gZXZlbnQudG90YWwpO1xuICAgIC8vICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwZXJjZW50YWdlID09PSAxMDApIHtcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGVyY2VudGFnZSA9IDk5O1xuICAgIC8vICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkaWZmID0gbmV3IERhdGUoKS5nZXRUaW1lKCkgLSB0aW1lO1xuICAgIC8vICAgICAgICAgICAgICAgICAgICAgICAgIHNwZWVkID0gTWF0aC5yb3VuZCgoZXZlbnQubG9hZGVkIC8gZGlmZikgKiAxMDAwKTtcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwcm9ncmVzc1N0YXJ0VGltZSA9ICh1cGxvYWRGaWxlLnByb2dyZXNzICYmIHVwbG9hZEZpbGUucHJvZ3Jlc3Muc3RhcnRUaW1lKSB8fCBuZXcgRGF0ZSgpLmdldFRpbWUoKTtcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgICBlc3RpbWF0ZWRUaW1lID0gTWF0aC5jZWlsKChldmVudC50b3RhbCAtIGV2ZW50LmxvYWRlZCkgLyBzcGVlZCk7XG5cbiAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgICB1cGxvYWRGaWxlLnByb2dyZXNzLnN0YXR1cyA9IFRoeVVwbG9hZFN0YXR1cy51cGxvYWRpbmc7XG4gICAgLy8gICAgICAgICAgICAgICAgICAgICAgICAgdXBsb2FkRmlsZS5wcm9ncmVzcy5wZXJjZW50YWdlID0gcGVyY2VudGFnZTtcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgICB1cGxvYWRGaWxlLnByb2dyZXNzLnNwZWVkID0gc3BlZWQ7XG4gICAgLy8gICAgICAgICAgICAgICAgICAgICAgICAgdXBsb2FkRmlsZS5wcm9ncmVzcy5zcGVlZEh1bWFuID0gYCR7dGhpcy5odW1hbml6ZUJ5dGVzKHNwZWVkKX0vc2A7XG4gICAgLy8gICAgICAgICAgICAgICAgICAgICAgICAgdXBsb2FkRmlsZS5wcm9ncmVzcy5zdGFydFRpbWUgPSBwcm9ncmVzc1N0YXJ0VGltZTtcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgICB1cGxvYWRGaWxlLnByb2dyZXNzLmVzdGltYXRlZFRpbWUgPSBlc3RpbWF0ZWRUaW1lO1xuICAgIC8vICAgICAgICAgICAgICAgICAgICAgICAgIHVwbG9hZEZpbGUucHJvZ3Jlc3MuZXN0aW1hdGVkVGltZUh1bWFuID0gdGhpcy5zZWNvbmRzVG9IdW1hbihlc3RpbWF0ZWRUaW1lKTtcblxuICAgIC8vICAgICAgICAgICAgICAgICAgICAgICAgIG9ic2VydmVyLm5leHQoeyBzdGF0dXM6IFRoeVVwbG9hZFN0YXR1cy51cGxvYWRpbmcsIHVwbG9hZEZpbGU6IHVwbG9hZEZpbGUgfSk7XG4gICAgLy8gICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgLy8gICAgICAgICAgICAgICAgICAgICBjYXNlIEh0dHBFdmVudFR5cGUuUmVzcG9uc2U6XG4gICAgLy8gICAgICAgICAgICAgICAgICAgICAgICAgdXBsb2FkRmlsZS5yZXNwb25zZSA9IGV2ZW50LmJvZHk7XG4gICAgLy8gICAgICAgICAgICAgICAgICAgICAgICAgb2JzZXJ2ZXIubmV4dCh7IHN0YXR1czogVGh5VXBsb2FkU3RhdHVzLmRvbmUsIHVwbG9hZEZpbGU6IHVwbG9hZEZpbGUgfSk7XG4gICAgLy8gICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgLy8gICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OlxuICAgIC8vICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5oYW5kbGVkIGV2ZW50OiAke2V2ZW50LnR5cGV9YCk7XG4gICAgLy8gICAgICAgICAgICAgICAgIH1cbiAgICAvLyAgICAgICAgICAgICB9LFxuICAgIC8vICAgICAgICAgICAgIGVycm9yID0+IHtcbiAgICAvLyAgICAgICAgICAgICAgICAgb2JzZXJ2ZXIuZXJyb3IoZXJyb3IpO1xuICAgIC8vICAgICAgICAgICAgIH1cbiAgICAvLyAgICAgICAgICk7XG4gICAgLy8gICAgIHJldHVybiBzdWJzY3JpcHRpb247XG4gICAgLy8gfVxuXG4gICAgcHJpdmF0ZSB1cGxvYWRCeVhocihvYnNlcnZlcjogU3Vic2NyaWJlcjxUaHlVcGxvYWRSZXNwb25zZT4sIHVwbG9hZEZpbGU6IFRoeVVwbG9hZEZpbGUpIHtcbiAgICAgICAgY29uc3QgeGhyID0gdGhpcy54aHJGYWN0b3J5LmJ1aWxkKCk7XG4gICAgICAgIGNvbnN0IHRpbWU6IG51bWJlciA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpO1xuICAgICAgICBsZXQgc3BlZWQgPSAwO1xuICAgICAgICBsZXQgZXN0aW1hdGVkVGltZTogbnVtYmVyIHwgbnVsbCA9IG51bGw7XG5cbiAgICAgICAgdXBsb2FkRmlsZS5wcm9ncmVzcyA9IHtcbiAgICAgICAgICAgIHN0YXR1czogVGh5VXBsb2FkU3RhdHVzLnN0YXJ0ZWQsXG4gICAgICAgICAgICBwZXJjZW50YWdlOiAwLFxuICAgICAgICAgICAgc3RhcnRUaW1lOiB0aW1lXG4gICAgICAgIH07XG5cbiAgICAgICAgeGhyLnVwbG9hZC5hZGRFdmVudExpc3RlbmVyKFxuICAgICAgICAgICAgJ3Byb2dyZXNzJyxcbiAgICAgICAgICAgIChldmVudDogUHJvZ3Jlc3NFdmVudCkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChldmVudC5sZW5ndGhDb21wdXRhYmxlKSB7XG4gICAgICAgICAgICAgICAgICAgIGxldCBwZXJjZW50YWdlID0gTWF0aC5yb3VuZCgoZXZlbnQubG9hZGVkICogMTAwKSAvIGV2ZW50LnRvdGFsKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHBlcmNlbnRhZ2UgPT09IDEwMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcGVyY2VudGFnZSA9IDk5O1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpZmYgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHRpbWU7XG4gICAgICAgICAgICAgICAgICAgIHNwZWVkID0gTWF0aC5yb3VuZCgoZXZlbnQubG9hZGVkIC8gZGlmZikgKiAxMDAwKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcHJvZ3Jlc3NTdGFydFRpbWUgPSAodXBsb2FkRmlsZS5wcm9ncmVzcyAmJiB1cGxvYWRGaWxlLnByb2dyZXNzLnN0YXJ0VGltZSkgfHwgbmV3IERhdGUoKS5nZXRUaW1lKCk7XG4gICAgICAgICAgICAgICAgICAgIGVzdGltYXRlZFRpbWUgPSBNYXRoLmNlaWwoKGV2ZW50LnRvdGFsIC0gZXZlbnQubG9hZGVkKSAvIHNwZWVkKTtcblxuICAgICAgICAgICAgICAgICAgICB1cGxvYWRGaWxlLnByb2dyZXNzLnN0YXR1cyA9IFRoeVVwbG9hZFN0YXR1cy51cGxvYWRpbmc7XG4gICAgICAgICAgICAgICAgICAgIHVwbG9hZEZpbGUucHJvZ3Jlc3MucGVyY2VudGFnZSA9IHBlcmNlbnRhZ2U7XG4gICAgICAgICAgICAgICAgICAgIHVwbG9hZEZpbGUucHJvZ3Jlc3Muc3BlZWQgPSBzcGVlZDtcbiAgICAgICAgICAgICAgICAgICAgdXBsb2FkRmlsZS5wcm9ncmVzcy5zcGVlZEh1bWFuID0gYCR7dGhpcy5odW1hbml6ZUJ5dGVzKHNwZWVkKX0vc2A7XG4gICAgICAgICAgICAgICAgICAgIHVwbG9hZEZpbGUucHJvZ3Jlc3Muc3RhcnRUaW1lID0gcHJvZ3Jlc3NTdGFydFRpbWU7XG4gICAgICAgICAgICAgICAgICAgIHVwbG9hZEZpbGUucHJvZ3Jlc3MuZXN0aW1hdGVkVGltZSA9IGVzdGltYXRlZFRpbWU7XG4gICAgICAgICAgICAgICAgICAgIHVwbG9hZEZpbGUucHJvZ3Jlc3MuZXN0aW1hdGVkVGltZUh1bWFuID0gdGhpcy5zZWNvbmRzVG9IdW1hbihlc3RpbWF0ZWRUaW1lKTtcblxuICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5uZXh0KHsgc3RhdHVzOiBUaHlVcGxvYWRTdGF0dXMudXBsb2FkaW5nLCB1cGxvYWRGaWxlOiB1cGxvYWRGaWxlIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBmYWxzZVxuICAgICAgICApO1xuXG4gICAgICAgIHhoci51cGxvYWQuYWRkRXZlbnRMaXN0ZW5lcignZXJyb3InLCAoZTogRXZlbnQpID0+IHtcbiAgICAgICAgICAgIG9ic2VydmVyLmVycm9yKGUpO1xuICAgICAgICAgICAgb2JzZXJ2ZXIuY29tcGxldGUoKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9ICgpID0+IHtcbiAgICAgICAgICAgIGlmICh4aHIucmVhZHlTdGF0ZSA9PT0gWE1MSHR0cFJlcXVlc3QuRE9ORSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IHNwZWVkVGltZSA9IChuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHVwbG9hZEZpbGUucHJvZ3Jlc3Muc3RhcnRUaW1lKSAqIDEwMDA7XG4gICAgICAgICAgICAgICAgY29uc3Qgc3BlZWRBdmVyYWdlID0gTWF0aC5yb3VuZCh1cGxvYWRGaWxlLm5hdGl2ZUZpbGUuc2l6ZSAvIHNwZWVkVGltZSk7XG5cbiAgICAgICAgICAgICAgICB1cGxvYWRGaWxlLnByb2dyZXNzLnN0YXR1cyA9IFRoeVVwbG9hZFN0YXR1cy5kb25lO1xuICAgICAgICAgICAgICAgIHVwbG9hZEZpbGUucHJvZ3Jlc3MucGVyY2VudGFnZSA9IDEwMDtcbiAgICAgICAgICAgICAgICB1cGxvYWRGaWxlLnByb2dyZXNzLnNwZWVkID0gc3BlZWRBdmVyYWdlO1xuICAgICAgICAgICAgICAgIHVwbG9hZEZpbGUucHJvZ3Jlc3Muc3BlZWRIdW1hbiA9IGAke3RoaXMuaHVtYW5pemVCeXRlcyhzcGVlZCl9L3NgO1xuICAgICAgICAgICAgICAgIHVwbG9hZEZpbGUucHJvZ3Jlc3MuZXN0aW1hdGVkVGltZSA9IGVzdGltYXRlZFRpbWU7XG4gICAgICAgICAgICAgICAgdXBsb2FkRmlsZS5wcm9ncmVzcy5lc3RpbWF0ZWRUaW1lSHVtYW4gPSB0aGlzLnNlY29uZHNUb0h1bWFuKGVzdGltYXRlZFRpbWUgfHwgMCk7XG5cbiAgICAgICAgICAgICAgICB1cGxvYWRGaWxlLnJlc3BvbnNlU3RhdHVzID0geGhyLnN0YXR1cztcblxuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIHVwbG9hZEZpbGUucmVzcG9uc2UgPSBKU09OLnBhcnNlKHhoci5yZXNwb25zZSk7XG4gICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgICAgICAgICB1cGxvYWRGaWxlLnJlc3BvbnNlID0geGhyLnJlc3BvbnNlO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIC8vIGZpbGUucmVzcG9uc2VIZWFkZXJzID0gdGhpcy5wYXJzZVJlc3BvbnNlSGVhZGVycyh4aHIuZ2V0QWxsUmVzcG9uc2VIZWFkZXJzKCkpO1xuXG4gICAgICAgICAgICAgICAgb2JzZXJ2ZXIubmV4dCh7IHN0YXR1czogVGh5VXBsb2FkU3RhdHVzLmRvbmUsIHVwbG9hZEZpbGU6IHVwbG9hZEZpbGUgfSk7XG5cbiAgICAgICAgICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuXG4gICAgICAgIHhoci5vcGVuKHVwbG9hZEZpbGUubWV0aG9kLCB1cGxvYWRGaWxlLnVybCwgdHJ1ZSk7XG4gICAgICAgIHhoci53aXRoQ3JlZGVudGlhbHMgPSB1cGxvYWRGaWxlLndpdGhDcmVkZW50aWFscyA/IHRydWUgOiBmYWxzZTtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgZm9ybURhdGEgPSBuZXcgRm9ybURhdGEoKTtcblxuICAgICAgICAgICAgT2JqZWN0LmtleXModXBsb2FkRmlsZS5kYXRhIHx8IHt9KS5mb3JFYWNoKGtleSA9PiBmb3JtRGF0YS5hcHBlbmQoa2V5LCB1cGxvYWRGaWxlLmRhdGFba2V5XSkpO1xuICAgICAgICAgICAgT2JqZWN0LmtleXModXBsb2FkRmlsZS5oZWFkZXJzIHx8IHt9KS5mb3JFYWNoKGtleSA9PiB4aHIuc2V0UmVxdWVzdEhlYWRlcihrZXksIHVwbG9hZEZpbGUuaGVhZGVyc1trZXldKSk7XG5cbiAgICAgICAgICAgIGZvcm1EYXRhLmFwcGVuZCh1cGxvYWRGaWxlLmZpbGVGaWVsZCB8fCAnZmlsZScsIHVwbG9hZEZpbGUubmF0aXZlRmlsZSwgdXBsb2FkRmlsZS5maWxlTmFtZSk7XG5cbiAgICAgICAgICAgIG9ic2VydmVyLm5leHQoeyBzdGF0dXM6IFRoeVVwbG9hZFN0YXR1cy5zdGFydGVkLCB1cGxvYWRGaWxlOiB1cGxvYWRGaWxlIH0pO1xuICAgICAgICAgICAgeGhyLnNlbmQoZm9ybURhdGEpO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgb2JzZXJ2ZXIuZXJyb3IoZXJyb3IpO1xuICAgICAgICAgICAgb2JzZXJ2ZXIuY29tcGxldGUoKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4geGhyO1xuICAgIH1cblxuICAgIHByaXZhdGUgZW5zdXJlRmlsZU5hbWUodXBsb2FkRmlsZTogVGh5VXBsb2FkRmlsZSkge1xuICAgICAgICB1cGxvYWRGaWxlLmZpbGVOYW1lID0gdXBsb2FkRmlsZS5maWxlTmFtZSB8fCB1cGxvYWRGaWxlLm5hdGl2ZUZpbGUubmFtZTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDkuIrkvKDljZXkuKrmlofku7ZcbiAgICAgKiBAcGFyYW0gdXBsb2FkRmlsZSDkuIrkvKDmlofku7blr7nosaFcbiAgICAgKi9cbiAgICB1cGxvYWQodXBsb2FkRmlsZTogVGh5VXBsb2FkRmlsZSk6IE9ic2VydmFibGU8VGh5VXBsb2FkUmVzcG9uc2U+IHtcbiAgICAgICAgdGhpcy5lbnN1cmVGaWxlTmFtZSh1cGxvYWRGaWxlKTtcblxuICAgICAgICByZXR1cm4gbmV3IE9ic2VydmFibGUob2JzZXJ2ZXIgPT4ge1xuICAgICAgICAgICAgY29uc3QgeGhyID0gdGhpcy51cGxvYWRCeVhocihvYnNlcnZlciwgdXBsb2FkRmlsZSk7XG4gICAgICAgICAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgICAgICAgICAgIHhoci5hYm9ydCgpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog5bm25Y+R5LiK5Lyg5aSa5Liq5paH5Lu2XG4gICAgICogQHBhcmFtIHVwbG9hZEZpbGVzIOS4iuS8oOaWh+S7tuWIl+ihqFxuICAgICAqIEBwYXJhbSBjb25jdXJyZW50IOW5tuWPkeS4iuS8oOaVsCwg6buY6K6kIDVcbiAgICAgKiBAcGFyYW0gb3B0aW9ucyBvblN0YXJlZCwgb25Eb25lIOWbnuiwg1xuICAgICAqL1xuICAgIHVwbG9hZEJ1bGsodXBsb2FkRmlsZXM6IFRoeVVwbG9hZEZpbGVbXSwgY29uY3VycmVudCA9IDUsIG9wdGlvbnM/OiBUaHlVcGxvYWRGaWxlc09wdGlvbnMpIHtcbiAgICAgICAgdGhpcy5ub3JtYWxpemVVcGxvYWRGaWxlcyh1cGxvYWRGaWxlcyk7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGZyb20odXBsb2FkRmlsZXMpLnBpcGUoXG4gICAgICAgICAgICBtZXJnZU1hcCh1cGxvYWRGaWxlID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy51cGxvYWQodXBsb2FkRmlsZSkucGlwZShcbiAgICAgICAgICAgICAgICAgICAgdGFwKHVwbG9hZFJlc3BvbnNlID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMub25TdGFydGVkICYmIHVwbG9hZFJlc3BvbnNlLnN0YXR1cyA9PT0gVGh5VXBsb2FkU3RhdHVzLnN0YXJ0ZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zLm9uU3RhcnRlZCh1cGxvYWRSZXNwb25zZS51cGxvYWRGaWxlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMub25Eb25lICYmIHVwbG9hZFJlc3BvbnNlLnN0YXR1cyA9PT0gVGh5VXBsb2FkU3RhdHVzLmRvbmUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zLm9uRG9uZSh1cGxvYWRSZXNwb25zZS51cGxvYWRGaWxlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfSwgY29uY3VycmVudCksXG4gICAgICAgICAgICBtYXAocmVzcG9uc2UgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICk7XG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG59XG4iXX0=