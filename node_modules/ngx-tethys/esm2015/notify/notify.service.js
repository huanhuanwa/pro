import { helpers } from 'ngx-tethys/util';
import { Subject } from 'rxjs';
import { ComponentPortal, DomPortalOutlet } from '@angular/cdk/portal';
import { ApplicationRef, ComponentFactoryResolver, Inject, Injectable, Injector } from '@angular/core';
import { THY_NOTIFY_DEFAULT_OPTIONS } from './notify-option.interface';
import { NotifyQueueStore } from './notify-queue.store';
import { ThyNotifyContainerComponent } from './notify.container.component';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from './notify-queue.store';
const NOTIFY_OPTION_DEFAULT = {
    duration: 4500,
    pauseOnHover: true,
    maxStack: 8,
    placement: 'topRight'
};
export class ThyNotifyService {
    constructor(injector, componentFactoryResolver, appRef, queueStore, defaultConfig) {
        this.injector = injector;
        this.componentFactoryResolver = componentFactoryResolver;
        this.appRef = appRef;
        this.queueStore = queueStore;
        this.defaultConfig = defaultConfig;
        this.notifyQueue$ = new Subject();
        this._lastNotifyId = 0;
    }
    show(options) {
        const notifyConfig = this.formatOptions(options);
        const { placement } = notifyConfig;
        this.queueStore.addNotify(placement, notifyConfig);
        this._initContainer(placement);
    }
    success(title, content, options) {
        this.show(Object.assign(Object.assign({}, (options || {})), { type: 'success', title: title || (options === null || options === void 0 ? void 0 : options.title) || '成功', content: content || (options === null || options === void 0 ? void 0 : options.content) }));
    }
    info(title, content, options) {
        this.show(Object.assign(Object.assign({}, (options || {})), { type: 'info', title: title || (options === null || options === void 0 ? void 0 : options.title) || '提示', content: content || (options === null || options === void 0 ? void 0 : options.content) }));
    }
    warning(title, content, options) {
        this.show(Object.assign(Object.assign({}, (options || {})), { type: 'warning', title: title || (options === null || options === void 0 ? void 0 : options.title) || '警告', content: content || (options === null || options === void 0 ? void 0 : options.content) }));
    }
    error(title, content, options) {
        var _a, _b;
        const config = helpers.isString(options)
            ? { type: 'error', title: title || '错误', content: content, detail: options }
            : Object.assign(Object.assign({}, (options || {})), { type: 'error', title: title || ((_a = options) === null || _a === void 0 ? void 0 : _a.title) || '错误', content: content || ((_b = options) === null || _b === void 0 ? void 0 : _b.content) });
        this.show(config);
    }
    removeNotifyById(id) {
        this.queueStore.removeNotify(id);
    }
    _initContainer(placement) {
        if (placement === 'topRight') {
            this.containerRefTopRight = this._loadNotifyContainerComponent(this.containerRefTopRight, placement);
        }
        else if (placement === 'bottomRight') {
            this.containerRefBottomRight = this._loadNotifyContainerComponent(this.containerRefBottomRight, placement);
        }
        else if (placement === 'bottomLeft') {
            this.containerRefBottomLeft = this._loadNotifyContainerComponent(this.containerRefBottomLeft, placement);
        }
        else if (placement === 'topLeft') {
            this.containerRefTopLeft = this._loadNotifyContainerComponent(this.containerRefTopLeft, placement);
        }
    }
    _loadNotifyContainerComponent(containerRef, placement) {
        if (!containerRef) {
            const portalOutlet = new DomPortalOutlet(document.body, this.componentFactoryResolver, this.appRef, this.injector);
            const componentPortal = new ComponentPortal(ThyNotifyContainerComponent, null);
            containerRef = portalOutlet.attachComponentPortal(componentPortal);
            Object.assign(containerRef.instance, {
                initialState: {
                    placement
                }
            });
            containerRef.changeDetectorRef.detectChanges();
        }
        return containerRef;
    }
    formatOptions(options) {
        if (helpers.isString(options.detail)) {
            options = Object.assign(Object.assign({}, options), { detail: { link: '[详情]', content: options.detail } });
        }
        return Object.assign({}, NOTIFY_OPTION_DEFAULT, { id: this._lastNotifyId++ }, this.defaultConfig, options);
    }
}
ThyNotifyService.ɵfac = function ThyNotifyService_Factory(t) { return new (t || ThyNotifyService)(ɵngcc0.ɵɵinject(ɵngcc0.Injector), ɵngcc0.ɵɵinject(ɵngcc0.ComponentFactoryResolver), ɵngcc0.ɵɵinject(ɵngcc0.ApplicationRef), ɵngcc0.ɵɵinject(ɵngcc1.NotifyQueueStore), ɵngcc0.ɵɵinject(THY_NOTIFY_DEFAULT_OPTIONS)); };
ThyNotifyService.ɵprov = ɵngcc0.ɵɵdefineInjectable({ token: ThyNotifyService, factory: ThyNotifyService.ɵfac });
ThyNotifyService.ctorParameters = () => [
    { type: Injector },
    { type: ComponentFactoryResolver },
    { type: ApplicationRef },
    { type: NotifyQueueStore },
    { type: undefined, decorators: [{ type: Inject, args: [THY_NOTIFY_DEFAULT_OPTIONS,] }] }
];
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(ThyNotifyService, [{
        type: Injectable
    }], function () { return [{ type: ɵngcc0.Injector }, { type: ɵngcc0.ComponentFactoryResolver }, { type: ɵngcc0.ApplicationRef }, { type: ɵngcc1.NotifyQueueStore }, { type: undefined, decorators: [{
                type: Inject,
                args: [THY_NOTIFY_DEFAULT_OPTIONS]
            }] }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibm90aWZ5LnNlcnZpY2UuanMiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9ub3RpZnkvbm90aWZ5LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzFDLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFL0IsT0FBTyxFQUFFLGVBQWUsRUFBRSxlQUFlLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN2RSxPQUFPLEVBQUUsY0FBYyxFQUFFLHdCQUF3QixFQUFnQixNQUFNLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUVySCxPQUFPLEVBQW1CLDBCQUEwQixFQUFvQixNQUFNLDJCQUEyQixDQUFDO0FBQzFHLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ3hELE9BQU8sRUFBRSwyQkFBMkIsRUFBRSxNQUFNLDhCQUE4QixDQUFDOzs7QUFFM0UsTUFBTSxxQkFBcUIsR0FBRztBQUM5QixJQUFJLFFBQVEsRUFBRSxJQUFJO0FBQ2xCLElBQUksWUFBWSxFQUFFLElBQUk7QUFDdEIsSUFBSSxRQUFRLEVBQUUsQ0FBQztBQUNmLElBQUksU0FBUyxFQUFFLFVBQVU7QUFDekIsQ0FBQyxDQUFDO0FBR0YsTUFBTSxPQUFPLGdCQUFnQjtBQUM3QixJQVlJLFlBQ1ksUUFBa0IsRUFDbEIsd0JBQWtELEVBQ2xELE1BQXNCLEVBQ3RCLFVBQTRCLEVBQ1EsYUFBK0I7QUFDaEYsUUFMYSxhQUFRLEdBQVIsUUFBUSxDQUFVO0FBQUMsUUFDbkIsNkJBQXdCLEdBQXhCLHdCQUF3QixDQUEwQjtBQUFDLFFBQ25ELFdBQU0sR0FBTixNQUFNLENBQWdCO0FBQUMsUUFDdkIsZUFBVSxHQUFWLFVBQVUsQ0FBa0I7QUFBQyxRQUNPLGtCQUFhLEdBQWIsYUFBYSxDQUFrQjtBQUNuRixRQWxCSSxpQkFBWSxHQUFpQixJQUFJ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QUMvRSxZQUFZLE1BQU0sQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLFFBQVEsRUFBRTtBQUNqRCxnQkFBZ0IsWUFBWSxFQUFFO0FBQzlCLG9CQUFvQixTQUFTO0FBQzdCLGlCQUFpQjtBQUNqQixhQUFhLENBQUMsQ0FBQztBQUNmLFlBQVksWUFBWSxDQUFDLGlCQUFpQixDQUFDLGFBQWEsRUFBRSxDQUFDO0FBQzNELFNBQVM7QUFDVCxRQUFRLE9BQU8sWUFBWSxDQUFDO0FBQzVCLElBQUksQ0FBQztBQUNMLElBQ1ksYUFBYSxDQUFDLE9BQXlCO0FBQ25ELFFBQVEsSUFBSSxPQUFPLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFBRTtBQUM5QyxZQUFZLE9BQU8sbUNBQVEsT0FBTyxLQUFFLE1BQU0sRUFBRSxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLE9BQU8sQ0FBQyxNQUFnQixFQUFFLEdBQUUsQ0FBQztBQUNsRyxTQUFTO0FBQ1QsUUFBUSxPQUFPLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLHFCQUFxQixFQUFFLEVBQUUsRUFBRSxFQUFFLElBQUksQ0FBQyxhQUFhLEVBQUUsRUFBRSxFQUFFLElBQUksQ0FBQyxhQUFhLEVBQUUsT0FBTyxDQUFDLENBQUM7QUFDbkgsSUFBSSxDQUFDO0FBQ0w7NENBNUdDLFVBQVU7Z0hBQ1Q7QUFBQztBQUNVLFlBZndFLFFBQVE7QUFBSSxZQUF4RSx3QkFBd0I7QUFBSSxZQUE1QyxjQUFjO0FBQUksWUFHbEIsZ0JBQWdCO0FBQUksNENBNkJwQixNQUFNLFNBQUMsMEJBQTBCO0FBQVE7Ozs7OztrQ0FBRTtBQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgaGVscGVycyB9IGZyb20gJ25neC10ZXRoeXMvdXRpbCc7XG5pbXBvcnQgeyBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5cbmltcG9ydCB7IENvbXBvbmVudFBvcnRhbCwgRG9tUG9ydGFsT3V0bGV0IH0gZnJvbSAnQGFuZ3VsYXIvY2RrL3BvcnRhbCc7XG5pbXBvcnQgeyBBcHBsaWNhdGlvblJlZiwgQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLCBDb21wb25lbnRSZWYsIEluamVjdCwgSW5qZWN0YWJsZSwgSW5qZWN0b3IgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHsgTm90aWZ5UGxhY2VtZW50LCBUSFlfTk9USUZZX0RFRkFVTFRfT1BUSU9OUywgVGh5Tm90aWZ5T3B0aW9ucyB9IGZyb20gJy4vbm90aWZ5LW9wdGlvbi5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgTm90aWZ5UXVldWVTdG9yZSB9IGZyb20gJy4vbm90aWZ5LXF1ZXVlLnN0b3JlJztcbmltcG9ydCB7IFRoeU5vdGlmeUNvbnRhaW5lckNvbXBvbmVudCB9IGZyb20gJy4vbm90aWZ5LmNvbnRhaW5lci5jb21wb25lbnQnO1xuXG5jb25zdCBOT1RJRllfT1BUSU9OX0RFRkFVTFQgPSB7XG4gICAgZHVyYXRpb246IDQ1MDAsXG4gICAgcGF1c2VPbkhvdmVyOiB0cnVlLFxuICAgIG1heFN0YWNrOiA4LFxuICAgIHBsYWNlbWVudDogJ3RvcFJpZ2h0J1xufTtcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFRoeU5vdGlmeVNlcnZpY2Uge1xuICAgIG5vdGlmeVF1ZXVlJDogU3ViamVjdDxhbnk+ID0gbmV3IFN1YmplY3QoKTtcblxuICAgIHByaXZhdGUgX2xhc3ROb3RpZnlJZCA9IDA7XG5cbiAgICBwcml2YXRlIGNvbnRhaW5lclJlZlRvcFJpZ2h0OiBDb21wb25lbnRSZWY8VGh5Tm90aWZ5Q29udGFpbmVyQ29tcG9uZW50PjtcblxuICAgIHByaXZhdGUgY29udGFpbmVyUmVmQm90dG9tUmlnaHQ6IENvbXBvbmVudFJlZjxUaHlOb3RpZnlDb250YWluZXJDb21wb25lbnQ+O1xuXG4gICAgcHJpdmF0ZSBjb250YWluZXJSZWZCb3R0b21MZWZ0OiBDb21wb25lbnRSZWY8VGh5Tm90aWZ5Q29udGFpbmVyQ29tcG9uZW50PjtcblxuICAgIHByaXZhdGUgY29udGFpbmVyUmVmVG9wTGVmdDogQ29tcG9uZW50UmVmPFRoeU5vdGlmeUNvbnRhaW5lckNvbXBvbmVudD47XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IsXG4gICAgICAgIHByaXZhdGUgY29tcG9uZW50RmFjdG9yeVJlc29sdmVyOiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXG4gICAgICAgIHByaXZhdGUgYXBwUmVmOiBBcHBsaWNhdGlvblJlZixcbiAgICAgICAgcHJpdmF0ZSBxdWV1ZVN0b3JlOiBOb3RpZnlRdWV1ZVN0b3JlLFxuICAgICAgICBASW5qZWN0KFRIWV9OT1RJRllfREVGQVVMVF9PUFRJT05TKSBwcml2YXRlIGRlZmF1bHRDb25maWc6IFRoeU5vdGlmeU9wdGlvbnNcbiAgICApIHt9XG5cbiAgICBzaG93KG9wdGlvbnM6IFRoeU5vdGlmeU9wdGlvbnMpIHtcbiAgICAgICAgY29uc3Qgbm90aWZ5Q29uZmlnID0gdGhpcy5mb3JtYXRPcHRpb25zKG9wdGlvbnMpO1xuICAgICAgICBjb25zdCB7IHBsYWNlbWVudCB9ID0gbm90aWZ5Q29uZmlnO1xuICAgICAgICB0aGlzLnF1ZXVlU3RvcmUuYWRkTm90aWZ5KHBsYWNlbWVudCwgbm90aWZ5Q29uZmlnKTtcbiAgICAgICAgdGhpcy5faW5pdENvbnRhaW5lcihwbGFjZW1lbnQpO1xuICAgIH1cblxuICAgIHN1Y2Nlc3ModGl0bGU/OiBzdHJpbmcsIGNvbnRlbnQ/OiBzdHJpbmcsIG9wdGlvbnM/OiBUaHlOb3RpZnlPcHRpb25zKSB7XG4gICAgICAgIHRoaXMuc2hvdyh7XG4gICAgICAgICAgICAuLi4ob3B0aW9ucyB8fCB7fSksXG4gICAgICAgICAgICB0eXBlOiAnc3VjY2VzcycsXG4gICAgICAgICAgICB0aXRsZTogdGl0bGUgfHwgb3B0aW9ucz8udGl0bGUgfHwgJ+aIkOWKnycsXG4gICAgICAgICAgICBjb250ZW50OiBjb250ZW50IHx8IG9wdGlvbnM/LmNvbnRlbnRcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgaW5mbyh0aXRsZT86IHN0cmluZywgY29udGVudD86IHN0cmluZywgb3B0aW9ucz86IFRoeU5vdGlmeU9wdGlvbnMpIHtcbiAgICAgICAgdGhpcy5zaG93KHtcbiAgICAgICAgICAgIC4uLihvcHRpb25zIHx8IHt9KSxcbiAgICAgICAgICAgIHR5cGU6ICdpbmZvJyxcbiAgICAgICAgICAgIHRpdGxlOiB0aXRsZSB8fCBvcHRpb25zPy50aXRsZSB8fCAn5o+Q56S6JyxcbiAgICAgICAgICAgIGNvbnRlbnQ6IGNvbnRlbnQgfHwgb3B0aW9ucz8uY29udGVudFxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICB3YXJuaW5nKHRpdGxlPzogc3RyaW5nLCBjb250ZW50Pzogc3RyaW5nLCBvcHRpb25zPzogVGh5Tm90aWZ5T3B0aW9ucykge1xuICAgICAgICB0aGlzLnNob3coe1xuICAgICAgICAgICAgLi4uKG9wdGlvbnMgfHwge30pLFxuICAgICAgICAgICAgdHlwZTogJ3dhcm5pbmcnLFxuICAgICAgICAgICAgdGl0bGU6IHRpdGxlIHx8IG9wdGlvbnM/LnRpdGxlIHx8ICforablkYonLFxuICAgICAgICAgICAgY29udGVudDogY29udGVudCB8fCBvcHRpb25zPy5jb250ZW50XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGVycm9yKHRpdGxlPzogc3RyaW5nLCBjb250ZW50Pzogc3RyaW5nLCBvcHRpb25zPzogVGh5Tm90aWZ5T3B0aW9ucyB8IHN0cmluZykge1xuICAgICAgICBjb25zdCBjb25maWc6IFRoeU5vdGlmeU9wdGlvbnMgPSBoZWxwZXJzLmlzU3RyaW5nKG9wdGlvbnMpXG4gICAgICAgICAgICA/IHsgdHlwZTogJ2Vycm9yJywgdGl0bGU6IHRpdGxlIHx8ICfplJnor68nLCBjb250ZW50OiBjb250ZW50LCBkZXRhaWw6IG9wdGlvbnMgfVxuICAgICAgICAgICAgOiB7XG4gICAgICAgICAgICAgICAgICAuLi4oKG9wdGlvbnMgfHwge30pIGFzIFRoeU5vdGlmeU9wdGlvbnMpLFxuICAgICAgICAgICAgICAgICAgdHlwZTogJ2Vycm9yJyxcbiAgICAgICAgICAgICAgICAgIHRpdGxlOiB0aXRsZSB8fCAob3B0aW9ucyBhcyBUaHlOb3RpZnlPcHRpb25zKT8udGl0bGUgfHwgJ+mUmeivrycsXG4gICAgICAgICAgICAgICAgICBjb250ZW50OiBjb250ZW50IHx8IChvcHRpb25zIGFzIFRoeU5vdGlmeU9wdGlvbnMpPy5jb250ZW50XG4gICAgICAgICAgICAgIH07XG4gICAgICAgIHRoaXMuc2hvdyhjb25maWcpO1xuICAgIH1cblxuICAgIHJlbW92ZU5vdGlmeUJ5SWQoaWQ6IG51bWJlcikge1xuICAgICAgICB0aGlzLnF1ZXVlU3RvcmUucmVtb3ZlTm90aWZ5KGlkKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9pbml0Q29udGFpbmVyKHBsYWNlbWVudDogTm90aWZ5UGxhY2VtZW50KSB7XG4gICAgICAgIGlmIChwbGFjZW1lbnQgPT09ICd0b3BSaWdodCcpIHtcbiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyUmVmVG9wUmlnaHQgPSB0aGlzLl9sb2FkTm90aWZ5Q29udGFpbmVyQ29tcG9uZW50KHRoaXMuY29udGFpbmVyUmVmVG9wUmlnaHQsIHBsYWNlbWVudCk7XG4gICAgICAgIH0gZWxzZSBpZiAocGxhY2VtZW50ID09PSAnYm90dG9tUmlnaHQnKSB7XG4gICAgICAgICAgICB0aGlzLmNvbnRhaW5lclJlZkJvdHRvbVJpZ2h0ID0gdGhpcy5fbG9hZE5vdGlmeUNvbnRhaW5lckNvbXBvbmVudCh0aGlzLmNvbnRhaW5lclJlZkJvdHRvbVJpZ2h0LCBwbGFjZW1lbnQpO1xuICAgICAgICB9IGVsc2UgaWYgKHBsYWNlbWVudCA9PT0gJ2JvdHRvbUxlZnQnKSB7XG4gICAgICAgICAgICB0aGlzLmNvbnRhaW5lclJlZkJvdHRvbUxlZnQgPSB0aGlzLl9sb2FkTm90aWZ5Q29udGFpbmVyQ29tcG9uZW50KHRoaXMuY29udGFpbmVyUmVmQm90dG9tTGVmdCwgcGxhY2VtZW50KTtcbiAgICAgICAgfSBlbHNlIGlmIChwbGFjZW1lbnQgPT09ICd0b3BMZWZ0Jykge1xuICAgICAgICAgICAgdGhpcy5jb250YWluZXJSZWZUb3BMZWZ0ID0gdGhpcy5fbG9hZE5vdGlmeUNvbnRhaW5lckNvbXBvbmVudCh0aGlzLmNvbnRhaW5lclJlZlRvcExlZnQsIHBsYWNlbWVudCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIF9sb2FkTm90aWZ5Q29udGFpbmVyQ29tcG9uZW50KFxuICAgICAgICBjb250YWluZXJSZWY6IENvbXBvbmVudFJlZjxUaHlOb3RpZnlDb250YWluZXJDb21wb25lbnQ+LFxuICAgICAgICBwbGFjZW1lbnQ6IE5vdGlmeVBsYWNlbWVudFxuICAgICk6IENvbXBvbmVudFJlZjxUaHlOb3RpZnlDb250YWluZXJDb21wb25lbnQ+IHtcbiAgICAgICAgaWYgKCFjb250YWluZXJSZWYpIHtcbiAgICAgICAgICAgIGNvbnN0IHBvcnRhbE91dGxldCA9IG5ldyBEb21Qb3J0YWxPdXRsZXQoZG9jdW1lbnQuYm9keSwgdGhpcy5jb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsIHRoaXMuYXBwUmVmLCB0aGlzLmluamVjdG9yKTtcbiAgICAgICAgICAgIGNvbnN0IGNvbXBvbmVudFBvcnRhbCA9IG5ldyBDb21wb25lbnRQb3J0YWwoVGh5Tm90aWZ5Q29udGFpbmVyQ29tcG9uZW50LCBudWxsKTtcbiAgICAgICAgICAgIGNvbnRhaW5lclJlZiA9IHBvcnRhbE91dGxldC5hdHRhY2hDb21wb25lbnRQb3J0YWwoY29tcG9uZW50UG9ydGFsKTtcbiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24oY29udGFpbmVyUmVmLmluc3RhbmNlLCB7XG4gICAgICAgICAgICAgICAgaW5pdGlhbFN0YXRlOiB7XG4gICAgICAgICAgICAgICAgICAgIHBsYWNlbWVudFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgY29udGFpbmVyUmVmLmNoYW5nZURldGVjdG9yUmVmLmRldGVjdENoYW5nZXMoKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gY29udGFpbmVyUmVmO1xuICAgIH1cblxuICAgIHByaXZhdGUgZm9ybWF0T3B0aW9ucyhvcHRpb25zOiBUaHlOb3RpZnlPcHRpb25zKSB7XG4gICAgICAgIGlmIChoZWxwZXJzLmlzU3RyaW5nKG9wdGlvbnMuZGV0YWlsKSkge1xuICAgICAgICAgICAgb3B0aW9ucyA9IHsgLi4ub3B0aW9ucywgZGV0YWlsOiB7IGxpbms6ICdb6K+m5oOFXScsIGNvbnRlbnQ6IG9wdGlvbnMuZGV0YWlsIGFzIHN0cmluZyB9IH07XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oe30sIE5PVElGWV9PUFRJT05fREVGQVVMVCwgeyBpZDogdGhpcy5fbGFzdE5vdGlmeUlkKysgfSwgdGhpcy5kZWZhdWx0Q29uZmlnLCBvcHRpb25zKTtcbiAgICB9XG59XG4iXX0=