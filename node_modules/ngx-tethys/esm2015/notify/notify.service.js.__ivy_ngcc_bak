import { helpers } from 'ngx-tethys/util';
import { Subject } from 'rxjs';
import { ComponentPortal, DomPortalOutlet } from '@angular/cdk/portal';
import { ApplicationRef, ComponentFactoryResolver, Inject, Injectable, Injector } from '@angular/core';
import { THY_NOTIFY_DEFAULT_OPTIONS } from './notify-option.interface';
import { NotifyQueueStore } from './notify-queue.store';
import { ThyNotifyContainerComponent } from './notify.container.component';
const NOTIFY_OPTION_DEFAULT = {
    duration: 4500,
    pauseOnHover: true,
    maxStack: 8,
    placement: 'topRight'
};
export class ThyNotifyService {
    constructor(injector, componentFactoryResolver, appRef, queueStore, defaultConfig) {
        this.injector = injector;
        this.componentFactoryResolver = componentFactoryResolver;
        this.appRef = appRef;
        this.queueStore = queueStore;
        this.defaultConfig = defaultConfig;
        this.notifyQueue$ = new Subject();
        this._lastNotifyId = 0;
    }
    show(options) {
        const notifyConfig = this.formatOptions(options);
        const { placement } = notifyConfig;
        this.queueStore.addNotify(placement, notifyConfig);
        this._initContainer(placement);
    }
    success(title, content, options) {
        this.show(Object.assign(Object.assign({}, (options || {})), { type: 'success', title: title || (options === null || options === void 0 ? void 0 : options.title) || '成功', content: content || (options === null || options === void 0 ? void 0 : options.content) }));
    }
    info(title, content, options) {
        this.show(Object.assign(Object.assign({}, (options || {})), { type: 'info', title: title || (options === null || options === void 0 ? void 0 : options.title) || '提示', content: content || (options === null || options === void 0 ? void 0 : options.content) }));
    }
    warning(title, content, options) {
        this.show(Object.assign(Object.assign({}, (options || {})), { type: 'warning', title: title || (options === null || options === void 0 ? void 0 : options.title) || '警告', content: content || (options === null || options === void 0 ? void 0 : options.content) }));
    }
    error(title, content, options) {
        var _a, _b;
        const config = helpers.isString(options)
            ? { type: 'error', title: title || '错误', content: content, detail: options }
            : Object.assign(Object.assign({}, (options || {})), { type: 'error', title: title || ((_a = options) === null || _a === void 0 ? void 0 : _a.title) || '错误', content: content || ((_b = options) === null || _b === void 0 ? void 0 : _b.content) });
        this.show(config);
    }
    removeNotifyById(id) {
        this.queueStore.removeNotify(id);
    }
    _initContainer(placement) {
        if (placement === 'topRight') {
            this.containerRefTopRight = this._loadNotifyContainerComponent(this.containerRefTopRight, placement);
        }
        else if (placement === 'bottomRight') {
            this.containerRefBottomRight = this._loadNotifyContainerComponent(this.containerRefBottomRight, placement);
        }
        else if (placement === 'bottomLeft') {
            this.containerRefBottomLeft = this._loadNotifyContainerComponent(this.containerRefBottomLeft, placement);
        }
        else if (placement === 'topLeft') {
            this.containerRefTopLeft = this._loadNotifyContainerComponent(this.containerRefTopLeft, placement);
        }
    }
    _loadNotifyContainerComponent(containerRef, placement) {
        if (!containerRef) {
            const portalOutlet = new DomPortalOutlet(document.body, this.componentFactoryResolver, this.appRef, this.injector);
            const componentPortal = new ComponentPortal(ThyNotifyContainerComponent, null);
            containerRef = portalOutlet.attachComponentPortal(componentPortal);
            Object.assign(containerRef.instance, {
                initialState: {
                    placement
                }
            });
            containerRef.changeDetectorRef.detectChanges();
        }
        return containerRef;
    }
    formatOptions(options) {
        if (helpers.isString(options.detail)) {
            options = Object.assign(Object.assign({}, options), { detail: { link: '[详情]', content: options.detail } });
        }
        return Object.assign({}, NOTIFY_OPTION_DEFAULT, { id: this._lastNotifyId++ }, this.defaultConfig, options);
    }
}
ThyNotifyService.decorators = [
    { type: Injectable }
];
ThyNotifyService.ctorParameters = () => [
    { type: Injector },
    { type: ComponentFactoryResolver },
    { type: ApplicationRef },
    { type: NotifyQueueStore },
    { type: undefined, decorators: [{ type: Inject, args: [THY_NOTIFY_DEFAULT_OPTIONS,] }] }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibm90aWZ5LnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvbm90aWZ5L25vdGlmeS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMxQyxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRS9CLE9BQU8sRUFBRSxlQUFlLEVBQUUsZUFBZSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDdkUsT0FBTyxFQUFFLGNBQWMsRUFBRSx3QkFBd0IsRUFBZ0IsTUFBTSxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFckgsT0FBTyxFQUFtQiwwQkFBMEIsRUFBb0IsTUFBTSwyQkFBMkIsQ0FBQztBQUMxRyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUN4RCxPQUFPLEVBQUUsMkJBQTJCLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUUzRSxNQUFNLHFCQUFxQixHQUFHO0lBQzFCLFFBQVEsRUFBRSxJQUFJO0lBQ2QsWUFBWSxFQUFFLElBQUk7SUFDbEIsUUFBUSxFQUFFLENBQUM7SUFDWCxTQUFTLEVBQUUsVUFBVTtDQUN4QixDQUFDO0FBR0YsTUFBTSxPQUFPLGdCQUFnQjtJQWF6QixZQUNZLFFBQWtCLEVBQ2xCLHdCQUFrRCxFQUNsRCxNQUFzQixFQUN0QixVQUE0QixFQUNRLGFBQStCO1FBSm5FLGFBQVEsR0FBUixRQUFRLENBQVU7UUFDbEIsNkJBQXdCLEdBQXhCLHdCQUF3QixDQUEwQjtRQUNsRCxXQUFNLEdBQU4sTUFBTSxDQUFnQjtRQUN0QixlQUFVLEdBQVYsVUFBVSxDQUFrQjtRQUNRLGtCQUFhLEdBQWIsYUFBYSxDQUFrQjtRQWpCL0UsaUJBQVksR0FBaUIsSUFBSSxPQUFPLEVBQUUsQ0FBQztRQUVuQyxrQkFBYSxHQUFHLENBQUMsQ0FBQztJQWdC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QUFNLEVBQUUsRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxPQUFPLENBQUMsTUFBZ0IsRUFBRSxHQUFFLENBQUM7U0FDekY7UUFDRCxPQUFPLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLHFCQUFxQixFQUFFLEVBQUUsRUFBRSxFQUFFLElBQUksQ0FBQyxhQUFhLEVBQUUsRUFBRSxFQUFFLElBQUksQ0FBQyxhQUFhLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDL0csQ0FBQzs7O1lBM0dKLFVBQVU7OztZQWIwRSxRQUFRO1lBQXBFLHdCQUF3QjtZQUF4QyxjQUFjO1lBR2QsZ0JBQWdCOzRDQTZCaEIsTUFBTSxTQUFDLDBCQUEwQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGhlbHBlcnMgfSBmcm9tICduZ3gtdGV0aHlzL3V0aWwnO1xuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuXG5pbXBvcnQgeyBDb21wb25lbnRQb3J0YWwsIERvbVBvcnRhbE91dGxldCB9IGZyb20gJ0Bhbmd1bGFyL2Nkay9wb3J0YWwnO1xuaW1wb3J0IHsgQXBwbGljYXRpb25SZWYsIENvbXBvbmVudEZhY3RvcnlSZXNvbHZlciwgQ29tcG9uZW50UmVmLCBJbmplY3QsIEluamVjdGFibGUsIEluamVjdG9yIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbmltcG9ydCB7IE5vdGlmeVBsYWNlbWVudCwgVEhZX05PVElGWV9ERUZBVUxUX09QVElPTlMsIFRoeU5vdGlmeU9wdGlvbnMgfSBmcm9tICcuL25vdGlmeS1vcHRpb24uaW50ZXJmYWNlJztcbmltcG9ydCB7IE5vdGlmeVF1ZXVlU3RvcmUgfSBmcm9tICcuL25vdGlmeS1xdWV1ZS5zdG9yZSc7XG5pbXBvcnQgeyBUaHlOb3RpZnlDb250YWluZXJDb21wb25lbnQgfSBmcm9tICcuL25vdGlmeS5jb250YWluZXIuY29tcG9uZW50JztcblxuY29uc3QgTk9USUZZX09QVElPTl9ERUZBVUxUID0ge1xuICAgIGR1cmF0aW9uOiA0NTAwLFxuICAgIHBhdXNlT25Ib3ZlcjogdHJ1ZSxcbiAgICBtYXhTdGFjazogOCxcbiAgICBwbGFjZW1lbnQ6ICd0b3BSaWdodCdcbn07XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBUaHlOb3RpZnlTZXJ2aWNlIHtcbiAgICBub3RpZnlRdWV1ZSQ6IFN1YmplY3Q8YW55PiA9IG5ldyBTdWJqZWN0KCk7XG5cbiAgICBwcml2YXRlIF9sYXN0Tm90aWZ5SWQgPSAwO1xuXG4gICAgcHJpdmF0ZSBjb250YWluZXJSZWZUb3BSaWdodDogQ29tcG9uZW50UmVmPFRoeU5vdGlmeUNvbnRhaW5lckNvbXBvbmVudD47XG5cbiAgICBwcml2YXRlIGNvbnRhaW5lclJlZkJvdHRvbVJpZ2h0OiBDb21wb25lbnRSZWY8VGh5Tm90aWZ5Q29udGFpbmVyQ29tcG9uZW50PjtcblxuICAgIHByaXZhdGUgY29udGFpbmVyUmVmQm90dG9tTGVmdDogQ29tcG9uZW50UmVmPFRoeU5vdGlmeUNvbnRhaW5lckNvbXBvbmVudD47XG5cbiAgICBwcml2YXRlIGNvbnRhaW5lclJlZlRvcExlZnQ6IENvbXBvbmVudFJlZjxUaHlOb3RpZnlDb250YWluZXJDb21wb25lbnQ+O1xuXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yLFxuICAgICAgICBwcml2YXRlIGNvbXBvbmVudEZhY3RvcnlSZXNvbHZlcjogQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLFxuICAgICAgICBwcml2YXRlIGFwcFJlZjogQXBwbGljYXRpb25SZWYsXG4gICAgICAgIHByaXZhdGUgcXVldWVTdG9yZTogTm90aWZ5UXVldWVTdG9yZSxcbiAgICAgICAgQEluamVjdChUSFlfTk9USUZZX0RFRkFVTFRfT1BUSU9OUykgcHJpdmF0ZSBkZWZhdWx0Q29uZmlnOiBUaHlOb3RpZnlPcHRpb25zXG4gICAgKSB7fVxuXG4gICAgc2hvdyhvcHRpb25zOiBUaHlOb3RpZnlPcHRpb25zKSB7XG4gICAgICAgIGNvbnN0IG5vdGlmeUNvbmZpZyA9IHRoaXMuZm9ybWF0T3B0aW9ucyhvcHRpb25zKTtcbiAgICAgICAgY29uc3QgeyBwbGFjZW1lbnQgfSA9IG5vdGlmeUNvbmZpZztcbiAgICAgICAgdGhpcy5xdWV1ZVN0b3JlLmFkZE5vdGlmeShwbGFjZW1lbnQsIG5vdGlmeUNvbmZpZyk7XG4gICAgICAgIHRoaXMuX2luaXRDb250YWluZXIocGxhY2VtZW50KTtcbiAgICB9XG5cbiAgICBzdWNjZXNzKHRpdGxlPzogc3RyaW5nLCBjb250ZW50Pzogc3RyaW5nLCBvcHRpb25zPzogVGh5Tm90aWZ5T3B0aW9ucykge1xuICAgICAgICB0aGlzLnNob3coe1xuICAgICAgICAgICAgLi4uKG9wdGlvbnMgfHwge30pLFxuICAgICAgICAgICAgdHlwZTogJ3N1Y2Nlc3MnLFxuICAgICAgICAgICAgdGl0bGU6IHRpdGxlIHx8IG9wdGlvbnM/LnRpdGxlIHx8ICfmiJDlip8nLFxuICAgICAgICAgICAgY29udGVudDogY29udGVudCB8fCBvcHRpb25zPy5jb250ZW50XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGluZm8odGl0bGU/OiBzdHJpbmcsIGNvbnRlbnQ/OiBzdHJpbmcsIG9wdGlvbnM/OiBUaHlOb3RpZnlPcHRpb25zKSB7XG4gICAgICAgIHRoaXMuc2hvdyh7XG4gICAgICAgICAgICAuLi4ob3B0aW9ucyB8fCB7fSksXG4gICAgICAgICAgICB0eXBlOiAnaW5mbycsXG4gICAgICAgICAgICB0aXRsZTogdGl0bGUgfHwgb3B0aW9ucz8udGl0bGUgfHwgJ+aPkOekuicsXG4gICAgICAgICAgICBjb250ZW50OiBjb250ZW50IHx8IG9wdGlvbnM/LmNvbnRlbnRcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgd2FybmluZyh0aXRsZT86IHN0cmluZywgY29udGVudD86IHN0cmluZywgb3B0aW9ucz86IFRoeU5vdGlmeU9wdGlvbnMpIHtcbiAgICAgICAgdGhpcy5zaG93KHtcbiAgICAgICAgICAgIC4uLihvcHRpb25zIHx8IHt9KSxcbiAgICAgICAgICAgIHR5cGU6ICd3YXJuaW5nJyxcbiAgICAgICAgICAgIHRpdGxlOiB0aXRsZSB8fCBvcHRpb25zPy50aXRsZSB8fCAn6K2m5ZGKJyxcbiAgICAgICAgICAgIGNvbnRlbnQ6IGNvbnRlbnQgfHwgb3B0aW9ucz8uY29udGVudFxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBlcnJvcih0aXRsZT86IHN0cmluZywgY29udGVudD86IHN0cmluZywgb3B0aW9ucz86IFRoeU5vdGlmeU9wdGlvbnMgfCBzdHJpbmcpIHtcbiAgICAgICAgY29uc3QgY29uZmlnOiBUaHlOb3RpZnlPcHRpb25zID0gaGVscGVycy5pc1N0cmluZyhvcHRpb25zKVxuICAgICAgICAgICAgPyB7IHR5cGU6ICdlcnJvcicsIHRpdGxlOiB0aXRsZSB8fCAn6ZSZ6K+vJywgY29udGVudDogY29udGVudCwgZGV0YWlsOiBvcHRpb25zIH1cbiAgICAgICAgICAgIDoge1xuICAgICAgICAgICAgICAgICAgLi4uKChvcHRpb25zIHx8IHt9KSBhcyBUaHlOb3RpZnlPcHRpb25zKSxcbiAgICAgICAgICAgICAgICAgIHR5cGU6ICdlcnJvcicsXG4gICAgICAgICAgICAgICAgICB0aXRsZTogdGl0bGUgfHwgKG9wdGlvbnMgYXMgVGh5Tm90aWZ5T3B0aW9ucyk/LnRpdGxlIHx8ICfplJnor68nLFxuICAgICAgICAgICAgICAgICAgY29udGVudDogY29udGVudCB8fCAob3B0aW9ucyBhcyBUaHlOb3RpZnlPcHRpb25zKT8uY29udGVudFxuICAgICAgICAgICAgICB9O1xuICAgICAgICB0aGlzLnNob3coY29uZmlnKTtcbiAgICB9XG5cbiAgICByZW1vdmVOb3RpZnlCeUlkKGlkOiBudW1iZXIpIHtcbiAgICAgICAgdGhpcy5xdWV1ZVN0b3JlLnJlbW92ZU5vdGlmeShpZCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfaW5pdENvbnRhaW5lcihwbGFjZW1lbnQ6IE5vdGlmeVBsYWNlbWVudCkge1xuICAgICAgICBpZiAocGxhY2VtZW50ID09PSAndG9wUmlnaHQnKSB7XG4gICAgICAgICAgICB0aGlzLmNvbnRhaW5lclJlZlRvcFJpZ2h0ID0gdGhpcy5fbG9hZE5vdGlmeUNvbnRhaW5lckNvbXBvbmVudCh0aGlzLmNvbnRhaW5lclJlZlRvcFJpZ2h0LCBwbGFjZW1lbnQpO1xuICAgICAgICB9IGVsc2UgaWYgKHBsYWNlbWVudCA9PT0gJ2JvdHRvbVJpZ2h0Jykge1xuICAgICAgICAgICAgdGhpcy5jb250YWluZXJSZWZCb3R0b21SaWdodCA9IHRoaXMuX2xvYWROb3RpZnlDb250YWluZXJDb21wb25lbnQodGhpcy5jb250YWluZXJSZWZCb3R0b21SaWdodCwgcGxhY2VtZW50KTtcbiAgICAgICAgfSBlbHNlIGlmIChwbGFjZW1lbnQgPT09ICdib3R0b21MZWZ0Jykge1xuICAgICAgICAgICAgdGhpcy5jb250YWluZXJSZWZCb3R0b21MZWZ0ID0gdGhpcy5fbG9hZE5vdGlmeUNvbnRhaW5lckNvbXBvbmVudCh0aGlzLmNvbnRhaW5lclJlZkJvdHRvbUxlZnQsIHBsYWNlbWVudCk7XG4gICAgICAgIH0gZWxzZSBpZiAocGxhY2VtZW50ID09PSAndG9wTGVmdCcpIHtcbiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyUmVmVG9wTGVmdCA9IHRoaXMuX2xvYWROb3RpZnlDb250YWluZXJDb21wb25lbnQodGhpcy5jb250YWluZXJSZWZUb3BMZWZ0LCBwbGFjZW1lbnQpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfbG9hZE5vdGlmeUNvbnRhaW5lckNvbXBvbmVudChcbiAgICAgICAgY29udGFpbmVyUmVmOiBDb21wb25lbnRSZWY8VGh5Tm90aWZ5Q29udGFpbmVyQ29tcG9uZW50PixcbiAgICAgICAgcGxhY2VtZW50OiBOb3RpZnlQbGFjZW1lbnRcbiAgICApOiBDb21wb25lbnRSZWY8VGh5Tm90aWZ5Q29udGFpbmVyQ29tcG9uZW50PiB7XG4gICAgICAgIGlmICghY29udGFpbmVyUmVmKSB7XG4gICAgICAgICAgICBjb25zdCBwb3J0YWxPdXRsZXQgPSBuZXcgRG9tUG9ydGFsT3V0bGV0KGRvY3VtZW50LmJvZHksIHRoaXMuY29tcG9uZW50RmFjdG9yeVJlc29sdmVyLCB0aGlzLmFwcFJlZiwgdGhpcy5pbmplY3Rvcik7XG4gICAgICAgICAgICBjb25zdCBjb21wb25lbnRQb3J0YWwgPSBuZXcgQ29tcG9uZW50UG9ydGFsKFRoeU5vdGlmeUNvbnRhaW5lckNvbXBvbmVudCwgbnVsbCk7XG4gICAgICAgICAgICBjb250YWluZXJSZWYgPSBwb3J0YWxPdXRsZXQuYXR0YWNoQ29tcG9uZW50UG9ydGFsKGNvbXBvbmVudFBvcnRhbCk7XG4gICAgICAgICAgICBPYmplY3QuYXNzaWduKGNvbnRhaW5lclJlZi5pbnN0YW5jZSwge1xuICAgICAgICAgICAgICAgIGluaXRpYWxTdGF0ZToge1xuICAgICAgICAgICAgICAgICAgICBwbGFjZW1lbnRcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGNvbnRhaW5lclJlZi5jaGFuZ2VEZXRlY3RvclJlZi5kZXRlY3RDaGFuZ2VzKCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGNvbnRhaW5lclJlZjtcbiAgICB9XG5cbiAgICBwcml2YXRlIGZvcm1hdE9wdGlvbnMob3B0aW9uczogVGh5Tm90aWZ5T3B0aW9ucykge1xuICAgICAgICBpZiAoaGVscGVycy5pc1N0cmluZyhvcHRpb25zLmRldGFpbCkpIHtcbiAgICAgICAgICAgIG9wdGlvbnMgPSB7IC4uLm9wdGlvbnMsIGRldGFpbDogeyBsaW5rOiAnW+ivpuaDhV0nLCBjb250ZW50OiBvcHRpb25zLmRldGFpbCBhcyBzdHJpbmcgfSB9O1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBPYmplY3QuYXNzaWduKHt9LCBOT1RJRllfT1BUSU9OX0RFRkFVTFQsIHsgaWQ6IHRoaXMuX2xhc3ROb3RpZnlJZCsrIH0sIHRoaXMuZGVmYXVsdENvbmZpZywgb3B0aW9ucyk7XG4gICAgfVxufVxuIl19