import { Component, ChangeDetectionStrategy, ViewEncapsulation, ElementRef, Input, HostBinding, Renderer2 } from '@angular/core';
import { UpdateHostClassService } from 'ngx-tethys/core';
import { ThyIconRegistry } from './icon-registry';
import { take } from 'rxjs/operators';
import { coerceBooleanProperty } from 'ngx-tethys/util';
import { getWhetherPrintErrorWhenIconNotFound } from './config';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from 'ngx-tethys/core';
import * as ɵngcc2 from './icon-registry';

const _c0 = ["*"];
const iconSuffixMap = {
    fill: 'fill',
    twotone: 'tt'
};
export class ThyIconComponent {
    constructor(updateHostClassService, render, elementRef, iconRegistry) {
        this.updateHostClassService = updateHostClassService;
        this.render = render;
        this.elementRef = elementRef;
        this.iconRegistry = iconRegistry;
        this.className = true;
        this.isInitialized = false;
        this.iconType = 'outline';
        updateHostClassService.initializeElement(elementRef.nativeElement);
    }
    ngOnInit() {
        this.updateClasses();
        this.isInitialized = true;
    }
    ngOnChanges(changes) {
        if (this.isInitialized) {
            if (changes['iconName'] || changes['iconSet'] || changes['iconTwotoneColor'] || changes['iconType']) {
                this.updateClasses();
            }
            else if (changes['iconRotate']) {
                this.setStyleRotate();
            }
        }
        if (changes['iconLegging']) {
            if (coerceBooleanProperty(this.iconLegging)) {
                this.updateHostClassService.addClass('thy-icon-legging');
            }
            else {
                this.updateHostClassService.removeClass('thy-icon-legging');
            }
        }
    }
    updateClasses() {
        const [namespace, iconName] = this.iconRegistry.splitIconName(this.iconName);
        if (iconName) {
            if (this.iconRegistry.iconMode === 'svg') {
                this.iconRegistry
                    .getSvgIcon(this.buildIconNameByType(iconName), namespace)
                    .pipe(take(1))
                    .subscribe(svg => this.setSvgElement(svg), (error) => {
                    if (getWhetherPrintErrorWhenIconNotFound()) {
                        console.error(`Error retrieving icon: ${error.message}`);
                    }
                });
                this.updateHostClassService.updateClass([
                    `thy-icon${namespace ? `-${namespace}` : ``}-${this.buildIconNameByType(iconName)}`
                ]);
            }
            else {
                const fontSetClass = this.iconSet
                    ? this.iconRegistry.getFontSetClassByAlias(this.iconSet)
                    : this.iconRegistry.getDefaultFontSetClass();
                this.updateHostClassService.updateClass([fontSetClass, `${fontSetClass}-${this.iconName}`]);
            }
        }
    }
    setStyleRotate() {
        if (this.iconRotate !== undefined) {
            this.render.setStyle(this.elementRef.nativeElement.querySelector('svg'), 'transform', `rotate(${this.iconRotate}deg)`);
        }
    }
    //#region svg element
    setSvgElement(svg) {
        this.clearSvgElement();
        // Workaround for IE11 and Edge ignoring `style` tags inside dynamically-created SVGs.
        // See: https://developer.microsoft.com/en-us/microsoft-edge/platform/issues/10898469/
        // Do this before inserting the element into the DOM, in order to avoid a style recalculation.
        const styleTags = svg.querySelectorAll('style');
        for (let i = 0; i < styleTags.length; i++) {
            styleTags[i].textContent += ' ';
        }
        if (this.iconType === 'twotone') {
            const allPaths = svg.querySelectorAll('path');
            if (allPaths.length > 1) {
                allPaths.forEach((child, index) => {
                    if (child.getAttribute('id').includes('secondary-color')) {
                        child.setAttribute('fill', this.iconTwotoneColor);
                    }
                });
            }
        }
        // Note: we do this fix here, rather than the icon registry, because the
        // references have to point to the URL at the time that the icon was created.
        // if (this._location) {
        //     const path = this._location.getPathname();
        //     this._previousPath = path;
        //     this._cacheChildrenWithExternalReferences(svg);
        //     this._prependPathToReferences(path);
        // }
        if (this.iconLinearGradient) {
            this.setBaseUrl(svg);
            this.clearTitleElement(svg);
        }
        this.elementRef.nativeElement.appendChild(svg);
        this.setStyleRotate();
    }
    clearSvgElement() {
        const layoutElement = this.elementRef.nativeElement;
        let childCount = layoutElement.childNodes.length;
        // if (this._elementsWithExternalReferences) {
        //     this._elementsWithExternalReferences.clear();
        // }
        // Remove existing non-element child nodes and SVGs, and add the new SVG element. Note that
        // we can't use innerHTML, because IE will throw if the element has a data binding.
        while (childCount--) {
            const child = layoutElement.childNodes[childCount];
            // 1 corresponds to Node.ELEMENT_NODE. We remove all non-element nodes in order to get rid
            // of any loose text nodes, as well as any SVG elements in order to remove any old icons.
            if (child.nodeType !== 1 || child.nodeName.toLowerCase() === 'svg') {
                layoutElement.removeChild(child);
            }
        }
    }
    //#endregion
    buildIconNameByType(iconName) {
        if (this.iconType && ['fill', 'twotone'].indexOf(this.iconType) >= 0) {
            const suffix = iconSuffixMap[this.iconType];
            return iconName.includes(`-${suffix}`) ? iconName : `${iconName}-${suffix}`;
        }
        else {
            return iconName;
        }
    }
    /**
     * Support Safari SVG LinearGradient.
     *
     *
     * @param svg
     */
    setBaseUrl(svg) {
        const styleElements = svg.querySelectorAll('[style]');
        styleElements.forEach((n) => {
            if (n.style.cssText.includes('url')) {
                n.style.fill = n.style.fill.replace('url("', 'url("' + location.pathname);
            }
            if (n.style.cssText.includes('clip-path')) {
                n.style.clipPath = n.style.clipPath.replace('url("', 'url("' + location.pathname);
            }
        });
    }
    clearTitleElement(svg) {
        svg.querySelector('title').remove();
    }
}
ThyIconComponent.ɵfac = function ThyIconComponent_Factory(t) { return new (t || ThyIconComponent)(ɵngcc0.ɵɵdirectiveInject(ɵngcc1.UpdateHostClassService), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.Renderer2), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.ElementRef), ɵngcc0.ɵɵdirectiveInject(ɵngcc2.ThyIconRegistry)); };
ThyIconComponent.ɵcmp = ɵngcc0.ɵɵdefineComponent({ type: ThyIconComponent, selectors: [["thy-icon"]], hostVars: 2, hostBindings: function ThyIconComponent_HostBindings(rf, ctx) { if (rf & 2) {
        ɵngcc0.ɵɵclassProp("thy-icon", ctx.className);
    } }, inputs: { iconType: ["thyIconType", "iconType"], iconTwotoneColor: ["thyTwotoneColor", "iconTwotoneColor"], iconName: ["thyIconName", "iconName"], iconRotate: ["thyIconRotate", "iconRotate"], iconSet: ["thyIconSet", "iconSet"], iconLegging: ["thyIconLegging", "iconLegging"], iconLinearGradient: ["thyIconLinearGradient", "iconLinearGradient"] }, features: [ɵngcc0.ɵɵProvidersFeature([UpdateHostClassService]), ɵngcc0.ɵɵNgOnChangesFeature], ngContentSelectors: _c0, decls: 1, vars: 0, template: function ThyIconComponent_Template(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵprojectionDef();
        ɵngcc0.ɵɵprojection(0);
    } }, encapsulation: 2, changeDetection: 0 });
ThyIconComponent.ctorParameters = () => [
    { type: UpdateHostClassService },
    { type: Renderer2 },
    { type: ElementRef },
    { type: ThyIconRegistry }
];
ThyIconComponent.propDecorators = {
    className: [{ type: HostBinding, args: ['class.thy-icon',] }],
    iconType: [{ type: Input, args: ['thyIconType',] }],
    iconTwotoneColor: [{ type: Input, args: ['thyTwotoneColor',] }],
    iconName: [{ type: Input, args: ['thyIconName',] }],
    iconRotate: [{ type: Input, args: ['thyIconRotate',] }],
    iconSet: [{ type: Input, args: ['thyIconSet',] }],
    iconLegging: [{ type: Input, args: ['thyIconLegging',] }],
    iconLinearGradient: [{ type: Input, args: ['thyIconLinearGradient',] }]
};
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(ThyIconComponent, [{
        type: Component,
        args: [{
                selector: 'thy-icon',
                template: '<ng-content></ng-content>',
                changeDetection: ChangeDetectionStrategy.OnPush,
                encapsulation: ViewEncapsulation.None,
                providers: [UpdateHostClassService]
            }]
    }], function () { return [{ type: ɵngcc1.UpdateHostClassService }, { type: ɵngcc0.Renderer2 }, { type: ɵngcc0.ElementRef }, { type: ɵngcc2.ThyIconRegistry }]; }, { className: [{
            type: HostBinding,
            args: ['class.thy-icon']
        }], iconType: [{
            type: Input,
            args: ['thyIconType']
        }], iconTwotoneColor: [{
            type: Input,
            args: ['thyTwotoneColor']
        }], iconName: [{
            type: Input,
            args: ['thyIconName']
        }], iconRotate: [{
            type: Input,
            args: ['thyIconRotate']
        }], iconSet: [{
            type: Input,
            args: ['thyIconSet']
        }], iconLegging: [{
            type: Input,
            args: ['thyIconLegging']
        }], iconLinearGradient: [{
            type: Input,
            args: ['thyIconLinearGradient']
        }] }); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaWNvbi5jb21wb25lbnQuanMiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9pY29uL2ljb24uY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDSCxTQUFTLEVBRVQsdUJBQXVCLEVBQ3ZCLGlCQUFpQixFQUNqQixVQUFVLEVBQ1YsS0FBSyxFQUNMLFdBQVcsRUFDWCxTQUFTLEVBR1osTUFBTSxlQUFlLENBQUM7QUFFdkIsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDekQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ2xELE9BQU8sRUFBRSxJQUFJLEVBQU8sTUFBTSxnQkFBZ0IsQ0FBQztBQUUzQyxPQUFPLEVBQWUscUJBQXFCLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUNyRSxPQUFPLEVBQUUsb0NBQW9DLEVBQUUsTUFBTSxVQUFVLENBQUM7Ozs7OztBQUVoRSxNQUFNLGFBQWEsR0FBRztBQUN0QixJQUFJLElBQUksRUFBRSxNQUFNO0FBQ2hCLElBQUksT0FBTyxFQUFFLElBQUk7QUFDakIsQ0FBQyxDQUFDO0FBU0YsTUFBTSxPQUFPLGdCQUFnQjtBQUFHLElBbUI1QixZQUNZLHNCQUE4QyxFQUM5QyxNQUFpQixFQUNqQixVQUFzQixFQUN0QixZQUE2QjtBQUMxQyxRQUphLDJCQUFzQixHQUF0QixzQkFBc0IsQ0FBd0I7QUFBQyxRQUMvQyxXQUFNLEdBQU4sTUFBTSxDQUFXO0FBQUMsUUFDbEIsZUFBVSxHQUFWLFVBQVUsQ0FBWTtBQUFDLFFBQ3ZCLGlCQUFZLEdBQVosWUFBWSxDQUFpQjtBQUM3QyxRQXZCbUMsY0FBUyxHQUFHLElBQUksQ0FBQztBQUNwRCxRQUNZLGtCQUFhLEdBQUcsS0FBSyxDQUFDO0FBQ2xDLFFBQzBCLGFBQVEsR0FBbUMsU0FBUyxDQUFDO0FBQy9FLFFBbUJRLHNCQUFzQixDQUFDLGlCQUFpQixDQUFDLFVBQVUsQ0FBQyxhQUFhLENBQUMs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QUFLLFNBQUMsdUJBQXVCO0FBQU07Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7b0JBQUU7QUFBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gICAgQ29tcG9uZW50LFxuICAgIE9uSW5pdCxcbiAgICBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneSxcbiAgICBWaWV3RW5jYXBzdWxhdGlvbixcbiAgICBFbGVtZW50UmVmLFxuICAgIElucHV0LFxuICAgIEhvc3RCaW5kaW5nLFxuICAgIFJlbmRlcmVyMixcbiAgICBTaW1wbGVDaGFuZ2VzLFxuICAgIE9uQ2hhbmdlc1xufSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHsgVXBkYXRlSG9zdENsYXNzU2VydmljZSB9IGZyb20gJ25neC10ZXRoeXMvY29yZSc7XG5pbXBvcnQgeyBUaHlJY29uUmVnaXN0cnkgfSBmcm9tICcuL2ljb24tcmVnaXN0cnknO1xuaW1wb3J0IHsgdGFrZSwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgU3ViamVjdCwgbm9vcCwgQmVoYXZpb3JTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBjb2VyY2VBcnJheSwgY29lcmNlQm9vbGVhblByb3BlcnR5IH0gZnJvbSAnbmd4LXRldGh5cy91dGlsJztcbmltcG9ydCB7IGdldFdoZXRoZXJQcmludEVycm9yV2hlbkljb25Ob3RGb3VuZCB9IGZyb20gJy4vY29uZmlnJztcblxuY29uc3QgaWNvblN1ZmZpeE1hcCA9IHtcbiAgICBmaWxsOiAnZmlsbCcsXG4gICAgdHdvdG9uZTogJ3R0J1xufTtcblxuQENvbXBvbmVudCh7XG4gICAgc2VsZWN0b3I6ICd0aHktaWNvbicsXG4gICAgdGVtcGxhdGU6ICc8bmctY29udGVudD48L25nLWNvbnRlbnQ+JyxcbiAgICBjaGFuZ2VEZXRlY3Rpb246IENoYW5nZURldGVjdGlvblN0cmF0ZWd5Lk9uUHVzaCxcbiAgICBlbmNhcHN1bGF0aW9uOiBWaWV3RW5jYXBzdWxhdGlvbi5Ob25lLFxuICAgIHByb3ZpZGVyczogW1VwZGF0ZUhvc3RDbGFzc1NlcnZpY2VdXG59KVxuZXhwb3J0IGNsYXNzIFRoeUljb25Db21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIE9uQ2hhbmdlcyB7XG4gICAgQEhvc3RCaW5kaW5nKCdjbGFzcy50aHktaWNvbicpIGNsYXNzTmFtZSA9IHRydWU7XG5cbiAgICBwcml2YXRlIGlzSW5pdGlhbGl6ZWQgPSBmYWxzZTtcblxuICAgIEBJbnB1dCgndGh5SWNvblR5cGUnKSBpY29uVHlwZTogJ291dGxpbmUnIHwgJ2ZpbGwnIHwgJ3R3b3RvbmUnID0gJ291dGxpbmUnO1xuXG4gICAgQElucHV0KCd0aHlUd290b25lQ29sb3InKSBpY29uVHdvdG9uZUNvbG9yOiBzdHJpbmc7XG5cbiAgICBASW5wdXQoJ3RoeUljb25OYW1lJykgaWNvbk5hbWU6IHN0cmluZztcblxuICAgIEBJbnB1dCgndGh5SWNvblJvdGF0ZScpIGljb25Sb3RhdGU6IG51bWJlcjtcblxuICAgIEBJbnB1dCgndGh5SWNvblNldCcpIGljb25TZXQ6IHN0cmluZztcblxuICAgIEBJbnB1dCgndGh5SWNvbkxlZ2dpbmcnKSBpY29uTGVnZ2luZzogYm9vbGVhbjtcblxuICAgIEBJbnB1dCgndGh5SWNvbkxpbmVhckdyYWRpZW50JykgaWNvbkxpbmVhckdyYWRpZW50OiBib29sZWFuO1xuXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIHByaXZhdGUgdXBkYXRlSG9zdENsYXNzU2VydmljZTogVXBkYXRlSG9zdENsYXNzU2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSByZW5kZXI6IFJlbmRlcmVyMixcbiAgICAgICAgcHJpdmF0ZSBlbGVtZW50UmVmOiBFbGVtZW50UmVmLFxuICAgICAgICBwcml2YXRlIGljb25SZWdpc3RyeTogVGh5SWNvblJlZ2lzdHJ5XG4gICAgKSB7XG4gICAgICAgIHVwZGF0ZUhvc3RDbGFzc1NlcnZpY2UuaW5pdGlhbGl6ZUVsZW1lbnQoZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50KTtcbiAgICB9XG5cbiAgICBuZ09uSW5pdCgpIHtcbiAgICAgICAgdGhpcy51cGRhdGVDbGFzc2VzKCk7XG4gICAgICAgIHRoaXMuaXNJbml0aWFsaXplZCA9IHRydWU7XG4gICAgfVxuXG4gICAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcykge1xuICAgICAgICBpZiAodGhpcy5pc0luaXRpYWxpemVkKSB7XG4gICAgICAgICAgICBpZiAoY2hhbmdlc1snaWNvbk5hbWUnXSB8fCBjaGFuZ2VzWydpY29uU2V0J10gfHwgY2hhbmdlc1snaWNvblR3b3RvbmVDb2xvciddIHx8IGNoYW5nZXNbJ2ljb25UeXBlJ10pIHtcbiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUNsYXNzZXMoKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2hhbmdlc1snaWNvblJvdGF0ZSddKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zZXRTdHlsZVJvdGF0ZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmIChjaGFuZ2VzWydpY29uTGVnZ2luZyddKSB7XG4gICAgICAgICAgICBpZiAoY29lcmNlQm9vbGVhblByb3BlcnR5KHRoaXMuaWNvbkxlZ2dpbmcpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy51cGRhdGVIb3N0Q2xhc3NTZXJ2aWNlLmFkZENsYXNzKCd0aHktaWNvbi1sZWdnaW5nJyk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlSG9zdENsYXNzU2VydmljZS5yZW1vdmVDbGFzcygndGh5LWljb24tbGVnZ2luZycpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSB1cGRhdGVDbGFzc2VzKCkge1xuICAgICAgICBjb25zdCBbbmFtZXNwYWNlLCBpY29uTmFtZV0gPSB0aGlzLmljb25SZWdpc3RyeS5zcGxpdEljb25OYW1lKHRoaXMuaWNvbk5hbWUpO1xuICAgICAgICBpZiAoaWNvbk5hbWUpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLmljb25SZWdpc3RyeS5pY29uTW9kZSA9PT0gJ3N2ZycpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmljb25SZWdpc3RyeVxuICAgICAgICAgICAgICAgICAgICAuZ2V0U3ZnSWNvbih0aGlzLmJ1aWxkSWNvbk5hbWVCeVR5cGUoaWNvbk5hbWUpLCBuYW1lc3BhY2UpXG4gICAgICAgICAgICAgICAgICAgIC5waXBlKHRha2UoMSkpXG4gICAgICAgICAgICAgICAgICAgIC5zdWJzY3JpYmUoXG4gICAgICAgICAgICAgICAgICAgICAgICBzdmcgPT4gdGhpcy5zZXRTdmdFbGVtZW50KHN2ZyksXG4gICAgICAgICAgICAgICAgICAgICAgICAoZXJyb3I6IEVycm9yKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGdldFdoZXRoZXJQcmludEVycm9yV2hlbkljb25Ob3RGb3VuZCgpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYEVycm9yIHJldHJpZXZpbmcgaWNvbjogJHtlcnJvci5tZXNzYWdlfWApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUhvc3RDbGFzc1NlcnZpY2UudXBkYXRlQ2xhc3MoW1xuICAgICAgICAgICAgICAgICAgICBgdGh5LWljb24ke25hbWVzcGFjZSA/IGAtJHtuYW1lc3BhY2V9YCA6IGBgfS0ke3RoaXMuYnVpbGRJY29uTmFtZUJ5VHlwZShpY29uTmFtZSl9YFxuICAgICAgICAgICAgICAgIF0pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjb25zdCBmb250U2V0Q2xhc3MgPSB0aGlzLmljb25TZXRcbiAgICAgICAgICAgICAgICAgICAgPyB0aGlzLmljb25SZWdpc3RyeS5nZXRGb250U2V0Q2xhc3NCeUFsaWFzKHRoaXMuaWNvblNldClcbiAgICAgICAgICAgICAgICAgICAgOiB0aGlzLmljb25SZWdpc3RyeS5nZXREZWZhdWx0Rm9udFNldENsYXNzKCk7XG4gICAgICAgICAgICAgICAgdGhpcy51cGRhdGVIb3N0Q2xhc3NTZXJ2aWNlLnVwZGF0ZUNsYXNzKFtmb250U2V0Q2xhc3MsIGAke2ZvbnRTZXRDbGFzc30tJHt0aGlzLmljb25OYW1lfWBdKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgc2V0U3R5bGVSb3RhdGUoKSB7XG4gICAgICAgIGlmICh0aGlzLmljb25Sb3RhdGUgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgdGhpcy5yZW5kZXIuc2V0U3R5bGUodGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQucXVlcnlTZWxlY3Rvcignc3ZnJyksICd0cmFuc2Zvcm0nLCBgcm90YXRlKCR7dGhpcy5pY29uUm90YXRlfWRlZylgKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vI3JlZ2lvbiBzdmcgZWxlbWVudFxuXG4gICAgcHJpdmF0ZSBzZXRTdmdFbGVtZW50KHN2ZzogU1ZHRWxlbWVudCkge1xuICAgICAgICB0aGlzLmNsZWFyU3ZnRWxlbWVudCgpO1xuXG4gICAgICAgIC8vIFdvcmthcm91bmQgZm9yIElFMTEgYW5kIEVkZ2UgaWdub3JpbmcgYHN0eWxlYCB0YWdzIGluc2lkZSBkeW5hbWljYWxseS1jcmVhdGVkIFNWR3MuXG4gICAgICAgIC8vIFNlZTogaHR0cHM6Ly9kZXZlbG9wZXIubWljcm9zb2Z0LmNvbS9lbi11cy9taWNyb3NvZnQtZWRnZS9wbGF0Zm9ybS9pc3N1ZXMvMTA4OTg0NjkvXG4gICAgICAgIC8vIERvIHRoaXMgYmVmb3JlIGluc2VydGluZyB0aGUgZWxlbWVudCBpbnRvIHRoZSBET00sIGluIG9yZGVyIHRvIGF2b2lkIGEgc3R5bGUgcmVjYWxjdWxhdGlvbi5cbiAgICAgICAgY29uc3Qgc3R5bGVUYWdzID0gc3ZnLnF1ZXJ5U2VsZWN0b3JBbGwoJ3N0eWxlJykgYXMgTm9kZUxpc3RPZjxIVE1MU3R5bGVFbGVtZW50PjtcblxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHN0eWxlVGFncy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgc3R5bGVUYWdzW2ldLnRleHRDb250ZW50ICs9ICcgJztcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLmljb25UeXBlID09PSAndHdvdG9uZScpIHtcbiAgICAgICAgICAgIGNvbnN0IGFsbFBhdGhzID0gc3ZnLnF1ZXJ5U2VsZWN0b3JBbGwoJ3BhdGgnKTtcbiAgICAgICAgICAgIGlmIChhbGxQYXRocy5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICAgICAgYWxsUGF0aHMuZm9yRWFjaCgoY2hpbGQsIGluZGV4OiBudW1iZXIpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkLmdldEF0dHJpYnV0ZSgnaWQnKS5pbmNsdWRlcygnc2Vjb25kYXJ5LWNvbG9yJykpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkLnNldEF0dHJpYnV0ZSgnZmlsbCcsIHRoaXMuaWNvblR3b3RvbmVDb2xvcik7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vIE5vdGU6IHdlIGRvIHRoaXMgZml4IGhlcmUsIHJhdGhlciB0aGFuIHRoZSBpY29uIHJlZ2lzdHJ5LCBiZWNhdXNlIHRoZVxuICAgICAgICAvLyByZWZlcmVuY2VzIGhhdmUgdG8gcG9pbnQgdG8gdGhlIFVSTCBhdCB0aGUgdGltZSB0aGF0IHRoZSBpY29uIHdhcyBjcmVhdGVkLlxuICAgICAgICAvLyBpZiAodGhpcy5fbG9jYXRpb24pIHtcbiAgICAgICAgLy8gICAgIGNvbnN0IHBhdGggPSB0aGlzLl9sb2NhdGlvbi5nZXRQYXRobmFtZSgpO1xuICAgICAgICAvLyAgICAgdGhpcy5fcHJldmlvdXNQYXRoID0gcGF0aDtcbiAgICAgICAgLy8gICAgIHRoaXMuX2NhY2hlQ2hpbGRyZW5XaXRoRXh0ZXJuYWxSZWZlcmVuY2VzKHN2Zyk7XG4gICAgICAgIC8vICAgICB0aGlzLl9wcmVwZW5kUGF0aFRvUmVmZXJlbmNlcyhwYXRoKTtcbiAgICAgICAgLy8gfVxuICAgICAgICBpZiAodGhpcy5pY29uTGluZWFyR3JhZGllbnQpIHtcbiAgICAgICAgICAgIHRoaXMuc2V0QmFzZVVybChzdmcpO1xuICAgICAgICAgICAgdGhpcy5jbGVhclRpdGxlRWxlbWVudChzdmcpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQuYXBwZW5kQ2hpbGQoc3ZnKTtcbiAgICAgICAgdGhpcy5zZXRTdHlsZVJvdGF0ZSgpO1xuICAgIH1cblxuICAgIHByaXZhdGUgY2xlYXJTdmdFbGVtZW50KCkge1xuICAgICAgICBjb25zdCBsYXlvdXRFbGVtZW50OiBIVE1MRWxlbWVudCA9IHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50O1xuICAgICAgICBsZXQgY2hpbGRDb3VudCA9IGxheW91dEVsZW1lbnQuY2hpbGROb2Rlcy5sZW5ndGg7XG5cbiAgICAgICAgLy8gaWYgKHRoaXMuX2VsZW1lbnRzV2l0aEV4dGVybmFsUmVmZXJlbmNlcykge1xuICAgICAgICAvLyAgICAgdGhpcy5fZWxlbWVudHNXaXRoRXh0ZXJuYWxSZWZlcmVuY2VzLmNsZWFyKCk7XG4gICAgICAgIC8vIH1cblxuICAgICAgICAvLyBSZW1vdmUgZXhpc3Rpbmcgbm9uLWVsZW1lbnQgY2hpbGQgbm9kZXMgYW5kIFNWR3MsIGFuZCBhZGQgdGhlIG5ldyBTVkcgZWxlbWVudC4gTm90ZSB0aGF0XG4gICAgICAgIC8vIHdlIGNhbid0IHVzZSBpbm5lckhUTUwsIGJlY2F1c2UgSUUgd2lsbCB0aHJvdyBpZiB0aGUgZWxlbWVudCBoYXMgYSBkYXRhIGJpbmRpbmcuXG4gICAgICAgIHdoaWxlIChjaGlsZENvdW50LS0pIHtcbiAgICAgICAgICAgIGNvbnN0IGNoaWxkID0gbGF5b3V0RWxlbWVudC5jaGlsZE5vZGVzW2NoaWxkQ291bnRdO1xuXG4gICAgICAgICAgICAvLyAxIGNvcnJlc3BvbmRzIHRvIE5vZGUuRUxFTUVOVF9OT0RFLiBXZSByZW1vdmUgYWxsIG5vbi1lbGVtZW50IG5vZGVzIGluIG9yZGVyIHRvIGdldCByaWRcbiAgICAgICAgICAgIC8vIG9mIGFueSBsb29zZSB0ZXh0IG5vZGVzLCBhcyB3ZWxsIGFzIGFueSBTVkcgZWxlbWVudHMgaW4gb3JkZXIgdG8gcmVtb3ZlIGFueSBvbGQgaWNvbnMuXG4gICAgICAgICAgICBpZiAoY2hpbGQubm9kZVR5cGUgIT09IDEgfHwgY2hpbGQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gJ3N2ZycpIHtcbiAgICAgICAgICAgICAgICBsYXlvdXRFbGVtZW50LnJlbW92ZUNoaWxkKGNoaWxkKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vI2VuZHJlZ2lvblxuXG4gICAgcHJpdmF0ZSBidWlsZEljb25OYW1lQnlUeXBlKGljb25OYW1lOiBzdHJpbmcpIHtcbiAgICAgICAgaWYgKHRoaXMuaWNvblR5cGUgJiYgWydmaWxsJywgJ3R3b3RvbmUnXS5pbmRleE9mKHRoaXMuaWNvblR5cGUpID49IDApIHtcbiAgICAgICAgICAgIGNvbnN0IHN1ZmZpeCA9IGljb25TdWZmaXhNYXBbdGhpcy5pY29uVHlwZV07XG4gICAgICAgICAgICByZXR1cm4gaWNvbk5hbWUuaW5jbHVkZXMoYC0ke3N1ZmZpeH1gKSA/IGljb25OYW1lIDogYCR7aWNvbk5hbWV9LSR7c3VmZml4fWA7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gaWNvbk5hbWU7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTdXBwb3J0IFNhZmFyaSBTVkcgTGluZWFyR3JhZGllbnQuXG4gICAgICpcbiAgICAgKlxuICAgICAqIEBwYXJhbSBzdmdcbiAgICAgKi9cbiAgICBwcml2YXRlIHNldEJhc2VVcmwoc3ZnOiBTVkdFbGVtZW50KSB7XG4gICAgICAgIGNvbnN0IHN0eWxlRWxlbWVudHMgPSBzdmcucXVlcnlTZWxlY3RvckFsbCgnW3N0eWxlXScpO1xuICAgICAgICBzdHlsZUVsZW1lbnRzLmZvckVhY2goKG46IGFueSkgPT4ge1xuICAgICAgICAgICAgaWYgKG4uc3R5bGUuY3NzVGV4dC5pbmNsdWRlcygndXJsJykpIHtcbiAgICAgICAgICAgICAgICBuLnN0eWxlLmZpbGwgPSBuLnN0eWxlLmZpbGwucmVwbGFjZSgndXJsKFwiJywgJ3VybChcIicgKyBsb2NhdGlvbi5wYXRobmFtZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAobi5zdHlsZS5jc3NUZXh0LmluY2x1ZGVzKCdjbGlwLXBhdGgnKSkge1xuICAgICAgICAgICAgICAgIG4uc3R5bGUuY2xpcFBhdGggPSBuLnN0eWxlLmNsaXBQYXRoLnJlcGxhY2UoJ3VybChcIicsICd1cmwoXCInICsgbG9jYXRpb24ucGF0aG5hbWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNsZWFyVGl0bGVFbGVtZW50KHN2ZzogU1ZHRWxlbWVudCkge1xuICAgICAgICBzdmcucXVlcnlTZWxlY3RvcigndGl0bGUnKS5yZW1vdmUoKTtcbiAgICB9XG59XG4iXX0=