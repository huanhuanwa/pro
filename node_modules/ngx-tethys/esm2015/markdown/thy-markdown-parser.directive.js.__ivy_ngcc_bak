import { Directive, ElementRef, Input } from '@angular/core';
import { ThyMarkdownParserService } from './thy-markdown-parser.service';
import { $, liteMarked, mermaid, katex } from 'ngx-tethys/types';
import { coerceBooleanProperty } from 'ngx-tethys/util';
export class ThyMarkdownParserDirective {
    constructor(elementRef, thyMarkdownParserService) {
        this.elementRef = elementRef;
        this.thyMarkdownParserService = thyMarkdownParserService;
        this.bypassSecurityTrustHtml = false;
        this.liteMarkedOptions = {
            gfm: true,
            tables: true,
            breaks: true,
            pedantic: false,
            sanitize: false,
            smartLists: true,
            smartypants: true,
            heading: true,
            link: true,
            list: true,
            wtlink: true,
            wthexcolor: true,
            wthexcolorRender: {
                className: 'msg-inline-color'
            },
            wtat: false,
            wthash: false,
            wtentity: true,
            wtentityRender: {
                className: 'slide-trigger'
            },
            wthashRender: {
                chlPrefix: '/messages/groups/'
            },
            wtexclamation: true,
            wtemoji: false,
            isParagraphDefault: true,
            isImageDefault: true,
            isBlockquoteDefault: true,
            isHrDefault: true,
            isStrongDefault: true,
            isEmDefault: true,
            isCodespanDefault: true,
            isCodeDefault: true,
            isDelDefault: true,
            isHtmlDefault: true,
            isTextEscape: true,
            isDef: true,
            isImgPreview: true
        };
    }
    set thyMarkdownParser(value) {
        if (value) {
            this.value = value;
            this.translateHTML();
        }
    }
    set thyBypassSecurityTrustHtml(value) {
        this.bypassSecurityTrustHtml = coerceBooleanProperty(value);
    }
    initGantt() {
        if (mermaid) {
            mermaid.parseError = function (err, hash) {
                mermaid.error = err;
            };
            mermaid.ganttConfig = {
                // Configuration for Gantt diagrams
                numberSectionStyles: 4,
                axisFormatter: [
                    [
                        '%I:%M',
                        function (d) {
                            // Within a day
                            return d.getHours();
                        }
                    ],
                    [
                        'w. %U',
                        function (d) {
                            // Monday a week
                            return d.getDay() === 1;
                        }
                    ],
                    [
                        '%a %d',
                        function (d) {
                            // Day within a week (not monday)
                            return d.getDay() && d.getDate() !== 1;
                        }
                    ],
                    [
                        '%b %d',
                        function (d) {
                            // within a month
                            return d.getDate() !== 1;
                        }
                    ],
                    [
                        '%m-%y',
                        function (d) {
                            // Month
                            return d.getMonth();
                        }
                    ]
                ]
            };
        }
    }
    initMarked() {
        // 设置marked
        const renderer = new liteMarked.Renderer();
        renderer.listitem = function (text) {
            if (!/^\[[ x]\]\s/.test(text)) {
                return liteMarked.Renderer.prototype.listitem(text);
            }
            // 任务列表
            const checkbox = $('<input type="checkbox" disabled/>');
            if (/^\[x\]\s/.test(text)) {
                // 完成的任务列表
                checkbox.attr('checked', true);
            }
            return $(liteMarked.Renderer.prototype.listitem(text.substring(3)))
                .addClass('task-list-item')
                .prepend(checkbox)[0].outerHTML;
        };
        renderer.codespan = function (text) {
            // inline code
            if (/^\$.+\$$/.test(text)) {
                // inline math
                const raw = /^\$(.+)\$$/.exec(text)[1];
                const line = raw
                    .replace(/&lt;/g, '<')
                    .replace(/&gt;/g, '>')
                    .replace(/&amp;/g, '&')
                    .replace(/&quot;/g, '"')
                    .replace(/&#39;/g, "'"); // unescape html characters
                try {
                    return katex.renderToString(line, { displayMode: false });
                }
                catch (err) {
                    return '<code>' + err + '</code>';
                }
            }
            return liteMarked.Renderer.prototype.codespan.apply(this, arguments);
        };
        renderer.code = function (code, language, escaped, line_number) {
            code = code.trim();
            const firstLine = code.split(/\n/)[0].trim();
            if (language === 'math') {
                // 数学公式
                let tex = '';
                code.split(/\n\n/).forEach(function (line) {
                    // 连续两个换行，则开始下一个公式
                    line = line.trim();
                    if (line.length > 0) {
                        try {
                            tex += katex.renderToString(line, { displayMode: true });
                        }
                        catch (err) {
                            tex += '<pre>' + err + '</pre>';
                        }
                    }
                });
                return '<div data-line="' + line_number + '">' + tex + '</div>';
            }
            else if (firstLine === 'gantt' || firstLine === 'sequenceDiagram' || firstLine.match(/^graph (?:TB|BT|RL|LR|TD);?$/)) {
                // mermaid
                if (firstLine === 'sequenceDiagram') {
                    code += '\n'; // 如果末尾没有空行，则语法错误
                }
                if (mermaid && mermaid.parse(code)) {
                    return '<div class="mermaid" data-line="' + line_number + '">' + code + '</div>';
                }
                else {
                    if (mermaid && mermaid.error) {
                        return '<pre data-line="' + line_number + '">' + mermaid.error + '</pre>';
                    }
                }
            }
            else {
                return liteMarked.Renderer.prototype.code.apply(this, arguments);
            }
        };
        renderer.html = function (html) {
            const result = liteMarked.Renderer.prototype.html.apply(this, arguments);
            const h = $(result.bold());
            return h.html();
        };
        renderer.paragraph = function (text) {
            const result = liteMarked.Renderer.prototype.paragraph.apply(this, arguments);
            const h = $(result.bold());
            return h.html();
        };
        liteMarked.setOptions(this.liteMarkedOptions);
    }
    initComponent() {
        // 初始化甘特图
        this.initGantt();
        // 初始解析器
        this.initMarked();
    }
    parseMarked(_value) {
        if (liteMarked && _value) {
            return liteMarked(_value);
        }
        else {
            return _value;
        }
    }
    parseMermaid() {
        if (mermaid) {
            mermaid.init();
        }
    }
    translateHTML() {
        this.initComponent();
        let _value = this.thyMarkdownParserService.filterHTML(this.value);
        _value = this.parseMarked(_value);
        if (!this.bypassSecurityTrustHtml) {
            _value = this.thyMarkdownParserService.sanitizeHTML(_value);
        }
        setTimeout(() => {
            this.parseMermaid();
        }, 100);
        this.elementRef.nativeElement.innerHTML = _value;
        $(this.elementRef.nativeElement)
            .find('a')
            .attr('target', function () {
            if (this.host !== location.host) {
                return '_blank';
            }
            else {
                let outer_path = [
                    'shared/',
                    'share/',
                    'club',
                    'videos',
                    'blog',
                    'plan',
                    'tour',
                    'mobile',
                    'security',
                    'uservoice',
                    'customers',
                    'press',
                    'help',
                    'guide',
                    'feedback',
                    'about',
                    'contact',
                    'privacy',
                    'terms'
                ].join(')|(/');
                outer_path = new RegExp('^(/' + outer_path + ')');
                if (outer_path.test(this.pathname)) {
                    return '_blank';
                }
            }
        });
    }
    ngOnInit() {
        const emojisRender = this.thyMarkdownParserService.getEmojisRender();
        if (emojisRender) {
            this.liteMarkedOptions.wtemoji = true;
            this.liteMarkedOptions.wtemojiRender = emojisRender;
        }
        this.translateHTML();
    }
}
ThyMarkdownParserDirective.decorators = [
    { type: Directive, args: [{
                selector: '[thyMarkdownParser]'
            },] }
];
ThyMarkdownParserDirective.ctorParameters = () => [
    { type: ElementRef },
    { type: ThyMarkdownParserService }
];
ThyMarkdownParserDirective.propDecorators = {
    thyMarkdownParser: [{ type: Input }],
    thyBypassSecurityTrustHtml: [{ type: Input }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGh5LW1hcmtkb3duLXBhcnNlci5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvbWFya2Rvd24vdGh5LW1hcmtkb3duLXBhcnNlci5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxVQUFVLEVBQVUsS0FBSyxFQUF3QixNQUFNLGVBQWUsQ0FBQztBQUMzRixPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUN6RSxPQUFPLEVBQUUsQ0FBQyxFQUFFLFVBQVUsRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDakUsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFLeEQsTUFBTSxPQUFPLDBCQUEwQjtJQTJEbkMsWUFBb0IsVUFBc0IsRUFBVSx3QkFBa0Q7UUFBbEYsZUFBVSxHQUFWLFVBQVUsQ0FBWTtRQUFVLDZCQUF3QixHQUF4Qix3QkFBd0IsQ0FBMEI7UUF4RDlGLDRCQUF1QixHQUFHLEtBQUssQ0FBQztRQUVoQyxzQkFBaUIsR0FBUTtZQUM3QixHQUFHLEVBQUUsSUFBSTtZQUNULE1BQU0sRUFBRSxJQUFJO1lBQ1osTUFBTSxFQUFFLElBQUk7WUFDWixRQUFRLEVBQUUsS0FBSztZQUNmLFFBQVEsRUFBRSxLQUFLO1lBQ2YsVUFBVSxFQUFFLElBQUk7WUFDaEIsV0FBVyxFQUFFLElBQUk7WUFDakIsT0FBTyxFQUFFLElBQUk7WUFDYixJQUFJLEVBQUUsSUFBSTtZQUNWLElBQUksRUFBRSxJQUFJO1lBQ1YsTUFBTSxFQUFFLElBQUk7WUFDWixVQUFVLEVBQUUsSUFBSTtZQUNoQixnQkFBZ0IsRUFBRTtnQkFDZCxTQUFTLEVBQUUsa0JBQWtCO2FBQ2hDO1lBQ0QsSUFBSSxFQUFFLEtBQUs7WUFDWCxNQUFNLEVBQUUsS0FBSztZQUNiLFFBQVEsRUFBRSxJQUFJO1lBQ2Qs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QzdCLE9BQU8sUUFBUSxDQUFDO2FBQ25CO2lCQUFNO2dCQUNILElBQUksVUFBVSxHQUFRO29CQUNsQixTQUFTO29CQUNULFFBQVE7b0JBQ1IsTUFBTTtvQkFDTixRQUFRO29CQUNSLE1BQU07b0JBQ04sTUFBTTtvQkFDTixNQUFNO29CQUNOLFFBQVE7b0JBQ1IsVUFBVTtvQkFDVixXQUFXO29CQUNYLFdBQVc7b0JBQ1gsT0FBTztvQkFDUCxNQUFNO29CQUNOLE9BQU87b0JBQ1AsVUFBVTtvQkFDVixPQUFPO29CQUNQLFNBQVM7b0JBQ1QsU0FBUztvQkFDVCxPQUFPO2lCQUNWLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO2dCQUNmLFVBQVUsR0FBRyxJQUFJLE1BQU0sQ0FBQyxLQUFLLEdBQUcsVUFBVSxHQUFHLEdBQUcsQ0FBQyxDQUFDO2dCQUNsRCxJQUFJLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFO29CQUNoQyxPQUFPLFFBQVEsQ0FBQztpQkFDbkI7YUFDSjtRQUNMLENBQUMsQ0FBQyxDQUFDO0lBQ1gsQ0FBQztJQUVELFFBQVE7UUFDSixNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsd0JBQXdCLENBQUMsZUFBZSxFQUFFLENBQUM7UUFDckUsSUFBSSxZQUFZLEVBQUU7WUFDZCxJQUFJLENBQUMsaUJBQWlCLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQztZQUN0QyxJQUFJLENBQUMsaUJBQWlCLENBQUMsYUFBYSxHQUFHLFlBQVksQ0FBQztTQUN2RDtRQUNELElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztJQUN6QixDQUFDOzs7WUE5UUosU0FBUyxTQUFDO2dCQUNQLFFBQVEsRUFBRSxxQkFBcUI7YUFDbEM7OztZQVBtQixVQUFVO1lBQ3JCLHdCQUF3Qjs7O2dDQXNENUIsS0FBSzt5Q0FRTCxLQUFLIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGlyZWN0aXZlLCBFbGVtZW50UmVmLCBPbkluaXQsIElucHV0LCBPdXRwdXQsIEV2ZW50RW1pdHRlciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgVGh5TWFya2Rvd25QYXJzZXJTZXJ2aWNlIH0gZnJvbSAnLi90aHktbWFya2Rvd24tcGFyc2VyLnNlcnZpY2UnO1xuaW1wb3J0IHsgJCwgbGl0ZU1hcmtlZCwgbWVybWFpZCwga2F0ZXggfSBmcm9tICduZ3gtdGV0aHlzL3R5cGVzJztcbmltcG9ydCB7IGNvZXJjZUJvb2xlYW5Qcm9wZXJ0eSB9IGZyb20gJ25neC10ZXRoeXMvdXRpbCc7XG5cbkBEaXJlY3RpdmUoe1xuICAgIHNlbGVjdG9yOiAnW3RoeU1hcmtkb3duUGFyc2VyXSdcbn0pXG5leHBvcnQgY2xhc3MgVGh5TWFya2Rvd25QYXJzZXJEaXJlY3RpdmUgaW1wbGVtZW50cyBPbkluaXQge1xuICAgIHB1YmxpYyB2YWx1ZTogc3RyaW5nO1xuXG4gICAgcHJpdmF0ZSBieXBhc3NTZWN1cml0eVRydXN0SHRtbCA9IGZhbHNlO1xuXG4gICAgcHJpdmF0ZSBsaXRlTWFya2VkT3B0aW9uczogYW55ID0ge1xuICAgICAgICBnZm06IHRydWUsXG4gICAgICAgIHRhYmxlczogdHJ1ZSxcbiAgICAgICAgYnJlYWtzOiB0cnVlLFxuICAgICAgICBwZWRhbnRpYzogZmFsc2UsXG4gICAgICAgIHNhbml0aXplOiBmYWxzZSxcbiAgICAgICAgc21hcnRMaXN0czogdHJ1ZSxcbiAgICAgICAgc21hcnR5cGFudHM6IHRydWUsXG4gICAgICAgIGhlYWRpbmc6IHRydWUsXG4gICAgICAgIGxpbms6IHRydWUsXG4gICAgICAgIGxpc3Q6IHRydWUsXG4gICAgICAgIHd0bGluazogdHJ1ZSxcbiAgICAgICAgd3RoZXhjb2xvcjogdHJ1ZSxcbiAgICAgICAgd3RoZXhjb2xvclJlbmRlcjoge1xuICAgICAgICAgICAgY2xhc3NOYW1lOiAnbXNnLWlubGluZS1jb2xvcidcbiAgICAgICAgfSxcbiAgICAgICAgd3RhdDogZmFsc2UsXG4gICAgICAgIHd0aGFzaDogZmFsc2UsXG4gICAgICAgIHd0ZW50aXR5OiB0cnVlLFxuICAgICAgICB3dGVudGl0eVJlbmRlcjoge1xuICAgICAgICAgICAgY2xhc3NOYW1lOiAnc2xpZGUtdHJpZ2dlcidcbiAgICAgICAgfSxcbiAgICAgICAgd3RoYXNoUmVuZGVyOiB7XG4gICAgICAgICAgICBjaGxQcmVmaXg6ICcvbWVzc2FnZXMvZ3JvdXBzLydcbiAgICAgICAgfSxcbiAgICAgICAgd3RleGNsYW1hdGlvbjogdHJ1ZSxcbiAgICAgICAgd3RlbW9qaTogZmFsc2UsXG4gICAgICAgIGlzUGFyYWdyYXBoRGVmYXVsdDogdHJ1ZSxcbiAgICAgICAgaXNJbWFnZURlZmF1bHQ6IHRydWUsXG4gICAgICAgIGlzQmxvY2txdW90ZURlZmF1bHQ6IHRydWUsXG4gICAgICAgIGlzSHJEZWZhdWx0OiB0cnVlLFxuICAgICAgICBpc1N0cm9uZ0RlZmF1bHQ6IHRydWUsXG4gICAgICAgIGlzRW1EZWZhdWx0OiB0cnVlLFxuICAgICAgICBpc0NvZGVzcGFuRGVmYXVsdDogdHJ1ZSxcbiAgICAgICAgaXNDb2RlRGVmYXVsdDogdHJ1ZSxcbiAgICAgICAgaXNEZWxEZWZhdWx0OiB0cnVlLFxuICAgICAgICBpc0h0bWxEZWZhdWx0OiB0cnVlLFxuICAgICAgICBpc1RleHRFc2NhcGU6IHRydWUsXG4gICAgICAgIGlzRGVmOiB0cnVlLFxuICAgICAgICBpc0ltZ1ByZXZpZXc6IHRydWVcbiAgICB9O1xuXG4gICAgQElucHV0KClcbiAgICBzZXQgdGh5TWFya2Rvd25QYXJzZXIodmFsdWU6IHN0cmluZykge1xuICAgICAgICBpZiAodmFsdWUpIHtcbiAgICAgICAgICAgIHRoaXMudmFsdWUgPSB2YWx1ZTtcbiAgICAgICAgICAgIHRoaXMudHJhbnNsYXRlSFRNTCgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgQElucHV0KCkgc2V0IHRoeUJ5cGFzc1NlY3VyaXR5VHJ1c3RIdG1sKHZhbHVlOiBib29sZWFuKSB7XG4gICAgICAgIHRoaXMuYnlwYXNzU2VjdXJpdHlUcnVzdEh0bWwgPSBjb2VyY2VCb29sZWFuUHJvcGVydHkodmFsdWUpO1xuICAgIH1cblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgZWxlbWVudFJlZjogRWxlbWVudFJlZiwgcHJpdmF0ZSB0aHlNYXJrZG93blBhcnNlclNlcnZpY2U6IFRoeU1hcmtkb3duUGFyc2VyU2VydmljZSkge31cblxuICAgIGluaXRHYW50dCgpIHtcbiAgICAgICAgaWYgKG1lcm1haWQpIHtcbiAgICAgICAgICAgIG1lcm1haWQucGFyc2VFcnJvciA9IGZ1bmN0aW9uKGVycjogYW55LCBoYXNoOiBhbnkpIHtcbiAgICAgICAgICAgICAgICBtZXJtYWlkLmVycm9yID0gZXJyO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIG1lcm1haWQuZ2FudHRDb25maWcgPSB7XG4gICAgICAgICAgICAgICAgLy8gQ29uZmlndXJhdGlvbiBmb3IgR2FudHQgZGlhZ3JhbXNcbiAgICAgICAgICAgICAgICBudW1iZXJTZWN0aW9uU3R5bGVzOiA0LFxuICAgICAgICAgICAgICAgIGF4aXNGb3JtYXR0ZXI6IFtcbiAgICAgICAgICAgICAgICAgICAgW1xuICAgICAgICAgICAgICAgICAgICAgICAgJyVJOiVNJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uKGQ6IGFueSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFdpdGhpbiBhIGRheVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBkLmdldEhvdXJzKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICAgICAgICAgIFtcbiAgICAgICAgICAgICAgICAgICAgICAgICd3LiAlVScsXG4gICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbihkOiBhbnkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBNb25kYXkgYSB3ZWVrXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGQuZ2V0RGF5KCkgPT09IDE7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICAgICAgICAgIFtcbiAgICAgICAgICAgICAgICAgICAgICAgICclYSAlZCcsXG4gICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbihkOiBhbnkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBEYXkgd2l0aGluIGEgd2VlayAobm90IG1vbmRheSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZC5nZXREYXkoKSAmJiBkLmdldERhdGUoKSAhPT0gMTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgXSxcbiAgICAgICAgICAgICAgICAgICAgW1xuICAgICAgICAgICAgICAgICAgICAgICAgJyViICVkJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uKGQ6IGFueSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdpdGhpbiBhIG1vbnRoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGQuZ2V0RGF0ZSgpICE9PSAxO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgICAgICAgICBbXG4gICAgICAgICAgICAgICAgICAgICAgICAnJW0tJXknLFxuICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24oZDogYW55KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gTW9udGhcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZC5nZXRNb250aCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBdXG4gICAgICAgICAgICAgICAgXVxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGluaXRNYXJrZWQoKSB7XG4gICAgICAgIC8vIOiuvue9rm1hcmtlZFxuICAgICAgICBjb25zdCByZW5kZXJlciA9IG5ldyBsaXRlTWFya2VkLlJlbmRlcmVyKCk7XG4gICAgICAgIHJlbmRlcmVyLmxpc3RpdGVtID0gZnVuY3Rpb24odGV4dDogc3RyaW5nKSB7XG4gICAgICAgICAgICBpZiAoIS9eXFxbWyB4XVxcXVxccy8udGVzdCh0ZXh0KSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBsaXRlTWFya2VkLlJlbmRlcmVyLnByb3RvdHlwZS5saXN0aXRlbSh0ZXh0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIOS7u+WKoeWIl+ihqFxuICAgICAgICAgICAgY29uc3QgY2hlY2tib3ggPSAkKCc8aW5wdXQgdHlwZT1cImNoZWNrYm94XCIgZGlzYWJsZWQvPicpO1xuICAgICAgICAgICAgaWYgKC9eXFxbeFxcXVxccy8udGVzdCh0ZXh0KSkge1xuICAgICAgICAgICAgICAgIC8vIOWujOaIkOeahOS7u+WKoeWIl+ihqFxuICAgICAgICAgICAgICAgIGNoZWNrYm94LmF0dHIoJ2NoZWNrZWQnLCB0cnVlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiAkKGxpdGVNYXJrZWQuUmVuZGVyZXIucHJvdG90eXBlLmxpc3RpdGVtKHRleHQuc3Vic3RyaW5nKDMpKSlcbiAgICAgICAgICAgICAgICAuYWRkQ2xhc3MoJ3Rhc2stbGlzdC1pdGVtJylcbiAgICAgICAgICAgICAgICAucHJlcGVuZChjaGVja2JveClbMF0ub3V0ZXJIVE1MO1xuICAgICAgICB9O1xuICAgICAgICByZW5kZXJlci5jb2Rlc3BhbiA9IGZ1bmN0aW9uKHRleHQ6IHN0cmluZykge1xuICAgICAgICAgICAgLy8gaW5saW5lIGNvZGVcbiAgICAgICAgICAgIGlmICgvXlxcJC4rXFwkJC8udGVzdCh0ZXh0KSkge1xuICAgICAgICAgICAgICAgIC8vIGlubGluZSBtYXRoXG4gICAgICAgICAgICAgICAgY29uc3QgcmF3ID0gL15cXCQoLispXFwkJC8uZXhlYyh0ZXh0KVsxXTtcbiAgICAgICAgICAgICAgICBjb25zdCBsaW5lID0gcmF3XG4gICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC8mbHQ7L2csICc8JylcbiAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoLyZndDsvZywgJz4nKVxuICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvJmFtcDsvZywgJyYnKVxuICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvJnF1b3Q7L2csICdcIicpXG4gICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC8mIzM5Oy9nLCBcIidcIik7IC8vIHVuZXNjYXBlIGh0bWwgY2hhcmFjdGVyc1xuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBrYXRleC5yZW5kZXJUb1N0cmluZyhsaW5lLCB7IGRpc3BsYXlNb2RlOiBmYWxzZSB9KTtcbiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICc8Y29kZT4nICsgZXJyICsgJzwvY29kZT4nO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBsaXRlTWFya2VkLlJlbmRlcmVyLnByb3RvdHlwZS5jb2Rlc3Bhbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpO1xuICAgICAgICB9O1xuICAgICAgICByZW5kZXJlci5jb2RlID0gZnVuY3Rpb24oY29kZTogYW55LCBsYW5ndWFnZTogYW55LCBlc2NhcGVkOiBhbnksIGxpbmVfbnVtYmVyOiBhbnkpIHtcbiAgICAgICAgICAgIGNvZGUgPSBjb2RlLnRyaW0oKTtcbiAgICAgICAgICAgIGNvbnN0IGZpcnN0TGluZSA9IGNvZGUuc3BsaXQoL1xcbi8pWzBdLnRyaW0oKTtcbiAgICAgICAgICAgIGlmIChsYW5ndWFnZSA9PT0gJ21hdGgnKSB7XG4gICAgICAgICAgICAgICAgLy8g5pWw5a2m5YWs5byPXG4gICAgICAgICAgICAgICAgbGV0IHRleCA9ICcnO1xuICAgICAgICAgICAgICAgIGNvZGUuc3BsaXQoL1xcblxcbi8pLmZvckVhY2goZnVuY3Rpb24obGluZTogYW55KSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIOi/nue7reS4pOS4quaNouihjO+8jOWImeW8gOWni+S4i+S4gOS4quWFrOW8j1xuICAgICAgICAgICAgICAgICAgICBsaW5lID0gbGluZS50cmltKCk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChsaW5lLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGV4ICs9IGthdGV4LnJlbmRlclRvU3RyaW5nKGxpbmUsIHsgZGlzcGxheU1vZGU6IHRydWUgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXggKz0gJzxwcmU+JyArIGVyciArICc8L3ByZT4nO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuICc8ZGl2IGRhdGEtbGluZT1cIicgKyBsaW5lX251bWJlciArICdcIj4nICsgdGV4ICsgJzwvZGl2Pic7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGZpcnN0TGluZSA9PT0gJ2dhbnR0JyB8fCBmaXJzdExpbmUgPT09ICdzZXF1ZW5jZURpYWdyYW0nIHx8IGZpcnN0TGluZS5tYXRjaCgvXmdyYXBoICg/OlRCfEJUfFJMfExSfFREKTs/JC8pKSB7XG4gICAgICAgICAgICAgICAgLy8gbWVybWFpZFxuICAgICAgICAgICAgICAgIGlmIChmaXJzdExpbmUgPT09ICdzZXF1ZW5jZURpYWdyYW0nKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvZGUgKz0gJ1xcbic7IC8vIOWmguaenOacq+WwvuayoeacieepuuihjO+8jOWImeivreazlemUmeivr1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAobWVybWFpZCAmJiBtZXJtYWlkLnBhcnNlKGNvZGUpKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiAnPGRpdiBjbGFzcz1cIm1lcm1haWRcIiBkYXRhLWxpbmU9XCInICsgbGluZV9udW1iZXIgKyAnXCI+JyArIGNvZGUgKyAnPC9kaXY+JztcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpZiAobWVybWFpZCAmJiBtZXJtYWlkLmVycm9yKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJzxwcmUgZGF0YS1saW5lPVwiJyArIGxpbmVfbnVtYmVyICsgJ1wiPicgKyBtZXJtYWlkLmVycm9yICsgJzwvcHJlPic7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiBsaXRlTWFya2VkLlJlbmRlcmVyLnByb3RvdHlwZS5jb2RlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIHJlbmRlcmVyLmh0bWwgPSBmdW5jdGlvbihodG1sOiBzdHJpbmcpIHtcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGxpdGVNYXJrZWQuUmVuZGVyZXIucHJvdG90eXBlLmh0bWwuYXBwbHkodGhpcywgYXJndW1lbnRzKTtcbiAgICAgICAgICAgIGNvbnN0IGggPSAkKHJlc3VsdC5ib2xkKCkpO1xuICAgICAgICAgICAgcmV0dXJuIGguaHRtbCgpO1xuICAgICAgICB9O1xuICAgICAgICByZW5kZXJlci5wYXJhZ3JhcGggPSBmdW5jdGlvbih0ZXh0OiBzdHJpbmcpIHtcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGxpdGVNYXJrZWQuUmVuZGVyZXIucHJvdG90eXBlLnBhcmFncmFwaC5hcHBseSh0aGlzLCBhcmd1bWVudHMpO1xuICAgICAgICAgICAgY29uc3QgaCA9ICQocmVzdWx0LmJvbGQoKSk7XG4gICAgICAgICAgICByZXR1cm4gaC5odG1sKCk7XG4gICAgICAgIH07XG4gICAgICAgIGxpdGVNYXJrZWQuc2V0T3B0aW9ucyh0aGlzLmxpdGVNYXJrZWRPcHRpb25zKTtcbiAgICB9XG5cbiAgICBpbml0Q29tcG9uZW50KCkge1xuICAgICAgICAvLyDliJ3lp4vljJbnlJjnibnlm75cbiAgICAgICAgdGhpcy5pbml0R2FudHQoKTtcbiAgICAgICAgLy8g5Yid5aeL6Kej5p6Q5ZmoXG4gICAgICAgIHRoaXMuaW5pdE1hcmtlZCgpO1xuICAgIH1cblxuICAgIHBhcnNlTWFya2VkKF92YWx1ZTogc3RyaW5nKSB7XG4gICAgICAgIGlmIChsaXRlTWFya2VkICYmIF92YWx1ZSkge1xuICAgICAgICAgICAgcmV0dXJuIGxpdGVNYXJrZWQoX3ZhbHVlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiBfdmFsdWU7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwYXJzZU1lcm1haWQoKSB7XG4gICAgICAgIGlmIChtZXJtYWlkKSB7XG4gICAgICAgICAgICBtZXJtYWlkLmluaXQoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHRyYW5zbGF0ZUhUTUwoKSB7XG4gICAgICAgIHRoaXMuaW5pdENvbXBvbmVudCgpO1xuICAgICAgICBsZXQgX3ZhbHVlID0gdGhpcy50aHlNYXJrZG93blBhcnNlclNlcnZpY2UuZmlsdGVySFRNTCh0aGlzLnZhbHVlKTtcbiAgICAgICAgX3ZhbHVlID0gdGhpcy5wYXJzZU1hcmtlZChfdmFsdWUpO1xuICAgICAgICBpZiAoIXRoaXMuYnlwYXNzU2VjdXJpdHlUcnVzdEh0bWwpIHtcbiAgICAgICAgICAgIF92YWx1ZSA9IHRoaXMudGh5TWFya2Rvd25QYXJzZXJTZXJ2aWNlLnNhbml0aXplSFRNTChfdmFsdWUpO1xuICAgICAgICB9XG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5wYXJzZU1lcm1haWQoKTtcbiAgICAgICAgfSwgMTAwKTtcbiAgICAgICAgdGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQuaW5uZXJIVE1MID0gX3ZhbHVlO1xuICAgICAgICAkKHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50KVxuICAgICAgICAgICAgLmZpbmQoJ2EnKVxuICAgICAgICAgICAgLmF0dHIoJ3RhcmdldCcsIGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLmhvc3QgIT09IGxvY2F0aW9uLmhvc3QpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICdfYmxhbmsnO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGxldCBvdXRlcl9wYXRoOiBhbnkgPSBbXG4gICAgICAgICAgICAgICAgICAgICAgICAnc2hhcmVkLycsXG4gICAgICAgICAgICAgICAgICAgICAgICAnc2hhcmUvJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICdjbHViJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICd2aWRlb3MnLFxuICAgICAgICAgICAgICAgICAgICAgICAgJ2Jsb2cnLFxuICAgICAgICAgICAgICAgICAgICAgICAgJ3BsYW4nLFxuICAgICAgICAgICAgICAgICAgICAgICAgJ3RvdXInLFxuICAgICAgICAgICAgICAgICAgICAgICAgJ21vYmlsZScsXG4gICAgICAgICAgICAgICAgICAgICAgICAnc2VjdXJpdHknLFxuICAgICAgICAgICAgICAgICAgICAgICAgJ3VzZXJ2b2ljZScsXG4gICAgICAgICAgICAgICAgICAgICAgICAnY3VzdG9tZXJzJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICdwcmVzcycsXG4gICAgICAgICAgICAgICAgICAgICAgICAnaGVscCcsXG4gICAgICAgICAgICAgICAgICAgICAgICAnZ3VpZGUnLFxuICAgICAgICAgICAgICAgICAgICAgICAgJ2ZlZWRiYWNrJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICdhYm91dCcsXG4gICAgICAgICAgICAgICAgICAgICAgICAnY29udGFjdCcsXG4gICAgICAgICAgICAgICAgICAgICAgICAncHJpdmFjeScsXG4gICAgICAgICAgICAgICAgICAgICAgICAndGVybXMnXG4gICAgICAgICAgICAgICAgICAgIF0uam9pbignKXwoLycpO1xuICAgICAgICAgICAgICAgICAgICBvdXRlcl9wYXRoID0gbmV3IFJlZ0V4cCgnXigvJyArIG91dGVyX3BhdGggKyAnKScpO1xuICAgICAgICAgICAgICAgICAgICBpZiAob3V0ZXJfcGF0aC50ZXN0KHRoaXMucGF0aG5hbWUpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ19ibGFuayc7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBuZ09uSW5pdCgpIHtcbiAgICAgICAgY29uc3QgZW1vamlzUmVuZGVyID0gdGhpcy50aHlNYXJrZG93blBhcnNlclNlcnZpY2UuZ2V0RW1vamlzUmVuZGVyKCk7XG4gICAgICAgIGlmIChlbW9qaXNSZW5kZXIpIHtcbiAgICAgICAgICAgIHRoaXMubGl0ZU1hcmtlZE9wdGlvbnMud3RlbW9qaSA9IHRydWU7XG4gICAgICAgICAgICB0aGlzLmxpdGVNYXJrZWRPcHRpb25zLnd0ZW1vamlSZW5kZXIgPSBlbW9qaXNSZW5kZXI7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy50cmFuc2xhdGVIVE1MKCk7XG4gICAgfVxufVxuIl19