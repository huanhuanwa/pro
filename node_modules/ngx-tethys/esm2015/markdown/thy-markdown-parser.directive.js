import { Directive, ElementRef, Input } from '@angular/core';
import { ThyMarkdownParserService } from './thy-markdown-parser.service';
import { $, liteMarked, mermaid, katex } from 'ngx-tethys/types';
import { coerceBooleanProperty } from 'ngx-tethys/util';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from './thy-markdown-parser.service';
export class ThyMarkdownParserDirective {
    constructor(elementRef, thyMarkdownParserService) {
        this.elementRef = elementRef;
        this.thyMarkdownParserService = thyMarkdownParserService;
        this.bypassSecurityTrustHtml = false;
        this.liteMarkedOptions = {
            gfm: true,
            tables: true,
            breaks: true,
            pedantic: false,
            sanitize: false,
            smartLists: true,
            smartypants: true,
            heading: true,
            link: true,
            list: true,
            wtlink: true,
            wthexcolor: true,
            wthexcolorRender: {
                className: 'msg-inline-color'
            },
            wtat: false,
            wthash: false,
            wtentity: true,
            wtentityRender: {
                className: 'slide-trigger'
            },
            wthashRender: {
                chlPrefix: '/messages/groups/'
            },
            wtexclamation: true,
            wtemoji: false,
            isParagraphDefault: true,
            isImageDefault: true,
            isBlockquoteDefault: true,
            isHrDefault: true,
            isStrongDefault: true,
            isEmDefault: true,
            isCodespanDefault: true,
            isCodeDefault: true,
            isDelDefault: true,
            isHtmlDefault: true,
            isTextEscape: true,
            isDef: true,
            isImgPreview: true
        };
    }
    set thyMarkdownParser(value) {
        if (value) {
            this.value = value;
            this.translateHTML();
        }
    }
    set thyBypassSecurityTrustHtml(value) {
        this.bypassSecurityTrustHtml = coerceBooleanProperty(value);
    }
    initGantt() {
        if (mermaid) {
            mermaid.parseError = function (err, hash) {
                mermaid.error = err;
            };
            mermaid.ganttConfig = {
                // Configuration for Gantt diagrams
                numberSectionStyles: 4,
                axisFormatter: [
                    [
                        '%I:%M',
                        function (d) {
                            // Within a day
                            return d.getHours();
                        }
                    ],
                    [
                        'w. %U',
                        function (d) {
                            // Monday a week
                            return d.getDay() === 1;
                        }
                    ],
                    [
                        '%a %d',
                        function (d) {
                            // Day within a week (not monday)
                            return d.getDay() && d.getDate() !== 1;
                        }
                    ],
                    [
                        '%b %d',
                        function (d) {
                            // within a month
                            return d.getDate() !== 1;
                        }
                    ],
                    [
                        '%m-%y',
                        function (d) {
                            // Month
                            return d.getMonth();
                        }
                    ]
                ]
            };
        }
    }
    initMarked() {
        // 设置marked
        const renderer = new liteMarked.Renderer();
        renderer.listitem = function (text) {
            if (!/^\[[ x]\]\s/.test(text)) {
                return liteMarked.Renderer.prototype.listitem(text);
            }
            // 任务列表
            const checkbox = $('<input type="checkbox" disabled/>');
            if (/^\[x\]\s/.test(text)) {
                // 完成的任务列表
                checkbox.attr('checked', true);
            }
            return $(liteMarked.Renderer.prototype.listitem(text.substring(3)))
                .addClass('task-list-item')
                .prepend(checkbox)[0].outerHTML;
        };
        renderer.codespan = function (text) {
            // inline code
            if (/^\$.+\$$/.test(text)) {
                // inline math
                const raw = /^\$(.+)\$$/.exec(text)[1];
                const line = raw
                    .replace(/&lt;/g, '<')
                    .replace(/&gt;/g, '>')
                    .replace(/&amp;/g, '&')
                    .replace(/&quot;/g, '"')
                    .replace(/&#39;/g, "'"); // unescape html characters
                try {
                    return katex.renderToString(line, { displayMode: false });
                }
                catch (err) {
                    return '<code>' + err + '</code>';
                }
            }
            return liteMarked.Renderer.prototype.codespan.apply(this, arguments);
        };
        renderer.code = function (code, language, escaped, line_number) {
            code = code.trim();
            const firstLine = code.split(/\n/)[0].trim();
            if (language === 'math') {
                // 数学公式
                let tex = '';
                code.split(/\n\n/).forEach(function (line) {
                    // 连续两个换行，则开始下一个公式
                    line = line.trim();
                    if (line.length > 0) {
                        try {
                            tex += katex.renderToString(line, { displayMode: true });
                        }
                        catch (err) {
                            tex += '<pre>' + err + '</pre>';
                        }
                    }
                });
                return '<div data-line="' + line_number + '">' + tex + '</div>';
            }
            else if (firstLine === 'gantt' || firstLine === 'sequenceDiagram' || firstLine.match(/^graph (?:TB|BT|RL|LR|TD);?$/)) {
                // mermaid
                if (firstLine === 'sequenceDiagram') {
                    code += '\n'; // 如果末尾没有空行，则语法错误
                }
                if (mermaid && mermaid.parse(code)) {
                    return '<div class="mermaid" data-line="' + line_number + '">' + code + '</div>';
                }
                else {
                    if (mermaid && mermaid.error) {
                        return '<pre data-line="' + line_number + '">' + mermaid.error + '</pre>';
                    }
                }
            }
            else {
                return liteMarked.Renderer.prototype.code.apply(this, arguments);
            }
        };
        renderer.html = function (html) {
            const result = liteMarked.Renderer.prototype.html.apply(this, arguments);
            const h = $(result.bold());
            return h.html();
        };
        renderer.paragraph = function (text) {
            const result = liteMarked.Renderer.prototype.paragraph.apply(this, arguments);
            const h = $(result.bold());
            return h.html();
        };
        liteMarked.setOptions(this.liteMarkedOptions);
    }
    initComponent() {
        // 初始化甘特图
        this.initGantt();
        // 初始解析器
        this.initMarked();
    }
    parseMarked(_value) {
        if (liteMarked && _value) {
            return liteMarked(_value);
        }
        else {
            return _value;
        }
    }
    parseMermaid() {
        if (mermaid) {
            mermaid.init();
        }
    }
    translateHTML() {
        this.initComponent();
        let _value = this.thyMarkdownParserService.filterHTML(this.value);
        _value = this.parseMarked(_value);
        if (!this.bypassSecurityTrustHtml) {
            _value = this.thyMarkdownParserService.sanitizeHTML(_value);
        }
        setTimeout(() => {
            this.parseMermaid();
        }, 100);
        this.elementRef.nativeElement.innerHTML = _value;
        $(this.elementRef.nativeElement)
            .find('a')
            .attr('target', function () {
            if (this.host !== location.host) {
                return '_blank';
            }
            else {
                let outer_path = [
                    'shared/',
                    'share/',
                    'club',
                    'videos',
                    'blog',
                    'plan',
                    'tour',
                    'mobile',
                    'security',
                    'uservoice',
                    'customers',
                    'press',
                    'help',
                    'guide',
                    'feedback',
                    'about',
                    'contact',
                    'privacy',
                    'terms'
                ].join(')|(/');
                outer_path = new RegExp('^(/' + outer_path + ')');
                if (outer_path.test(this.pathname)) {
                    return '_blank';
                }
            }
        });
    }
    ngOnInit() {
        const emojisRender = this.thyMarkdownParserService.getEmojisRender();
        if (emojisRender) {
            this.liteMarkedOptions.wtemoji = true;
            this.liteMarkedOptions.wtemojiRender = emojisRender;
        }
        this.translateHTML();
    }
}
ThyMarkdownParserDirective.ɵfac = function ThyMarkdownParserDirective_Factory(t) { return new (t || ThyMarkdownParserDirective)(ɵngcc0.ɵɵdirectiveInject(ɵngcc0.ElementRef), ɵngcc0.ɵɵdirectiveInject(ɵngcc1.ThyMarkdownParserService)); };
ThyMarkdownParserDirective.ɵdir = ɵngcc0.ɵɵdefineDirective({ type: ThyMarkdownParserDirective, selectors: [["", "thyMarkdownParser", ""]], inputs: { thyMarkdownParser: "thyMarkdownParser", thyBypassSecurityTrustHtml: "thyBypassSecurityTrustHtml" } });
ThyMarkdownParserDirective.ctorParameters = () => [
    { type: ElementRef },
    { type: ThyMarkdownParserService }
];
ThyMarkdownParserDirective.propDecorators = {
    thyMarkdownParser: [{ type: Input }],
    thyBypassSecurityTrustHtml: [{ type: Input }]
};
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(ThyMarkdownParserDirective, [{
        type: Directive,
        args: [{
                selector: '[thyMarkdownParser]'
            }]
    }], function () { return [{ type: ɵngcc0.ElementRef }, { type: ɵngcc1.ThyMarkdownParserService }]; }, { thyMarkdownParser: [{
            type: Input
        }], thyBypassSecurityTrustHtml: [{
            type: Input
        }] }); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGh5LW1hcmtkb3duLXBhcnNlci5kaXJlY3RpdmUuanMiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9tYXJrZG93bi90aHktbWFya2Rvd24tcGFyc2VyLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBVSxLQUFLLEVBQXdCLE1BQU0sZUFBZSxDQUFDO0FBQzNGLE9BQU8sRUFBRSx3QkFBd0IsRUFBRSxNQUFNLCtCQUErQixDQUFDO0FBQ3pFLE9BQU8sRUFBRSxDQUFDLEVBQUUsVUFBVSxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUNqRSxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQzs7O0FBS3hELE1BQU0sT0FBTywwQkFBMEI7QUFBRyxJQTJEdEMsWUFBb0IsVUFBc0IsRUFBVSx3QkFBa0Q7QUFBSSxRQUF0RixlQUFVLEdBQVYsVUFBVSxDQUFZO0FBQUMsUUFBUyw2QkFBd0IsR0FBeEIsd0JBQXdCLENBQTBCO0FBQUMsUUF4RC9GLDRCQUF1QixHQUFHLEtBQUssQ0FBQztBQUM1QyxRQUNZLHNCQUFpQixHQUFRO0FBQ3JDLFlBQVEsR0FBRyxFQUFFLElBQUk7QUFDakIsWUFBUSxNQUFNLEVBQUUsSUFBSTtBQUNwQixZQUFRLE1BQU0sRUFBRSxJQUFJO0FBQ3BCLFlBQVEsUUFBUSxFQUFFLEtBQUs7QUFDdkIsWUFBUSxRQUFRLEVBQUUsS0FBSztBQUN2QixZQUFRLFVBQVUsRUFBRSxJQUFJO0FBQ3hCLFlBQVEsV0FBVyxFQUFFLElBQUk7QUFDekIsWUFBUSxPQUFPLEVBQUUsSUFBSTtBQUNyQixZQUFRLElBQUksRUFBRSxJQUFJO0FBQ2xCLFlBQVEsSUFBSSxFQUFFLElBQUk7QUFDbEIsWUFBUSxNQUFNLEVBQUUsSUFBSTtBQUNwQixZQUFRLFVBQVUsRUFBRSxJQUFJO0FBQ3hCLFlBQVEsZ0JBQWdCLEVBQUU7QUFDMUIsZ0JB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QUFDO0FBQ3RFLGdCQUFvQixJQUFJLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFO0FBQ3hELG9CQUF3QixPQUFPLFFBQVEsQ0FBQztBQUN4QyxpQkFBcUI7QUFDckIsYUFBaUI7QUFDakIsUUFBWSxDQUFDLENBQUMsQ0FBQztBQUNmLElBQUksQ0FBQztBQUNMLElBQ0ksUUFBUTtBQUNaLFFBQVEsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLHdCQUF3QixDQUFDLGVBQWUsRUFBRSxDQUFDO0FBQzdFLFFBQVEsSUFBSSxZQUFZLEVBQUU7QUFDMUIsWUFBWSxJQUFJLENBQUMsaUJBQWlCLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQztBQUNsRCxZQUFZLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxhQUFhLEdBQUcsWUFBWSxDQUFDO0FBQ2hFLFNBQVM7QUFDVCxRQUFRLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztBQUM3QixJQUFJLENBQUM7QUFDTDtzREEvUUMsU0FBUyxTQUFDLGtCQUNQLFFBQVEsRUFBRSxxQkFBcUIsY0FDbEM7MlBBQ0k7QUFBQztBQUFvRCxZQVJ0QyxVQUFVO0FBQUksWUFDekIsd0JBQXdCO0FBQUc7QUFBRztBQUM1QixnQ0FxRE4sS0FBSztBQUNSLHlDQU9HLEtBQUs7QUFBSTs7Ozs7Ozs7OztvQkFBRTtBQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGlyZWN0aXZlLCBFbGVtZW50UmVmLCBPbkluaXQsIElucHV0LCBPdXRwdXQsIEV2ZW50RW1pdHRlciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgVGh5TWFya2Rvd25QYXJzZXJTZXJ2aWNlIH0gZnJvbSAnLi90aHktbWFya2Rvd24tcGFyc2VyLnNlcnZpY2UnO1xuaW1wb3J0IHsgJCwgbGl0ZU1hcmtlZCwgbWVybWFpZCwga2F0ZXggfSBmcm9tICduZ3gtdGV0aHlzL3R5cGVzJztcbmltcG9ydCB7IGNvZXJjZUJvb2xlYW5Qcm9wZXJ0eSB9IGZyb20gJ25neC10ZXRoeXMvdXRpbCc7XG5cbkBEaXJlY3RpdmUoe1xuICAgIHNlbGVjdG9yOiAnW3RoeU1hcmtkb3duUGFyc2VyXSdcbn0pXG5leHBvcnQgY2xhc3MgVGh5TWFya2Rvd25QYXJzZXJEaXJlY3RpdmUgaW1wbGVtZW50cyBPbkluaXQge1xuICAgIHB1YmxpYyB2YWx1ZTogc3RyaW5nO1xuXG4gICAgcHJpdmF0ZSBieXBhc3NTZWN1cml0eVRydXN0SHRtbCA9IGZhbHNlO1xuXG4gICAgcHJpdmF0ZSBsaXRlTWFya2VkT3B0aW9uczogYW55ID0ge1xuICAgICAgICBnZm06IHRydWUsXG4gICAgICAgIHRhYmxlczogdHJ1ZSxcbiAgICAgICAgYnJlYWtzOiB0cnVlLFxuICAgICAgICBwZWRhbnRpYzogZmFsc2UsXG4gICAgICAgIHNhbml0aXplOiBmYWxzZSxcbiAgICAgICAgc21hcnRMaXN0czogdHJ1ZSxcbiAgICAgICAgc21hcnR5cGFudHM6IHRydWUsXG4gICAgICAgIGhlYWRpbmc6IHRydWUsXG4gICAgICAgIGxpbms6IHRydWUsXG4gICAgICAgIGxpc3Q6IHRydWUsXG4gICAgICAgIHd0bGluazogdHJ1ZSxcbiAgICAgICAgd3RoZXhjb2xvcjogdHJ1ZSxcbiAgICAgICAgd3RoZXhjb2xvclJlbmRlcjoge1xuICAgICAgICAgICAgY2xhc3NOYW1lOiAnbXNnLWlubGluZS1jb2xvcidcbiAgICAgICAgfSxcbiAgICAgICAgd3RhdDogZmFsc2UsXG4gICAgICAgIHd0aGFzaDogZmFsc2UsXG4gICAgICAgIHd0ZW50aXR5OiB0cnVlLFxuICAgICAgICB3dGVudGl0eVJlbmRlcjoge1xuICAgICAgICAgICAgY2xhc3NOYW1lOiAnc2xpZGUtdHJpZ2dlcidcbiAgICAgICAgfSxcbiAgICAgICAgd3RoYXNoUmVuZGVyOiB7XG4gICAgICAgICAgICBjaGxQcmVmaXg6ICcvbWVzc2FnZXMvZ3JvdXBzLydcbiAgICAgICAgfSxcbiAgICAgICAgd3RleGNsYW1hdGlvbjogdHJ1ZSxcbiAgICAgICAgd3RlbW9qaTogZmFsc2UsXG4gICAgICAgIGlzUGFyYWdyYXBoRGVmYXVsdDogdHJ1ZSxcbiAgICAgICAgaXNJbWFnZURlZmF1bHQ6IHRydWUsXG4gICAgICAgIGlzQmxvY2txdW90ZURlZmF1bHQ6IHRydWUsXG4gICAgICAgIGlzSHJEZWZhdWx0OiB0cnVlLFxuICAgICAgICBpc1N0cm9uZ0RlZmF1bHQ6IHRydWUsXG4gICAgICAgIGlzRW1EZWZhdWx0OiB0cnVlLFxuICAgICAgICBpc0NvZGVzcGFuRGVmYXVsdDogdHJ1ZSxcbiAgICAgICAgaXNDb2RlRGVmYXVsdDogdHJ1ZSxcbiAgICAgICAgaXNEZWxEZWZhdWx0OiB0cnVlLFxuICAgICAgICBpc0h0bWxEZWZhdWx0OiB0cnVlLFxuICAgICAgICBpc1RleHRFc2NhcGU6IHRydWUsXG4gICAgICAgIGlzRGVmOiB0cnVlLFxuICAgICAgICBpc0ltZ1ByZXZpZXc6IHRydWVcbiAgICB9O1xuXG4gICAgQElucHV0KClcbiAgICBzZXQgdGh5TWFya2Rvd25QYXJzZXIodmFsdWU6IHN0cmluZykge1xuICAgICAgICBpZiAodmFsdWUpIHtcbiAgICAgICAgICAgIHRoaXMudmFsdWUgPSB2YWx1ZTtcbiAgICAgICAgICAgIHRoaXMudHJhbnNsYXRlSFRNTCgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgQElucHV0KCkgc2V0IHRoeUJ5cGFzc1NlY3VyaXR5VHJ1c3RIdG1sKHZhbHVlOiBib29sZWFuKSB7XG4gICAgICAgIHRoaXMuYnlwYXNzU2VjdXJpdHlUcnVzdEh0bWwgPSBjb2VyY2VCb29sZWFuUHJvcGVydHkodmFsdWUpO1xuICAgIH1cblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgZWxlbWVudFJlZjogRWxlbWVudFJlZiwgcHJpdmF0ZSB0aHlNYXJrZG93blBhcnNlclNlcnZpY2U6IFRoeU1hcmtkb3duUGFyc2VyU2VydmljZSkge31cblxuICAgIGluaXRHYW50dCgpIHtcbiAgICAgICAgaWYgKG1lcm1haWQpIHtcbiAgICAgICAgICAgIG1lcm1haWQucGFyc2VFcnJvciA9IGZ1bmN0aW9uKGVycjogYW55LCBoYXNoOiBhbnkpIHtcbiAgICAgICAgICAgICAgICBtZXJtYWlkLmVycm9yID0gZXJyO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIG1lcm1haWQuZ2FudHRDb25maWcgPSB7XG4gICAgICAgICAgICAgICAgLy8gQ29uZmlndXJhdGlvbiBmb3IgR2FudHQgZGlhZ3JhbXNcbiAgICAgICAgICAgICAgICBudW1iZXJTZWN0aW9uU3R5bGVzOiA0LFxuICAgICAgICAgICAgICAgIGF4aXNGb3JtYXR0ZXI6IFtcbiAgICAgICAgICAgICAgICAgICAgW1xuICAgICAgICAgICAgICAgICAgICAgICAgJyVJOiVNJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uKGQ6IGFueSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFdpdGhpbiBhIGRheVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBkLmdldEhvdXJzKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICAgICAgICAgIFtcbiAgICAgICAgICAgICAgICAgICAgICAgICd3LiAlVScsXG4gICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbihkOiBhbnkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBNb25kYXkgYSB3ZWVrXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGQuZ2V0RGF5KCkgPT09IDE7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICAgICAgICAgIFtcbiAgICAgICAgICAgICAgICAgICAgICAgICclYSAlZCcsXG4gICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbihkOiBhbnkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBEYXkgd2l0aGluIGEgd2VlayAobm90IG1vbmRheSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZC5nZXREYXkoKSAmJiBkLmdldERhdGUoKSAhPT0gMTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgXSxcbiAgICAgICAgICAgICAgICAgICAgW1xuICAgICAgICAgICAgICAgICAgICAgICAgJyViICVkJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uKGQ6IGFueSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdpdGhpbiBhIG1vbnRoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGQuZ2V0RGF0ZSgpICE9PSAxO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgICAgICAgICBbXG4gICAgICAgICAgICAgICAgICAgICAgICAnJW0tJXknLFxuICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24oZDogYW55KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gTW9udGhcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZC5nZXRNb250aCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBdXG4gICAgICAgICAgICAgICAgXVxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGluaXRNYXJrZWQoKSB7XG4gICAgICAgIC8vIOiuvue9rm1hcmtlZFxuICAgICAgICBjb25zdCByZW5kZXJlciA9IG5ldyBsaXRlTWFya2VkLlJlbmRlcmVyKCk7XG4gICAgICAgIHJlbmRlcmVyLmxpc3RpdGVtID0gZnVuY3Rpb24odGV4dDogc3RyaW5nKSB7XG4gICAgICAgICAgICBpZiAoIS9eXFxbWyB4XVxcXVxccy8udGVzdCh0ZXh0KSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBsaXRlTWFya2VkLlJlbmRlcmVyLnByb3RvdHlwZS5saXN0aXRlbSh0ZXh0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIOS7u+WKoeWIl+ihqFxuICAgICAgICAgICAgY29uc3QgY2hlY2tib3ggPSAkKCc8aW5wdXQgdHlwZT1cImNoZWNrYm94XCIgZGlzYWJsZWQvPicpO1xuICAgICAgICAgICAgaWYgKC9eXFxbeFxcXVxccy8udGVzdCh0ZXh0KSkge1xuICAgICAgICAgICAgICAgIC8vIOWujOaIkOeahOS7u+WKoeWIl+ihqFxuICAgICAgICAgICAgICAgIGNoZWNrYm94LmF0dHIoJ2NoZWNrZWQnLCB0cnVlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiAkKGxpdGVNYXJrZWQuUmVuZGVyZXIucHJvdG90eXBlLmxpc3RpdGVtKHRleHQuc3Vic3RyaW5nKDMpKSlcbiAgICAgICAgICAgICAgICAuYWRkQ2xhc3MoJ3Rhc2stbGlzdC1pdGVtJylcbiAgICAgICAgICAgICAgICAucHJlcGVuZChjaGVja2JveClbMF0ub3V0ZXJIVE1MO1xuICAgICAgICB9O1xuICAgICAgICByZW5kZXJlci5jb2Rlc3BhbiA9IGZ1bmN0aW9uKHRleHQ6IHN0cmluZykge1xuICAgICAgICAgICAgLy8gaW5saW5lIGNvZGVcbiAgICAgICAgICAgIGlmICgvXlxcJC4rXFwkJC8udGVzdCh0ZXh0KSkge1xuICAgICAgICAgICAgICAgIC8vIGlubGluZSBtYXRoXG4gICAgICAgICAgICAgICAgY29uc3QgcmF3ID0gL15cXCQoLispXFwkJC8uZXhlYyh0ZXh0KVsxXTtcbiAgICAgICAgICAgICAgICBjb25zdCBsaW5lID0gcmF3XG4gICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC8mbHQ7L2csICc8JylcbiAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoLyZndDsvZywgJz4nKVxuICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvJmFtcDsvZywgJyYnKVxuICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvJnF1b3Q7L2csICdcIicpXG4gICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC8mIzM5Oy9nLCBcIidcIik7IC8vIHVuZXNjYXBlIGh0bWwgY2hhcmFjdGVyc1xuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBrYXRleC5yZW5kZXJUb1N0cmluZyhsaW5lLCB7IGRpc3BsYXlNb2RlOiBmYWxzZSB9KTtcbiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICc8Y29kZT4nICsgZXJyICsgJzwvY29kZT4nO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBsaXRlTWFya2VkLlJlbmRlcmVyLnByb3RvdHlwZS5jb2Rlc3Bhbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpO1xuICAgICAgICB9O1xuICAgICAgICByZW5kZXJlci5jb2RlID0gZnVuY3Rpb24oY29kZTogYW55LCBsYW5ndWFnZTogYW55LCBlc2NhcGVkOiBhbnksIGxpbmVfbnVtYmVyOiBhbnkpIHtcbiAgICAgICAgICAgIGNvZGUgPSBjb2RlLnRyaW0oKTtcbiAgICAgICAgICAgIGNvbnN0IGZpcnN0TGluZSA9IGNvZGUuc3BsaXQoL1xcbi8pWzBdLnRyaW0oKTtcbiAgICAgICAgICAgIGlmIChsYW5ndWFnZSA9PT0gJ21hdGgnKSB7XG4gICAgICAgICAgICAgICAgLy8g5pWw5a2m5YWs5byPXG4gICAgICAgICAgICAgICAgbGV0IHRleCA9ICcnO1xuICAgICAgICAgICAgICAgIGNvZGUuc3BsaXQoL1xcblxcbi8pLmZvckVhY2goZnVuY3Rpb24obGluZTogYW55KSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIOi/nue7reS4pOS4quaNouihjO+8jOWImeW8gOWni+S4i+S4gOS4quWFrOW8j1xuICAgICAgICAgICAgICAgICAgICBsaW5lID0gbGluZS50cmltKCk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChsaW5lLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGV4ICs9IGthdGV4LnJlbmRlclRvU3RyaW5nKGxpbmUsIHsgZGlzcGxheU1vZGU6IHRydWUgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXggKz0gJzxwcmU+JyArIGVyciArICc8L3ByZT4nO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuICc8ZGl2IGRhdGEtbGluZT1cIicgKyBsaW5lX251bWJlciArICdcIj4nICsgdGV4ICsgJzwvZGl2Pic7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGZpcnN0TGluZSA9PT0gJ2dhbnR0JyB8fCBmaXJzdExpbmUgPT09ICdzZXF1ZW5jZURpYWdyYW0nIHx8IGZpcnN0TGluZS5tYXRjaCgvXmdyYXBoICg/OlRCfEJUfFJMfExSfFREKTs/JC8pKSB7XG4gICAgICAgICAgICAgICAgLy8gbWVybWFpZFxuICAgICAgICAgICAgICAgIGlmIChmaXJzdExpbmUgPT09ICdzZXF1ZW5jZURpYWdyYW0nKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvZGUgKz0gJ1xcbic7IC8vIOWmguaenOacq+WwvuayoeacieepuuihjO+8jOWImeivreazlemUmeivr1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAobWVybWFpZCAmJiBtZXJtYWlkLnBhcnNlKGNvZGUpKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiAnPGRpdiBjbGFzcz1cIm1lcm1haWRcIiBkYXRhLWxpbmU9XCInICsgbGluZV9udW1iZXIgKyAnXCI+JyArIGNvZGUgKyAnPC9kaXY+JztcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpZiAobWVybWFpZCAmJiBtZXJtYWlkLmVycm9yKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJzxwcmUgZGF0YS1saW5lPVwiJyArIGxpbmVfbnVtYmVyICsgJ1wiPicgKyBtZXJtYWlkLmVycm9yICsgJzwvcHJlPic7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiBsaXRlTWFya2VkLlJlbmRlcmVyLnByb3RvdHlwZS5jb2RlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIHJlbmRlcmVyLmh0bWwgPSBmdW5jdGlvbihodG1sOiBzdHJpbmcpIHtcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGxpdGVNYXJrZWQuUmVuZGVyZXIucHJvdG90eXBlLmh0bWwuYXBwbHkodGhpcywgYXJndW1lbnRzKTtcbiAgICAgICAgICAgIGNvbnN0IGggPSAkKHJlc3VsdC5ib2xkKCkpO1xuICAgICAgICAgICAgcmV0dXJuIGguaHRtbCgpO1xuICAgICAgICB9O1xuICAgICAgICByZW5kZXJlci5wYXJhZ3JhcGggPSBmdW5jdGlvbih0ZXh0OiBzdHJpbmcpIHtcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGxpdGVNYXJrZWQuUmVuZGVyZXIucHJvdG90eXBlLnBhcmFncmFwaC5hcHBseSh0aGlzLCBhcmd1bWVudHMpO1xuICAgICAgICAgICAgY29uc3QgaCA9ICQocmVzdWx0LmJvbGQoKSk7XG4gICAgICAgICAgICByZXR1cm4gaC5odG1sKCk7XG4gICAgICAgIH07XG4gICAgICAgIGxpdGVNYXJrZWQuc2V0T3B0aW9ucyh0aGlzLmxpdGVNYXJrZWRPcHRpb25zKTtcbiAgICB9XG5cbiAgICBpbml0Q29tcG9uZW50KCkge1xuICAgICAgICAvLyDliJ3lp4vljJbnlJjnibnlm75cbiAgICAgICAgdGhpcy5pbml0R2FudHQoKTtcbiAgICAgICAgLy8g5Yid5aeL6Kej5p6Q5ZmoXG4gICAgICAgIHRoaXMuaW5pdE1hcmtlZCgpO1xuICAgIH1cblxuICAgIHBhcnNlTWFya2VkKF92YWx1ZTogc3RyaW5nKSB7XG4gICAgICAgIGlmIChsaXRlTWFya2VkICYmIF92YWx1ZSkge1xuICAgICAgICAgICAgcmV0dXJuIGxpdGVNYXJrZWQoX3ZhbHVlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiBfdmFsdWU7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwYXJzZU1lcm1haWQoKSB7XG4gICAgICAgIGlmIChtZXJtYWlkKSB7XG4gICAgICAgICAgICBtZXJtYWlkLmluaXQoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHRyYW5zbGF0ZUhUTUwoKSB7XG4gICAgICAgIHRoaXMuaW5pdENvbXBvbmVudCgpO1xuICAgICAgICBsZXQgX3ZhbHVlID0gdGhpcy50aHlNYXJrZG93blBhcnNlclNlcnZpY2UuZmlsdGVySFRNTCh0aGlzLnZhbHVlKTtcbiAgICAgICAgX3ZhbHVlID0gdGhpcy5wYXJzZU1hcmtlZChfdmFsdWUpO1xuICAgICAgICBpZiAoIXRoaXMuYnlwYXNzU2VjdXJpdHlUcnVzdEh0bWwpIHtcbiAgICAgICAgICAgIF92YWx1ZSA9IHRoaXMudGh5TWFya2Rvd25QYXJzZXJTZXJ2aWNlLnNhbml0aXplSFRNTChfdmFsdWUpO1xuICAgICAgICB9XG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5wYXJzZU1lcm1haWQoKTtcbiAgICAgICAgfSwgMTAwKTtcbiAgICAgICAgdGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQuaW5uZXJIVE1MID0gX3ZhbHVlO1xuICAgICAgICAkKHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50KVxuICAgICAgICAgICAgLmZpbmQoJ2EnKVxuICAgICAgICAgICAgLmF0dHIoJ3RhcmdldCcsIGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLmhvc3QgIT09IGxvY2F0aW9uLmhvc3QpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICdfYmxhbmsnO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGxldCBvdXRlcl9wYXRoOiBhbnkgPSBbXG4gICAgICAgICAgICAgICAgICAgICAgICAnc2hhcmVkLycsXG4gICAgICAgICAgICAgICAgICAgICAgICAnc2hhcmUvJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICdjbHViJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICd2aWRlb3MnLFxuICAgICAgICAgICAgICAgICAgICAgICAgJ2Jsb2cnLFxuICAgICAgICAgICAgICAgICAgICAgICAgJ3BsYW4nLFxuICAgICAgICAgICAgICAgICAgICAgICAgJ3RvdXInLFxuICAgICAgICAgICAgICAgICAgICAgICAgJ21vYmlsZScsXG4gICAgICAgICAgICAgICAgICAgICAgICAnc2VjdXJpdHknLFxuICAgICAgICAgICAgICAgICAgICAgICAgJ3VzZXJ2b2ljZScsXG4gICAgICAgICAgICAgICAgICAgICAgICAnY3VzdG9tZXJzJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICdwcmVzcycsXG4gICAgICAgICAgICAgICAgICAgICAgICAnaGVscCcsXG4gICAgICAgICAgICAgICAgICAgICAgICAnZ3VpZGUnLFxuICAgICAgICAgICAgICAgICAgICAgICAgJ2ZlZWRiYWNrJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICdhYm91dCcsXG4gICAgICAgICAgICAgICAgICAgICAgICAnY29udGFjdCcsXG4gICAgICAgICAgICAgICAgICAgICAgICAncHJpdmFjeScsXG4gICAgICAgICAgICAgICAgICAgICAgICAndGVybXMnXG4gICAgICAgICAgICAgICAgICAgIF0uam9pbignKXwoLycpO1xuICAgICAgICAgICAgICAgICAgICBvdXRlcl9wYXRoID0gbmV3IFJlZ0V4cCgnXigvJyArIG91dGVyX3BhdGggKyAnKScpO1xuICAgICAgICAgICAgICAgICAgICBpZiAob3V0ZXJfcGF0aC50ZXN0KHRoaXMucGF0aG5hbWUpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ19ibGFuayc7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBuZ09uSW5pdCgpIHtcbiAgICAgICAgY29uc3QgZW1vamlzUmVuZGVyID0gdGhpcy50aHlNYXJrZG93blBhcnNlclNlcnZpY2UuZ2V0RW1vamlzUmVuZGVyKCk7XG4gICAgICAgIGlmIChlbW9qaXNSZW5kZXIpIHtcbiAgICAgICAgICAgIHRoaXMubGl0ZU1hcmtlZE9wdGlvbnMud3RlbW9qaSA9IHRydWU7XG4gICAgICAgICAgICB0aGlzLmxpdGVNYXJrZWRPcHRpb25zLnd0ZW1vamlSZW5kZXIgPSBlbW9qaXNSZW5kZXI7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy50cmFuc2xhdGVIVE1MKCk7XG4gICAgfVxufVxuIl19