import { Component, forwardRef, Input, ChangeDetectorRef } from '@angular/core';
import { NG_VALUE_ACCESSOR } from '@angular/forms';
import { ThyPopover } from 'ngx-tethys/popover';
import { OptionalDateRangesComponent } from './optional-dates/optional-dates.component';
import { getUnixTime, startOfISOWeek, endOfISOWeek, endOfMonth, startOfMonth, addDays, addMonths, addYears } from 'date-fns';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from 'ngx-tethys/popover';
import * as ɵngcc2 from '@angular/common';
import * as ɵngcc3 from 'ngx-tethys/nav';
import * as ɵngcc4 from 'ngx-tethys/icon';
import * as ɵngcc5 from 'ngx-tethys/date-picker';

function ThyDateRangeComponent_ng_container_1_Template(rf, ctx) { if (rf & 1) {
    const _r7 = ɵngcc0.ɵɵgetCurrentView();
    ɵngcc0.ɵɵelementContainerStart(0);
    ɵngcc0.ɵɵelementStart(1, "thy-icon-nav", 4);
    ɵngcc0.ɵɵlistener("click", function ThyDateRangeComponent_ng_container_1_Template_thy_icon_nav_click_1_listener() { ɵngcc0.ɵɵrestoreView(_r7); const ctx_r6 = ɵngcc0.ɵɵnextContext(); return ctx_r6.previous(); });
    ɵngcc0.ɵɵelementStart(2, "a", 5);
    ɵngcc0.ɵɵelement(3, "thy-icon", 6);
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementContainerEnd();
} }
function ThyDateRangeComponent_ng_container_3_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementContainerStart(0);
    ɵngcc0.ɵɵtext(1);
    ɵngcc0.ɵɵpipe(2, "thyDatePickerFormat");
    ɵngcc0.ɵɵpipe(3, "thyDatePickerFormat");
    ɵngcc0.ɵɵelementContainerEnd();
} if (rf & 2) {
    const ctx_r1 = ɵngcc0.ɵɵnextContext();
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵtextInterpolate2(" ", ɵngcc0.ɵɵpipeBind1(2, 2, ctx_r1.selectedDate == null ? null : ctx_r1.selectedDate.begin), " ~ ", ɵngcc0.ɵɵpipeBind1(3, 4, ctx_r1.selectedDate == null ? null : ctx_r1.selectedDate.end), " ");
} }
function ThyDateRangeComponent_ng_container_4_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementContainerStart(0);
    ɵngcc0.ɵɵtext(1);
    ɵngcc0.ɵɵpipe(2, "thyDatePickerFormat");
    ɵngcc0.ɵɵelementContainerEnd();
} if (rf & 2) {
    const ctx_r2 = ɵngcc0.ɵɵnextContext();
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵtextInterpolate1(" ", ɵngcc0.ɵɵpipeBind2(2, 1, ctx_r2.selectedDate == null ? null : ctx_r2.selectedDate.begin, ctx_r2.thyPickerFormat), " ");
} }
function ThyDateRangeComponent_ng_container_5_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementContainerStart(0);
    ɵngcc0.ɵɵtext(1);
    ɵngcc0.ɵɵelementContainerEnd();
} if (rf & 2) {
    const ctx_r3 = ɵngcc0.ɵɵnextContext();
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵtextInterpolate(ctx_r3.selectedDate == null ? null : ctx_r3.selectedDate.text);
} }
function ThyDateRangeComponent_thy_icon_6_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelement(0, "thy-icon", 7);
} }
function ThyDateRangeComponent_ng_container_7_Template(rf, ctx) { if (rf & 1) {
    const _r9 = ɵngcc0.ɵɵgetCurrentView();
    ɵngcc0.ɵɵelementContainerStart(0);
    ɵngcc0.ɵɵelementStart(1, "thy-icon-nav", 4);
    ɵngcc0.ɵɵlistener("click", function ThyDateRangeComponent_ng_container_7_Template_thy_icon_nav_click_1_listener() { ɵngcc0.ɵɵrestoreView(_r9); const ctx_r8 = ɵngcc0.ɵɵnextContext(); return ctx_r8.next(); });
    ɵngcc0.ɵɵelementStart(2, "a", 5);
    ɵngcc0.ɵɵelement(3, "thy-icon", 8);
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementContainerEnd();
} }
const _c0 = function (a0) { return { "thy-date-range-disabled": a0 }; };
const allDayTimestamp = 24 * 60 * 60;
const INPUT_CONTROL_VALUE_ACCESSOR = {
    provide: NG_VALUE_ACCESSOR,
    useExisting: forwardRef(() => ThyDateRangeComponent),
    multi: true
};
export class ThyDateRangeComponent {
    constructor(thyPopover, cdr) {
        this.thyPopover = thyPopover;
        this.cdr = cdr;
        this.thyHiddenMenu = false;
        this.thyDisabledSwitch = false;
        this.thyCustomTextValue = '自定义';
        this.thyCustomKey = 'custom';
        this.optionalDateRanges = [
            {
                key: 'week',
                text: '本周',
                begin: getUnixTime(startOfISOWeek(new Date())),
                end: getUnixTime(endOfISOWeek(new Date())),
                timestamp: {
                    interval: 7,
                    unit: 'day'
                }
            },
            {
                key: 'month',
                text: '本月',
                begin: getUnixTime(startOfMonth(new Date())),
                end: getUnixTime(endOfMonth(new Date())),
                timestamp: {
                    interval: 1,
                    unit: 'month'
                }
            }
        ];
        this.onModelChange = () => { };
        this.onModelTouched = () => { };
    }
    set thyOptionalDateRanges(value) {
        this.optionalDateRanges = value.length > 0 ? value : this.optionalDateRanges;
    }
    writeValue(value) {
        if (value) {
            this.selectedDate = value;
        }
        else if (this.optionalDateRanges.length > 0) {
            this.selectedDate = this.optionalDateRanges[0];
            this.onModelChange(this.selectedDate);
        }
        this._setSelectedDateRange();
        this.cdr.detectChanges();
    }
    registerOnChange(fn) {
        this.onModelChange = fn;
    }
    registerOnTouched(fn) {
        this.onModelTouched = fn;
    }
    ngOnInit() { }
    _setSelectedDateRange() {
        this.selectedDateRange = {
            begin: this.selectedDate.begin,
            end: this.selectedDate.end
        };
    }
    _calculateNewTime(type) {
        if (this.selectedDate.timestamp) {
            const beginDate = new Date(this.selectedDate.begin * 1000);
            const endDate = new Date(this.selectedDate.end * 1000);
            const interval = this.selectedDate.timestamp.interval;
            if (this.selectedDate.timestamp.unit === 'day') {
                if (type === 'previous') {
                    return {
                        begin: getUnixTime(addDays(beginDate, -1 * interval)),
                        end: getUnixTime(addDays(endDate, -1 * interval)),
                        key: this.thyCustomKey
                    };
                }
                else {
                    return {
                        begin: getUnixTime(addDays(beginDate, 1 * interval)),
                        end: getUnixTime(addDays(endDate, 1 * interval)),
                        key: this.thyCustomKey
                    };
                }
            }
            else if (this.selectedDate.timestamp.unit === 'month') {
                if (type === 'previous') {
                    return {
                        begin: getUnixTime(addMonths(beginDate, -1 * interval)),
                        end: getUnixTime(addMonths(endDate, -1 * interval)),
                        key: this.thyCustomKey
                    };
                }
                else {
                    return {
                        begin: getUnixTime(addMonths(beginDate, 1 * interval)),
                        end: getUnixTime(addMonths(endDate, 1 * interval)),
                        key: this.thyCustomKey
                    };
                }
            }
            else if (this.selectedDate.timestamp.unit === 'year') {
                if (type === 'previous') {
                    return {
                        begin: getUnixTime(addYears(beginDate, -1 * interval)),
                        end: getUnixTime(addYears(endDate, -1 * interval)),
                        key: this.thyCustomKey
                    };
                }
                else {
                    return {
                        begin: getUnixTime(addYears(beginDate, 1 * interval)),
                        end: getUnixTime(addYears(endDate, 1 * interval)),
                        key: this.thyCustomKey
                    };
                }
            }
        }
        else {
            const interval = this.selectedDate.end - this.selectedDate.begin + allDayTimestamp;
            if (type === 'previous') {
                return {
                    begin: this.selectedDate.begin - interval,
                    end: this.selectedDate.end - interval,
                    key: this.thyCustomKey
                };
            }
            else {
                return {
                    begin: this.selectedDate.begin + interval,
                    end: this.selectedDate.end + interval,
                    key: this.thyCustomKey
                };
            }
        }
    }
    _setPreviousOrNextDate(type) {
        this.selectedDate = Object.assign({}, this.selectedDate, this._calculateNewTime(type));
        this._setSelectedDateRange();
        this.onModelChange(this.selectedDate);
    }
    previous() {
        this._setPreviousOrNextDate('previous');
    }
    next() {
        this._setPreviousOrNextDate('next');
    }
    openOptionalDateRangesMenu(event) {
        if (this.thyHiddenMenu) {
            return;
        }
        this.thyPopover.open(OptionalDateRangesComponent, {
            origin: event.currentTarget,
            hasBackdrop: true,
            backdropClass: 'thy-overlay-transparent-backdrop',
            offset: 0,
            manualClosure: true,
            originActiveClass: 'thy-date-range-text-active',
            initialState: {
                hiddenMenu: this.thyHiddenMenu,
                optionalDateRanges: this.optionalDateRanges,
                selectedDate: this.selectedDate,
                minDate: this.thyMinDate,
                maxDate: this.thyMaxDate,
                customValue: this.thyCustomTextValue,
                customKey: this.thyCustomKey,
                selectedDateRange: (dateRange) => {
                    this.onModelChange(dateRange);
                    this.selectedDate = dateRange;
                }
            }
        });
    }
}
ThyDateRangeComponent.ɵfac = function ThyDateRangeComponent_Factory(t) { return new (t || ThyDateRangeComponent)(ɵngcc0.ɵɵdirectiveInject(ɵngcc1.ThyPopover), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.ChangeDetectorRef)); };
ThyDateRangeComponent.ɵcmp = ɵngcc0.ɵɵdefineComponent({ type: ThyDateRangeComponent, selectors: [["thy-date-range"]], inputs: { thyHiddenMenu: "thyHiddenMenu", thyDisabledSwitch: "thyDisabledSwitch", thyCustomTextValue: "thyCustomTextValue", thyCustomKey: "thyCustomKey", thyOptionalDateRanges: "thyOptionalDateRanges", thyMinDate: "thyMinDate", thyMaxDate: "thyMaxDate", thyPickerFormat: "thyPickerFormat" }, features: [ɵngcc0.ɵɵProvidersFeature([INPUT_CONTROL_VALUE_ACCESSOR])], decls: 8, vars: 9, consts: [[1, "thy-date-range-container"], [4, "ngIf"], ["href", "javascript:;", 1, "thy-date-range-text", 3, "ngClass", "click"], ["class", "thy-date-range-text-caret-down ml-2", "thyIconName", "angle-down", 4, "ngIf"], ["thyType", "secondary", 3, "click"], ["href", "javascript:;", "thyIconNavLink", ""], ["thyIconName", "angle-left"], ["thyIconName", "angle-down", 1, "thy-date-range-text-caret-down", "ml-2"], ["thyIconName", "angle-right"]], template: function ThyDateRangeComponent_Template(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵelementStart(0, "div", 0);
        ɵngcc0.ɵɵtemplate(1, ThyDateRangeComponent_ng_container_1_Template, 4, 0, "ng-container", 1);
        ɵngcc0.ɵɵelementStart(2, "span", 2);
        ɵngcc0.ɵɵlistener("click", function ThyDateRangeComponent_Template_span_click_2_listener($event) { return ctx.openOptionalDateRangesMenu($event); });
        ɵngcc0.ɵɵtemplate(3, ThyDateRangeComponent_ng_container_3_Template, 4, 6, "ng-container", 1);
        ɵngcc0.ɵɵtemplate(4, ThyDateRangeComponent_ng_container_4_Template, 3, 4, "ng-container", 1);
        ɵngcc0.ɵɵtemplate(5, ThyDateRangeComponent_ng_container_5_Template, 2, 1, "ng-container", 1);
        ɵngcc0.ɵɵtemplate(6, ThyDateRangeComponent_thy_icon_6_Template, 1, 0, "thy-icon", 3);
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵtemplate(7, ThyDateRangeComponent_ng_container_7_Template, 4, 0, "ng-container", 1);
        ɵngcc0.ɵɵelementEnd();
    } if (rf & 2) {
        ɵngcc0.ɵɵadvance(1);
        ɵngcc0.ɵɵproperty("ngIf", !ctx.thyDisabledSwitch);
        ɵngcc0.ɵɵadvance(1);
        ɵngcc0.ɵɵproperty("ngClass", ɵngcc0.ɵɵpureFunction1(7, _c0, ctx.thyHiddenMenu));
        ɵngcc0.ɵɵadvance(1);
        ɵngcc0.ɵɵproperty("ngIf", (ctx.selectedDate == null ? null : ctx.selectedDate.key) === "custom");
        ɵngcc0.ɵɵadvance(1);
        ɵngcc0.ɵɵproperty("ngIf", (ctx.selectedDate == null ? null : ctx.selectedDate.key) === "exception");
        ɵngcc0.ɵɵadvance(1);
        ɵngcc0.ɵɵproperty("ngIf", (ctx.selectedDate == null ? null : ctx.selectedDate.key) !== "custom" && (ctx.selectedDate == null ? null : ctx.selectedDate.key) !== "exception");
        ɵngcc0.ɵɵadvance(1);
        ɵngcc0.ɵɵproperty("ngIf", !ctx.thyHiddenMenu);
        ɵngcc0.ɵɵadvance(1);
        ɵngcc0.ɵɵproperty("ngIf", !ctx.thyDisabledSwitch);
    } }, directives: [ɵngcc2.NgIf, ɵngcc2.NgClass, ɵngcc3.ThyIconNavComponent, ɵngcc3.ThyIconNavLinkComponent, ɵngcc4.ThyIconComponent], pipes: [ɵngcc5.ThyDatePickerFormatPipe], encapsulation: 2 });
ThyDateRangeComponent.ctorParameters = () => [
    { type: ThyPopover },
    { type: ChangeDetectorRef }
];
ThyDateRangeComponent.propDecorators = {
    thyOptionalDateRanges: [{ type: Input }],
    thyHiddenMenu: [{ type: Input }],
    thyDisabledSwitch: [{ type: Input }],
    thyCustomTextValue: [{ type: Input }],
    thyMinDate: [{ type: Input }],
    thyMaxDate: [{ type: Input }],
    thyCustomKey: [{ type: Input }],
    thyPickerFormat: [{ type: Input }]
};
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(ThyDateRangeComponent, [{
        type: Component,
        args: [{
                selector: 'thy-date-range',
                template: "<div class=\"thy-date-range-container\">\n  <ng-container *ngIf=\"!thyDisabledSwitch\">\n    <thy-icon-nav thyType=\"secondary\" (click)=\"previous()\">\n      <a href=\"javascript:;\" thyIconNavLink><thy-icon thyIconName=\"angle-left\"></thy-icon></a>\n    </thy-icon-nav>\n  </ng-container>\n  <span\n    href=\"javascript:;\"\n    (click)=\"openOptionalDateRangesMenu($event)\"\n    class=\"thy-date-range-text\"\n    [ngClass]=\"{ 'thy-date-range-disabled': thyHiddenMenu }\"\n  >\n    <ng-container *ngIf=\"selectedDate?.key === 'custom'\">\n      {{ selectedDate?.begin | thyDatePickerFormat }} ~ {{ selectedDate?.end | thyDatePickerFormat }}\n    </ng-container>\n    <ng-container *ngIf=\"selectedDate?.key === 'exception'\">\n      {{ selectedDate?.begin | thyDatePickerFormat: thyPickerFormat }}\n    </ng-container>\n    <ng-container *ngIf=\"selectedDate?.key !== 'custom' && selectedDate?.key !== 'exception'\">{{ selectedDate?.text }}</ng-container>\n    <thy-icon *ngIf=\"!thyHiddenMenu\" class=\"thy-date-range-text-caret-down ml-2\" thyIconName=\"angle-down\"></thy-icon>\n  </span>\n  <ng-container *ngIf=\"!thyDisabledSwitch\">\n    <thy-icon-nav thyType=\"secondary\" (click)=\"next()\">\n      <a href=\"javascript:;\" thyIconNavLink><thy-icon thyIconName=\"angle-right\"></thy-icon></a>\n    </thy-icon-nav>\n  </ng-container>\n</div>\n",
                providers: [INPUT_CONTROL_VALUE_ACCESSOR]
            }]
    }], function () { return [{ type: ɵngcc1.ThyPopover }, { type: ɵngcc0.ChangeDetectorRef }]; }, { thyHiddenMenu: [{
            type: Input
        }], thyDisabledSwitch: [{
            type: Input
        }], thyCustomTextValue: [{
            type: Input
        }], thyCustomKey: [{
            type: Input
        }], thyOptionalDateRanges: [{
            type: Input
        }], thyMinDate: [{
            type: Input
        }], thyMaxDate: [{
            type: Input
        }], thyPickerFormat: [{
            type: Input
        }] }); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0ZS1yYW5nZS5jb21wb25lbnQuanMiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9kYXRlLXJhbmdlL2RhdGUtcmFuZ2UuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFVLEtBQUssRUFBaUIsaUJBQWlCLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDdkcsT0FBTyxFQUFFLGlCQUFpQixFQUF3QixNQUFNLGdCQUFnQixDQUFDO0FBR3pFLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUNoRCxPQUFPLEVBQUUsMkJBQTJCLEVBQUUsTUFBTSwyQ0FBMkMsQ0FBQztBQUV4RixPQUFPLEVBQUUsV0FBVyxFQUFFLGNBQWMsRUFBRSxZQUFZLEVBQUUsVUFBVSxFQUFFLFlBQVksRUFBRSxPQUFPLEVBQUUsU0FBUyxFQUFFLFFBQVEsRUFBRSxNQUFNLFVBQVUsQ0FBQzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUM3SCxNQUFNLGVBQWUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsQ0FBQztBQUVyQyxNQUFNLDRCQUE0QixHQUFRO0FBQzFDLElBQUksT0FBTyxFQUFFLGlCQUFpQjtBQUM5QixJQUFJLFdBQVcsRUFBRSxVQUFVLENBQUMsR0FBRyxFQUFFLENBQUMscUJBQXFCLENBQUM7QUFDeEQsSUFBSSxLQUFLLEVBQUUsSUFBSTtBQUNmLENBQUMsQ0FBQztBQU9GLE1BQU0sT0FBTyxxQkFBcUI7QUFBRyxJQXNEakMsWUFBb0IsVUFBc0IsRUFBVSxHQUFzQjtBQUFJLFFBQTFELGVBQVUsR0FBVixVQUFVLENBQVk7QUFBQyxRQUFTLFFBQUcsR0FBSCxHQUFHLENBQW1CO0FBQUMsUUFoRGxFLGtCQUFhLEdBQUcsS0FBSyxDQUFDO0FBQ25DLFFBQ2Esc0JBQWlCLEdBQUcsS0FBSyxDQUFDO0FB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LENBQUMsVUFBVTtBQUN4QyxnQkFBZ0IsT0FBTyxFQUFFLElBQUksQ0FBQyxVQUFVO0FBQ3hDLGdCQUFnQixXQUFXLEVBQUUsSUFBSSxDQUFDLGtCQUFrQjtBQUNwRCxnQkFBZ0IsU0FBUyxFQUFFLElBQUksQ0FBQyxZQUFZO0FBQzVDLGdCQUFnQixpQkFBaUIsRUFBRSxDQUFDLFNBQTRCLEVBQUUsRUFBRTtBQUNwRSxvQkFBb0IsSUFBSSxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsQ0FBQztBQUNsRCxvQkFBb0IsSUFBSSxDQUFDLFlBQVksR0FBRyxTQUFTLENBQUM7QUFDbEQsZ0JBQWdCLENBQUM7QUFDakIsYUFBYTtBQUNiLFNBQVMsQ0FBQyxDQUFDO0FBQ1gsSUFBSSxDQUFDO0FBQ0w7aURBcE1DLFNBQVMsU0FBQyxrQkFDUCxRQUFRLEVBQUUsZ0JBQWdCLGtCQUMxQjs7Ozs7eUVBQTBDLGtCQUMxQyxTQUFTLEVBQUUsQ0FBQyw0QkFBNEIsQ0FBQyxjQUM1Qzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7c01BQ0k7QUFBQztBQUErQyxZQWpCNUMsVUFBVTtBQUFJLFlBSnVDLGlCQUFpQjtBQUFHO0FBQUc7QUFDL0Qsb0NBcUJqQixLQUFLO0FBQ1IsNEJBSUcsS0FBSztBQUFLLGdDQUVWLEtBQUs7QUFBSyxpQ0FFVixLQUFLO0FBQUsseUJBRVYsS0FBSztBQUFLLHlCQUVWLEtBQUs7QUFBSywyQkFFVixLQUFLO0FBQUssOEJBRVYsS0FBSztBQUFJOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7b0JBQUU7QUFBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgZm9yd2FyZFJlZiwgT25Jbml0LCBJbnB1dCwgU2ltcGxlQ2hhbmdlcywgQ2hhbmdlRGV0ZWN0b3JSZWYgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE5HX1ZBTFVFX0FDQ0VTU09SLCBDb250cm9sVmFsdWVBY2Nlc3NvciB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcbmltcG9ydCB7IERhdGVSYW5nZUl0ZW1JbmZvIH0gZnJvbSAnLi9kYXRlLXJhbmdlLmNsYXNzJztcbmltcG9ydCB7IGhlbHBlcnMgfSBmcm9tICduZ3gtdGV0aHlzL3V0aWwnO1xuaW1wb3J0IHsgVGh5UG9wb3ZlciB9IGZyb20gJ25neC10ZXRoeXMvcG9wb3Zlcic7XG5pbXBvcnQgeyBPcHRpb25hbERhdGVSYW5nZXNDb21wb25lbnQgfSBmcm9tICcuL29wdGlvbmFsLWRhdGVzL29wdGlvbmFsLWRhdGVzLmNvbXBvbmVudCc7XG5cbmltcG9ydCB7IGdldFVuaXhUaW1lLCBzdGFydE9mSVNPV2VlaywgZW5kT2ZJU09XZWVrLCBlbmRPZk1vbnRoLCBzdGFydE9mTW9udGgsIGFkZERheXMsIGFkZE1vbnRocywgYWRkWWVhcnMgfSBmcm9tICdkYXRlLWZucyc7XG5jb25zdCBhbGxEYXlUaW1lc3RhbXAgPSAyNCAqIDYwICogNjA7XG5cbmNvbnN0IElOUFVUX0NPTlRST0xfVkFMVUVfQUNDRVNTT1I6IGFueSA9IHtcbiAgICBwcm92aWRlOiBOR19WQUxVRV9BQ0NFU1NPUixcbiAgICB1c2VFeGlzdGluZzogZm9yd2FyZFJlZigoKSA9PiBUaHlEYXRlUmFuZ2VDb21wb25lbnQpLFxuICAgIG11bHRpOiB0cnVlXG59O1xuXG5AQ29tcG9uZW50KHtcbiAgICBzZWxlY3RvcjogJ3RoeS1kYXRlLXJhbmdlJyxcbiAgICB0ZW1wbGF0ZVVybDogJy4vZGF0ZS1yYW5nZS5jb21wb25lbnQuaHRtbCcsXG4gICAgcHJvdmlkZXJzOiBbSU5QVVRfQ09OVFJPTF9WQUxVRV9BQ0NFU1NPUl1cbn0pXG5leHBvcnQgY2xhc3MgVGh5RGF0ZVJhbmdlQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBDb250cm9sVmFsdWVBY2Nlc3NvciB7XG4gICAgQElucHV0KClcbiAgICBzZXQgdGh5T3B0aW9uYWxEYXRlUmFuZ2VzKHZhbHVlOiBEYXRlUmFuZ2VJdGVtSW5mb1tdKSB7XG4gICAgICAgIHRoaXMub3B0aW9uYWxEYXRlUmFuZ2VzID0gdmFsdWUubGVuZ3RoID4gMCA/IHZhbHVlIDogdGhpcy5vcHRpb25hbERhdGVSYW5nZXM7XG4gICAgfVxuXG4gICAgQElucHV0KCkgdGh5SGlkZGVuTWVudSA9IGZhbHNlO1xuXG4gICAgQElucHV0KCkgdGh5RGlzYWJsZWRTd2l0Y2ggPSBmYWxzZTtcblxuICAgIEBJbnB1dCgpIHRoeUN1c3RvbVRleHRWYWx1ZSA9ICfoh6rlrprkuYknO1xuXG4gICAgQElucHV0KCkgdGh5TWluRGF0ZTogRGF0ZSB8IG51bWJlcjtcblxuICAgIEBJbnB1dCgpIHRoeU1heERhdGU6IERhdGUgfCBudW1iZXI7XG5cbiAgICBASW5wdXQoKSB0aHlDdXN0b21LZXk6ICdjdXN0b20nIHwgJ2V4Y2VwdGlvbicgPSAnY3VzdG9tJztcblxuICAgIEBJbnB1dCgpIHRoeVBpY2tlckZvcm1hdDogc3RyaW5nO1xuXG4gICAgcHVibGljIHNlbGVjdGVkRGF0ZT86IERhdGVSYW5nZUl0ZW1JbmZvO1xuXG4gICAgcHVibGljIG9wdGlvbmFsRGF0ZVJhbmdlczogRGF0ZVJhbmdlSXRlbUluZm9bXSA9IFtcbiAgICAgICAge1xuICAgICAgICAgICAga2V5OiAnd2VlaycsXG4gICAgICAgICAgICB0ZXh0OiAn5pys5ZGoJyxcbiAgICAgICAgICAgIGJlZ2luOiBnZXRVbml4VGltZShzdGFydE9mSVNPV2VlayhuZXcgRGF0ZSgpKSksXG4gICAgICAgICAgICBlbmQ6IGdldFVuaXhUaW1lKGVuZE9mSVNPV2VlayhuZXcgRGF0ZSgpKSksXG4gICAgICAgICAgICB0aW1lc3RhbXA6IHtcbiAgICAgICAgICAgICAgICBpbnRlcnZhbDogNyxcbiAgICAgICAgICAgICAgICB1bml0OiAnZGF5J1xuICAgICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgICBrZXk6ICdtb250aCcsXG4gICAgICAgICAgICB0ZXh0OiAn5pys5pyIJyxcbiAgICAgICAgICAgIGJlZ2luOiBnZXRVbml4VGltZShzdGFydE9mTW9udGgobmV3IERhdGUoKSkpLFxuICAgICAgICAgICAgZW5kOiBnZXRVbml4VGltZShlbmRPZk1vbnRoKG5ldyBEYXRlKCkpKSxcbiAgICAgICAgICAgIHRpbWVzdGFtcDoge1xuICAgICAgICAgICAgICAgIGludGVydmFsOiAxLFxuICAgICAgICAgICAgICAgIHVuaXQ6ICdtb250aCdcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIF07XG5cbiAgICBwdWJsaWMgc2VsZWN0ZWREYXRlUmFuZ2U6IHtcbiAgICAgICAgYmVnaW46IG51bWJlcjtcbiAgICAgICAgZW5kOiBudW1iZXI7XG4gICAgfTtcblxuICAgIHB1YmxpYyBvbk1vZGVsQ2hhbmdlOiBGdW5jdGlvbiA9ICgpID0+IHt9O1xuXG4gICAgcHVibGljIG9uTW9kZWxUb3VjaGVkOiBGdW5jdGlvbiA9ICgpID0+IHt9O1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSB0aHlQb3BvdmVyOiBUaHlQb3BvdmVyLCBwcml2YXRlIGNkcjogQ2hhbmdlRGV0ZWN0b3JSZWYpIHt9XG5cbiAgICB3cml0ZVZhbHVlKHZhbHVlOiBhbnkpOiB2b2lkIHtcbiAgICAgICAgaWYgKHZhbHVlKSB7XG4gICAgICAgICAgICB0aGlzLnNlbGVjdGVkRGF0ZSA9IHZhbHVlO1xuICAgICAgICB9IGVsc2UgaWYgKHRoaXMub3B0aW9uYWxEYXRlUmFuZ2VzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWREYXRlID0gdGhpcy5vcHRpb25hbERhdGVSYW5nZXNbMF07XG4gICAgICAgICAgICB0aGlzLm9uTW9kZWxDaGFuZ2UodGhpcy5zZWxlY3RlZERhdGUpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuX3NldFNlbGVjdGVkRGF0ZVJhbmdlKCk7XG4gICAgICAgIHRoaXMuY2RyLmRldGVjdENoYW5nZXMoKTtcbiAgICB9XG5cbiAgICByZWdpc3Rlck9uQ2hhbmdlKGZuOiBhbnkpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5vbk1vZGVsQ2hhbmdlID0gZm47XG4gICAgfVxuXG4gICAgcmVnaXN0ZXJPblRvdWNoZWQoZm46IGFueSk6IHZvaWQge1xuICAgICAgICB0aGlzLm9uTW9kZWxUb3VjaGVkID0gZm47XG4gICAgfVxuXG4gICAgbmdPbkluaXQoKSB7fVxuXG4gICAgcHJpdmF0ZSBfc2V0U2VsZWN0ZWREYXRlUmFuZ2UoKSB7XG4gICAgICAgIHRoaXMuc2VsZWN0ZWREYXRlUmFuZ2UgPSB7XG4gICAgICAgICAgICBiZWdpbjogdGhpcy5zZWxlY3RlZERhdGUuYmVnaW4sXG4gICAgICAgICAgICBlbmQ6IHRoaXMuc2VsZWN0ZWREYXRlLmVuZFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHByaXZhdGUgX2NhbGN1bGF0ZU5ld1RpbWUodHlwZTogc3RyaW5nKSB7XG4gICAgICAgIGlmICh0aGlzLnNlbGVjdGVkRGF0ZS50aW1lc3RhbXApIHtcbiAgICAgICAgICAgIGNvbnN0IGJlZ2luRGF0ZSA9IG5ldyBEYXRlKHRoaXMuc2VsZWN0ZWREYXRlLmJlZ2luICogMTAwMCk7XG4gICAgICAgICAgICBjb25zdCBlbmREYXRlID0gbmV3IERhdGUodGhpcy5zZWxlY3RlZERhdGUuZW5kICogMTAwMCk7XG4gICAgICAgICAgICBjb25zdCBpbnRlcnZhbCA9IHRoaXMuc2VsZWN0ZWREYXRlLnRpbWVzdGFtcC5pbnRlcnZhbDtcblxuICAgICAgICAgICAgaWYgKHRoaXMuc2VsZWN0ZWREYXRlLnRpbWVzdGFtcC51bml0ID09PSAnZGF5Jykge1xuICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAncHJldmlvdXMnKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBiZWdpbjogZ2V0VW5peFRpbWUoYWRkRGF5cyhiZWdpbkRhdGUsIC0xICogaW50ZXJ2YWwpKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGVuZDogZ2V0VW5peFRpbWUoYWRkRGF5cyhlbmREYXRlLCAtMSAqIGludGVydmFsKSksXG4gICAgICAgICAgICAgICAgICAgICAgICBrZXk6IHRoaXMudGh5Q3VzdG9tS2V5XG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGJlZ2luOiBnZXRVbml4VGltZShhZGREYXlzKGJlZ2luRGF0ZSwgMSAqIGludGVydmFsKSksXG4gICAgICAgICAgICAgICAgICAgICAgICBlbmQ6IGdldFVuaXhUaW1lKGFkZERheXMoZW5kRGF0ZSwgMSAqIGludGVydmFsKSksXG4gICAgICAgICAgICAgICAgICAgICAgICBrZXk6IHRoaXMudGh5Q3VzdG9tS2V5XG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLnNlbGVjdGVkRGF0ZS50aW1lc3RhbXAudW5pdCA9PT0gJ21vbnRoJykge1xuICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAncHJldmlvdXMnKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBiZWdpbjogZ2V0VW5peFRpbWUoYWRkTW9udGhzKGJlZ2luRGF0ZSwgLTEgKiBpbnRlcnZhbCkpLFxuICAgICAgICAgICAgICAgICAgICAgICAgZW5kOiBnZXRVbml4VGltZShhZGRNb250aHMoZW5kRGF0ZSwgLTEgKiBpbnRlcnZhbCkpLFxuICAgICAgICAgICAgICAgICAgICAgICAga2V5OiB0aGlzLnRoeUN1c3RvbUtleVxuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBiZWdpbjogZ2V0VW5peFRpbWUoYWRkTW9udGhzKGJlZ2luRGF0ZSwgMSAqIGludGVydmFsKSksXG4gICAgICAgICAgICAgICAgICAgICAgICBlbmQ6IGdldFVuaXhUaW1lKGFkZE1vbnRocyhlbmREYXRlLCAxICogaW50ZXJ2YWwpKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGtleTogdGhpcy50aHlDdXN0b21LZXlcbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuc2VsZWN0ZWREYXRlLnRpbWVzdGFtcC51bml0ID09PSAneWVhcicpIHtcbiAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gJ3ByZXZpb3VzJykge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgYmVnaW46IGdldFVuaXhUaW1lKGFkZFllYXJzKGJlZ2luRGF0ZSwgLTEgKiBpbnRlcnZhbCkpLFxuICAgICAgICAgICAgICAgICAgICAgICAgZW5kOiBnZXRVbml4VGltZShhZGRZZWFycyhlbmREYXRlLCAtMSAqIGludGVydmFsKSksXG4gICAgICAgICAgICAgICAgICAgICAgICBrZXk6IHRoaXMudGh5Q3VzdG9tS2V5XG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGJlZ2luOiBnZXRVbml4VGltZShhZGRZZWFycyhiZWdpbkRhdGUsIDEgKiBpbnRlcnZhbCkpLFxuICAgICAgICAgICAgICAgICAgICAgICAgZW5kOiBnZXRVbml4VGltZShhZGRZZWFycyhlbmREYXRlLCAxICogaW50ZXJ2YWwpKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGtleTogdGhpcy50aHlDdXN0b21LZXlcbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zdCBpbnRlcnZhbDogbnVtYmVyID0gdGhpcy5zZWxlY3RlZERhdGUuZW5kIC0gdGhpcy5zZWxlY3RlZERhdGUuYmVnaW4gKyBhbGxEYXlUaW1lc3RhbXA7XG4gICAgICAgICAgICBpZiAodHlwZSA9PT0gJ3ByZXZpb3VzJykge1xuICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgIGJlZ2luOiB0aGlzLnNlbGVjdGVkRGF0ZS5iZWdpbiAtIGludGVydmFsLFxuICAgICAgICAgICAgICAgICAgICBlbmQ6IHRoaXMuc2VsZWN0ZWREYXRlLmVuZCAtIGludGVydmFsLFxuICAgICAgICAgICAgICAgICAgICBrZXk6IHRoaXMudGh5Q3VzdG9tS2V5XG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgYmVnaW46IHRoaXMuc2VsZWN0ZWREYXRlLmJlZ2luICsgaW50ZXJ2YWwsXG4gICAgICAgICAgICAgICAgICAgIGVuZDogdGhpcy5zZWxlY3RlZERhdGUuZW5kICsgaW50ZXJ2YWwsXG4gICAgICAgICAgICAgICAgICAgIGtleTogdGhpcy50aHlDdXN0b21LZXlcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfc2V0UHJldmlvdXNPck5leHREYXRlKHR5cGU6IHN0cmluZykge1xuICAgICAgICB0aGlzLnNlbGVjdGVkRGF0ZSA9IE9iamVjdC5hc3NpZ24oe30sIHRoaXMuc2VsZWN0ZWREYXRlLCB0aGlzLl9jYWxjdWxhdGVOZXdUaW1lKHR5cGUpKTtcbiAgICAgICAgdGhpcy5fc2V0U2VsZWN0ZWREYXRlUmFuZ2UoKTtcbiAgICAgICAgdGhpcy5vbk1vZGVsQ2hhbmdlKHRoaXMuc2VsZWN0ZWREYXRlKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgcHJldmlvdXMoKSB7XG4gICAgICAgIHRoaXMuX3NldFByZXZpb3VzT3JOZXh0RGF0ZSgncHJldmlvdXMnKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgbmV4dCgpIHtcbiAgICAgICAgdGhpcy5fc2V0UHJldmlvdXNPck5leHREYXRlKCduZXh0Jyk7XG4gICAgfVxuXG4gICAgcHVibGljIG9wZW5PcHRpb25hbERhdGVSYW5nZXNNZW51KGV2ZW50OiBFdmVudCkge1xuICAgICAgICBpZiAodGhpcy50aHlIaWRkZW5NZW51KSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy50aHlQb3BvdmVyLm9wZW4oT3B0aW9uYWxEYXRlUmFuZ2VzQ29tcG9uZW50LCB7XG4gICAgICAgICAgICBvcmlnaW46IGV2ZW50LmN1cnJlbnRUYXJnZXQgYXMgSFRNTEVsZW1lbnQsXG4gICAgICAgICAgICBoYXNCYWNrZHJvcDogdHJ1ZSxcbiAgICAgICAgICAgIGJhY2tkcm9wQ2xhc3M6ICd0aHktb3ZlcmxheS10cmFuc3BhcmVudC1iYWNrZHJvcCcsXG4gICAgICAgICAgICBvZmZzZXQ6IDAsXG4gICAgICAgICAgICBtYW51YWxDbG9zdXJlOiB0cnVlLFxuICAgICAgICAgICAgb3JpZ2luQWN0aXZlQ2xhc3M6ICd0aHktZGF0ZS1yYW5nZS10ZXh0LWFjdGl2ZScsXG4gICAgICAgICAgICBpbml0aWFsU3RhdGU6IHtcbiAgICAgICAgICAgICAgICBoaWRkZW5NZW51OiB0aGlzLnRoeUhpZGRlbk1lbnUsXG4gICAgICAgICAgICAgICAgb3B0aW9uYWxEYXRlUmFuZ2VzOiB0aGlzLm9wdGlvbmFsRGF0ZVJhbmdlcyxcbiAgICAgICAgICAgICAgICBzZWxlY3RlZERhdGU6IHRoaXMuc2VsZWN0ZWREYXRlLFxuICAgICAgICAgICAgICAgIG1pbkRhdGU6IHRoaXMudGh5TWluRGF0ZSxcbiAgICAgICAgICAgICAgICBtYXhEYXRlOiB0aGlzLnRoeU1heERhdGUsXG4gICAgICAgICAgICAgICAgY3VzdG9tVmFsdWU6IHRoaXMudGh5Q3VzdG9tVGV4dFZhbHVlLFxuICAgICAgICAgICAgICAgIGN1c3RvbUtleTogdGhpcy50aHlDdXN0b21LZXksXG4gICAgICAgICAgICAgICAgc2VsZWN0ZWREYXRlUmFuZ2U6IChkYXRlUmFuZ2U6IERhdGVSYW5nZUl0ZW1JbmZvKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMub25Nb2RlbENoYW5nZShkYXRlUmFuZ2UpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdGVkRGF0ZSA9IGRhdGVSYW5nZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cbn1cbiJdfQ==