import { Directive, ElementRef, Input, EventEmitter, Output, Optional, Self } from '@angular/core';
import { NgControl } from '@angular/forms';
import { ThyPopover, ThyPopoverConfig } from 'ngx-tethys/popover';
import { ThyMentionSuggestionsComponent } from './suggestions/suggestions.component';
import { CaretPositioner } from './caret-positioner';
import { createMentionAdapter } from './adapter';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from 'ngx-tethys/popover';
import * as ɵngcc2 from '@angular/forms';
const SUGGESTION_BACKDROP_CLASS = 'thy-mention-suggestions-backdrop';
const POPOVER_DEFAULT_CONFIG = {
    backdropClass: SUGGESTION_BACKDROP_CLASS,
    placement: 'bottomLeft'
};
const ɵ0 = (term, data) => {
    return data.filter(item => {
        return !item.name || item.name.toLowerCase().includes(term.toLowerCase());
    });
};
const DEFAULT_MENTION_CONFIG = {
    autoClose: true,
    emptyText: '无匹配数据，按空格完成输入',
    search: ɵ0
};
export class ThyMentionDirective {
    constructor(elementRef, thyPopover, ngControl) {
        this.elementRef = elementRef;
        this.thyPopover = thyPopover;
        this.ngControl = ngControl;
        this.adapter = null;
        this.select = new EventEmitter();
        this.adapter = createMentionAdapter(elementRef.nativeElement);
        this.bindEvents();
    }
    get mentions() {
        return this._mentions;
    }
    set mentions(value) {
        this._mentions = value;
        if (this._mentions) {
            this._mentions = this._mentions.map(mention => {
                if (!mention.trigger) {
                    throw new Error(`mention trigger is required`);
                }
                return Object.assign({}, DEFAULT_MENTION_CONFIG, mention);
            });
        }
    }
    ngOnInit() { }
    bindEvents() {
        this.elementRef.nativeElement.addEventListener('input', (event) => {
            this.onInput(event);
        });
        this.elementRef.nativeElement.addEventListener('click', (event) => {
            this.onClick(event);
        });
    }
    onClick(event) {
        this.lookup(event);
    }
    onInput(event) {
        this.lookup(event);
    }
    lookup(event) {
        const matched = this.adapter.lookup(event, this.mentions);
        if (matched) {
            this.openSuggestions(matched);
        }
        else {
            this.closeSuggestions();
        }
    }
    openSuggestions(matched) {
        if (!this.openedSuggestionsRef) {
            const inputElement = this.elementRef.nativeElement;
            const position = CaretPositioner.getCaretPosition(inputElement, matched.query.start);
            const fontSize = parseInt(getComputedStyle(this.elementRef.nativeElement).fontSize, 10);
            this.openedSuggestionsRef = this.thyPopover.open(ThyMentionSuggestionsComponent, Object.assign({}, POPOVER_DEFAULT_CONFIG, this.popoverConfig, {
                origin: this.elementRef,
                originPosition: {
                    x: position.left,
                    y: position.top,
                    width: fontSize,
                    height: fontSize
                },
                initialState: {
                    mention: matched.mention
                }
            }));
            this.openedSuggestionsRef.afterClosed().subscribe(() => {
                this.openedSuggestionsRef = null;
            });
            this.openedSuggestionsRef.componentInstance.suggestionSelect$.subscribe(event => {
                const newValue = this.adapter.insertMention(event.item);
                if (this.ngControl && this.ngControl.control) {
                    this.ngControl.control.setValue(newValue);
                }
                this.openedSuggestionsRef.close();
                this.select.emit(event);
            });
        }
        if (this.openedSuggestionsRef) {
            this.openedSuggestionsRef.componentInstance.search(matched.query);
        }
    }
    closeSuggestions() {
        if (this.openedSuggestionsRef) {
            this.openedSuggestionsRef.close();
        }
    }
    isEditable() {
        const element = this.elementRef.nativeElement;
        return !element.readOnly && !element.disabled;
    }
}
ThyMentionDirective.ɵfac = function ThyMentionDirective_Factory(t) { return new (t || ThyMentionDirective)(ɵngcc0.ɵɵdirectiveInject(ɵngcc0.ElementRef), ɵngcc0.ɵɵdirectiveInject(ɵngcc1.ThyPopover), ɵngcc0.ɵɵdirectiveInject(ɵngcc2.NgControl, 10)); };
ThyMentionDirective.ɵdir = ɵngcc0.ɵɵdefineDirective({ type: ThyMentionDirective, selectors: [["", "thyMention", ""]], inputs: { mentions: ["thyMention", "mentions"], popoverConfig: ["thyPopoverConfig", "popoverConfig"] }, outputs: { select: "thySelectSuggestion" }, features: [ɵngcc0.ɵɵProvidersFeature([])] });
ThyMentionDirective.ctorParameters = () => [
    { type: ElementRef },
    { type: ThyPopover },
    { type: NgControl, decorators: [{ type: Optional }, { type: Self }] }
];
ThyMentionDirective.propDecorators = {
    mentions: [{ type: Input, args: ['thyMention',] }],
    popoverConfig: [{ type: Input, args: ['thyPopoverConfig',] }],
    select: [{ type: Output, args: ['thySelectSuggestion',] }]
};
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(ThyMentionDirective, [{
        type: Directive,
        args: [{
                selector: '[thyMention]',
                providers: []
            }]
    }], function () { return [{ type: ɵngcc0.ElementRef }, { type: ɵngcc1.ThyPopover }, { type: ɵngcc2.NgControl, decorators: [{
                type: Optional
            }, {
                type: Self
            }] }]; }, { select: [{
            type: Output,
            args: ['thySelectSuggestion']
        }], mentions: [{
            type: Input,
            args: ['thyMention']
        }], popoverConfig: [{
            type: Input,
            args: ['thyPopoverConfig']
        }] }); })();
export { ɵ0 };

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVudGlvbi5kaXJlY3RpdmUuanMiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9tZW50aW9uL21lbnRpb24uZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDSCxTQUFTLEVBQ1QsVUFBVSxFQUNWLEtBQUssRUFFTCxZQUFZLEVBQ1osTUFBTSxFQUVOLFFBQVEsRUFHUixJQUFJLEVBQ1AsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFXLFNBQVMsRUFBZSxNQUFNLGdCQUFnQixDQUFDO0FBRWpFLE9BQU8sRUFBRSxVQUFVLEVBQWlCLGdCQUFnQixFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDakYsT0FBTyxFQUFFLDhCQUE4QixFQUFFLE1BQU0scUNBQXFDLENBQUM7QUFDckYsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3JELE9BQU8sRUFBa0Isb0JBQW9CLEVBQXlDLE1BQU0sV0FBVyxDQUFDOzs7O0FBRXhHLE1BQU0seUJBQXlCLEdBQUcsa0NBQWtDLENBQUM7QUFFckUsTUFBTSxzQkFBc0IsR0FBRztBQUMvQixJQUFJLGFBQWEsRUFBRSx5QkFBeUI7QUFDNUMsSUFBSSxTQUFTLEVBQUUsWUFBWTtBQUMzQixDQUFDLENBQUM7QUFDRixXQUlZLENBQUMsSUFBWSxFQUFFLElBQThCLEVBQUUsRUFBRTtBQUM3RCxJQUFRLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRTtBQUNsQyxRQUFZLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDO0FBQ3RGLElBQVEsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDO0FBUEwsTUFBTSxzQkFBc0IsR0FBcUI7QUFDakQsSUFBSSxTQUFTLEVBQUUsSUFBSTtBQUNuQixJQUFJLFNBQVMsRUFBRSxl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TyxVQUFVO0FBQUksWUFGTCxTQUFTLHVCQTBEbEIsUUFBUSxZQUFJLElBQUk7QUFBTTtBQUFHO0FBRTFCLHVCQXRCSCxLQUFLLFNBQUMsWUFBWTtBQUFPLDRCQVl6QixLQUFLLFNBQUMsa0JBQWtCO0FBQU8scUJBRS9CLE1BQU0sU0FBQyxxQkFBcUI7QUFDN0I7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O29CQUFFO0FBQUM7QUFBZSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gICAgRGlyZWN0aXZlLFxuICAgIEVsZW1lbnRSZWYsXG4gICAgSW5wdXQsXG4gICAgT25Jbml0LFxuICAgIEV2ZW50RW1pdHRlcixcbiAgICBPdXRwdXQsXG4gICAgTmdab25lLFxuICAgIE9wdGlvbmFsLFxuICAgIENoYW5nZURldGVjdG9yUmVmLFxuICAgIGZvcndhcmRSZWYsXG4gICAgU2VsZlxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE5nTW9kZWwsIE5nQ29udHJvbCwgRm9ybUNvbnRyb2wgfSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XG5pbXBvcnQgeyBNZW50aW9uLCBNZW50aW9uU3VnZ2VzdGlvblNlbGVjdEV2ZW50LCBNZW50aW9uRGVmYXVsdERhdGFJdGVtIH0gZnJvbSAnLi9pbnRlcmZhY2VzJztcbmltcG9ydCB7IFRoeVBvcG92ZXIsIFRoeVBvcG92ZXJSZWYsIFRoeVBvcG92ZXJDb25maWcgfSBmcm9tICduZ3gtdGV0aHlzL3BvcG92ZXInO1xuaW1wb3J0IHsgVGh5TWVudGlvblN1Z2dlc3Rpb25zQ29tcG9uZW50IH0gZnJvbSAnLi9zdWdnZXN0aW9ucy9zdWdnZXN0aW9ucy5jb21wb25lbnQnO1xuaW1wb3J0IHsgQ2FyZXRQb3NpdGlvbmVyIH0gZnJvbSAnLi9jYXJldC1wb3NpdGlvbmVyJztcbmltcG9ydCB7IE1lbnRpb25BZGFwdGVyLCBjcmVhdGVNZW50aW9uQWRhcHRlciwgTWF0Y2hlZE1lbnRpb24sIE1lbnRpb25JbnB1dG9yRWxlbWVudCB9IGZyb20gJy4vYWRhcHRlcic7XG5cbmNvbnN0IFNVR0dFU1RJT05fQkFDS0RST1BfQ0xBU1MgPSAndGh5LW1lbnRpb24tc3VnZ2VzdGlvbnMtYmFja2Ryb3AnO1xuXG5jb25zdCBQT1BPVkVSX0RFRkFVTFRfQ09ORklHID0ge1xuICAgIGJhY2tkcm9wQ2xhc3M6IFNVR0dFU1RJT05fQkFDS0RST1BfQ0xBU1MsXG4gICAgcGxhY2VtZW50OiAnYm90dG9tTGVmdCdcbn07XG5cbmNvbnN0IERFRkFVTFRfTUVOVElPTl9DT05GSUc6IFBhcnRpYWw8TWVudGlvbj4gPSB7XG4gICAgYXV0b0Nsb3NlOiB0cnVlLFxuICAgIGVtcHR5VGV4dDogJ+aXoOWMuemFjeaVsOaNru+8jOaMieepuuagvOWujOaIkOi+k+WFpScsXG4gICAgc2VhcmNoOiAodGVybTogc3RyaW5nLCBkYXRhOiBNZW50aW9uRGVmYXVsdERhdGFJdGVtW10pID0+IHtcbiAgICAgICAgcmV0dXJuIGRhdGEuZmlsdGVyKGl0ZW0gPT4ge1xuICAgICAgICAgICAgcmV0dXJuICFpdGVtLm5hbWUgfHwgaXRlbS5uYW1lLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXModGVybS50b0xvd2VyQ2FzZSgpKTtcbiAgICAgICAgfSk7XG4gICAgfVxufTtcblxuQERpcmVjdGl2ZSh7XG4gICAgc2VsZWN0b3I6ICdbdGh5TWVudGlvbl0nLFxuICAgIHByb3ZpZGVyczogW11cbn0pXG5leHBvcnQgY2xhc3MgVGh5TWVudGlvbkRpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uSW5pdCB7XG4gICAgcHJpdmF0ZSBhZGFwdGVyOiBNZW50aW9uQWRhcHRlciA9IG51bGw7XG5cbiAgICBwcml2YXRlIG9wZW5lZFN1Z2dlc3Rpb25zUmVmOiBUaHlQb3BvdmVyUmVmPFRoeU1lbnRpb25TdWdnZXN0aW9uc0NvbXBvbmVudD47XG5cbiAgICBwcml2YXRlIF9tZW50aW9uczogTWVudGlvbjxhbnk+W107XG4gICAgZ2V0IG1lbnRpb25zKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fbWVudGlvbnM7XG4gICAgfVxuXG4gICAgQElucHV0KCd0aHlNZW50aW9uJykgc2V0IG1lbnRpb25zKHZhbHVlOiBNZW50aW9uPGFueT5bXSkge1xuICAgICAgICB0aGlzLl9tZW50aW9ucyA9IHZhbHVlO1xuICAgICAgICBpZiAodGhpcy5fbWVudGlvbnMpIHtcbiAgICAgICAgICAgIHRoaXMuX21lbnRpb25zID0gdGhpcy5fbWVudGlvbnMubWFwKG1lbnRpb24gPT4ge1xuICAgICAgICAgICAgICAgIGlmICghbWVudGlvbi50cmlnZ2VyKSB7XG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgbWVudGlvbiB0cmlnZ2VyIGlzIHJlcXVpcmVkYCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiBPYmplY3QuYXNzaWduKHt9LCBERUZBVUxUX01FTlRJT05fQ09ORklHLCBtZW50aW9uKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgQElucHV0KCd0aHlQb3BvdmVyQ29uZmlnJykgcG9wb3ZlckNvbmZpZzogVGh5UG9wb3ZlckNvbmZpZztcblxuICAgIEBPdXRwdXQoJ3RoeVNlbGVjdFN1Z2dlc3Rpb24nKVxuICAgIHNlbGVjdCA9IG5ldyBFdmVudEVtaXR0ZXI8TWVudGlvblN1Z2dlc3Rpb25TZWxlY3RFdmVudD4oKTtcblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBwcml2YXRlIGVsZW1lbnRSZWY6IEVsZW1lbnRSZWY8SFRNTEVsZW1lbnQ+LFxuICAgICAgICBwcml2YXRlIHRoeVBvcG92ZXI6IFRoeVBvcG92ZXIsXG4gICAgICAgIEBPcHRpb25hbCgpIEBTZWxmKCkgcHJpdmF0ZSBuZ0NvbnRyb2w6IE5nQ29udHJvbFxuICAgICkge1xuICAgICAgICB0aGlzLmFkYXB0ZXIgPSBjcmVhdGVNZW50aW9uQWRhcHRlcihlbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQgYXMgTWVudGlvbklucHV0b3JFbGVtZW50KTtcbiAgICAgICAgdGhpcy5iaW5kRXZlbnRzKCk7XG4gICAgfVxuXG4gICAgbmdPbkluaXQoKSB7fVxuXG4gICAgYmluZEV2ZW50cygpIHtcbiAgICAgICAgdGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignaW5wdXQnLCAoZXZlbnQ6IEV2ZW50KSA9PiB7XG4gICAgICAgICAgICB0aGlzLm9uSW5wdXQoZXZlbnQpO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZXZlbnQ6IEV2ZW50KSA9PiB7XG4gICAgICAgICAgICB0aGlzLm9uQ2xpY2soZXZlbnQpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBvbkNsaWNrKGV2ZW50OiBFdmVudCkge1xuICAgICAgICB0aGlzLmxvb2t1cChldmVudCk7XG4gICAgfVxuXG4gICAgb25JbnB1dChldmVudDogRXZlbnQpIHtcbiAgICAgICAgdGhpcy5sb29rdXAoZXZlbnQpO1xuICAgIH1cblxuICAgIHByaXZhdGUgbG9va3VwKGV2ZW50OiBFdmVudCkge1xuICAgICAgICBjb25zdCBtYXRjaGVkID0gdGhpcy5hZGFwdGVyLmxvb2t1cChldmVudCwgdGhpcy5tZW50aW9ucyk7XG4gICAgICAgIGlmIChtYXRjaGVkKSB7XG4gICAgICAgICAgICB0aGlzLm9wZW5TdWdnZXN0aW9ucyhtYXRjaGVkKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuY2xvc2VTdWdnZXN0aW9ucygpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvcGVuU3VnZ2VzdGlvbnMobWF0Y2hlZDogTWF0Y2hlZE1lbnRpb24pIHtcbiAgICAgICAgaWYgKCF0aGlzLm9wZW5lZFN1Z2dlc3Rpb25zUmVmKSB7XG4gICAgICAgICAgICBjb25zdCBpbnB1dEVsZW1lbnQgPSB0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudCBhcyBIVE1MSW5wdXRFbGVtZW50O1xuICAgICAgICAgICAgY29uc3QgcG9zaXRpb24gPSBDYXJldFBvc2l0aW9uZXIuZ2V0Q2FyZXRQb3NpdGlvbihpbnB1dEVsZW1lbnQsIG1hdGNoZWQucXVlcnkuc3RhcnQpO1xuICAgICAgICAgICAgY29uc3QgZm9udFNpemUgPSBwYXJzZUludChnZXRDb21wdXRlZFN0eWxlKHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50KS5mb250U2l6ZSwgMTApO1xuICAgICAgICAgICAgdGhpcy5vcGVuZWRTdWdnZXN0aW9uc1JlZiA9IHRoaXMudGh5UG9wb3Zlci5vcGVuKFxuICAgICAgICAgICAgICAgIFRoeU1lbnRpb25TdWdnZXN0aW9uc0NvbXBvbmVudCxcbiAgICAgICAgICAgICAgICBPYmplY3QuYXNzaWduKHt9LCBQT1BPVkVSX0RFRkFVTFRfQ09ORklHLCB0aGlzLnBvcG92ZXJDb25maWcsIHtcbiAgICAgICAgICAgICAgICAgICAgb3JpZ2luOiB0aGlzLmVsZW1lbnRSZWYsXG4gICAgICAgICAgICAgICAgICAgIG9yaWdpblBvc2l0aW9uOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICB4OiBwb3NpdGlvbi5sZWZ0LFxuICAgICAgICAgICAgICAgICAgICAgICAgeTogcG9zaXRpb24udG9wLFxuICAgICAgICAgICAgICAgICAgICAgICAgd2lkdGg6IGZvbnRTaXplLFxuICAgICAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiBmb250U2l6ZVxuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICBpbml0aWFsU3RhdGU6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lbnRpb246IG1hdGNoZWQubWVudGlvblxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICB0aGlzLm9wZW5lZFN1Z2dlc3Rpb25zUmVmLmFmdGVyQ2xvc2VkKCkuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLm9wZW5lZFN1Z2dlc3Rpb25zUmVmID0gbnVsbDtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgdGhpcy5vcGVuZWRTdWdnZXN0aW9uc1JlZi5jb21wb25lbnRJbnN0YW5jZS5zdWdnZXN0aW9uU2VsZWN0JC5zdWJzY3JpYmUoZXZlbnQgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IG5ld1ZhbHVlID0gdGhpcy5hZGFwdGVyLmluc2VydE1lbnRpb24oZXZlbnQuaXRlbSk7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMubmdDb250cm9sICYmIHRoaXMubmdDb250cm9sLmNvbnRyb2wpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5uZ0NvbnRyb2wuY29udHJvbC5zZXRWYWx1ZShuZXdWYWx1ZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHRoaXMub3BlbmVkU3VnZ2VzdGlvbnNSZWYuY2xvc2UoKTtcbiAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdC5lbWl0KGV2ZW50KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMub3BlbmVkU3VnZ2VzdGlvbnNSZWYpIHtcbiAgICAgICAgICAgIHRoaXMub3BlbmVkU3VnZ2VzdGlvbnNSZWYuY29tcG9uZW50SW5zdGFuY2Uuc2VhcmNoKG1hdGNoZWQucXVlcnkpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjbG9zZVN1Z2dlc3Rpb25zKCkge1xuICAgICAgICBpZiAodGhpcy5vcGVuZWRTdWdnZXN0aW9uc1JlZikge1xuICAgICAgICAgICAgdGhpcy5vcGVuZWRTdWdnZXN0aW9uc1JlZi5jbG9zZSgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBpc0VkaXRhYmxlKCkge1xuICAgICAgICBjb25zdCBlbGVtZW50ID0gdGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQgYXMgSFRNTElucHV0RWxlbWVudCB8IEhUTUxUZXh0QXJlYUVsZW1lbnQ7XG4gICAgICAgIHJldHVybiAhZWxlbWVudC5yZWFkT25seSAmJiAhZWxlbWVudC5kaXNhYmxlZDtcbiAgICB9XG59XG4iXX0=