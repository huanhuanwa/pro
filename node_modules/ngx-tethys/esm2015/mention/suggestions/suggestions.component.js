import { Component, HostBinding, ElementRef, NgZone } from '@angular/core';
import { Subject, Observable, of } from 'rxjs';
import { debounceTime, switchMap, catchError, take } from 'rxjs/operators';
import { ThyPopoverRef } from 'ngx-tethys/popover';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from 'ngx-tethys/popover';
import * as ɵngcc2 from 'ngx-tethys/loading';
import * as ɵngcc3 from '@angular/common';
import * as ɵngcc4 from 'ngx-tethys/list';
import * as ɵngcc5 from 'ngx-tethys/shared';

function ThyMentionSuggestionsComponent_ng_container_1_thy_selection_list_1_thy_list_option_1_ng_container_1_1_ng_template_0_Template(rf, ctx) { }
function ThyMentionSuggestionsComponent_ng_container_1_thy_selection_list_1_thy_list_option_1_ng_container_1_1_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵtemplate(0, ThyMentionSuggestionsComponent_ng_container_1_thy_selection_list_1_thy_list_option_1_ng_container_1_1_ng_template_0_Template, 0, 0, "ng-template");
} }
const _c0 = function (a0) { return { $implicit: a0 }; };
function ThyMentionSuggestionsComponent_ng_container_1_thy_selection_list_1_thy_list_option_1_ng_container_1_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementContainerStart(0);
    ɵngcc0.ɵɵtemplate(1, ThyMentionSuggestionsComponent_ng_container_1_thy_selection_list_1_thy_list_option_1_ng_container_1_1_Template, 1, 0, undefined, 9);
    ɵngcc0.ɵɵelementContainerEnd();
} if (rf & 2) {
    const item_r5 = ɵngcc0.ɵɵnextContext().$implicit;
    const ctx_r6 = ɵngcc0.ɵɵnextContext(3);
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("ngTemplateOutlet", ctx_r6.mention == null ? null : ctx_r6.mention.displayTemplateRef)("ngTemplateOutletContext", ɵngcc0.ɵɵpureFunction1(2, _c0, item_r5));
} }
function ThyMentionSuggestionsComponent_ng_container_1_thy_selection_list_1_thy_list_option_1_ng_template_2_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵtext(0);
} if (rf & 2) {
    const item_r5 = ɵngcc0.ɵɵnextContext().$implicit;
    ɵngcc0.ɵɵtextInterpolate1(" ", item_r5["name"] || "", " ");
} }
function ThyMentionSuggestionsComponent_ng_container_1_thy_selection_list_1_thy_list_option_1_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementStart(0, "thy-list-option", 6);
    ɵngcc0.ɵɵtemplate(1, ThyMentionSuggestionsComponent_ng_container_1_thy_selection_list_1_thy_list_option_1_ng_container_1_Template, 2, 4, "ng-container", 7);
    ɵngcc0.ɵɵtemplate(2, ThyMentionSuggestionsComponent_ng_container_1_thy_selection_list_1_thy_list_option_1_ng_template_2_Template, 1, 1, "ng-template", null, 8, ɵngcc0.ɵɵtemplateRefExtractor);
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const item_r5 = ctx.$implicit;
    const _r7 = ɵngcc0.ɵɵreference(3);
    const ctx_r4 = ɵngcc0.ɵɵnextContext(3);
    ɵngcc0.ɵɵproperty("thyValue", item_r5);
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("ngIf", ctx_r4.mention == null ? null : ctx_r4.mention.displayTemplateRef)("ngIfElse", _r7);
} }
function ThyMentionSuggestionsComponent_ng_container_1_thy_selection_list_1_Template(rf, ctx) { if (rf & 1) {
    const _r14 = ɵngcc0.ɵɵgetCurrentView();
    ɵngcc0.ɵɵelementStart(0, "thy-selection-list", 4);
    ɵngcc0.ɵɵlistener("thySelectionChange", function ThyMentionSuggestionsComponent_ng_container_1_thy_selection_list_1_Template_thy_selection_list_thySelectionChange_0_listener($event) { ɵngcc0.ɵɵrestoreView(_r14); const ctx_r13 = ɵngcc0.ɵɵnextContext(2); return ctx_r13.selectionChange($event); });
    ɵngcc0.ɵɵtemplate(1, ThyMentionSuggestionsComponent_ng_container_1_thy_selection_list_1_thy_list_option_1_Template, 4, 3, "thy-list-option", 5);
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const ctx_r3 = ɵngcc0.ɵɵnextContext(2);
    ɵngcc0.ɵɵproperty("thyScrollContainer", ctx_r3.elementRef);
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("ngForOf", ctx_r3.data);
} }
function ThyMentionSuggestionsComponent_ng_container_1_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementContainerStart(0);
    ɵngcc0.ɵɵtemplate(1, ThyMentionSuggestionsComponent_ng_container_1_thy_selection_list_1_Template, 2, 2, "thy-selection-list", 3);
    ɵngcc0.ɵɵelementContainerEnd();
} if (rf & 2) {
    const ctx_r0 = ɵngcc0.ɵɵnextContext();
    const _r1 = ɵngcc0.ɵɵreference(3);
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("ngIf", (ctx_r0.data == null ? null : ctx_r0.data.length) > 0)("ngIfElse", _r1);
} }
function ThyMentionSuggestionsComponent_ng_template_2_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementStart(0, "div", 10);
    ɵngcc0.ɵɵtext(1);
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const ctx_r2 = ɵngcc0.ɵɵnextContext();
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵtextInterpolate1(" ", ctx_r2.mention == null ? null : ctx_r2.mention.emptyText, " ");
} }
export class ThyMentionSuggestionsComponent {
    constructor(elementRef, ngZone, popoverRef) {
        this.elementRef = elementRef;
        this.ngZone = ngZone;
        this.popoverRef = popoverRef;
        this.suggestionSelect$ = new Subject();
        this.debounce = 150;
        this.loadingDone = true;
        this.search$ = new Subject();
        this.suggestionsClass = true;
        this.search$
            .pipe(switchMap(query => {
            const data = this.mention.search(query.term, this.mention.data);
            if (data instanceof Observable) {
                this.loadingDone = false;
                return data.pipe(debounceTime(this.debounce));
            }
            else {
                return of(data);
            }
        }), catchError(() => {
            this.loadingDone = false;
            return [];
        }))
            .subscribe(data => {
            this.loadingDone = true;
            this.data = data || [];
            if (this.popoverRef) {
                if (this.mention.autoClose && this.data.length === 0) {
                    this.popoverRef.close();
                }
                this.ngZone.onStable.pipe(take(1)).subscribe(() => {
                    this.popoverRef.updatePosition();
                });
            }
        });
    }
    ngOnInit() {
        if (this.mention.popoverClass) {
            this.elementRef.nativeElement.classList.add(this.mention.popoverClass);
        }
    }
    search(query) {
        this.search$.next(query);
    }
    select(item, event) {
        this.suggestionSelect$.next({
            event,
            item
        });
    }
    selectionChange(event) {
        this.select(event.value, event.event);
    }
    ngOnDestroy() {
        this.search$.next();
        this.search$.complete();
    }
}
ThyMentionSuggestionsComponent.ɵfac = function ThyMentionSuggestionsComponent_Factory(t) { return new (t || ThyMentionSuggestionsComponent)(ɵngcc0.ɵɵdirectiveInject(ɵngcc0.ElementRef), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.NgZone), ɵngcc0.ɵɵdirectiveInject(ɵngcc1.ThyPopoverRef)); };
ThyMentionSuggestionsComponent.ɵcmp = ɵngcc0.ɵɵdefineComponent({ type: ThyMentionSuggestionsComponent, selectors: [["thy-mention-suggestions"]], hostVars: 2, hostBindings: function ThyMentionSuggestionsComponent_HostBindings(rf, ctx) { if (rf & 2) {
        ɵngcc0.ɵɵclassProp("thy-mention-suggestions", ctx.suggestionsClass);
    } }, decls: 4, vars: 2, consts: [[3, "thyDone"], [4, "ngIf"], ["empty", ""], ["thyBindKeyEventContainer", "body", "thyMultiple", "false", "thyAutoActiveFirstItem", "true", "thySpaceKeyEnabled", "false", 3, "thyScrollContainer", "thySelectionChange", 4, "ngIf", "ngIfElse"], ["thyBindKeyEventContainer", "body", "thyMultiple", "false", "thyAutoActiveFirstItem", "true", "thySpaceKeyEnabled", "false", 3, "thyScrollContainer", "thySelectionChange"], [3, "thyValue", 4, "ngFor", "ngForOf"], [3, "thyValue"], [4, "ngIf", "ngIfElse"], ["default", ""], [4, "ngTemplateOutlet", "ngTemplateOutletContext"], [1, "text-desc", "p-3"]], template: function ThyMentionSuggestionsComponent_Template(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵelement(0, "thy-loading", 0);
        ɵngcc0.ɵɵtemplate(1, ThyMentionSuggestionsComponent_ng_container_1_Template, 2, 2, "ng-container", 1);
        ɵngcc0.ɵɵtemplate(2, ThyMentionSuggestionsComponent_ng_template_2_Template, 2, 1, "ng-template", null, 2, ɵngcc0.ɵɵtemplateRefExtractor);
    } if (rf & 2) {
        ɵngcc0.ɵɵproperty("thyDone", ctx.loadingDone);
        ɵngcc0.ɵɵadvance(1);
        ɵngcc0.ɵɵproperty("ngIf", ctx.loadingDone);
    } }, directives: [ɵngcc2.ThyLoadingComponent, ɵngcc3.NgIf, ɵngcc4.ThySelectionListComponent, ɵngcc3.NgForOf, ɵngcc5.ThyListOptionComponent, ɵngcc3.NgTemplateOutlet], encapsulation: 2 });
ThyMentionSuggestionsComponent.ctorParameters = () => [
    { type: ElementRef },
    { type: NgZone },
    { type: ThyPopoverRef }
];
ThyMentionSuggestionsComponent.propDecorators = {
    suggestionsClass: [{ type: HostBinding, args: ['class.thy-mention-suggestions',] }]
};
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(ThyMentionSuggestionsComponent, [{
        type: Component,
        args: [{
                selector: 'thy-mention-suggestions',
                template: "<thy-loading [thyDone]=\"loadingDone\"></thy-loading>\n<ng-container *ngIf=\"loadingDone\">\n  <thy-selection-list\n    *ngIf=\"data?.length > 0; else empty\"\n    thyBindKeyEventContainer=\"body\"\n    thyMultiple=\"false\"\n    thyAutoActiveFirstItem=\"true\"\n    thySpaceKeyEnabled=\"false\"\n    [thyScrollContainer]=\"elementRef\"\n    (thySelectionChange)=\"selectionChange($event)\"\n  >\n    <thy-list-option *ngFor=\"let item of data\" [thyValue]=\"item\">\n      <ng-container *ngIf=\"mention?.displayTemplateRef; else default\">\n        <ng-template *ngTemplateOutlet=\"mention?.displayTemplateRef; context: { $implicit: item }\"></ng-template>\n      </ng-container>\n      <ng-template #default>\n        {{ item['name'] || '' }}\n      </ng-template>\n    </thy-list-option>\n  </thy-selection-list>\n</ng-container>\n<ng-template #empty>\n  <div class=\"text-desc p-3\">\n    {{ mention?.emptyText }}\n  </div>\n</ng-template>\n"
            }]
    }], function () { return [{ type: ɵngcc0.ElementRef }, { type: ɵngcc0.NgZone }, { type: ɵngcc1.ThyPopoverRef }]; }, { suggestionsClass: [{
            type: HostBinding,
            args: ['class.thy-mention-suggestions']
        }] }); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3VnZ2VzdGlvbnMuY29tcG9uZW50LmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvbWVudGlvbi9zdWdnZXN0aW9ucy9zdWdnZXN0aW9ucy5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFNBQVMsRUFBcUIsV0FBVyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDOUYsT0FBTyxFQUFFLE9BQU8sRUFBRSxVQUFVLEVBQUUsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRy9DLE9BQU8sRUFBRSxZQUFZLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBRSxJQUFJLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUUzRSxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFNbkQsTUFBTSxPQUFPLDhCQUE4QjtBQUFHLElBZTFDLFlBQW1CLFVBQW1DLEVBQVUsTUFBYyxFQUFVLFVBQThCO0FBQzFILFFBRHVCLGVBQVUsR0FBVixVQUFVLENBQXlCO0FBQUMsUUFBUyxXQUFNLEdBQU4sTUFBTSxDQUFRO0FBQUMsUUFBUyxlQUFVLEdBQVYsVUFBVSxDQUFvQjtBQUFDLFFBVnZILHNCQUFpQixHQUFHLElBQUksT0FBTyxFQUFnQyxDQUFDO0FBQ3BFLFFBQ0ksYUFBUSxHQUFHLEdBQUcsQ0FBQztBQUNuQixRQUNJLGdCQUFXLEdBQUcsSUFBSSxDQUFDO0FBQ3ZCLFFBQ1ksWUFBTyxHQUFHLElBQUksT0FBTyxFQUFtQixDQUFDO0FBQ3JELFFBQ2tELHFCQUFnQixHQUFHLElBQUksQ0FBQztBQUMxRSxRQUVRLElBQUksQ0FBQyxPQUFPO0FBQ3BCLGFBQWEsSUFBSSxDQUNELFNBQVMsQ0FBQyxLQUFLLENBQUMsRUFBRTtBQUNsQyxZQUFvQixNQUFNLElB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TTtBQUFJLFlBTWpFLGFBQWE7QUFBRztBQUFHO0FBR2hCLCtCQWdCUCxXQUFXLFNBQUMsK0JBQStCO0FBQU07Ozs7Ozs7Ozs7b0JBQUU7QUFBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgT25Jbml0LCBPbkRlc3Ryb3ksIEhvc3RCaW5kaW5nLCBFbGVtZW50UmVmLCBOZ1pvbmUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFN1YmplY3QsIE9ic2VydmFibGUsIG9mIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBUaHlTZWxlY3Rpb25MaXN0Q2hhbmdlIH0gZnJvbSAnbmd4LXRldGh5cy9saXN0JztcbmltcG9ydCB7IE1lbnRpb25EZWZhdWx0RGF0YUl0ZW0sIE1lbnRpb24sIE1lbnRpb25TdWdnZXN0aW9uU2VsZWN0RXZlbnQgfSBmcm9tICcuLi9pbnRlcmZhY2VzJztcbmltcG9ydCB7IGRlYm91bmNlVGltZSwgc3dpdGNoTWFwLCBjYXRjaEVycm9yLCB0YWtlIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgU2Vla1F1ZXJ5UmVzdWx0IH0gZnJvbSAnLi4vYWRhcHRlci9hZGFwdGVyJztcbmltcG9ydCB7IFRoeVBvcG92ZXJSZWYgfSBmcm9tICduZ3gtdGV0aHlzL3BvcG92ZXInO1xuXG5AQ29tcG9uZW50KHtcbiAgICBzZWxlY3RvcjogJ3RoeS1tZW50aW9uLXN1Z2dlc3Rpb25zJyxcbiAgICB0ZW1wbGF0ZVVybDogJy4vc3VnZ2VzdGlvbnMuY29tcG9uZW50Lmh0bWwnXG59KVxuZXhwb3J0IGNsYXNzIFRoeU1lbnRpb25TdWdnZXN0aW9uc0NvbXBvbmVudDxUSXRlbSA9IE1lbnRpb25EZWZhdWx0RGF0YUl0ZW0+IGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3kge1xuICAgIGRhdGE6IFRJdGVtW107XG5cbiAgICBtZW50aW9uOiBNZW50aW9uPFRJdGVtPjtcblxuICAgIHN1Z2dlc3Rpb25TZWxlY3QkID0gbmV3IFN1YmplY3Q8TWVudGlvblN1Z2dlc3Rpb25TZWxlY3RFdmVudD4oKTtcblxuICAgIGRlYm91bmNlID0gMTUwO1xuXG4gICAgbG9hZGluZ0RvbmUgPSB0cnVlO1xuXG4gICAgcHJpdmF0ZSBzZWFyY2gkID0gbmV3IFN1YmplY3Q8U2Vla1F1ZXJ5UmVzdWx0PigpO1xuXG4gICAgQEhvc3RCaW5kaW5nKCdjbGFzcy50aHktbWVudGlvbi1zdWdnZXN0aW9ucycpIHN1Z2dlc3Rpb25zQ2xhc3MgPSB0cnVlO1xuXG4gICAgY29uc3RydWN0b3IocHVibGljIGVsZW1lbnRSZWY6IEVsZW1lbnRSZWY8SFRNTEVsZW1lbnQ+LCBwcml2YXRlIG5nWm9uZTogTmdab25lLCBwcml2YXRlIHBvcG92ZXJSZWY6IFRoeVBvcG92ZXJSZWY8YW55Pikge1xuICAgICAgICB0aGlzLnNlYXJjaCRcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIHN3aXRjaE1hcChxdWVyeSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGRhdGEgPSB0aGlzLm1lbnRpb24uc2VhcmNoKHF1ZXJ5LnRlcm0sIHRoaXMubWVudGlvbi5kYXRhKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGEgaW5zdGFuY2VvZiBPYnNlcnZhYmxlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxvYWRpbmdEb25lID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gKGRhdGEgYXMgT2JzZXJ2YWJsZTxUSXRlbVtdPikucGlwZShkZWJvdW5jZVRpbWUodGhpcy5kZWJvdW5jZSkpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9mKGRhdGEgYXMgVEl0ZW1bXSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2FkaW5nRG9uZSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gW107XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIClcbiAgICAgICAgICAgIC5zdWJzY3JpYmUoZGF0YSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5sb2FkaW5nRG9uZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgdGhpcy5kYXRhID0gZGF0YSB8fCBbXTtcblxuICAgICAgICAgICAgICAgIGlmICh0aGlzLnBvcG92ZXJSZWYpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMubWVudGlvbi5hdXRvQ2xvc2UgJiYgdGhpcy5kYXRhLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wb3BvdmVyUmVmLmNsb3NlKCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgdGhpcy5uZ1pvbmUub25TdGFibGUucGlwZSh0YWtlKDEpKS5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wb3BvdmVyUmVmLnVwZGF0ZVBvc2l0aW9uKCk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgIH1cblxuICAgIG5nT25Jbml0KCk6IHZvaWQge1xuICAgICAgICBpZiAodGhpcy5tZW50aW9uLnBvcG92ZXJDbGFzcykge1xuICAgICAgICAgICAgdGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQuY2xhc3NMaXN0LmFkZCh0aGlzLm1lbnRpb24ucG9wb3ZlckNsYXNzKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHNlYXJjaChxdWVyeTogU2Vla1F1ZXJ5UmVzdWx0KSB7XG4gICAgICAgIHRoaXMuc2VhcmNoJC5uZXh0KHF1ZXJ5KTtcbiAgICB9XG5cbiAgICBzZWxlY3QoaXRlbTogVEl0ZW0sIGV2ZW50OiBFdmVudCkge1xuICAgICAgICB0aGlzLnN1Z2dlc3Rpb25TZWxlY3QkLm5leHQoe1xuICAgICAgICAgICAgZXZlbnQsXG4gICAgICAgICAgICBpdGVtXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHNlbGVjdGlvbkNoYW5nZShldmVudDogVGh5U2VsZWN0aW9uTGlzdENoYW5nZTxUSXRlbT4pIHtcbiAgICAgICAgdGhpcy5zZWxlY3QoZXZlbnQudmFsdWUsIGV2ZW50LmV2ZW50KTtcbiAgICB9XG5cbiAgICBuZ09uRGVzdHJveSgpIHtcbiAgICAgICAgdGhpcy5zZWFyY2gkLm5leHQoKTtcbiAgICAgICAgdGhpcy5zZWFyY2gkLmNvbXBsZXRlKCk7XG4gICAgfVxufVxuIl19