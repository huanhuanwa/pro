import { Injectable, Injector, Optional, Inject } from '@angular/core';
import { of } from 'rxjs';
import { ComponentPortal } from '@angular/cdk/portal';
import { ThyDialogConfig, ThyDialogSizes, THY_DIALOG_DEFAULT_OPTIONS } from './dialog.config';
import { Overlay } from '@angular/cdk/overlay';
import { ThyDialogContainerComponent } from './dialog-container.component';
import { ThyDialogRef, ThyInternalDialogRef } from './dialog-ref';
import { Directionality } from '@angular/cdk/bidi';
import { ThyClickPositioner } from 'ngx-tethys/core';
import { ThyConfirmComponent } from './confirm/confirm.component';
import { ThyAbstractOverlayService } from 'ngx-tethys/core';
import { dialogUpperOverlayOptions } from './dialog.options';
import * as i0 from "@angular/core";
import * as i1 from "@angular/cdk/overlay";
import * as i2 from "./dialog.config";
import * as i3 from "ngx-tethys/core";
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@angular/cdk/overlay';
import * as ɵngcc2 from 'ngx-tethys/core';
import * as ɵngcc3 from './dialog.config';
export class ThyDialog extends ThyAbstractOverlayService {
    constructor(overlay, injector, defaultConfig, clickPositioner) {
        super(dialogUpperOverlayOptions, overlay, injector, defaultConfig);
        clickPositioner.initialize();
    }
    buildOverlayConfig(config) {
        const size = config.size || ThyDialogSizes.md;
        const overlayConfig = this.buildBaseOverlayConfig(config, [`dialog-${size}`]);
        overlayConfig.positionStrategy = this.overlay.position().global();
        overlayConfig.scrollStrategy = config.scrollStrategy || this.overlay.scrollStrategies.block();
        return overlayConfig;
    }
    attachUpperOverlayContainer(overlay, config) {
        const userInjector = config && config.viewContainerRef && config.viewContainerRef.injector;
        const injector = Injector.create({
            parent: userInjector || this.injector,
            providers: [{ provide: ThyDialogConfig, useValue: config }]
        });
        const containerPortal = new ComponentPortal(ThyDialogContainerComponent, config.viewContainerRef, injector);
        const containerRef = overlay.attach(containerPortal);
        return containerRef.instance;
    }
    createUpperOverlayRef(overlayRef, containerInstance, config) {
        return new ThyInternalDialogRef(overlayRef, containerInstance, config);
    }
    createInjector(config, dialogRef, dialogContainer) {
        const userInjector = config && config.viewContainerRef && config.viewContainerRef.injector;
        const injectionTokens = [
            { provide: ThyDialogContainerComponent, useValue: dialogContainer },
            {
                provide: ThyDialogRef,
                useValue: dialogRef
            }
        ];
        if (config.direction && (!userInjector || !userInjector.get(Directionality, null))) {
            injectionTokens.push({
                provide: Directionality,
                useValue: {
                    value: config.direction,
                    change: of()
                }
            });
        }
        return Injector.create({ parent: userInjector || this.injector, providers: injectionTokens });
    }
    open(componentOrTemplateRef, config) {
        const dialogRef = this.openUpperOverlay(componentOrTemplateRef, config);
        const dialogRefInternal = dialogRef;
        dialogRefInternal.updateSizeAndPosition(dialogRef.containerInstance.config.width, dialogRef.containerInstance.config.height, dialogRef.containerInstance.config.position);
        return dialogRef;
    }
    confirm(options) {
        return this.open(ThyConfirmComponent, {
            initialState: {
                options: options
            }
        });
    }
    getDialogById(id) {
        return this.getUpperOverlayById(id);
    }
    /**
     * Finds the closest ThyDialogRef to an element by looking at the DOM.
     */
    getClosestDialog(element) {
        let parent = element.parentElement;
        while (parent && !parent.classList.contains('thy-dialog-container')) {
            parent = parent.parentElement;
        }
        if (parent && parent.id) {
            return this.getDialogById(parent.id);
        }
        return null;
    }
    ngOnDestroy() {
        this.dispose();
    }
}
ThyDialog.ɵfac = function ThyDialog_Factory(t) { return new (t || ThyDialog)(ɵngcc0.ɵɵinject(ɵngcc1.Overlay), ɵngcc0.ɵɵinject(ɵngcc0.Injector), ɵngcc0.ɵɵinject(THY_DIALOG_DEFAULT_OPTIONS, 8), ɵngcc0.ɵɵinject(ɵngcc2.ThyClickPositioner)); };
ThyDialog.ɵprov = i0.ɵɵdefineInjectable({ factory: function ThyDialog_Factory() { return new ThyDialog(i0.ɵɵinject(i1.Overlay), i0.ɵɵinject(i0.INJECTOR), i0.ɵɵinject(i2.THY_DIALOG_DEFAULT_OPTIONS, 8), i0.ɵɵinject(i3.ThyClickPositioner)); }, token: ThyDialog, providedIn: "root" });
ThyDialog.ctorParameters = () => [
    { type: Overlay },
    { type: Injector },
    { type: ThyDialogConfig, decorators: [{ type: Optional }, { type: Inject, args: [THY_DIALOG_DEFAULT_OPTIONS,] }] },
    { type: ThyClickPositioner }
];
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(ThyDialog, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], function () { return [{ type: ɵngcc1.Overlay }, { type: ɵngcc0.Injector }, { type: ɵngcc3.ThyDialogConfig, decorators: [{
                type: Optional
            }, {
                type: Inject,
                args: [THY_DIALOG_DEFAULT_OPTIONS]
            }] }, { type: ɵngcc2.ThyClickPositioner }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGlhbG9nLnNlcnZpY2UuanMiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9kaWFsb2cvZGlhbG9nLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBZSxRQUFRLEVBQUUsUUFBUSxFQUFhLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUUvRixPQUFPLEVBQUUsRUFBRSxFQUFXLE1BQU0sTUFBTSxDQUFDO0FBQ25DLE9BQU8sRUFBaUIsZUFBZSxFQUFrQixNQUFNLHFCQUFxQixDQUFDO0FBQ3JGLE9BQU8sRUFBRSxlQUFlLEVBQUUsY0FBYyxFQUFFLDBCQUEwQixFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDOUYsT0FBTyxFQUFFLE9BQU8sRUFBNkMsTUFBTSxzQkFBc0IsQ0FBQztBQUMxRixPQUFPLEVBQUUsMkJBQTJCLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUMzRSxPQUFPLEVBQUUsWUFBWSxFQUFFLG9CQUFvQixFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQ2xFLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUVuRCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUNyRCxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQUVsRSxPQUFPLEVBQUUseUJBQXlCLEVBQXlCLE1BQU0saUJBQWlCLENBQUM7QUFDbkYsT0FBTyxFQUFFLHlCQUF5QixFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDN0Q7QUFBcUM7QUFHbkI7QUFFYTs7Ozs7QUFBL0IsTUFBTSxPQUFPLFNBQVUsU0FBUSx5QkFBdUU7QUFBRyxJQXlEckcsWUFDSSxPQUFnQixFQUNoQixRQUFrQixFQUdsQixhQUE4QixFQUM5QixlQUFtQztBQUN4QyxRQUNLLEtBQUssQ0FBQyx5QkFBeUIsRUFBRSxPQUFPLEVBQUUsUUFBUSxFQUFFLGFBQWEsQ0FBQyxDQUFDO0FBQzNFLFFBQVEs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QUMsYUFBYSxDQUFDO0FBQzFDLFNBQVM7QUFDVCxRQUFRLElBQUksTUFBTSxJQUFJLE1BQU0sQ0FBQyxFQUFFLEVBQUU7QUFDakMsWUFBWSxPQUFPLElBQUksQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQ2pELFNBQVM7QUFDVCxRQUFRLE9BQU8sSUFBSSxDQUFDO0FBQ3BCLElBQUksQ0FBQztBQUNMLElBQ0ksV0FBVztBQUNmLFFBQVEsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO0FBQ3ZCLElBQUksQ0FBQztBQUNMOytPQUFDO0FBQ0QseVJBbEhLO0FBQUM7RUFITCxVQUFVLFNBQUMsckJBRzZCLFlBZmhDLE9BQU87Z0JBYVosaEJBYmdCLFlBTGMsUUFBUTtFQWtCNUIsRUFBRSxNQUFNLGNBQ3JCLHhCQW5CNkMsWUFJckMsZUFBZSx1QkE0RWYsUUFBUSxZQUNSLE1BQU0sU0FBQywwQkFBMEI7QUFDbkMsWUF4RUUsa0JBQWtCO0FBQUc7Ozs7Ozs7Ozs7O3VFQUFFO0FBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBUZW1wbGF0ZVJlZiwgSW5qZWN0b3IsIE9wdGlvbmFsLCBPbkRlc3Ryb3ksIEluamVjdCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgTG9jYXRpb24gfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuaW1wb3J0IHsgb2YsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IENvbXBvbmVudFR5cGUsIENvbXBvbmVudFBvcnRhbCwgVGVtcGxhdGVQb3J0YWwgfSBmcm9tICdAYW5ndWxhci9jZGsvcG9ydGFsJztcbmltcG9ydCB7IFRoeURpYWxvZ0NvbmZpZywgVGh5RGlhbG9nU2l6ZXMsIFRIWV9ESUFMT0dfREVGQVVMVF9PUFRJT05TIH0gZnJvbSAnLi9kaWFsb2cuY29uZmlnJztcbmltcG9ydCB7IE92ZXJsYXksIE92ZXJsYXlDb25maWcsIE92ZXJsYXlSZWYsIFNjcm9sbFN0cmF0ZWd5IH0gZnJvbSAnQGFuZ3VsYXIvY2RrL292ZXJsYXknO1xuaW1wb3J0IHsgVGh5RGlhbG9nQ29udGFpbmVyQ29tcG9uZW50IH0gZnJvbSAnLi9kaWFsb2ctY29udGFpbmVyLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBUaHlEaWFsb2dSZWYsIFRoeUludGVybmFsRGlhbG9nUmVmIH0gZnJvbSAnLi9kaWFsb2ctcmVmJztcbmltcG9ydCB7IERpcmVjdGlvbmFsaXR5IH0gZnJvbSAnQGFuZ3VsYXIvY2RrL2JpZGknO1xuaW1wb3J0IHsgaGVscGVycyB9IGZyb20gJ25neC10ZXRoeXMvdXRpbCc7XG5pbXBvcnQgeyBUaHlDbGlja1Bvc2l0aW9uZXIgfSBmcm9tICduZ3gtdGV0aHlzL2NvcmUnO1xuaW1wb3J0IHsgVGh5Q29uZmlybUNvbXBvbmVudCB9IGZyb20gJy4vY29uZmlybS9jb25maXJtLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBUaHlDb25maXJtQ29uZmlnIH0gZnJvbSAnLi9jb25maXJtLmNvbmZpZyc7XG5pbXBvcnQgeyBUaHlBYnN0cmFjdE92ZXJsYXlTZXJ2aWNlLCBUaHlBYnN0cmFjdE92ZXJsYXlSZWYgfSBmcm9tICduZ3gtdGV0aHlzL2NvcmUnO1xuaW1wb3J0IHsgZGlhbG9nVXBwZXJPdmVybGF5T3B0aW9ucyB9IGZyb20gJy4vZGlhbG9nLm9wdGlvbnMnO1xuaW1wb3J0IHsgU3RhdGljUHJvdmlkZXIgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuQEluamVjdGFibGUoe1xuICAgIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBUaHlEaWFsb2cgZXh0ZW5kcyBUaHlBYnN0cmFjdE92ZXJsYXlTZXJ2aWNlPFRoeURpYWxvZ0NvbmZpZywgVGh5RGlhbG9nQ29udGFpbmVyQ29tcG9uZW50PiBpbXBsZW1lbnRzIE9uRGVzdHJveSB7XG4gICAgcHJvdGVjdGVkIGJ1aWxkT3ZlcmxheUNvbmZpZyhjb25maWc6IFRoeURpYWxvZ0NvbmZpZzxhbnk+KTogT3ZlcmxheUNvbmZpZyB7XG4gICAgICAgIGNvbnN0IHNpemUgPSBjb25maWcuc2l6ZSB8fCBUaHlEaWFsb2dTaXplcy5tZDtcbiAgICAgICAgY29uc3Qgb3ZlcmxheUNvbmZpZyA9IHRoaXMuYnVpbGRCYXNlT3ZlcmxheUNvbmZpZyhjb25maWcsIFtgZGlhbG9nLSR7c2l6ZX1gXSk7XG4gICAgICAgIG92ZXJsYXlDb25maWcucG9zaXRpb25TdHJhdGVneSA9IHRoaXMub3ZlcmxheS5wb3NpdGlvbigpLmdsb2JhbCgpO1xuICAgICAgICBvdmVybGF5Q29uZmlnLnNjcm9sbFN0cmF0ZWd5ID0gY29uZmlnLnNjcm9sbFN0cmF0ZWd5IHx8IHRoaXMub3ZlcmxheS5zY3JvbGxTdHJhdGVnaWVzLmJsb2NrKCk7XG4gICAgICAgIHJldHVybiBvdmVybGF5Q29uZmlnO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBhdHRhY2hVcHBlck92ZXJsYXlDb250YWluZXIob3ZlcmxheTogT3ZlcmxheVJlZiwgY29uZmlnOiBUaHlEaWFsb2dDb25maWc8YW55Pik6IFRoeURpYWxvZ0NvbnRhaW5lckNvbXBvbmVudCB7XG4gICAgICAgIGNvbnN0IHVzZXJJbmplY3RvciA9IGNvbmZpZyAmJiBjb25maWcudmlld0NvbnRhaW5lclJlZiAmJiBjb25maWcudmlld0NvbnRhaW5lclJlZi5pbmplY3RvcjtcbiAgICAgICAgY29uc3QgaW5qZWN0b3IgPSBJbmplY3Rvci5jcmVhdGUoe1xuICAgICAgICAgICAgcGFyZW50OiB1c2VySW5qZWN0b3IgfHwgdGhpcy5pbmplY3RvcixcbiAgICAgICAgICAgIHByb3ZpZGVyczogW3sgcHJvdmlkZTogVGh5RGlhbG9nQ29uZmlnLCB1c2VWYWx1ZTogY29uZmlnIH1dXG4gICAgICAgIH0pO1xuICAgICAgICBjb25zdCBjb250YWluZXJQb3J0YWwgPSBuZXcgQ29tcG9uZW50UG9ydGFsKFRoeURpYWxvZ0NvbnRhaW5lckNvbXBvbmVudCwgY29uZmlnLnZpZXdDb250YWluZXJSZWYsIGluamVjdG9yKTtcbiAgICAgICAgY29uc3QgY29udGFpbmVyUmVmID0gb3ZlcmxheS5hdHRhY2g8VGh5RGlhbG9nQ29udGFpbmVyQ29tcG9uZW50Pihjb250YWluZXJQb3J0YWwpO1xuXG4gICAgICAgIHJldHVybiBjb250YWluZXJSZWYuaW5zdGFuY2U7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGNyZWF0ZVVwcGVyT3ZlcmxheVJlZjxUPihcbiAgICAgICAgb3ZlcmxheVJlZjogT3ZlcmxheVJlZixcbiAgICAgICAgY29udGFpbmVySW5zdGFuY2U6IFRoeURpYWxvZ0NvbnRhaW5lckNvbXBvbmVudCxcbiAgICAgICAgY29uZmlnOiBUaHlEaWFsb2dDb25maWc8YW55PlxuICAgICk6IFRoeUFic3RyYWN0T3ZlcmxheVJlZjxULCBhbnk+IHtcbiAgICAgICAgcmV0dXJuIG5ldyBUaHlJbnRlcm5hbERpYWxvZ1JlZihvdmVybGF5UmVmLCBjb250YWluZXJJbnN0YW5jZSwgY29uZmlnKTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgY3JlYXRlSW5qZWN0b3I8VD4oXG4gICAgICAgIGNvbmZpZzogVGh5RGlhbG9nQ29uZmlnLFxuICAgICAgICBkaWFsb2dSZWY6IFRoeURpYWxvZ1JlZjxUPixcbiAgICAgICAgZGlhbG9nQ29udGFpbmVyOiBUaHlEaWFsb2dDb250YWluZXJDb21wb25lbnRcbiAgICApOiBJbmplY3RvciB7XG4gICAgICAgIGNvbnN0IHVzZXJJbmplY3RvciA9IGNvbmZpZyAmJiBjb25maWcudmlld0NvbnRhaW5lclJlZiAmJiBjb25maWcudmlld0NvbnRhaW5lclJlZi5pbmplY3RvcjtcblxuICAgICAgICBjb25zdCBpbmplY3Rpb25Ub2tlbnM6IFN0YXRpY1Byb3ZpZGVyW10gPSBbXG4gICAgICAgICAgICB7IHByb3ZpZGU6IFRoeURpYWxvZ0NvbnRhaW5lckNvbXBvbmVudCwgdXNlVmFsdWU6IGRpYWxvZ0NvbnRhaW5lciB9LFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIHByb3ZpZGU6IFRoeURpYWxvZ1JlZixcbiAgICAgICAgICAgICAgICB1c2VWYWx1ZTogZGlhbG9nUmVmXG4gICAgICAgICAgICB9XG4gICAgICAgIF07XG5cbiAgICAgICAgaWYgKGNvbmZpZy5kaXJlY3Rpb24gJiYgKCF1c2VySW5qZWN0b3IgfHwgIXVzZXJJbmplY3Rvci5nZXQ8RGlyZWN0aW9uYWxpdHkgfCBudWxsPihEaXJlY3Rpb25hbGl0eSwgbnVsbCkpKSB7XG4gICAgICAgICAgICBpbmplY3Rpb25Ub2tlbnMucHVzaCh7XG4gICAgICAgICAgICAgICAgcHJvdmlkZTogRGlyZWN0aW9uYWxpdHksXG4gICAgICAgICAgICAgICAgdXNlVmFsdWU6IHtcbiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGNvbmZpZy5kaXJlY3Rpb24sXG4gICAgICAgICAgICAgICAgICAgIGNoYW5nZTogb2YoKVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIEluamVjdG9yLmNyZWF0ZSh7IHBhcmVudDogdXNlckluamVjdG9yIHx8IHRoaXMuaW5qZWN0b3IsIHByb3ZpZGVyczogaW5qZWN0aW9uVG9rZW5zIH0pO1xuICAgIH1cblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBvdmVybGF5OiBPdmVybGF5LFxuICAgICAgICBpbmplY3RvcjogSW5qZWN0b3IsXG4gICAgICAgIEBPcHRpb25hbCgpXG4gICAgICAgIEBJbmplY3QoVEhZX0RJQUxPR19ERUZBVUxUX09QVElPTlMpXG4gICAgICAgIGRlZmF1bHRDb25maWc6IFRoeURpYWxvZ0NvbmZpZyxcbiAgICAgICAgY2xpY2tQb3NpdGlvbmVyOiBUaHlDbGlja1Bvc2l0aW9uZXJcbiAgICApIHtcbiAgICAgICAgc3VwZXIoZGlhbG9nVXBwZXJPdmVybGF5T3B0aW9ucywgb3ZlcmxheSwgaW5qZWN0b3IsIGRlZmF1bHRDb25maWcpO1xuICAgICAgICBjbGlja1Bvc2l0aW9uZXIuaW5pdGlhbGl6ZSgpO1xuICAgIH1cblxuICAgIG9wZW48VCwgVERhdGEgPSBhbnksIFRSZXN1bHQgPSBhbnk+KFxuICAgICAgICBjb21wb25lbnRPclRlbXBsYXRlUmVmOiBDb21wb25lbnRUeXBlPFQ+IHwgVGVtcGxhdGVSZWY8VD4sXG4gICAgICAgIGNvbmZpZz86IFRoeURpYWxvZ0NvbmZpZzxURGF0YT5cbiAgICApOiBUaHlEaWFsb2dSZWY8VCwgVFJlc3VsdD4ge1xuICAgICAgICBjb25zdCBkaWFsb2dSZWYgPSB0aGlzLm9wZW5VcHBlck92ZXJsYXkoY29tcG9uZW50T3JUZW1wbGF0ZVJlZiwgY29uZmlnKTtcbiAgICAgICAgY29uc3QgZGlhbG9nUmVmSW50ZXJuYWwgPSBkaWFsb2dSZWYgYXMgVGh5SW50ZXJuYWxEaWFsb2dSZWY8VCwgVFJlc3VsdD47XG4gICAgICAgIGRpYWxvZ1JlZkludGVybmFsLnVwZGF0ZVNpemVBbmRQb3NpdGlvbihcbiAgICAgICAgICAgIGRpYWxvZ1JlZi5jb250YWluZXJJbnN0YW5jZS5jb25maWcud2lkdGgsXG4gICAgICAgICAgICBkaWFsb2dSZWYuY29udGFpbmVySW5zdGFuY2UuY29uZmlnLmhlaWdodCxcbiAgICAgICAgICAgIGRpYWxvZ1JlZi5jb250YWluZXJJbnN0YW5jZS5jb25maWcucG9zaXRpb25cbiAgICAgICAgKTtcbiAgICAgICAgcmV0dXJuIGRpYWxvZ1JlZiBhcyBUaHlEaWFsb2dSZWY8VCwgVFJlc3VsdD47XG4gICAgfVxuXG4gICAgY29uZmlybShvcHRpb25zOiBUaHlDb25maXJtQ29uZmlnKSB7XG4gICAgICAgIHJldHVybiB0aGlzLm9wZW4oVGh5Q29uZmlybUNvbXBvbmVudCwge1xuICAgICAgICAgICAgaW5pdGlhbFN0YXRlOiB7XG4gICAgICAgICAgICAgICAgb3B0aW9uczogb3B0aW9uc1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBnZXREaWFsb2dCeUlkKGlkOiBzdHJpbmcpOiBUaHlEaWFsb2dSZWY8YW55PiB8IHVuZGVmaW5lZCB7XG4gICAgICAgIHJldHVybiB0aGlzLmdldFVwcGVyT3ZlcmxheUJ5SWQoaWQpIGFzIFRoeURpYWxvZ1JlZjxhbnk+IHwgdW5kZWZpbmVkO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEZpbmRzIHRoZSBjbG9zZXN0IFRoeURpYWxvZ1JlZiB0byBhbiBlbGVtZW50IGJ5IGxvb2tpbmcgYXQgdGhlIERPTS5cbiAgICAgKi9cbiAgICBnZXRDbG9zZXN0RGlhbG9nKGVsZW1lbnQ6IEhUTUxFbGVtZW50KTogVGh5RGlhbG9nUmVmPGFueT4gfCB1bmRlZmluZWQge1xuICAgICAgICBsZXQgcGFyZW50OiBIVE1MRWxlbWVudCB8IG51bGwgPSBlbGVtZW50LnBhcmVudEVsZW1lbnQ7XG5cbiAgICAgICAgd2hpbGUgKHBhcmVudCAmJiAhcGFyZW50LmNsYXNzTGlzdC5jb250YWlucygndGh5LWRpYWxvZy1jb250YWluZXInKSkge1xuICAgICAgICAgICAgcGFyZW50ID0gcGFyZW50LnBhcmVudEVsZW1lbnQ7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHBhcmVudCAmJiBwYXJlbnQuaWQpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldERpYWxvZ0J5SWQocGFyZW50LmlkKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBuZ09uRGVzdHJveSgpIHtcbiAgICAgICAgdGhpcy5kaXNwb3NlKCk7XG4gICAgfVxufVxuIl19