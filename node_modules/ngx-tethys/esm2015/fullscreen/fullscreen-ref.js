import { coerceElement } from '@angular/cdk/coercion';
import { DOCUMENT } from '@angular/common';
import { Inject } from '@angular/core';
import { fromEvent, merge, Subject } from 'rxjs';
import { takeUntil } from 'rxjs/operators';
import { ThyFullscreenMode } from './fullscreen.config';
import { ESCAPE } from '@angular/cdk/keycodes';
export class ThyFullscreenRef {
    constructor(document) {
        this.document = document;
        this.isFullscreen = false;
        this.ngUnsubscribe$ = new Subject();
        this._afterLaunched = new Subject();
        this._afterExited = new Subject();
    }
    onFullscreenChange() {
        const isFullScreen = this.isImmersiveFullscreen();
        if (isFullScreen) {
            this.launchNormalFullscreen();
        }
        else {
            this.exitNormalFullscreen();
        }
    }
    resetElement(element) {
        const targetType = typeof element;
        if (targetType === 'string') {
            return this.document.querySelector(`.${element}`);
        }
        else {
            return coerceElement(element);
        }
    }
    isImmersiveFullscreen() {
        const doc = this.document;
        return !!(doc['fullscreenElement'] || doc['mozFullScreenElement'] || doc['webkitFullscreenElement'] || doc['msFullscreenElement']);
    }
    handleKeyDown(event) {
        if (event.keyCode === ESCAPE) {
            if (this.isFullscreen && this.fullscreenConfig.mode === ThyFullscreenMode.emulated) {
                this.exitNormalFullscreen();
            }
        }
    }
    launchNormalFullscreen() {
        const targetElement = this.resetElement(this.fullscreenConfig.target);
        const classes = this.fullscreenConfig.targetLaunchededClasse;
        const container = this.fullscreenConfig.emulatedContainer;
        if (container) {
            const containerElement = this.resetElement(container);
            const containerClientRect = containerElement.getBoundingClientRect();
            const targetClientRect = targetElement.getBoundingClientRect();
            const distanceX = containerClientRect.left - targetClientRect.left;
            const distanceY = containerClientRect.top - targetClientRect.top;
            targetElement.style.transform = `translate(${distanceX}px, ${distanceY}px)`;
            targetElement.style.width = `${containerClientRect.width}px`;
            targetElement.style.height = `${containerClientRect.height}px`;
        }
        else {
            targetElement.classList.add('thy-fullscreen');
        }
        targetElement.classList.add('thy-fullscreen-active');
        if (classes && classes.length) {
            targetElement.classList.add(classes);
        }
        this.isFullscreen = true;
        this._afterLaunched.next();
    }
    exitNormalFullscreen() {
        const targetElement = this.resetElement(this.fullscreenConfig.target);
        const classes = this.fullscreenConfig.targetLaunchededClasse;
        const container = this.fullscreenConfig.emulatedContainer;
        if (container) {
            targetElement.style.transform = ``;
            targetElement.style.width = ``;
            targetElement.style.height = ``;
        }
        else {
            targetElement.classList.remove('thy-fullscreen');
        }
        targetElement.classList.remove('thy-fullscreen-active');
        if (classes && classes.length) {
            targetElement.classList.remove(classes);
        }
        this.isFullscreen = false;
        this._afterExited.next();
        this.ngUnsubscribe$.next();
        this.ngUnsubscribe$.complete();
    }
    launchImmersiveFullscreen() {
        const docElement = this.document.documentElement;
        if (docElement.requestFullscreen) {
            docElement.requestFullscreen();
        }
        else if (docElement['mozRequestFullScreen']) {
            docElement['mozRequestFullScreen']();
        }
        else if (docElement['webkitRequestFullscreen']) {
            docElement['webkitRequestFullscreen']();
        }
        else if (docElement['msRequestFullscreen']) {
            docElement['msRequestFullscreen']();
        }
    }
    exitImmersiveFullscreen() {
        const doc = this.document;
        if (doc['exitFullscreen']) {
            doc['exitFullscreen']();
        }
        else if (doc['mozCancelFullScreen']) {
            doc['mozCancelFullScreen']();
        }
        else if (doc['webkitExitFullscreen']) {
            doc['webkitExitFullscreen']();
        }
        else if (doc['msExitFullscreen']) {
            doc['msExitFullscreen']();
        }
    }
    launch() {
        if (this.fullscreenConfig.mode === ThyFullscreenMode.immersive) {
            merge(fromEvent(this.document, 'fullscreenchange'), fromEvent(this.document, 'MSFullscreenChange'), fromEvent(this.document, 'webkitfullscreenchange'))
                .pipe(takeUntil(this.ngUnsubscribe$))
                .subscribe(() => {
                this.onFullscreenChange();
            });
            this.launchImmersiveFullscreen();
        }
        else {
            fromEvent(this.document, 'keydown')
                .pipe(takeUntil(this.ngUnsubscribe$))
                .subscribe(event => {
                this.handleKeyDown(event);
            });
            this.launchNormalFullscreen();
        }
    }
    exit() {
        if (this.fullscreenConfig.mode === ThyFullscreenMode.immersive) {
            this.exitImmersiveFullscreen();
        }
        else {
            this.exitNormalFullscreen();
        }
    }
    afterLaunched() {
        return this._afterLaunched.asObservable();
    }
    afterExited() {
        return this._afterExited.asObservable();
    }
}
ThyFullscreenRef.ctorParameters = () => [
    { type: undefined, decorators: [{ type: Inject, args: [DOCUMENT,] }] }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZnVsbHNjcmVlbi1yZWYuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvZnVsbHNjcmVlbi9mdWxsc2NyZWVuLXJlZi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDdEQsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzNDLE9BQU8sRUFBYyxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDbkQsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQWMsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzdELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMzQyxPQUFPLEVBQXVCLGlCQUFpQixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDN0UsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBRS9DLE1BQU0sT0FBTyxnQkFBZ0I7SUFXekIsWUFBd0MsUUFBYTtRQUFiLGFBQVEsR0FBUixRQUFRLENBQUs7UUFSN0MsaUJBQVksR0FBRyxLQUFLLENBQUM7UUFFckIsbUJBQWMsR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFDO1FBRXRCLG1CQUFjLEdBQUcsSUFBSSxPQUFPLEVBQVcsQ0FBQztRQUV4QyxpQkFBWSxHQUFHLElBQUksT0FBTyxFQUFXLENBQUM7SUFFQyxDQUFDO0lBRWpELGtCQUFrQjtRQUN0QixNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMscUJBQXFCLEVBQUUsQ0FBQztRQUNsRCxJQUFJLFlBQVksRUFBRTtZQUNkLElBQUksQ0FBQyxzQkFBc0IsRUFBRSxDQUFDO1NBQ2pDO2FBQU07WUFDSCxJQUFJLENBQUMsb0JBQW9CLEVBQUUsQ0FBQztTQUMvQjtJQUNMLENBQUM7SUFFTyxZQUFZLENBQUMsT0FBc0M7UUFDdkQsTUFBTSxVQUFVLEdBQUcsT0FBTyxPQUFPLENBQUM7UUFDbEMsSUFBSSxVQUFVLEtBQUssUUFBUSxFQUFFO1lBQ3pCLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQUMsSUFBSSxPQUFPLEVBQUUsQ0FBQyxDQUFDO1NBQ3JEO2FBQU07WUFDSCxPQUFPLGFBQWEsQ0FBQyxPQUFPLENBQUMsQ0FBQztTQUNqQztJQUNMLENBQUM7SUFFTyxxQkFBcUI7UUFDekIsTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQztRQUMxQixPQUFPLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxzQkFBc0IsQ0FBQyxJQUFJLEdBQUcsQ0FBQyx5QkFBeUIsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDLENBQUM7SUFDdkksQ0FBQztJQUVPLGFBQWEsQ0FBQyxLQUFvQjtRQUN0QyxJQUFJLEtBQUssQ0FBQyxPQUFPLEtBQUssTUFBTSxFQUFFO1lBQzFCLElBQUksSUFBSSxDQUFDLFlBQVksSUFBSSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxLQUFLLGlCQUFpQixDQUFDLFFBQVEsRUFBRTtnQkFDaEYsSUFBSSxDQUFDLG9CQUFvQixFQUFFLENBQUM7YUFDL0I7U0FDSjtJQUNMLENBQUM7SUFFTyxzQkFBc0I7UUFDMUIsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDdEUsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLHNCQUFzQixDQUFDO1FBQzdELE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxpQkFBaUIsQ0FBQztRQUMxRCxJQUFJLFNBQVMsRUFBRTtZQUNYLE1BQU0sZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUN0RCxNQUFNLG1CQUFtQixHQUFHLGdCQUFnQixDQUFDLHFCQUFxQixFQUFFLENBQUM7WUFDckUsTUFBTSxnQkFBZ0IsR0FBRyxhQUFhLENBQUMscUJBQXFCLEVBQUUsQ0FBQztZQUMvRCxNQUFNLFNBQVMsR0FBRyxtQkFBbUIsQ0FBQyxJQUFJLEdBQUcsZ0JBQWdCLENBQUMsSUFBSSxDQUFDO1lBQ25FLE1BQU0sU0FBUyxHQUFHLG1CQUFtQixDQUFDLEdBQUcsR0FBRyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUM7WUFDakUsYUFBYSxDQUFDLEtBQUssQ0FBQyxTQUFTLEdBQUcsYUFBYSxTQUFTLE9BQU8sU0FBUyxLQUFLLENBQUM7WUFDNUUsYUFBYSxDQUFDLEtBQUssQ0FBQyxLQUFLLEdBQUcsR0FBRyxtQkFBbUIsQ0FBQyxLQUFLLElBQUksQ0FBQztZQUM3RCxhQUFhLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxHQUFHLG1CQUFtQixDQUFDLE1BQU0sSUFBSSxDQUFDO1NBQ2xFO2FBQU07WUFDSCxhQUFhLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1NBQ2pEO1FBQ0QsYUFBYSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsdUJBQXVCLENBQUMsQ0FBQztRQUNyRCxJQUFJLE9BQU8sSUFBSSxPQUFPLENBQUMsTUFBTSxFQUFFO1lBQzNCLGFBQWEsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1NBQ3hDO1FBQ0QsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUM7UUFDekIsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUMvQixDQUFDO0lBRU8sb0JBQW9CO1FBQ3hCLE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ3RFLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxzQkFBc0IsQ0FBQztRQUM3RCxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsaUJBQWlCLENBQUM7UUFDMUQsSUFBSSxTQUFTLEVBQUU7WUFDWCxhQUFhLENBQUMsS0FBSyxDQUFDLFNBQVMsR0FBRyxFQUFFLENBQUM7WUFDbkMsYUFBYSxDQUFDLEtBQUssQ0FBQyxLQUFLLEdBQUcsRUFBRSxDQUFDO1lBQy9CLGFBQWEsQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLEVBQUUsQ0FBQztTQUNuQzthQUFNO1lBQ0gsYUFBYSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztTQUNwRDtRQUNELGFBQWEsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLHVCQUF1QixDQUFDLENBQUM7UUFDeEQsSUFBSSxPQUFPLElBQUksT0FBTyxDQUFDLE1BQU0sRUFBRTtZQUMzQixhQUFhLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQztTQUMzQztRQUVELElBQUksQ0FBQyxZQUFZLEdBQUcsS0FBSyxDQUFDO1FBQzFCLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFLENBQUM7UUFFekIsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUMzQixJQUFJLENBQUMsY0FBYyxDQUFDLFFBQVEsRUFBRSxDQUFDO0lBQ25DLENBQUM7SUFFUyx5QkFBeUI7UUFDL0IsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxlQUFlLENBQUM7UUFFakQsSUFBSSxVQUFVLENBQUMsaUJBQWlCLEVBQUU7WUFDOUIsVUFBVSxDQUFDLGlCQUFpQixFQUFFLENBQUM7U0FDbEM7YUFBTSxJQUFJLFVBQVUsQ0FBQyxzQkFBc0IsQ0FBQyxFQUFFO1lBQzNDLFVBQVUsQ0FBQyxzQkFBc0IsQ0FBQyxFQUFFLENBQUM7U0FDeEM7YUFBTSxJQUFJLFVBQVUsQ0FBQyx5QkFBeUIsQ0FBQyxFQUFFO1lBQzlDLFVBQVUsQ0FBQyx5QkFBeUIsQ0FBQyxFQUFFLENBQUM7U0FDM0M7YUFBTSxJQUFJLFVBQVUsQ0FBQyxxQkFBcUIsQ0FBQyxFQUFFO1lBQzFDLFVBQVUsQ0FBQyxxQkFBcUIsQ0FBQyxFQUFFLENBQUM7U0FDdkM7SUFDTCxDQUFDO0lBRVMsdUJBQXVCO1FBQzdCLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUM7UUFDMUIsSUFBSSxHQUFHLENBQUMsZ0JBQWdCLENBQUMsRUFBRTtZQUN2QixHQUFHLENBQUMsZ0JBQWdCLENBQUMsRUFBRSxDQUFDO1NBQzNCO2FBQU0sSUFBSSxHQUFHLENBQUMscUJBQXFCLENBQUMsRUFBRTtZQUNuQyxHQUFHLENBQUMscUJBQXFCLENBQUMsRUFBRSxDQUFDO1NBQ2hDO2FBQU0sSUFBSSxHQUFHLENBQUMsc0JBQXNCLENBQUMsRUFBRTtZQUNwQyxHQUFHLENBQUMsc0JBQXNCLENBQUMsRUFBRSxDQUFDO1NBQ2pDO2FBQU0sSUFBSSxHQUFHLENBQUMsa0JBQWtCLENBQUMsRUFBRTtZQUNoQyxHQUFHLENBQUMsa0JBQWtCLENBQUMsRUFBRSxDQUFDO1NBQzdCO0lBQ0wsQ0FBQztJQUVELE1BQU07UUFDRixJQUFJLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLEtBQUssaUJBQWlCLENBQUMsU0FBUyxFQUFFO1lBQzVELEtBQUssQ0FDRCxTQUFTLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxrQkFBa0IsQ0FBQyxFQUM1QyxTQUFTLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxvQkFBb0IsQ0FBQyxFQUM5QyxTQUFTLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSx3QkFBd0IsQ0FBQyxDQUNyRDtpQkFDSSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQztpQkFDcEMsU0FBUyxDQUFDLEdBQUcsRUFBRTtnQkFDWixJQUFJLENBQUMsa0JBQWtCLEVBQUUsQ0FBQztZQUM5QixDQUFDLENBQUMsQ0FBQztZQUNQLElBQUksQ0FBQyx5QkFBeUIsRUFBRSxDQUFDO1NBQ3BDO2FBQU07WUFDSCxTQUFTLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxTQUFTLENBQUM7aUJBQzlCLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDO2lCQUNwQyxTQUFTLENBQUMsS0FBSyxDQUFDLEVBQUU7Z0JBQ2YsSUFBSSxDQUFDLGFBQWEsQ0FBQyxLQUFzQixDQUFDLENBQUM7WUFDL0MsQ0FBQyxDQUFDLENBQUM7WUFDUCxJQUFJLENBQUMsc0JBQXNCLEVBQUUsQ0FBQztTQUNqQztJQUNMLENBQUM7SUFFRCxJQUFJO1FBQ0EsSUFBSSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxLQUFLLGlCQUFpQixDQUFDLFNBQVMsRUFBRTtZQUM1RCxJQUFJLENBQUMsdUJBQXVCLEVBQUUsQ0FBQztTQUNsQzthQUFNO1lBQ0gsSUFBSSxDQUFDLG9CQUFvQixFQUFFLENBQUM7U0FDL0I7SUFDTCxDQUFDO0lBRUQsYUFBYTtRQUNULE9BQU8sSUFBSSxDQUFDLGNBQWMsQ0FBQyxZQUFZLEVBQUUsQ0FBQztJQUM5QyxDQUFDO0lBRUQsV0FBVztRQUNQLE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxZQUFZLEVBQUUsQ0FBQztJQUM1QyxDQUFDOzs7NENBL0lZLE1BQU0sU0FBQyxRQUFRIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgY29lcmNlRWxlbWVudCB9IGZyb20gJ0Bhbmd1bGFyL2Nkay9jb2VyY2lvbic7XG5pbXBvcnQgeyBET0NVTUVOVCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5pbXBvcnQgeyBFbGVtZW50UmVmLCBJbmplY3QgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IGZyb21FdmVudCwgbWVyZ2UsIE9ic2VydmFibGUsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IHRha2VVbnRpbCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IFRoeUZ1bGxzY3JlZW5Db25maWcsIFRoeUZ1bGxzY3JlZW5Nb2RlIH0gZnJvbSAnLi9mdWxsc2NyZWVuLmNvbmZpZyc7XG5pbXBvcnQgeyBFU0NBUEUgfSBmcm9tICdAYW5ndWxhci9jZGsva2V5Y29kZXMnO1xuXG5leHBvcnQgY2xhc3MgVGh5RnVsbHNjcmVlblJlZjxUUmVzdWx0ID0gdW5rbm93bj4ge1xuICAgIGZ1bGxzY3JlZW5Db25maWc6IFRoeUZ1bGxzY3JlZW5Db25maWc7XG5cbiAgICBwcml2YXRlIGlzRnVsbHNjcmVlbiA9IGZhbHNlO1xuXG4gICAgcHJpdmF0ZSBuZ1Vuc3Vic2NyaWJlJCA9IG5ldyBTdWJqZWN0KCk7XG5cbiAgICBwcml2YXRlIHJlYWRvbmx5IF9hZnRlckxhdW5jaGVkID0gbmV3IFN1YmplY3Q8VFJlc3VsdD4oKTtcblxuICAgIHByaXZhdGUgcmVhZG9ubHkgX2FmdGVyRXhpdGVkID0gbmV3IFN1YmplY3Q8VFJlc3VsdD4oKTtcblxuICAgIGNvbnN0cnVjdG9yKEBJbmplY3QoRE9DVU1FTlQpIHByb3RlY3RlZCBkb2N1bWVudDogYW55KSB7fVxuXG4gICAgcHJpdmF0ZSBvbkZ1bGxzY3JlZW5DaGFuZ2UoKSB7XG4gICAgICAgIGNvbnN0IGlzRnVsbFNjcmVlbiA9IHRoaXMuaXNJbW1lcnNpdmVGdWxsc2NyZWVuKCk7XG4gICAgICAgIGlmIChpc0Z1bGxTY3JlZW4pIHtcbiAgICAgICAgICAgIHRoaXMubGF1bmNoTm9ybWFsRnVsbHNjcmVlbigpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5leGl0Tm9ybWFsRnVsbHNjcmVlbigpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSByZXNldEVsZW1lbnQoZWxlbWVudDogc3RyaW5nIHwgRWxlbWVudCB8IEVsZW1lbnRSZWYpIHtcbiAgICAgICAgY29uc3QgdGFyZ2V0VHlwZSA9IHR5cGVvZiBlbGVtZW50O1xuICAgICAgICBpZiAodGFyZ2V0VHlwZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYC4ke2VsZW1lbnR9YCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gY29lcmNlRWxlbWVudChlbGVtZW50KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgaXNJbW1lcnNpdmVGdWxsc2NyZWVuKCkge1xuICAgICAgICBjb25zdCBkb2MgPSB0aGlzLmRvY3VtZW50O1xuICAgICAgICByZXR1cm4gISEoZG9jWydmdWxsc2NyZWVuRWxlbWVudCddIHx8IGRvY1snbW96RnVsbFNjcmVlbkVsZW1lbnQnXSB8fCBkb2NbJ3dlYmtpdEZ1bGxzY3JlZW5FbGVtZW50J10gfHwgZG9jWydtc0Z1bGxzY3JlZW5FbGVtZW50J10pO1xuICAgIH1cblxuICAgIHByaXZhdGUgaGFuZGxlS2V5RG93bihldmVudDogS2V5Ym9hcmRFdmVudCkge1xuICAgICAgICBpZiAoZXZlbnQua2V5Q29kZSA9PT0gRVNDQVBFKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5pc0Z1bGxzY3JlZW4gJiYgdGhpcy5mdWxsc2NyZWVuQ29uZmlnLm1vZGUgPT09IFRoeUZ1bGxzY3JlZW5Nb2RlLmVtdWxhdGVkKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5leGl0Tm9ybWFsRnVsbHNjcmVlbigpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBsYXVuY2hOb3JtYWxGdWxsc2NyZWVuKCkge1xuICAgICAgICBjb25zdCB0YXJnZXRFbGVtZW50ID0gdGhpcy5yZXNldEVsZW1lbnQodGhpcy5mdWxsc2NyZWVuQ29uZmlnLnRhcmdldCk7XG4gICAgICAgIGNvbnN0IGNsYXNzZXMgPSB0aGlzLmZ1bGxzY3JlZW5Db25maWcudGFyZ2V0TGF1bmNoZWRlZENsYXNzZTtcbiAgICAgICAgY29uc3QgY29udGFpbmVyID0gdGhpcy5mdWxsc2NyZWVuQ29uZmlnLmVtdWxhdGVkQ29udGFpbmVyO1xuICAgICAgICBpZiAoY29udGFpbmVyKSB7XG4gICAgICAgICAgICBjb25zdCBjb250YWluZXJFbGVtZW50ID0gdGhpcy5yZXNldEVsZW1lbnQoY29udGFpbmVyKTtcbiAgICAgICAgICAgIGNvbnN0IGNvbnRhaW5lckNsaWVudFJlY3QgPSBjb250YWluZXJFbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xuICAgICAgICAgICAgY29uc3QgdGFyZ2V0Q2xpZW50UmVjdCA9IHRhcmdldEVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG4gICAgICAgICAgICBjb25zdCBkaXN0YW5jZVggPSBjb250YWluZXJDbGllbnRSZWN0LmxlZnQgLSB0YXJnZXRDbGllbnRSZWN0LmxlZnQ7XG4gICAgICAgICAgICBjb25zdCBkaXN0YW5jZVkgPSBjb250YWluZXJDbGllbnRSZWN0LnRvcCAtIHRhcmdldENsaWVudFJlY3QudG9wO1xuICAgICAgICAgICAgdGFyZ2V0RWxlbWVudC5zdHlsZS50cmFuc2Zvcm0gPSBgdHJhbnNsYXRlKCR7ZGlzdGFuY2VYfXB4LCAke2Rpc3RhbmNlWX1weClgO1xuICAgICAgICAgICAgdGFyZ2V0RWxlbWVudC5zdHlsZS53aWR0aCA9IGAke2NvbnRhaW5lckNsaWVudFJlY3Qud2lkdGh9cHhgO1xuICAgICAgICAgICAgdGFyZ2V0RWxlbWVudC5zdHlsZS5oZWlnaHQgPSBgJHtjb250YWluZXJDbGllbnRSZWN0LmhlaWdodH1weGA7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0YXJnZXRFbGVtZW50LmNsYXNzTGlzdC5hZGQoJ3RoeS1mdWxsc2NyZWVuJyk7XG4gICAgICAgIH1cbiAgICAgICAgdGFyZ2V0RWxlbWVudC5jbGFzc0xpc3QuYWRkKCd0aHktZnVsbHNjcmVlbi1hY3RpdmUnKTtcbiAgICAgICAgaWYgKGNsYXNzZXMgJiYgY2xhc3Nlcy5sZW5ndGgpIHtcbiAgICAgICAgICAgIHRhcmdldEVsZW1lbnQuY2xhc3NMaXN0LmFkZChjbGFzc2VzKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmlzRnVsbHNjcmVlbiA9IHRydWU7XG4gICAgICAgIHRoaXMuX2FmdGVyTGF1bmNoZWQubmV4dCgpO1xuICAgIH1cblxuICAgIHByaXZhdGUgZXhpdE5vcm1hbEZ1bGxzY3JlZW4oKSB7XG4gICAgICAgIGNvbnN0IHRhcmdldEVsZW1lbnQgPSB0aGlzLnJlc2V0RWxlbWVudCh0aGlzLmZ1bGxzY3JlZW5Db25maWcudGFyZ2V0KTtcbiAgICAgICAgY29uc3QgY2xhc3NlcyA9IHRoaXMuZnVsbHNjcmVlbkNvbmZpZy50YXJnZXRMYXVuY2hlZGVkQ2xhc3NlO1xuICAgICAgICBjb25zdCBjb250YWluZXIgPSB0aGlzLmZ1bGxzY3JlZW5Db25maWcuZW11bGF0ZWRDb250YWluZXI7XG4gICAgICAgIGlmIChjb250YWluZXIpIHtcbiAgICAgICAgICAgIHRhcmdldEVsZW1lbnQuc3R5bGUudHJhbnNmb3JtID0gYGA7XG4gICAgICAgICAgICB0YXJnZXRFbGVtZW50LnN0eWxlLndpZHRoID0gYGA7XG4gICAgICAgICAgICB0YXJnZXRFbGVtZW50LnN0eWxlLmhlaWdodCA9IGBgO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGFyZ2V0RWxlbWVudC5jbGFzc0xpc3QucmVtb3ZlKCd0aHktZnVsbHNjcmVlbicpO1xuICAgICAgICB9XG4gICAgICAgIHRhcmdldEVsZW1lbnQuY2xhc3NMaXN0LnJlbW92ZSgndGh5LWZ1bGxzY3JlZW4tYWN0aXZlJyk7XG4gICAgICAgIGlmIChjbGFzc2VzICYmIGNsYXNzZXMubGVuZ3RoKSB7XG4gICAgICAgICAgICB0YXJnZXRFbGVtZW50LmNsYXNzTGlzdC5yZW1vdmUoY2xhc3Nlcyk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmlzRnVsbHNjcmVlbiA9IGZhbHNlO1xuICAgICAgICB0aGlzLl9hZnRlckV4aXRlZC5uZXh0KCk7XG5cbiAgICAgICAgdGhpcy5uZ1Vuc3Vic2NyaWJlJC5uZXh0KCk7XG4gICAgICAgIHRoaXMubmdVbnN1YnNjcmliZSQuY29tcGxldGUoKTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgbGF1bmNoSW1tZXJzaXZlRnVsbHNjcmVlbigpIHtcbiAgICAgICAgY29uc3QgZG9jRWxlbWVudCA9IHRoaXMuZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50O1xuXG4gICAgICAgIGlmIChkb2NFbGVtZW50LnJlcXVlc3RGdWxsc2NyZWVuKSB7XG4gICAgICAgICAgICBkb2NFbGVtZW50LnJlcXVlc3RGdWxsc2NyZWVuKCk7XG4gICAgICAgIH0gZWxzZSBpZiAoZG9jRWxlbWVudFsnbW96UmVxdWVzdEZ1bGxTY3JlZW4nXSkge1xuICAgICAgICAgICAgZG9jRWxlbWVudFsnbW96UmVxdWVzdEZ1bGxTY3JlZW4nXSgpO1xuICAgICAgICB9IGVsc2UgaWYgKGRvY0VsZW1lbnRbJ3dlYmtpdFJlcXVlc3RGdWxsc2NyZWVuJ10pIHtcbiAgICAgICAgICAgIGRvY0VsZW1lbnRbJ3dlYmtpdFJlcXVlc3RGdWxsc2NyZWVuJ10oKTtcbiAgICAgICAgfSBlbHNlIGlmIChkb2NFbGVtZW50Wydtc1JlcXVlc3RGdWxsc2NyZWVuJ10pIHtcbiAgICAgICAgICAgIGRvY0VsZW1lbnRbJ21zUmVxdWVzdEZ1bGxzY3JlZW4nXSgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGV4aXRJbW1lcnNpdmVGdWxsc2NyZWVuKCkge1xuICAgICAgICBjb25zdCBkb2MgPSB0aGlzLmRvY3VtZW50O1xuICAgICAgICBpZiAoZG9jWydleGl0RnVsbHNjcmVlbiddKSB7XG4gICAgICAgICAgICBkb2NbJ2V4aXRGdWxsc2NyZWVuJ10oKTtcbiAgICAgICAgfSBlbHNlIGlmIChkb2NbJ21vekNhbmNlbEZ1bGxTY3JlZW4nXSkge1xuICAgICAgICAgICAgZG9jWydtb3pDYW5jZWxGdWxsU2NyZWVuJ10oKTtcbiAgICAgICAgfSBlbHNlIGlmIChkb2NbJ3dlYmtpdEV4aXRGdWxsc2NyZWVuJ10pIHtcbiAgICAgICAgICAgIGRvY1snd2Via2l0RXhpdEZ1bGxzY3JlZW4nXSgpO1xuICAgICAgICB9IGVsc2UgaWYgKGRvY1snbXNFeGl0RnVsbHNjcmVlbiddKSB7XG4gICAgICAgICAgICBkb2NbJ21zRXhpdEZ1bGxzY3JlZW4nXSgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgbGF1bmNoKCkge1xuICAgICAgICBpZiAodGhpcy5mdWxsc2NyZWVuQ29uZmlnLm1vZGUgPT09IFRoeUZ1bGxzY3JlZW5Nb2RlLmltbWVyc2l2ZSkge1xuICAgICAgICAgICAgbWVyZ2UoXG4gICAgICAgICAgICAgICAgZnJvbUV2ZW50KHRoaXMuZG9jdW1lbnQsICdmdWxsc2NyZWVuY2hhbmdlJyksXG4gICAgICAgICAgICAgICAgZnJvbUV2ZW50KHRoaXMuZG9jdW1lbnQsICdNU0Z1bGxzY3JlZW5DaGFuZ2UnKSxcbiAgICAgICAgICAgICAgICBmcm9tRXZlbnQodGhpcy5kb2N1bWVudCwgJ3dlYmtpdGZ1bGxzY3JlZW5jaGFuZ2UnKVxuICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgIC5waXBlKHRha2VVbnRpbCh0aGlzLm5nVW5zdWJzY3JpYmUkKSlcbiAgICAgICAgICAgICAgICAuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5vbkZ1bGxzY3JlZW5DaGFuZ2UoKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHRoaXMubGF1bmNoSW1tZXJzaXZlRnVsbHNjcmVlbigpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZnJvbUV2ZW50KHRoaXMuZG9jdW1lbnQsICdrZXlkb3duJylcbiAgICAgICAgICAgICAgICAucGlwZSh0YWtlVW50aWwodGhpcy5uZ1Vuc3Vic2NyaWJlJCkpXG4gICAgICAgICAgICAgICAgLnN1YnNjcmliZShldmVudCA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlS2V5RG93bihldmVudCBhcyBLZXlib2FyZEV2ZW50KTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHRoaXMubGF1bmNoTm9ybWFsRnVsbHNjcmVlbigpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgZXhpdCgpIHtcbiAgICAgICAgaWYgKHRoaXMuZnVsbHNjcmVlbkNvbmZpZy5tb2RlID09PSBUaHlGdWxsc2NyZWVuTW9kZS5pbW1lcnNpdmUpIHtcbiAgICAgICAgICAgIHRoaXMuZXhpdEltbWVyc2l2ZUZ1bGxzY3JlZW4oKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuZXhpdE5vcm1hbEZ1bGxzY3JlZW4oKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGFmdGVyTGF1bmNoZWQoKTogT2JzZXJ2YWJsZTxUUmVzdWx0PiB7XG4gICAgICAgIHJldHVybiB0aGlzLl9hZnRlckxhdW5jaGVkLmFzT2JzZXJ2YWJsZSgpO1xuICAgIH1cblxuICAgIGFmdGVyRXhpdGVkKCk6IE9ic2VydmFibGU8VFJlc3VsdD4ge1xuICAgICAgICByZXR1cm4gdGhpcy5fYWZ0ZXJFeGl0ZWQuYXNPYnNlcnZhYmxlKCk7XG4gICAgfVxufVxuIl19