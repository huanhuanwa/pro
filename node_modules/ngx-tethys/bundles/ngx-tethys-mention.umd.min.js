!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@angular/common"),require("@angular/forms"),require("ngx-tethys/popover"),require("rxjs"),require("rxjs/operators"),require("ngx-tethys/util"),require("ngx-tethys/list"),require("ngx-tethys/loading")):"function"==typeof define&&define.amd?define("ngx-tethys/mention",["exports","@angular/core","@angular/common","@angular/forms","ngx-tethys/popover","rxjs","rxjs/operators","ngx-tethys/util","ngx-tethys/list","ngx-tethys/loading"],t):t(((e="undefined"!=typeof globalThis?globalThis:e||self)["ngx-tethys"]=e["ngx-tethys"]||{},e["ngx-tethys"].mention={}),e.ng.core,e.ng.common,e.ng.forms,e["ngx-tethys"].popover,e.rxjs,e.rxjs.operators,e["ngx-tethys"].util,e["ngx-tethys"].list,e["ngx-tethys"].loading)}(this,(function(e,t,n,o,i,r,s,a,l,p){"use strict";var u=function(){function e(e,t,n){var o=this;this.elementRef=e,this.ngZone=t,this.popoverRef=n,this.suggestionSelect$=new r.Subject,this.debounce=150,this.loadingDone=!0,this.search$=new r.Subject,this.suggestionsClass=!0,this.search$.pipe(s.switchMap((function(e){var t=o.mention.search(e.term,o.mention.data);return t instanceof r.Observable?(o.loadingDone=!1,t.pipe(s.debounceTime(o.debounce))):r.of(t)})),s.catchError((function(){return o.loadingDone=!1,[]}))).subscribe((function(e){o.loadingDone=!0,o.data=e||[],o.popoverRef&&(o.mention.autoClose&&0===o.data.length&&o.popoverRef.close(),o.ngZone.onStable.pipe(s.take(1)).subscribe((function(){o.popoverRef.updatePosition()})))}))}return e.prototype.ngOnInit=function(){this.mention.popoverClass&&this.elementRef.nativeElement.classList.add(this.mention.popoverClass)},e.prototype.search=function(e){this.search$.next(e)},e.prototype.select=function(e,t){this.suggestionSelect$.next({event:t,item:e})},e.prototype.selectionChange=function(e){this.select(e.value,e.event)},e.prototype.ngOnDestroy=function(){this.search$.next(),this.search$.complete()},e}();u.decorators=[{type:t.Component,args:[{selector:"thy-mention-suggestions",template:'<thy-loading [thyDone]="loadingDone"></thy-loading>\n<ng-container *ngIf="loadingDone">\n  <thy-selection-list\n    *ngIf="data?.length > 0; else empty"\n    thyBindKeyEventContainer="body"\n    thyMultiple="false"\n    thyAutoActiveFirstItem="true"\n    thySpaceKeyEnabled="false"\n    [thyScrollContainer]="elementRef"\n    (thySelectionChange)="selectionChange($event)"\n  >\n    <thy-list-option *ngFor="let item of data" [thyValue]="item">\n      <ng-container *ngIf="mention?.displayTemplateRef; else default">\n        <ng-template *ngTemplateOutlet="mention?.displayTemplateRef; context: { $implicit: item }"></ng-template>\n      </ng-container>\n      <ng-template #default>\n        {{ item[\'name\'] || \'\' }}\n      </ng-template>\n    </thy-list-option>\n  </thy-selection-list>\n</ng-container>\n<ng-template #empty>\n  <div class="text-desc p-3">\n    {{ mention?.emptyText }}\n  </div>\n</ng-template>\n'}]}],u.ctorParameters=function(){return[{type:t.ElementRef},{type:t.NgZone},{type:i.ThyPopoverRef}]},u.propDecorators={suggestionsClass:[{type:t.HostBinding,args:["class.thy-mention-suggestions"]}]};var c=["direction","boxSizing","width","height","overflowX","overflowY","borderTopWidth","borderRightWidth","borderBottomWidth","borderLeftWidth","borderStyle","paddingTop","paddingRight","paddingBottom","paddingLeft","fontStyle","fontVariant","fontWeight","fontStretch","fontSize","fontSizeAdjust","lineHeight","fontFamily","textAlign","textTransform","textIndent","textDecoration","letterSpacing","wordSpacing","tabSize","MozTabSize"],h="undefined"!=typeof window,g=h&&null!=window.mozInnerScreenX,d=function(){function e(){}return e.getTextareaCaretCoordinates=function(e,t,n){if(!h)throw new Error("textarea-caret-position#getCaretCoordinates should only be called in a browser");var o=n&&n.debug||!1;if(o){var i=document.querySelector("#input-textarea-caret-position-mirror-div");i&&i.parentNode.removeChild(i)}var r=document.createElement("div");r.id="input-textarea-caret-position-mirror-div",document.body.appendChild(r);var s=r.style,a=window.getComputedStyle?window.getComputedStyle(e):e.currentStyle,l="INPUT"===e.nodeName;s.whiteSpace="pre-wrap",l||(s.wordWrap="break-word"),s.position="absolute",o||(s.visibility="hidden"),c.forEach((function(e){if(l&&"lineHeight"===e)if("border-box"===a.boxSizing){var t=parseInt(a.height,10),n=parseInt(a.paddingTop,10)+parseInt(a.paddingBottom,10)+parseInt(a.borderTopWidth,10)+parseInt(a.borderBottomWidth,10),o=n+parseInt(a.lineHeight,10);s.lineHeight=t>o?t-n+"px":t===o?a.lineHeight:"0"}else s.lineHeight=a.height;else s[e]=a[e]})),g?e.scrollHeight>parseInt(a.height,10)&&(s.overflowY="scroll"):s.overflow="hidden",r.textContent=e.value.substring(0,t),l&&(r.textContent=r.textContent.replace(/\s/g," "));var p=document.createElement("span");p.textContent=e.value.substring(t)||".",r.appendChild(p);var u={top:p.offsetTop+parseInt(a.borderTopWidth,10),left:p.offsetLeft+parseInt(a.borderLeftWidth,10),height:parseInt(a.lineHeight,10)};return o?p.style.backgroundColor="#aaa":document.body.removeChild(r),u},e.getEditableCaretCoordinates=function(e){if(window.getSelection().rangeCount){var t=window.getSelection().getRangeAt(0),n=t.getBoundingClientRect(),o=1===t.startContainer.nodeType?getComputedStyle(t.startContainer).lineHeight:getComputedStyle(t.startContainer.parentNode).lineHeight;if(isNaN(o)){var i=t.startContainer;1!==t.startContainer.nodeType&&(i=i.parentNode);var r=i.style.lineHeight;i.style.lineHeight="1em",o=parseInt(getComputedStyle(i).lineHeight,10),i.style.lineHeight=null!=r?r:"",i.getAttribute("style").length||i.removeAttribute("style")}var s=e.getBoundingClientRect();return{top:n.top-s.top,left:n.left-s.left,height:o}}return{top:0,left:0,height:0}},e.getCaretCoordinates=function(e,t,n){return["INPUT","TEXTAREA"].indexOf(e.nodeName)>=0?this.getTextareaCaretCoordinates(e,t,n):this.getEditableCaretCoordinates(e)},e.getCaretPosition=function(t,n,o){var i=e.getCaretCoordinates(t,n,o),r=a.getElementOffset(t);return{top:i.top+r.top,left:i.left+r.left}},e}(),f=function(e,t){return(f=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(e,t)};function m(e,t){function n(){this.constructor=e}f(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}Object.create;function y(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],o=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&o>=e.length&&(e=void 0),{value:e&&e[o++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}Object.create;var v=function(){function e(e){this.inputor=e}return e.prototype.lookup=function(e,t){var n,o;this.matchedMention=null;try{for(var i=y(t),r=i.next();!r.done;r=i.next()){var s=r.value,a=this.seekQuery(e,s);if(a){this.matchedMention={query:a,mention:s};break}}}catch(e){n={error:e}}finally{try{r&&!r.done&&(o=i.return)&&o.call(i)}finally{if(n)throw n.error}}return this.matchedMention},e}(),b=function(e){function t(t){return e.call(this,t)||this}return m(t,e),t.prototype.seekQuery=function(e,t){var n=this.inputor.selectionStart,o=this.inputor.value.replace(/[\r\n]/g," "),i=o.lastIndexOf(t.trigger,n),r=o.indexOf(" ",n),s=r>-1?r:o.length,a=o.substring(i,s);return!(i>0&&" "===o[i-1])&&0!==i||a.includes(" ")||a.includes(t.trigger,1)?null:{start:i,end:s,term:a.substring(t.trigger.length)}},t.prototype.insertMention=function(e){if(!this.matchedMention)throw new Error("matchedMention is null");var t=this.getInsertValue(e),n=this.inputor.value,o=[n.slice(0,this.matchedMention.query.start),t,n.slice(this.matchedMention.query.end,n.length)].join("");return this.inputor.value=o,this.focus(this.matchedMention.query.start+t.length),o},t.prototype.getInsertValue=function(e){return this.matchedMention.mention.insertTransform?this.matchedMention.mention.insertTransform(e).trim()+" ":(""+this.matchedMention.mention.trigger+e.name).trim()+" "},t.prototype.focus=function(e){this.inputor.focus(),this.inputor.setSelectionRange(e,e)},t.prototype.isEditable=function(){return!this.inputor.readOnly&&!this.inputor.disabled},t}(v),C=function(e){function t(t){return e.call(this,t)||this}return m(t,e),t.prototype.seekQuery=function(e,t){return null},t.prototype.insertMention=function(e){throw new Error("Method not implemented.")},t}(v);var x={backdropClass:"thy-mention-suggestions-backdrop",placement:"bottomLeft"},S=function(e,t){return t.filter((function(t){return!t.name||t.name.toLowerCase().includes(e.toLowerCase())}))},w={autoClose:!0,emptyText:"无匹配数据，按空格完成输入",search:S},R=function(){function e(e,n,o){var i;this.elementRef=e,this.thyPopover=n,this.ngControl=o,this.adapter=null,this.select=new t.EventEmitter,this.adapter=(i=e.nativeElement,a.isInputOrTextarea(i)?new b(i):(i.contentEditable="true",new C(i))),this.bindEvents()}return Object.defineProperty(e.prototype,"mentions",{get:function(){return this._mentions},set:function(e){this._mentions=e,this._mentions&&(this._mentions=this._mentions.map((function(e){if(!e.trigger)throw new Error("mention trigger is required");return Object.assign({},w,e)})))},enumerable:!1,configurable:!0}),e.prototype.ngOnInit=function(){},e.prototype.bindEvents=function(){var e=this;this.elementRef.nativeElement.addEventListener("input",(function(t){e.onInput(t)})),this.elementRef.nativeElement.addEventListener("click",(function(t){e.onClick(t)}))},e.prototype.onClick=function(e){this.lookup(e)},e.prototype.onInput=function(e){this.lookup(e)},e.prototype.lookup=function(e){var t=this.adapter.lookup(e,this.mentions);t?this.openSuggestions(t):this.closeSuggestions()},e.prototype.openSuggestions=function(e){var t=this;if(!this.openedSuggestionsRef){var n=this.elementRef.nativeElement,o=d.getCaretPosition(n,e.query.start),i=parseInt(getComputedStyle(this.elementRef.nativeElement).fontSize,10);this.openedSuggestionsRef=this.thyPopover.open(u,Object.assign({},x,this.popoverConfig,{origin:this.elementRef,originPosition:{x:o.left,y:o.top,width:i,height:i},initialState:{mention:e.mention}})),this.openedSuggestionsRef.afterClosed().subscribe((function(){t.openedSuggestionsRef=null})),this.openedSuggestionsRef.componentInstance.suggestionSelect$.subscribe((function(e){var n=t.adapter.insertMention(e.item);t.ngControl&&t.ngControl.control&&t.ngControl.control.setValue(n),t.openedSuggestionsRef.close(),t.select.emit(e)}))}this.openedSuggestionsRef&&this.openedSuggestionsRef.componentInstance.search(e.query)},e.prototype.closeSuggestions=function(){this.openedSuggestionsRef&&this.openedSuggestionsRef.close()},e.prototype.isEditable=function(){var e=this.elementRef.nativeElement;return!e.readOnly&&!e.disabled},e}();R.decorators=[{type:t.Directive,args:[{selector:"[thyMention]",providers:[]}]}],R.ctorParameters=function(){return[{type:t.ElementRef},{type:i.ThyPopover},{type:o.NgControl,decorators:[{type:t.Optional},{type:t.Self}]}]},R.propDecorators={mentions:[{type:t.Input,args:["thyMention"]}],popoverConfig:[{type:t.Input,args:["thyPopoverConfig"]}],select:[{type:t.Output,args:["thySelectSuggestion"]}]};var T=function(){};T.decorators=[{type:t.NgModule,args:[{declarations:[R,u],imports:[n.CommonModule,o.FormsModule,i.ThyPopoverModule,l.ThyListModule,p.ThyLoadingModule],exports:[R],providers:[],entryComponents:[u]}]}],e.ThyMentionDirective=R,e.ThyMentionModule=T,e.ThyMentionSuggestionsComponent=u,e.ɵ0=S,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=ngx-tethys-mention.umd.min.js.map