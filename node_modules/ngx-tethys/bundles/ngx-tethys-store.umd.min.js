!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@angular/core"),require("rxjs"),require("rxjs/operators"),require("ngx-tethys/util")):"function"==typeof define&&define.amd?define("ngx-tethys/store",["exports","@angular/core","rxjs","rxjs/operators","ngx-tethys/util"],e):e(((t="undefined"!=typeof globalThis?globalThis:t||self)["ngx-tethys"]=t["ngx-tethys"]||{},t["ngx-tethys"].store={}),t.ng.core,t.rxjs,t.rxjs.operators,t["ngx-tethys"].util)}(this,(function(t,e,n,o,i){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */var r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(t,e)};function s(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}function a(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)}Object.create;function c(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var o,i,r=n.call(t),s=[];try{for(;(void 0===e||e-- >0)&&!(o=r.next()).done;)s.push(o.value)}catch(t){i={error:t}}finally{try{o&&!o.done&&(n=r.return)&&n.call(r)}finally{if(i)throw i.error}}return s}function u(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(c(arguments[e]));return t}Object.create;var p="__THY_META__",f=new e.InjectionToken("ROOT_STATE_TOKEN"),h=new e.InjectionToken("FEATURE_STATE_TOKEN");!function(t){function e(){return t.call(this,'You\'ve forgotten to import "ThyStoreModule"!')||this}s(e,t)}(Error);function l(){null}var d=function(t){var e;e=t.injector,e,t.onDestroy(l)};d.decorators=[{type:e.NgModule}],d.ctorParameters=function(){return[{type:e.NgModuleRef}]};var y=function(){};y.decorators=[{type:e.NgModule}];var g=function(){function t(){}return t.forRoot=function(t){return void 0===t&&(t=[]),{ngModule:d,providers:u(t,[{provide:f,useValue:t}])}},t.forFeature=function(t){return void 0===t&&(t=[]),{ngModule:y,providers:u(t,[{provide:h,multi:!0,useValue:t}])}},t}();g.decorators=[{type:e.NgModule,args:[{}]}];var v=function(){function t(){if(this._devTools=null,this._window=window,null!=this._window){var t=this._window.__REDUX_DEVTOOLS_EXTENSION__||this._window.devToolsExtension;if(!t)return console.log("未安装Chrome浏览器的拓展插件: Redux DevTools."),void console.log("插件下载地址: https://www.chromefor.com/redux-devtools_v2-17-0/");this._devTools=t.connect({name:"NgxStore v0.6.0"})}}return t.prototype.handleNewState=function(t,e){this.isConnectSuccessed()&&this._devTools.send(t,e)},t.prototype.isConnectSuccessed=function(){return null!==this._devTools},t}();var _,b=function(){function t(){}return t.changeAction=function(t){this.actionName=t},t.getActionName=function(){return this.actionName},t}();b.actionName="";var S=function(){function t(){this.connectSuccessed=!1,this._containers=new n.BehaviorSubject(new Map),this._plugin=(window.___ReduxDevtoolsPlugin___||(window.___ReduxDevtoolsPlugin___=new v),window.___ReduxDevtoolsPlugin___),this._combinedStateSubscription=new n.Subscription,this._plugin.isConnectSuccessed()&&(this.connectSuccessed=!0,this._assignCombinedState(),console.log("是否在Angular开发环境："+e.isDevMode()+", 初始化root-store"))}return t.prototype._assignCombinedState=function(){var t=this;this._combinedStateSubscription=this._containers.pipe(o.switchMap((function(e){return t._getCombinedState(e)}))).pipe(o.map((function(t){var e=b.getActionName();return{state:t.reduce((function(t,e){return t[e.containerName]=e.state,t}),{}),actionName:e}}))).subscribe((function(e){t._plugin.handleNewState(e.actionName,e.state)}))},t.prototype._getCombinedState=function(t){return n.combineLatest.apply(void 0,u(Array.from(t.entries()).map((function(t){var e=c(t,2),n=e[0];return e[1].state$.pipe(o.map((function(t){return{containerName:n,state:t}})),o.tap((function(t){})))}))))},t.prototype.ngOnDestroy=function(){this._combinedStateSubscription.unsubscribe()},t.prototype.registerStore=function(t){if(this.connectSuccessed){var e=new Map(this._containers.value);if(e.has(t.getStoreInstanceId()))throw new Error("Store: Store with duplicate instance ID found! "+t.getStoreInstanceId()+" is already registered. Please check your getStoreInstanceId() methods!");e.set(t.getStoreInstanceId(),t),this._containers.next(e)}},t.prototype.existStoreInstanceId=function(t){return!!new Map(this._containers.value).has(t)},t.prototype.unregisterStore=function(t){if(this.connectSuccessed){var e=new Map(this._containers.value);e.delete(t.getStoreInstanceId()),this._containers.next(e)}},t}();function m(){return _||(_=new S),_}function w(t){return function(e,i,r){var s=function(t){t.hasOwnProperty(p)||(t[p]={actions:{},path:null,children:[],instance:null});return t[p]}(e);t||(t={type:i}),"string"==typeof t&&(t={type:t});var a=t.type;if(!t.type)throw new Error("Action "+t.type+' is missing a static "type" property');var c=r.value;s.actions[a]={fn:i,originalFn:c,type:a},r.value=function(){for(var r=[],s=0;s<arguments.length;s++)r[s]=arguments[s];b.changeAction(e.constructor.name+"-"+i);var a=c.call.apply(c,u([this],r));return a instanceof n.Observable&&(a=a.pipe(o.catchError((function(e){return n.of({status:"ERRORED",action:t,error:e})})),o.shareReplay(),o.exhaustMap((function(t){return t&&"ERRORED"===t.status?n.throwError(t.error):n.of(t)})))).subscribe(),a}}}S.decorators=[{type:e.Injectable}],S.ctorParameters=function(){return[]};var x=function(){function t(t){if(this.reduxToolEnabled=e.isDevMode(),this._defaultStoreInstanceId=this._getClassName(),this.state$=new n.BehaviorSubject(t),this.initialStateCache=Object.assign({},t),this.reduxToolEnabled){var o=m();b.changeAction("Add-"+this._defaultStoreInstanceId),o.registerStore(this)}}return Object.defineProperty(t.prototype,"snapshot",{get:function(){return this.state$.getValue()},enumerable:!1,configurable:!0}),t.prototype.dispatch=function(t,e){b.changeAction(this._defaultStoreInstanceId+"-"+t);var n=this._dispatch({type:t,payload:e});return n.subscribe(),n},t.prototype._dispatch=function(t){var e=this[p];if(!e)throw new Error(p+" is not found, current store has not action");var i=e.actions[t.type];if(!i)throw new Error(t.type+" is not found");var r=i.originalFn.call(this,this.snapshot,t.payload);return r instanceof Promise&&(r=n.from(r)),(r=r instanceof n.Observable?r.pipe(o.map((function(t){return t}))):new n.Observable((function(t){t.next({})}))).pipe(o.shareReplay())},t.prototype.select=function(t){return this.state$.pipe(o.map(t),o.distinctUntilChanged())},t.prototype.next=function(t){this.state$.next(t)},t.prototype.error=function(t){this.state$.error(t)},t.prototype.complete=function(){this.state$.complete()},t.prototype.subscribe=function(t,e,n){return this.state$.subscribe(t,e,n)},t.prototype.setState=function(t){i.helpers.isFunction(t)?this.next(Object.assign(Object.assign({},this.snapshot),t(this.snapshot))):this.next(Object.assign(Object.assign({},this.snapshot),t))},t.prototype.getState=function(){return this.snapshot},t.prototype.clearState=function(){this.setState(this.initialStateCache)},t.prototype.ngOnDestroy=function(){this.reduxToolEnabled&&m().unregisterStore(this)},t.prototype.getStoreInstanceId=function(){return this._defaultStoreInstanceId},t.prototype._getClassName=function(){var t=this.constructor.name||/function (.+)\(/.exec(this.constructor+"")[1];if(this.reduxToolEnabled){var e=m();if(!e.existStoreInstanceId(t))return t;for(var n=0,o=1;o<20;o++)if(!e.existStoreInstanceId(t+"-"+o)){n=o;break}return t+"-"+n}return t},t}();x.decorators=[{type:e.Injectable}],x.ctorParameters=function(){return[{type:void 0}]},function(t,e,n,o){var i,r=arguments.length,s=r<3?e:null===o?o=Object.getOwnPropertyDescriptor(e,n):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,n,o);else for(var a=t.length-1;a>=0;a--)(i=t[a])&&(s=(r<3?i(s):r>3?i(e,n,s):i(e,n))||s);r>3&&s&&Object.defineProperty(e,n,s)}([w(),a("design:type",Function),a("design:paramtypes",[]),a("design:returntype",void 0)],x.prototype,"clearState",null);var I=function(t){function e(e,n){void 0===e&&(e={entities:[]}),void 0===n&&(n={idKey:"_id"});var i=t.call(this,e)||this;if(i.entities$=i.select((function(t){return t.entities})),i.entitiesWithRefs$=i.entities$.pipe(o.map((function(t){return t?t.map((function(t){var e=Object.assign({},t);if(!i.onCombineRefs)throw new Error("onCombineRefs is not empty");return e.refs||(e.refs={}),i.onCombineRefs(e,i.internalReferencesIdMap,i.snapshot.references),e})):t}))),i.trackBy=function(t,e){return e[i.options.idKey]},i.options=Object.assign({idKey:"_id"},n),!i.options.idKey)throw new Error("idKey is required in EntityStore");return i.buildReferencesIdMap(),i}return s(e,t),Object.defineProperty(e.prototype,"entities",{get:function(){return this.snapshot.entities},enumerable:!1,configurable:!0}),e.prototype.resetPagination=function(t,e){t.count=e;var n=Math.ceil(t.count/t.pageSize);t.pageCount=n,this.snapshot.pagination=Object.assign({},t)},e.prototype.increasePagination=function(t){var e=this.snapshot.pagination;this.resetPagination(e,e.count+t)},e.prototype.decreasePagination=function(t){var e=this.snapshot.pagination;e&&this.resetPagination(e,e.count-t)},e.prototype.buildReferencesIdMap=function(){this.snapshot.references&&(this.internalReferencesIdMap=i.buildReferencesKeyBy(this.snapshot.references,this.options.referencesIdKeys))},e.prototype.initialize=function(t,e){var n=this.snapshot;n.entities=t||[],n.pagination=e,this.next(n)},e.prototype.initializeWithReferences=function(t,e,n){var o=this.snapshot;o.entities=t||[],o.pagination=n,o.references=e,this.buildReferencesIdMap(),this.next(o)},e.prototype.addInternal=function(t,e,n){var o=i.helpers.coerceArray(t);if(0!==o.length){var r=this.snapshot;r.entities=i.produce(r.entities).add(o,n),r.references&&(i.mergeReferences(r.references,e,this.options.referencesIdKeys),this.buildReferencesIdMap()),r.pagination&&(this.increasePagination(o.length),n&&!n.prepend&&n.autoGotoLastPage&&(r.pagination.pageIndex=r.pagination.pageCount)),this.next(r)}},e.prototype.add=function(t,e){this.addInternal(t,void 0,e)},e.prototype.addWithReferences=function(t,e,n){this.addInternal(t,e,n)},e.prototype.updateInternal=function(t,e,n){for(var o=i.helpers.coerceArray(t),r=this.snapshot,s=0;s<r.entities.length;s++){var a=r.entities[s];if(o.indexOf(a[this.options.idKey])>-1){var c=i.helpers.isFunction(e)?e(a):e;r.entities[s]=Object.assign(Object.assign({},a),c)}}r.entities=u(r.entities),r.references&&(i.mergeReferences(r.references,n,this.options.referencesIdKeys),this.buildReferencesIdMap()),this.next(r)},e.prototype.update=function(t,e){this.updateInternal(t,e,void 0)},e.prototype.updateWithReferences=function(t,e,n){this.updateInternal(t,e,n)},e.prototype.remove=function(t){var e=this.snapshot,n=e.entities.length;e.entities=i.produce(e.entities,this.options).remove(t),this.decreasePagination(n-e.entities.length),this.next(e)},e.prototype.clearPagination=function(){var t=this.snapshot;t.pagination=null,this.next(t)},e.prototype.clear=function(){var t=this.snapshot;t.entities=[],t.pagination=null,t.references=null,this.next(t)},e}(x);t.Action=w,t.EntityStore=I,t.FEATURE_STATE_TOKEN=h,t.META_KEY=p,t.ROOT_STATE_TOKEN=f,t.RootStore=S,t.Store=x,t.ThyFeatureStoreModule=y,t.ThyRootStoreModule=d,t.ThyStoreModule=g,t.getSingletonRootStore=m,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=ngx-tethys-store.umd.min.js.map